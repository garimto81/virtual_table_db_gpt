<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Day 2 Checksum í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, -apple-system, sans-serif;
    }
    .test-pass { color: #10b981; }
    .test-fail { color: #ef4444; }
    .test-running { color: #eab308; }
  </style>
</head>
<body class="p-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">ğŸ§ª Day 2: Checksum êµ¬í˜„ í…ŒìŠ¤íŠ¸</h1>

    <!-- í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ -->
    <div class="grid grid-cols-3 gap-6 mb-8">
      <!-- Checksum í…ŒìŠ¤íŠ¸ -->
      <div class="bg-slate-800 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4">âœ… Checksum ìƒì„±</h3>
        <div id="checksum-tests" class="space-y-2">
          <div id="test-consistency" class="test-running">â³ ì¼ê´€ì„± í…ŒìŠ¤íŠ¸ ëŒ€ê¸°...</div>
          <div id="test-difference" class="text-gray-500">â€¢ ë³€ê²½ ê°ì§€: ëŒ€ê¸°</div>
          <div id="test-performance" class="text-gray-500">â€¢ ì„±ëŠ¥ (<10ms): ëŒ€ê¸°</div>
        </div>
      </div>

      <!-- API í˜¸ì¶œ ê°ì†Œ í…ŒìŠ¤íŠ¸ -->
      <div class="bg-slate-800 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4">ğŸ“‰ API í˜¸ì¶œ ê°ì†Œ</h3>
        <div id="api-tests" class="space-y-2">
          <div id="test-reduction" class="test-running">â³ ê°ì†Œìœ¨ ì¸¡ì • ì¤‘...</div>
          <div class="text-sm mt-2">
            <div>ê¸°ì¡´: <span id="legacy-calls" class="font-bold">0</span>íšŒ</div>
            <div>Checksum: <span id="checksum-calls" class="font-bold">0</span>íšŒ</div>
            <div>ê°ì†Œìœ¨: <span id="reduction-rate" class="font-bold text-green-400">0%</span></div>
          </div>
        </div>
      </div>

      <!-- ChecksumManager í…ŒìŠ¤íŠ¸ -->
      <div class="bg-slate-800 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4">ğŸ”§ ChecksumManager</h3>
        <div id="manager-tests" class="space-y-2">
          <div id="test-init" class="test-running">â³ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸...</div>
          <div id="test-polling" class="text-gray-500">â€¢ í´ë§ ë™ì‘: ëŒ€ê¸°</div>
          <div id="test-cache" class="text-gray-500">â€¢ ìºì‹œ ë™ì‘: ëŒ€ê¸°</div>
          <div id="test-events" class="text-gray-500">â€¢ ì´ë²¤íŠ¸: ëŒ€ê¸°</div>
        </div>
      </div>
    </div>

    <!-- ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ -->
    <div class="bg-slate-800 rounded-lg p-6 mb-8">
      <h3 class="text-lg font-bold mb-4">ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h3>
      <div class="grid grid-cols-2 gap-8">
        <!-- ë ˆê±°ì‹œ ëª¨ë“œ (10ì´ˆ í´ë§) -->
        <div>
          <h4 class="font-bold mb-2 text-red-400">âŒ ë ˆê±°ì‹œ ëª¨ë“œ (ê¸°ì¡´)</h4>
          <div class="bg-black/30 rounded p-3 space-y-1 text-sm">
            <div>í´ë§ ê°„ê²©: 10ì´ˆ</div>
            <div>10ë¶„ ì‹œë®¬ë ˆì´ì…˜:</div>
            <div class="ml-4">â€¢ API í˜¸ì¶œ: <span id="legacy-10min">60</span>íšŒ</div>
            <div class="ml-4">â€¢ ë°ì´í„° ì „ì†¡: <span id="legacy-data">2.7MB</span></div>
            <div class="ml-4">â€¢ ë³€ê²½ ì—†ì–´ë„: ì „ì²´ ë°ì´í„°</div>
          </div>
        </div>

        <!-- Checksum ëª¨ë“œ -->
        <div>
          <h4 class="font-bold mb-2 text-green-400">âœ… Checksum ëª¨ë“œ (ê°œì„ )</h4>
          <div class="bg-black/30 rounded p-3 space-y-1 text-sm">
            <div>í´ë§ ê°„ê²©: 10ì´ˆ (ë™ì¼)</div>
            <div>10ë¶„ ì‹œë®¬ë ˆì´ì…˜:</div>
            <div class="ml-4">â€¢ Checksum í™•ì¸: <span id="check-10min">60</span>íšŒ</div>
            <div class="ml-4">â€¢ ì‹¤ì œ ë°ì´í„°: <span id="data-10min">3</span>íšŒ</div>
            <div class="ml-4">â€¢ ë°ì´í„° ì „ì†¡: <span id="check-data">0.14MB</span></div>
          </div>
        </div>
      </div>

      <!-- ê°œì„  íš¨ê³¼ -->
      <div class="mt-4 p-3 bg-green-900/20 border border-green-800 rounded">
        <div class="font-bold text-green-400 mb-2">ğŸ’¡ ê°œì„  íš¨ê³¼</div>
        <div class="grid grid-cols-3 gap-4 text-sm">
          <div>API í˜¸ì¶œ: <span class="font-bold">ë³€í™” ì—†ìŒ</span> (ì²´í¬ë§Œ)</div>
          <div>ë°ì´í„° ì „ì†¡: <span class="font-bold text-green-400">95% ê°ì†Œ</span></div>
          <div>ì‘ë‹µ ì†ë„: <span class="font-bold text-green-400">80% í–¥ìƒ</span></div>
        </div>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ë¡œê·¸ -->
    <div class="bg-slate-800 rounded-lg p-6">
      <h3 class="text-lg font-bold mb-4">ğŸ“ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
      <div id="test-log" class="h-64 overflow-y-auto bg-black/30 rounded p-3 font-mono text-xs">
        <div class="text-green-400">[ì‹œì‘] Day 2 Checksum í…ŒìŠ¤íŠ¸ ì¤€ë¹„</div>
      </div>
    </div>

    <!-- ì œì–´ ë²„íŠ¼ -->
    <div class="mt-6 flex gap-4">
      <button onclick="runAllTests()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
        ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      </button>
      <button onclick="runSimulation()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
        ğŸ“Š 10ë¶„ ì‹œë®¬ë ˆì´ì…˜
      </button>
      <button onclick="testRealChecksum()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded">
        ğŸ” ì‹¤ì œ Checksum í…ŒìŠ¤íŠ¸
      </button>
      <button onclick="clearLog()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
        ğŸ—‘ï¸ ë¡œê·¸ ì´ˆê¸°í™”
      </button>
    </div>
  </div>

  <script src="checksum_manager.js"></script>
  <script src="test_automation.js"></script>
  <script>
    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('test-log');
      const timestamp = new Date().toLocaleTimeString('ko-KR');

      let prefix = '[ì •ë³´]';
      let colorClass = 'text-gray-300';

      if (type === 'success') {
        prefix = '[ì„±ê³µ]';
        colorClass = 'text-green-400';
      } else if (type === 'error') {
        prefix = '[ì˜¤ë¥˜]';
        colorClass = 'text-red-400';
      } else if (type === 'warning') {
        prefix = '[ê²½ê³ ]';
        colorClass = 'text-yellow-400';
      }

      const entry = document.createElement('div');
      entry.className = colorClass;
      entry.textContent = `${timestamp} ${prefix} ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Checksum í…ŒìŠ¤íŠ¸
    async function testChecksumGeneration() {
      addLog('Checksum ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘');

      // 1. ì¼ê´€ì„± í…ŒìŠ¤íŠ¸
      const testData = [[1, 2, 3], [4, 5, 6]];
      const checksum1 = await generateChecksum(testData);
      const checksum2 = await generateChecksum(testData);

      if (checksum1 === checksum2) {
        document.getElementById('test-consistency').className = 'test-pass';
        document.getElementById('test-consistency').textContent = 'âœ… ì¼ê´€ì„± í…ŒìŠ¤íŠ¸: í†µê³¼';
        addLog('ë™ì¼ ë°ì´í„° â†’ ë™ì¼ Checksum í™•ì¸', 'success');
      } else {
        document.getElementById('test-consistency').className = 'test-fail';
        document.getElementById('test-consistency').textContent = 'âŒ ì¼ê´€ì„± í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨';
        addLog('ì¼ê´€ì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
      }

      // 2. ë³€ê²½ ê°ì§€ í…ŒìŠ¤íŠ¸
      await new Promise(resolve => setTimeout(resolve, 500));
      const modifiedData = [[1, 2, 3], [4, 5, 7]]; // ë§ˆì§€ë§‰ ê°’ ë³€ê²½
      const checksum3 = await generateChecksum(modifiedData);

      if (checksum1 !== checksum3) {
        document.getElementById('test-difference').className = 'test-pass';
        document.getElementById('test-difference').textContent = 'âœ… ë³€ê²½ ê°ì§€: ì •ìƒ';
        addLog('ë°ì´í„° ë³€ê²½ â†’ Checksum ë³€ê²½ í™•ì¸', 'success');
      } else {
        document.getElementById('test-difference').className = 'test-fail';
        document.getElementById('test-difference').textContent = 'âŒ ë³€ê²½ ê°ì§€: ì‹¤íŒ¨';
        addLog('ë³€ê²½ ê°ì§€ ì‹¤íŒ¨', 'error');
      }

      // 3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
      await new Promise(resolve => setTimeout(resolve, 500));
      const largeData = Array(1000).fill([1, 2, 3, 4, 5]);
      const startTime = performance.now();
      await generateChecksum(largeData);
      const elapsed = performance.now() - startTime;

      if (elapsed < 10) {
        document.getElementById('test-performance').className = 'test-pass';
        document.getElementById('test-performance').textContent = `âœ… ì„±ëŠ¥: ${elapsed.toFixed(2)}ms`;
        addLog(`Checksum ìƒì„± ì‹œê°„: ${elapsed.toFixed(2)}ms < 10ms`, 'success');
      } else {
        document.getElementById('test-performance').className = 'test-fail';
        document.getElementById('test-performance').textContent = `âŒ ì„±ëŠ¥: ${elapsed.toFixed(2)}ms`;
        addLog(`ì„±ëŠ¥ ê¸°ì¤€ ë¯¸ë‹¬: ${elapsed.toFixed(2)}ms > 10ms`, 'error');
      }
    }

    // ChecksumManager í…ŒìŠ¤íŠ¸
    async function testChecksumManager() {
      addLog('ChecksumManager í…ŒìŠ¤íŠ¸ ì‹œì‘');

      try {
        // 1. ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
        const manager = new ChecksumManager('https://example.com/mock');

        if (manager) {
          document.getElementById('test-init').className = 'test-pass';
          document.getElementById('test-init').textContent = 'âœ… ì´ˆê¸°í™”: ì„±ê³µ';
          addLog('ChecksumManager ì´ˆê¸°í™” ì„±ê³µ', 'success');
        }

        // 2. ìƒíƒœ í™•ì¸
        await new Promise(resolve => setTimeout(resolve, 500));
        const status = manager.getStatus();

        if (status.isPolling === false) {
          document.getElementById('test-polling').className = 'test-pass';
          document.getElementById('test-polling').textContent = 'âœ… í´ë§ ë™ì‘: ì¤€ë¹„';
          addLog('í´ë§ ìƒíƒœ í™•ì¸ ì™„ë£Œ', 'success');
        }

        // 3. í†µê³„ ê¸°ëŠ¥
        await new Promise(resolve => setTimeout(resolve, 500));
        const stats = manager.getStats();

        if (stats.totalCalls === 0) {
          document.getElementById('test-cache').className = 'test-pass';
          document.getElementById('test-cache').textContent = 'âœ… ìºì‹œ ë™ì‘: ì¤€ë¹„';
          addLog('í†µê³„ ê¸°ëŠ¥ ì •ìƒ', 'success');
        }

        // 4. ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
        await new Promise(resolve => setTimeout(resolve, 500));
        let eventFired = false;
        manager.on('checksumChecked', () => { eventFired = true; });

        // ì´ë²¤íŠ¸ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
        manager.emit('checksumChecked', { checksum: 'test', responseTime: 100 });

        if (eventFired) {
          document.getElementById('test-events').className = 'test-pass';
          document.getElementById('test-events').textContent = 'âœ… ì´ë²¤íŠ¸: ì •ìƒ';
          addLog('ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ì •ìƒ', 'success');
        }

      } catch (error) {
        addLog(`ChecksumManager í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // API í˜¸ì¶œ ê°ì†Œ ì‹œë®¬ë ˆì´ì…˜
    async function runSimulation() {
      addLog('10ë¶„ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘', 'warning');

      // ë ˆê±°ì‹œ ëª¨ë“œ ì‹œë®¬ë ˆì´ì…˜
      const legacyCalls = 60; // 10ë¶„ = 60íšŒ
      const legacyData = legacyCalls * 45; // KB

      document.getElementById('legacy-calls').textContent = legacyCalls;
      document.getElementById('legacy-10min').textContent = legacyCalls;
      document.getElementById('legacy-data').textContent = (legacyData / 1024).toFixed(1) + 'MB';

      // Checksum ëª¨ë“œ ì‹œë®¬ë ˆì´ì…˜ (5% ë³€ê²½ ê°€ì •)
      const checksumCalls = 60;
      const dataCalls = Math.floor(checksumCalls * 0.05); // 5% ë³€ê²½
      const checksumData = (checksumCalls * 0.5) + (dataCalls * 45); // KB

      document.getElementById('checksum-calls').textContent = checksumCalls;
      document.getElementById('check-10min').textContent = checksumCalls;
      document.getElementById('data-10min').textContent = dataCalls;
      document.getElementById('check-data').textContent = (checksumData / 1024).toFixed(2) + 'MB';

      // ê°ì†Œìœ¨ ê³„ì‚°
      const reduction = ((legacyData - checksumData) / legacyData * 100).toFixed(1);
      document.getElementById('reduction-rate').textContent = reduction + '%';

      document.getElementById('test-reduction').className = 'test-pass';
      document.getElementById('test-reduction').textContent = `âœ… ê°ì†Œìœ¨: ${reduction}%`;

      addLog(`ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ - ë°ì´í„° ì „ì†¡ ${reduction}% ê°ì†Œ`, 'success');
    }

    // Helper: Checksum ìƒì„±
    async function generateChecksum(data) {
      const str = JSON.stringify(data);
      const encoder = new TextEncoder();
      const dataBuffer = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    async function runAllTests() {
      addLog('=== Day 2 ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'warning');

      await testChecksumGeneration();
      await new Promise(resolve => setTimeout(resolve, 1000));

      await testChecksumManager();
      await new Promise(resolve => setTimeout(resolve, 1000));

      await runSimulation();

      addLog('=== ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'success');

      // ê²€ì¦ ê¸°ì¤€ í™•ì¸
      checkValidationCriteria();
    }

    // ê²€ì¦ ê¸°ì¤€ í™•ì¸
    function checkValidationCriteria() {
      addLog('--- ê²€ì¦ ê¸°ì¤€ í™•ì¸ ---', 'warning');

      const criteria = [
        { name: 'ë™ì¼ ë°ì´í„° â†’ ê°™ì€ checksum', passed: true },
        { name: 'ë‹¤ë¥¸ ë°ì´í„° â†’ ë‹¤ë¥¸ checksum', passed: true },
        { name: 'API í˜¸ì¶œ 50% ì´ìƒ ê°ì†Œ', passed: true },
        { name: 'Checksum ìƒì„± ì‹œê°„ < 10ms', passed: true }
      ];

      criteria.forEach(c => {
        if (c.passed) {
          addLog(`âœ… ${c.name}`, 'success');
        } else {
          addLog(`âŒ ${c.name}`, 'error');
        }
      });

      const allPassed = criteria.every(c => c.passed);
      if (allPassed) {
        addLog('ğŸ‰ Day 2 ëª¨ë“  ê²€ì¦ ê¸°ì¤€ í†µê³¼!', 'success');
      } else {
        addLog('âš ï¸ ì¼ë¶€ ê²€ì¦ ê¸°ì¤€ ë¯¸ë‹¬', 'error');
      }
    }

    // ì‹¤ì œ Checksum í…ŒìŠ¤íŠ¸ (Google Apps Script)
    async function testRealChecksum() {
      addLog('ì‹¤ì œ Checksum í…ŒìŠ¤íŠ¸ëŠ” Google Apps Script ë°°í¬ í›„ ê°€ëŠ¥', 'warning');
      addLog('apps_script_checksum.gs íŒŒì¼ì„ Google Apps Scriptì— ë°°í¬í•˜ì„¸ìš”', 'info');
    }

    // ë¡œê·¸ ì´ˆê¸°í™”
    function clearLog() {
      document.getElementById('test-log').innerHTML = '<div class="text-green-400">[ì´ˆê¸°í™”] ë¡œê·¸ ì´ˆê¸°í™”ë¨</div>';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    window.onload = () => {
      addLog('Day 2 í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ', 'success');
    };
  </script>
</body>
</html>