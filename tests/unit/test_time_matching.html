<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œê°„ ë§¤ì¹­ í…ŒìŠ¤íŠ¸</title>
</head>
<body>
    <h1>ì‹œê°„ ë§¤ì¹­ ë¡œì§ í…ŒìŠ¤íŠ¸</h1>
    <pre id="output"></pre>

    <script>
        // í…ŒìŠ¤íŠ¸ ì¶œë ¥ í•¨ìˆ˜
        const output = document.getElementById('output');
        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }

        // parseCSV í•¨ìˆ˜ (ë©”ì¸ ì½”ë“œì—ì„œ ë³µì‚¬)
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const rows = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].replace(/\r/g, '');
                if (!line.trim()) continue;

                const row = [];
                let inQuotes = false;
                let currentField = '';

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    const nextChar = line[j + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentField += '"';
                            j++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());
                rows.push(row);
            }

            return rows;
        }

        // ì‹œê°„ íŒŒì‹± í•¨ìˆ˜
        function parseTimeToTimestamp(timeStr) {
            if (!timeStr) return null;

            const str = String(timeStr).trim();

            // ì´ë¯¸ íƒ€ì„ìŠ¤íƒ¬í”„ì¸ ê²½ìš°
            const numValue = parseInt(str);
            if (!isNaN(numValue) && numValue > 1000000000 && str.match(/^\d+$/)) {
                return numValue;
            }

            // HH:MM:SS ë˜ëŠ” HH:MM í˜•ì‹
            const timeParts = str.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if (timeParts) {
                const today = new Date();
                const hours = parseInt(timeParts[1]);
                const minutes = parseInt(timeParts[2]);
                const seconds = parseInt(timeParts[3] || 0);

                today.setHours(hours, minutes, seconds, 0);

                const now = new Date();
                if (today > now) {
                    today.setDate(today.getDate() - 1);
                }

                return Math.floor(today.getTime() / 1000);
            }

            log(`âš ï¸ ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: "${str}"`);
            return null;
        }

        async function runTest() {
            log('ğŸ§ª ì‹œê°„ ë§¤ì¹­ í…ŒìŠ¤íŠ¸ ì‹œì‘\n');

            // Virtual ì‹œíŠ¸ CSV ê°€ì ¸ì˜¤ê¸°
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/export?format=csv&gid=561799849';

            log('ğŸ“¥ CSV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°...');
            const response = await fetch(csvUrl);
            const csvText = await response.text();

            log(`âœ… CSV í¬ê¸°: ${csvText.length} bytes\n`);

            // CSV íŒŒì‹±
            const rows = parseCSV(csvText);
            log(`ğŸ“Š íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}ê°œ\n`);

            // 618-622í–‰ ë°ì´í„° í™•ì¸
            log('ğŸ” 618-622í–‰ ë°ì´í„° ë¶„ì„:');
            for (let i = 617; i < 623 && i < rows.length; i++) {
                const row = rows[i];
                if (row && row.length > 4) {
                    log(`   í–‰ ${i+1}: Bì—´="${row[1] || ''}", Eì—´="${row[4] || ''}"`);
                }
            }

            // ì‹œê°„ ìºì‹œ êµ¬ì¶•
            log('\nğŸ“‹ ì‹œê°„ ë°ì´í„° ìºì‹±:');
            const cache = new Map();
            const timeIndex = new Map();

            for (let i = 0; i < rows.length && i < 1000; i++) {
                const cols = rows[i];
                if (!cols || cols.length < 8) continue;

                const timeStr = cols[1]?.trim();
                if (!timeStr) continue;

                const timestamp = parseTimeToTimestamp(timeStr);
                if (!timestamp) continue;

                let status = cols[4]?.trim() || '';
                if (status.startsWith('"') && status.endsWith('"')) {
                    status = status.slice(1, -1);
                }

                const rowData = {
                    row: i + 1,
                    time: timeStr,
                    timestamp: timestamp,
                    status: status
                };

                cache.set(i + 1, rowData);

                if (!timeIndex.has(timestamp)) {
                    timeIndex.set(timestamp, []);
                }
                timeIndex.get(timestamp).push(i + 1);

                // 618-622í–‰ ê·¼ì²˜ë§Œ ë¡œê·¸
                if (i >= 617 && i < 623) {
                    log(`   ìºì‹œ ì €ì¥: í–‰ ${i+1}, ì‹œê°„="${timeStr}", ìƒíƒœ="${status}", íƒ€ì„ìŠ¤íƒ¬í”„=${timestamp}`);
                }
            }

            log(`\nâœ… ìºì‹œ í¬ê¸°: ${cache.size}ê°œ`);
            log(`âœ… ì‹œê°„ ì¸ë±ìŠ¤: ${timeIndex.size}ê°œ\n`);

            // 10:18 ì°¾ê¸°
            log('ğŸ¯ 10:18 ë§¤ì¹­ í…ŒìŠ¤íŠ¸:');

            // Hand ì‹œíŠ¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ (í•¸ë“œ #138)
            const handTimestamp = 1758075882; // 2025-09-17 10:18:02
            const handDate = new Date(handTimestamp * 1000);
            const targetHours = handDate.getHours();
            const targetMinutes = handDate.getMinutes();
            const targetTimeString = `${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}`;

            log(`   Hand íƒ€ì„ìŠ¤íƒ¬í”„: ${handTimestamp}`);
            log(`   ëª©í‘œ ì‹œê°„: ${targetTimeString}\n`);

            // ì •í™•í•œ ë§¤ì¹­ ì°¾ê¸°
            let exactMatch = null;
            for (const [rowNum, data] of cache) {
                if (data.time === targetTimeString) {
                    exactMatch = data;
                    log(`   âœ… ì •í™•í•œ ë§¤ì¹­ ë°œê²¬: í–‰ ${rowNum}, ì‹œê°„="${data.time}", ìƒíƒœ="${data.status}"`);
                    break;
                }
            }

            if (!exactMatch) {
                log(`   âŒ ì •í™•í•œ ë§¤ì¹­ ì—†ìŒ\n`);

                // ê·¼ì‚¬ ë§¤ì¹­ ì‹œë„
                log('   ğŸ”„ ê·¼ì‚¬ ë§¤ì¹­ ì‹œë„ (Â±3ë¶„):');
                const targetTotalMinutes = targetHours * 60 + targetMinutes;

                let closestMatch = null;
                let minDiff = Infinity;

                for (const [rowNum, data] of cache) {
                    const timeParts = data.time.match(/(\d+):(\d+)/);
                    if (timeParts) {
                        const hours = parseInt(timeParts[1]);
                        const minutes = parseInt(timeParts[2]);
                        const totalMinutes = hours * 60 + minutes;
                        const diff = Math.abs(totalMinutes - targetTotalMinutes);

                        if (diff <= 5) {
                            log(`      í–‰ ${rowNum}: ì‹œê°„="${data.time}" (${diff}ë¶„ ì°¨ì´), ìƒíƒœ="${data.status}"`);

                            if (diff < minDiff) {
                                minDiff = diff;
                                closestMatch = data;
                            }
                        }
                    }
                }

                if (closestMatch) {
                    log(`\n   ğŸ¯ ìµœì¢… ì„ íƒ: í–‰ ${closestMatch.row}, ì‹œê°„="${closestMatch.time}", ìƒíƒœ="${closestMatch.status}"`);
                }
            }

            // "10:18" ë¬¸ìì—´ì´ ìºì‹œì— ìˆëŠ”ì§€ ì§ì ‘ í™•ì¸
            log('\nğŸ” "10:18" ë¬¸ìì—´ ì§ì ‘ ê²€ìƒ‰:');
            let found1018 = false;
            for (const [rowNum, data] of cache) {
                if (data.time.includes('10:18')) {
                    log(`   ë°œê²¬: í–‰ ${rowNum}, ì‹œê°„="${data.time}", ìƒíƒœ="${data.status}"`);
                    found1018 = true;
                }
            }
            if (!found1018) {
                log('   âŒ "10:18"ì„ í¬í•¨í•˜ëŠ” í–‰ì´ ì—†ìŒ');
            }

            // "10:14" í™•ì¸
            log('\nğŸ” "10:14" ë¬¸ìì—´ ê²€ìƒ‰:');
            for (const [rowNum, data] of cache) {
                if (data.time.includes('10:14')) {
                    log(`   ë°œê²¬: í–‰ ${rowNum}, ì‹œê°„="${data.time}", ìƒíƒœ="${data.status}"`);
                    break;
                }
            }

            log('\nğŸ§ª í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
        }

        // í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        runTest().catch(err => {
            log('âŒ ì˜¤ë¥˜: ' + err.message);
            console.error(err);
        });
    </script>
</body>
</html>