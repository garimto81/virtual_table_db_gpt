<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Sheets CSV ì—°ë™ í…ŒìŠ¤íŠ¸ ë„êµ¬ v1.1 (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: #f8fafc;
            min-height: 100vh;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .test-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending { background: #fbbf24; color: #92400e; }
        .status-running { background: #3b82f6; color: #1e40af; }
        .status-success { background: #10b981; color: #065f46; }
        .status-error { background: #ef4444; color: #991b1b; }
        
        .log-output {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .url-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
            width: 100%;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .url-valid { border-color: #10b981 !important; }
        .url-warning { border-color: #f59e0b !important; }
        .url-error { border-color: #ef4444 !important; }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            margin: 4px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">ğŸ§ª Google Sheets CSV ì—°ë™ í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
            <p class="text-xl text-blue-200">Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹œìŠ¤í…œ ë””ë²„ê¹… ë° í…ŒìŠ¤íŠ¸ (Fixed v1.1)</p>
        </div>

        <!-- ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸ ì§„í–‰ë„ -->
        <div class="test-card">
            <h2 class="text-2xl font-bold mb-4">ğŸ“Š í…ŒìŠ¤íŠ¸ ì§„í–‰ë„</h2>
            <div class="progress-bar mb-4">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center">
                    <div id="step1-status" class="status-badge status-pending mb-2">ëŒ€ê¸°</div>
                    <div class="text-sm">URL ê²€ì¦</div>
                </div>
                <div class="text-center">
                    <div id="step2-status" class="status-badge status-pending mb-2">ëŒ€ê¸°</div>
                    <div class="text-sm">CSV ì ‘ê·¼</div>
                </div>
                <div class="text-center">
                    <div id="step3-status" class="status-badge status-pending mb-2">ëŒ€ê¸°</div>
                    <div class="text-sm">ë°ì´í„° íŒŒì‹±</div>
                </div>
                <div class="text-center">
                    <div id="step4-status" class="status-badge status-pending mb-2">ëŒ€ê¸°</div>
                    <div class="text-sm">ì‹œê°„ ë§¤ì¹­</div>
                </div>
                <div class="text-center">
                    <div id="step5-status" class="status-badge status-pending mb-2">ëŒ€ê¸°</div>
                    <div class="text-sm">ê²°ê³¼ ê²€ì¦</div>
                </div>
            </div>
        </div>

        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div class="test-card">
            <h2 class="text-2xl font-bold mb-4">ğŸ”— í…ŒìŠ¤íŠ¸ ì„¤ì •</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Google Sheets URL</label>
                    <input 
                        type="text" 
                        id="sheets-url" 
                        class="url-input"
                        placeholder="https://docs.google.com/spreadsheets/d/..."
                    >
                    <div id="url-feedback" class="mt-2 text-sm"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">í…ŒìŠ¤íŠ¸í•  ì‹œê°„ (Seoul ê¸°ì¤€)</label>
                    <input 
                        type="text" 
                        id="target-time" 
                        class="url-input"
                        placeholder="14:30:25 ë˜ëŠ” 14ì‹œ 30ë¶„ 25ì´ˆ"
                        value="14:30:25"
                    >
                </div>
            </div>
            <div class="mt-6 flex gap-4 flex-wrap">
                <button id="start-test" class="btn btn-primary">ğŸš€ ìë™ í…ŒìŠ¤íŠ¸</button>
                <button id="manual-csv-test" class="btn btn-success">ğŸ“‹ ìˆ˜ë™ CSV í…ŒìŠ¤íŠ¸</button>
                <button id="clear-logs" class="btn btn-secondary">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
        <div class="test-card">
            <h2 class="text-2xl font-bold mb-4">ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
            <div id="log-output" class="log-output">
                <div class="text-gray-400">í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
            </div>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- CSV ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
            <div class="test-card">
                <h2 class="text-2xl font-bold mb-4">ğŸ“„ CSV ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h2>
                <div id="csv-preview" class="log-output">
                    <div class="text-gray-400">CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- ë§¤ì¹­ ê²°ê³¼ -->
            <div class="test-card">
                <h2 class="text-2xl font-bold mb-4">ğŸ¯ ë§¤ì¹­ ê²°ê³¼</h2>
                <div id="match-result" class="log-output">
                    <div class="text-gray-400">ë§¤ì¹­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <!-- ë¬¸ì œ ì§„ë‹¨ ì„¹ì…˜ -->
        <div class="test-card">
            <h2 class="text-2xl font-bold mb-4">ğŸ” ë¬¸ì œ ì§„ë‹¨</h2>
            <div id="diagnosis-result" class="log-output">
                <div class="text-gray-400">í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë¬¸ì œ ì§„ë‹¨ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let testResults = {};
        let currentStep = 0;
        const totalSteps = 5;

        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#94a3b8',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444',
                debug: '#8b5cf6'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `<span style="color: #64748b">[${timestamp}]</span> ${message}`;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        function updateProgress(step) {
            currentStep = step;
            const progressFill = document.getElementById('progress-fill');
            const percentage = (step / totalSteps) * 100;
            progressFill.style.width = `${percentage}%`;
        }

        // ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStepStatus(step, status) {
            const stepElement = document.getElementById(`step${step}-status`);
            stepElement.className = `status-badge status-${status}`;
            stepElement.textContent = {
                pending: 'ëŒ€ê¸°',
                running: 'ì§„í–‰ì¤‘',
                success: 'ì„±ê³µ',
                error: 'ì‹¤íŒ¨'
            }[status];
        }

        // Google Sheets URL ê²€ì¦ í•¨ìˆ˜
        function validateGoogleSheetsUrl(url) {
            if (!url || !url.trim()) {
                return {
                    valid: false,
                    type: 'empty',
                    message: 'URLì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
                    color: '#ef4444'
                };
            }
            
            const trimmedUrl = url.trim();
            
            // 1. ì´ë¯¸ ì›¹ ê²Œì‹œëœ CSV URL (ê°€ì¥ ê¶Œì¥)
            if (trimmedUrl.includes('/pub?') && trimmedUrl.includes('output=csv')) {
                return {
                    valid: true,
                    type: 'published-csv',
                    message: 'âœ… ì™„ë²½í•œ ì›¹ ê²Œì‹œ CSV URL (ê¶Œì¥)',
                    color: '#10b981',
                    csvUrl: trimmedUrl
                };
            }
            
            // 2. ì›¹ ê²Œì‹œëœ ì¼ë°˜ URL (2PACX í˜•ì‹)
            if (trimmedUrl.includes('/spreadsheets/d/e/2PACX-')) {
                const gidMatch = trimmedUrl.match(/gid=(\d+)/);
                const gid = gidMatch ? gidMatch[1] : '0';
                const publishedIdMatch = trimmedUrl.match(/\/spreadsheets\/d\/e\/(2PACX-[a-zA-Z0-9-_]+)/);
                
                if (publishedIdMatch) {
                    const csvUrl = `https://docs.google.com/spreadsheets/d/e/${publishedIdMatch[1]}/pub?gid=${gid}&single=true&output=csv`;
                    return {
                        valid: true,
                        type: 'published-converted',
                        message: 'ğŸŸ¡ ì›¹ ê²Œì‹œ URL (ìë™ìœ¼ë¡œ CSVë¡œ ë³€í™˜ë¨)',
                        color: '#f59e0b',
                        csvUrl: csvUrl
                    };
                }
            }
            
            // 3. ì¼ë°˜ í¸ì§‘ URL (ë¹„ì¶”ì²œ)
            if (trimmedUrl.includes('/spreadsheets/d/') && !trimmedUrl.includes('/pub?')) {
                const sheetIdMatch = trimmedUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                
                if (sheetIdMatch) {
                    const sheetId = sheetIdMatch[1];
                    const gidMatch = trimmedUrl.match(/gid=(\d+)/);
                    const gid = gidMatch ? gidMatch[1] : '0';
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    
                    return {
                        valid: true,
                        type: 'export-url',
                        message: 'ğŸŸ  í¸ì§‘ URL (CORS ë° ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥ì„±)',
                        color: '#f59e0b',
                        csvUrl: csvUrl,
                        warning: true
                    };
                }
            }
            
            // 4. ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹
            if (trimmedUrl.includes('docs.google.com')) {
                return {
                    valid: false,
                    type: 'unsupported',
                    message: 'ğŸ”´ ì§€ì›ë˜ì§€ ì•ŠëŠ” Google Sheets URL í˜•ì‹',
                    color: '#ef4444'
                };
            }
            
            return {
                valid: false,
                type: 'invalid',
                message: 'âŒ Google Sheets URLì´ ì•„ë‹™ë‹ˆë‹¤',
                color: '#ef4444'
            };
        }

        // CSV íŒŒì‹± í•¨ìˆ˜
        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // ì‹œê°„ íŒŒì‹± í•¨ìˆ˜
        function parseTimeString(timeStr) {
            const timePatterns = [
                { pattern: /(\d{1,2}):(\d{2}):(\d{2})/, name: 'HH:MM:SS' },
                { pattern: /(\d{1,2}):(\d{2})/, name: 'HH:MM' },
                { pattern: /(\d{1,2})ì‹œ\s*(\d{1,2})ë¶„\s*(\d{1,2})ì´ˆ/, name: 'í•œêµ­ì–´ ì‹œ:ë¶„:ì´ˆ' },
                { pattern: /(\d{1,2})ì‹œ\s*(\d{1,2})ë¶„/, name: 'í•œêµ­ì–´ ì‹œ:ë¶„' }
            ];
            
            for (const {pattern, name} of timePatterns) {
                const match = timeStr.match(pattern);
                if (match) {
                    const hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const seconds = match[3] ? parseInt(match[3]) : 0;
                    
                    return {
                        hours,
                        minutes,
                        seconds,
                        totalSeconds: hours * 3600 + minutes * 60 + seconds,
                        pattern: name,
                        formatted: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                    };
                }
            }
            
            return null;
        }

        // CSV íŒŒì‹± í•¨ìˆ˜ (GitHub ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¨ ê²€ì¦ëœ ë°©ë²•)
        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // GitHub ì €ì¥ì†Œ ë°©ì‹ì˜ CSV fetch í•¨ìˆ˜ (ì˜¬ë°”ë¥¸ êµ¬í˜„)
        async function fetchCsv(url) {
            log(`ğŸ”„ GitHub ë°©ì‹: ì§ì ‘ CSV fetch ì‹œë„`, 'debug');
            log(`ğŸ“¡ ìš”ì²­ URL: ${url}`, 'debug');
            
            try {
                // GitHub ì €ì¥ì†Œì™€ ë™ì¼í•œ ë‹¨ìˆœí•œ fetch
                const res = await fetch(url);
                
                log(`ğŸ“Š HTTP ì‘ë‹µ: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');
                log(`ğŸ“Š Content-Type: ${res.headers.get('content-type')}`, 'debug');
                
                if (!res.ok) {
                    throw new Error(`CSV fetch failed: ${res.status}`);
                }
                
                const txt = await res.text();
                log(`âœ… ì§ì ‘ ë°©ë²• ì„±ê³µ: ${txt.length}ê¸€ì`, 'success');
                
                const rows = parseCSV(txt);
                log(`âœ… CSV íŒŒì‹± ì„±ê³µ: ${rows.length}í–‰`, 'success');
                
                return { 
                    response: {
                        ok: true,
                        status: res.status,
                        statusText: res.statusText,
                        headers: { get: (key) => res.headers.get(key) },
                        text: async () => txt
                    },
                    fetchMethod: 'ì§ì ‘ fetch (GitHub ë°©ì‹)',
                    csvText: txt,
                    parsedRows: rows
                };
                
            } catch (error) {
                log(`âŒ ì§ì ‘ ë°©ë²• ì‹¤íŒ¨: ${error.message}`, 'error');
                log('ğŸ’¡ CORS ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í”„ë¡ì‹œ ë°©ë²•ì„ ì‹œë„í•©ë‹ˆë‹¤.', 'debug');
                
                // í”„ë¡ì‹œ ë°©ë²• ì‹œë„
                try {
                    log('ğŸ”„ ë°©ë²• 2: AllOrigins í”„ë¡ì‹œ ì‹œë„', 'debug');
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const proxyResponse = await fetch(proxyUrl);
                    const proxyData = await proxyResponse.json();
                    
                    if (!proxyData.contents) {
                        throw new Error('í”„ë¡ì‹œì—ì„œ ë¹ˆ ë°ì´í„° ë°˜í™˜');
                    }
                    
                    let csvText = proxyData.contents;
                    
                    // Base64ë¡œ ì¸ì½”ë”©ëœ ë°ì´í„°ì¸ì§€ í™•ì¸ ë° ë””ì½”ë”©
                    if (csvText.startsWith('data:text/csv;base64,')) {
                        log('ğŸ”„ Base64 ì¸ì½”ë”© ë°ì´í„° ê°ì§€ - ë””ì½”ë”© ì¤‘...', 'debug');
                        const base64Data = csvText.replace('data:text/csv;base64,', '');
                        try {
                            csvText = atob(base64Data);
                            log(`âœ… Base64 ë””ì½”ë”© ì„±ê³µ: ${csvText.length}ê¸€ì`, 'success');
                        } catch (decodeError) {
                            log(`âŒ Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`, 'error');
                            throw new Error(`Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`);
                        }
                    }
                    
                    const rows = parseCSV(csvText);
                    log(`âœ… í”„ë¡ì‹œ ë°©ë²• ì„±ê³µ: ${rows.length}í–‰`, 'success');
                    
                    return {
                        response: {
                            ok: true,
                            status: 200,
                            statusText: 'OK (Proxy)',
                            headers: { get: (key) => key === 'content-type' ? 'text/csv' : null },
                            text: async () => csvText
                        },
                        fetchMethod: 'AllOrigins í”„ë¡ì‹œ',
                        csvText: csvText,
                        parsedRows: rows
                    };
                    
                } catch (error2) {
                    log(`âŒ í”„ë¡ì‹œ ë°©ë²• ì‹¤íŒ¨: ${error2.message}`, 'error');
                    throw new Error(`ëª¨ë“  fetch ë°©ë²• ì‹¤íŒ¨. ì§ì ‘: ${error.message}, í”„ë¡ì‹œ: ${error2.message}`);
                }
            }
        }

        // ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function runTest() {
            const url = document.getElementById('sheets-url').value;
            const targetTimeStr = document.getElementById('target-time').value;
            
            testResults = {};
            log('ğŸš€ === Google Sheets CSV ì—°ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            
            // ì´ˆê¸°í™”
            updateProgress(0);
            for (let i = 1; i <= totalSteps; i++) {
                updateStepStatus(i, 'pending');
            }
            
            try {
                // 1ë‹¨ê³„: URL ê²€ì¦
                updateStepStatus(1, 'running');
                updateProgress(1);
                log('ğŸ“‹ 1ë‹¨ê³„: URL ê²€ì¦ ì‹œì‘', 'info');
                
                const urlValidation = validateGoogleSheetsUrl(url);
                testResults.urlValidation = urlValidation;
                
                log(`ğŸ”— ì…ë ¥ URL: ${url}`, 'debug');
                log(`ğŸ’¬ ê²€ì¦ ê²°ê³¼: ${urlValidation.message}`, urlValidation.valid ? 'success' : 'error');
                
                if (!urlValidation.valid) {
                    updateStepStatus(1, 'error');
                    throw new Error(`URL ê²€ì¦ ì‹¤íŒ¨: ${urlValidation.message}`);
                }
                
                updateStepStatus(1, 'success');
                log(`âœ… CSV URL: ${urlValidation.csvUrl}`, 'success');
                
                // 2ë‹¨ê³„: CSV ë°ì´í„° ì ‘ê·¼
                updateStepStatus(2, 'running');
                updateProgress(2);
                log('ğŸ“¥ 2ë‹¨ê³„: CSV ë°ì´í„° ì ‘ê·¼ ì‹œì‘', 'info');
                
                const { response, fetchMethod, csvText, parsedRows } = await fetchCsv(urlValidation.csvUrl);
                log(`ğŸ“Š ì‚¬ìš©ëœ ë°©ë²•: ${fetchMethod}`, 'info');
                
                testResults.httpResponse = {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type'),
                    ok: response.ok
                };
                
                log(`ğŸ“Š HTTP ì‘ë‹µ: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    updateStepStatus(2, 'error');
                    throw new Error(`HTTP ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
                
                testResults.csvText = csvText;
                testResults.parsedRows = parsedRows;
                
                log(`ğŸ“„ CSV ë°ì´í„° í¬ê¸°: ${csvText.length} ê¸€ì`, 'success');
                updateStepStatus(2, 'success');
                
                // CSV ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                document.getElementById('csv-preview').innerHTML = `
                    <div style="color: #10b981;">âœ… ë°ì´í„° í¬ê¸°: ${csvText.length} ê¸€ì</div>
                    <div style="color: #64748b; margin-top: 8px;">ì²« 500ì:</div>
                    <pre style="white-space: pre-wrap; margin-top: 4px; color: #e2e8f0;">${csvText.substring(0, 500)}${csvText.length > 500 ? '...' : ''}</pre>
                `;
                
                // 3ë‹¨ê³„: ë°ì´í„° íŒŒì‹± (ì´ë¯¸ ì™„ë£Œ)
                updateStepStatus(3, 'running');
                updateProgress(3);
                log('ğŸ”§ 3ë‹¨ê³„: CSV ë°ì´í„° íŒŒì‹± (ì´ë¯¸ GitHub ë°©ë²•ì—ì„œ ì™„ë£Œ)', 'info');
                
                const rows = parsedRows;
                
                log(`ğŸ“‹ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}`, 'success');
                
                if (rows.length === 0) {
                    updateStepStatus(3, 'error');
                    throw new Error('CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ì²« 5í–‰ ë¡œê·¸
                log('ğŸ“Š CSV ë°ì´í„° êµ¬ì¡° (ì²« 5í–‰):', 'debug');
                for (let i = 0; i < Math.min(5, rows.length); i++) {
                    log(`   í–‰ ${i+1}: A="${rows[i][0] || ''}", B="${rows[i][1] || ''}", C="${rows[i][2] || ''}", D="${rows[i][3] || ''}"`, 'debug');
                }
                
                updateStepStatus(3, 'success');
                
                // 4ë‹¨ê³„: ì‹œê°„ ë§¤ì¹­
                updateStepStatus(4, 'running');
                updateProgress(4);
                log('â° 4ë‹¨ê³„: ì‹œê°„ ë§¤ì¹­ ì‹œì‘', 'info');
                
                const targetTime = parseTimeString(targetTimeStr);
                if (!targetTime) {
                    updateStepStatus(4, 'error');
                    throw new Error(`íƒ€ê²Ÿ ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: ${targetTimeStr}`);
                }
                
                log(`ğŸ¯ íƒ€ê²Ÿ ì‹œê°„: ${targetTime.formatted} (${targetTime.totalSeconds}ì´ˆ)`, 'info');
                
                let closestRow = null;
                let minDiff = Infinity;
                let rowIndex = -1;
                let matchedTime = null;
                let validTimeCount = 0;
                
                for (let i = 0; i < rows.length; i++) {
                    const cellValue = rows[i][2]; // Cì—´
                    if (!cellValue || !cellValue.trim()) continue;
                    
                    const cellTime = parseTimeString(cellValue);
                    if (!cellTime) {
                        log(`   í–‰ ${i+1} Cì—´: "${cellValue}" - ë§¤ì¹­ ì‹¤íŒ¨`, 'debug');
                        continue;
                    }
                    
                    validTimeCount++;
                    const diff = Math.abs(cellTime.totalSeconds - targetTime.totalSeconds);
                    
                    log(`   í–‰ ${i+1} Cì—´: "${cellValue}" â†’ ${cellTime.formatted} (ì°¨ì´: ${diff}ì´ˆ)`, 'debug');
                    
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestRow = rows[i];
                        rowIndex = i + 1;
                        matchedTime = cellTime;
                        
                        log(`   ğŸ¯ ìƒˆë¡œìš´ ìµœì  ë§¤ì¹­: í–‰ ${rowIndex}, ì°¨ì´ ${diff}ì´ˆ`, 'success');
                        
                        if (diff <= 5) {
                            log('âœ… ì •í™•í•œ ë§¤ì¹­ ë°œê²¬! (5ì´ˆ ì´ë‚´)', 'success');
                            break;
                        }
                    }
                }
                
                testResults.matching = {
                    targetTime,
                    validTimeCount,
                    closestRow,
                    rowIndex,
                    matchedTime,
                    minDiff,
                    success: closestRow !== null
                };
                
                log(`ğŸ“Š ë§¤ì¹­ ìš”ì•½: ìœ íš¨í•œ ì‹œê°„ ${validTimeCount}ê°œ, ìµœì†Œ ì°¨ì´ ${minDiff === Infinity ? 'ë¬´í•œ' : minDiff + 'ì´ˆ'}`, 'info');
                
                if (closestRow) {
                    updateStepStatus(4, 'success');
                    
                    const accuracy = minDiff <= 5 ? 'ì •í™• (5ì´ˆ ì´ë‚´)' : minDiff <= 30 ? 'ê·¼ì‚¬ (30ì´ˆ ì´ë‚´)' : 'ëŒ€ëµì  (30ì´ˆ ì´ˆê³¼)';
                    log(`âœ… ë§¤ì¹­ ì„±ê³µ: í–‰ ${rowIndex}, ì‹œê°„ ${matchedTime.formatted}, ì •í™•ë„ ${accuracy}`, 'success');
                    
                    document.getElementById('match-result').innerHTML = `
                        <div style="color: #10b981;">âœ… ë§¤ì¹­ ì„±ê³µ!</div>
                        <div style="margin-top: 8px;">
                            <div>ğŸ“ ìœ„ì¹˜: í–‰ ${rowIndex}</div>
                            <div>ğŸ¯ íƒ€ê²Ÿ ì‹œê°„: ${targetTime.formatted}</div>
                            <div>ğŸ• ë§¤ì¹­ëœ ì‹œê°„: ${matchedTime.formatted}</div>
                            <div>â° ì‹œê°„ ì°¨ì´: ${minDiff}ì´ˆ</div>
                            <div>ğŸ“Š ì •í™•ë„: ${accuracy}</div>
                            <div style="margin-top: 8px; color: #64748b;">ì „ì²´ í–‰ ë°ì´í„°:</div>
                            <div>Aì—´: "${closestRow[0] || ''}"</div>
                            <div>Bì—´: "${closestRow[1] || ''}"</div>
                            <div>Cì—´: "${closestRow[2] || ''}"</div>
                            <div>Dì—´: "${closestRow[3] || ''}"</div>
                        </div>
                    `;
                } else {
                    updateStepStatus(4, 'error');
                    log('âŒ ë§¤ì¹­í•  ìˆ˜ ìˆëŠ” ì‹œê°„ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
                    
                    document.getElementById('match-result').innerHTML = `
                        <div style="color: #ef4444;">âŒ ë§¤ì¹­ ì‹¤íŒ¨</div>
                        <div style="margin-top: 8px;">
                            <div>ğŸ¯ íƒ€ê²Ÿ ì‹œê°„: ${targetTime.formatted}</div>
                            <div>ğŸ“Š ìœ íš¨í•œ ì‹œê°„ ë°ì´í„°: ${validTimeCount}ê°œ</div>
                            <div style="color: #f59e0b; margin-top: 8px;">ê°€ëŠ¥í•œ ì›ì¸:</div>
                            <div style="margin-left: 16px;">
                                <div>â€¢ Cì—´ì— ì˜¬ë°”ë¥¸ ì‹œê°„ í˜•ì‹ ë°ì´í„° ì—†ìŒ</div>
                                <div>â€¢ íƒ€ê²Ÿ ì‹œê°„ê³¼ ìœ ì‚¬í•œ ì‹œê°„ëŒ€ ë°ì´í„° ë¶€ì¡±</div>
                            </div>
                        </div>
                    `;
                }
                
                // 5ë‹¨ê³„: ê²°ê³¼ ê²€ì¦
                updateStepStatus(5, 'running');
                updateProgress(5);
                log('ğŸ” 5ë‹¨ê³„: ê²°ê³¼ ê²€ì¦ ì‹œì‘', 'info');
                
                generateDiagnosis();
                
                updateStepStatus(5, 'success');
                log('âœ… === í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'success');
                
            } catch (error) {
                log(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                generateDiagnosis();
            }
        }

        // ìˆ˜ë™ CSV í…ŒìŠ¤íŠ¸
        async function manualCSVTest() {
            const csvData = prompt(`CORS ë¬¸ì œë¡œ ìë™ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
ìˆ˜ë™ìœ¼ë¡œ CSV ë°ì´í„°ë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

ë‹¤ìŒ ë‹¨ê³„:
1. Google Sheets CSV URLì„ ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
2. ì „ì²´ CSV ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°

CSV ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, 
`Blinds,Cyprus,Seoul,#
100/200,13:30:25,14:30:25,1
150/300,13:35:45,14:35:45,2
200/400,13:40:15,14:40:15,3`);

            if (!csvData) {
                log('âŒ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì·¨ì†Œë¨', 'warning');
                return;
            }

            log('ğŸ“‹ === ìˆ˜ë™ CSV í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            
            // ì§„í–‰ë„ ì´ˆê¸°í™”
            updateProgress(2); // ì²˜ìŒ 2ë‹¨ê³„ ìŠ¤í‚µ
            updateStepStatus(1, 'success');
            updateStepStatus(2, 'success');
            
            testResults = {
                csvText: csvData,
                urlValidation: { valid: true, type: 'manual', message: 'ìˆ˜ë™ ì…ë ¥' },
                httpResponse: { status: 200, statusText: 'OK (Manual)', ok: true }
            };

            document.getElementById('csv-preview').innerHTML = `
                <div style="color: #10b981;">âœ… ìˆ˜ë™ ì…ë ¥ ë°ì´í„°</div>
                <pre style="white-space: pre-wrap; margin-top: 4px; color: #e2e8f0;">${csvData}</pre>
            `;

            try {
                // 3ë‹¨ê³„: ë°ì´í„° íŒŒì‹±
                updateStepStatus(3, 'running');
                updateProgress(3);
                
                const rows = parseCSV(csvData);
                testResults.parsedRows = rows;
                log(`ğŸ“‹ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}`, 'success');
                updateStepStatus(3, 'success');

                // 4ë‹¨ê³„: ì‹œê°„ ë§¤ì¹­
                updateStepStatus(4, 'running');
                updateProgress(4);
                
                const targetTimeStr = document.getElementById('target-time').value;
                const targetTime = parseTimeString(targetTimeStr);
                
                if (!targetTime) {
                    throw new Error(`íƒ€ê²Ÿ ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: ${targetTimeStr}`);
                }

                log(`ğŸ¯ íƒ€ê²Ÿ ì‹œê°„: ${targetTime.formatted}`, 'info');

                let closestRow = null;
                let minDiff = Infinity;
                let rowIndex = -1;
                let matchedTime = null;
                let validTimeCount = 0;

                for (let i = 0; i < rows.length; i++) {
                    const cellValue = rows[i][2]; // Cì—´
                    if (!cellValue || !cellValue.trim()) continue;

                    const cellTime = parseTimeString(cellValue);
                    if (!cellTime) continue;

                    validTimeCount++;
                    const diff = Math.abs(cellTime.totalSeconds - targetTime.totalSeconds);

                    if (diff < minDiff) {
                        minDiff = diff;
                        closestRow = rows[i];
                        rowIndex = i + 1;
                        matchedTime = cellTime;

                        if (diff <= 5) break;
                    }
                }

                if (closestRow) {
                    updateStepStatus(4, 'success');
                    const accuracy = minDiff <= 5 ? 'ì •í™•' : minDiff <= 30 ? 'ê·¼ì‚¬' : 'ëŒ€ëµì ';
                    log(`âœ… ë§¤ì¹­ ì„±ê³µ: í–‰ ${rowIndex}, ì‹œê°„ ${matchedTime.formatted}, ì •í™•ë„ ${accuracy}`, 'success');
                    
                    document.getElementById('match-result').innerHTML = `
                        <div style="color: #10b981;">âœ… ë§¤ì¹­ ì„±ê³µ!</div>
                        <div style="margin-top: 8px;">
                            <div>ğŸ“ ìœ„ì¹˜: í–‰ ${rowIndex}</div>
                            <div>ğŸ¯ íƒ€ê²Ÿ ì‹œê°„: ${targetTime.formatted}</div>
                            <div>ğŸ• ë§¤ì¹­ëœ ì‹œê°„: ${matchedTime.formatted}</div>
                            <div>â° ì‹œê°„ ì°¨ì´: ${minDiff}ì´ˆ</div>
                            <div>ğŸ“Š ì •í™•ë„: ${accuracy}</div>
                        </div>
                    `;
                } else {
                    updateStepStatus(4, 'error');
                    log('âŒ ë§¤ì¹­ ì‹¤íŒ¨', 'error');
                }

                // 5ë‹¨ê³„ ì™„ë£Œ
                updateStepStatus(5, 'success');
                updateProgress(5);
                log('âœ… === ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'success');

            } catch (error) {
                log(`âŒ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë¬¸ì œ ì§„ë‹¨ ìƒì„±
        function generateDiagnosis() {
            let html = '<div style="color: #3b82f6; font-weight: bold;">ğŸ” ìë™ ì§„ë‹¨ ê²°ê³¼</div><div style="margin-top: 12px;">';
            
            if (testResults.urlValidation) {
                const url = testResults.urlValidation;
                html += `<div><span style="color: #f59e0b;">URL ê²€ì¦:</span> ${url.message}</div>`;
            }
            
            if (testResults.httpResponse) {
                const http = testResults.httpResponse;
                html += `<div><span style="color: #f59e0b;">HTTP ì‘ë‹µ:</span> ${http.status} ${http.statusText}</div>`;
            }
            
            if (testResults.matching) {
                const m = testResults.matching;
                html += `<div><span style="color: #f59e0b;">ì‹œê°„ ë§¤ì¹­:</span> ìœ íš¨í•œ ì‹œê°„ ${m.validTimeCount}ê°œ ${m.success ? 'âœ…' : 'âŒ'}</div>`;
            }
            
            html += '</div>';
            document.getElementById('diagnosis-result').innerHTML = html;
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLogs() {
            document.getElementById('log-output').innerHTML = '<div class="text-gray-400">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
            document.getElementById('csv-preview').innerHTML = '<div class="text-gray-400">CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
            document.getElementById('match-result').innerHTML = '<div class="text-gray-400">ë§¤ì¹­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
            document.getElementById('diagnosis-result').innerHTML = '<div class="text-gray-400">í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë¬¸ì œ ì§„ë‹¨ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
            
            updateProgress(0);
            for (let i = 1; i <= totalSteps; i++) {
                updateStepStatus(i, 'pending');
            }
        }

        // DOM ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            // URL ì‹¤ì‹œê°„ ê²€ì¦
            document.getElementById('sheets-url').addEventListener('input', function(e) {
                const url = e.target.value;
                const feedback = document.getElementById('url-feedback');
                
                if (!url) {
                    e.target.className = 'url-input';
                    feedback.textContent = '';
                    return;
                }
                
                const validation = validateGoogleSheetsUrl(url);
                let cssClass = 'url-input';
                
                if (validation.valid) {
                    cssClass += validation.warning ? ' url-warning' : ' url-valid';
                } else {
                    cssClass += ' url-error';
                }
                
                e.target.className = cssClass;
                feedback.textContent = validation.message;
            });

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('start-test').addEventListener('click', runTest);
            document.getElementById('manual-csv-test').addEventListener('click', manualCSVTest);
            document.getElementById('clear-logs').addEventListener('click', clearLogs);
        });
    </script>
</body>
</html>