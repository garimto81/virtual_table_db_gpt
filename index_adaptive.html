<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Table DB - Adaptive Polling Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #10b981; animation: pulse 2s infinite; }
        .status-normal { background-color: #3b82f6; }
        .status-idle { background-color: #6b7280; }
        .status-background { background-color: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .activity-bar {
            height: 4px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .data-table {
            font-size: 12px;
        }

        .row-added {
            background-color: rgba(16, 185, 129, 0.2);
            animation: highlight 1s ease-out;
        }

        .row-modified {
            background-color: rgba(59, 130, 246, 0.2);
            animation: highlight 1s ease-out;
        }

        .row-deleted {
            background-color: rgba(239, 68, 68, 0.2);
            animation: slideOut 0.5s ease-out;
        }

        @keyframes highlight {
            0% { background-color: rgba(255, 255, 255, 0.3); }
            100% { background-color: transparent; }
        }

        @keyframes slideOut {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(-100%); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- í—¤ë” -->
    <div class="border-b border-gray-700 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Virtual Table DB</h1>
                <p class="text-gray-400">Adaptive Polling Mode v10.4.0</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="connection-status" class="flex items-center">
                    <span class="status-indicator status-normal"></span>
                    <span class="text-sm">ì—°ê²°ë¨</span>
                </div>
                <div id="polling-status" class="flex items-center">
                    <span id="polling-indicator" class="status-indicator status-normal"></span>
                    <span id="polling-text" class="text-sm">ì¼ë°˜ ëª¨ë“œ</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- ì œì–´ íŒ¨ë„ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- í´ë§ ì œì–´ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“Š í´ë§ ì œì–´</h3>
                <div class="space-y-4">
                    <button id="start-adaptive" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                        ì ì‘í˜• í´ë§ ì‹œì‘
                    </button>
                    <button id="stop-polling" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                        í´ë§ ì¤‘ì§€
                    </button>
                    <div class="border-t border-gray-600 pt-4">
                        <label class="block text-sm text-gray-400 mb-2">ëª¨ë“œ ì „í™˜</label>
                        <select id="polling-mode" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="adaptive">ì ì‘í˜• (ìŠ¤ë§ˆíŠ¸)</option>
                            <option value="incremental">ì¦ë¶„ (ê³ ì • 10ì´ˆ)</option>
                            <option value="checksum">ì²´í¬ì„¬ (ê³ ì • 10ì´ˆ)</option>
                            <option value="legacy">ë ˆê±°ì‹œ (ê³ ì • 10ì´ˆ)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì í™œë™ ëª¨ë‹ˆí„° -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ‘¤ ì‚¬ìš©ì í™œë™</h3>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>í™œë™ ìˆ˜ì¤€</span>
                            <span id="activity-score">0</span>
                        </div>
                        <div class="bg-gray-700 rounded-full h-2">
                            <div id="activity-bar" class="activity-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 space-y-1">
                        <div>ë§ˆì§€ë§‰ í™œë™: <span id="last-activity">-</span></div>
                        <div>ë§ˆì§€ë§‰ í¸ì§‘: <span id="last-editing">-</span></div>
                        <div>í˜„ì¬ ìƒíƒœ: <span id="current-activity">ì¼ë°˜</span></div>
                    </div>
                </div>
            </div>

            <!-- í´ë§ í†µê³„ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ í´ë§ í†µê³„</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">í˜„ì¬ ê°„ê²©:</span>
                        <span id="current-interval">10ì´ˆ</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">ì´ í´ë§:</span>
                        <span id="total-polls">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">ì ˆì•½ëœ í´ë§:</span>
                        <span id="saved-polls" class="text-green-400">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">íš¨ìœ¨ì„±:</span>
                        <span id="efficiency" class="text-blue-400">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ -->
        <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">API í˜¸ì¶œ/ì‹œê°„</div>
                <div id="api-calls-per-hour" class="text-xl font-bold text-blue-400">0</div>
            </div>
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">ë°ì´í„° ì „ì†¡ëŸ‰</div>
                <div id="data-transferred" class="text-xl font-bold text-purple-400">0KB</div>
            </div>
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">í‰ê·  ì‘ë‹µì‹œê°„</div>
                <div id="avg-response-time" class="text-xl font-bold text-yellow-400">0ms</div>
            </div>
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">ë°°í„°ë¦¬ ì ˆì•½</div>
                <div id="battery-savings" class="text-xl font-bold text-green-400">0%</div>
            </div>
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">ìƒíƒœ ë³€ê²½</div>
                <div id="state-changes" class="text-xl font-bold text-orange-400">0</div>
            </div>
            <div class="metric-card bg-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-1">ìš´ì˜ì‹œê°„</div>
                <div id="uptime" class="text-xl font-bold text-cyan-400">0s</div>
            </div>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="bg-gray-800 rounded-lg overflow-hidden">
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">ğŸ—‚ï¸ ë°ì´í„° í…Œì´ë¸”</h3>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-400">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update">-</span></span>
                        <div id="delta-indicator" class="text-xs px-2 py-1 rounded bg-gray-700">
                            ëŒ€ê¸° ì¤‘
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full data-table">
                    <thead>
                        <tr class="bg-gray-700 border-b border-gray-600">
                            <th class="p-2 text-left">#</th>
                            <th class="p-2 text-left">A</th>
                            <th class="p-2 text-left">B</th>
                            <th class="p-2 text-left">C</th>
                            <th class="p-2 text-left">D</th>
                            <th class="p-2 text-left">E</th>
                            <th class="p-2 text-left">F</th>
                            <th class="p-2 text-left">G</th>
                            <th class="p-2 text-left">H</th>
                            <th class="p-2 text-left">I</th>
                            <th class="p-2 text-left">J</th>
                        </tr>
                    </thead>
                    <tbody id="data-tbody">
                        <tr>
                            <td colspan="11" class="p-8 text-center text-gray-400">
                                ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- í™œë™ ë¡œê·¸ (ë””ë²„ê¹…ìš©) -->
    <div class="fixed bottom-4 right-4 w-80 bg-gray-800 rounded-lg p-4 max-h-60 overflow-y-auto text-xs" id="activity-log" style="display: none;">
        <div class="flex justify-between items-center mb-2">
            <span class="font-semibold">í™œë™ ë¡œê·¸</span>
            <button id="toggle-log" class="text-gray-400 hover:text-white">âœ–</button>
        </div>
        <div id="log-content" class="space-y-1"></div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="performance_monitor.js"></script>
    <script src="incremental_manager.js"></script>
    <script src="adaptive_polling_manager.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let performanceMonitor;
        let incrementalManager;
        let adaptivePollingManager;
        let currentMode = 'adaptive';

        // Apps Script URL (ì‹¤ì œ URLë¡œ êµì²´ í•„ìš”)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Adaptive Polling Mode ì´ˆê¸°í™” ì‹œì‘');

            try {
                // ì„±ëŠ¥ ëª¨ë‹ˆí„° ì´ˆê¸°í™”
                performanceMonitor = new PerformanceMonitor();

                // ì¦ë¶„ ì—…ë°ì´íŠ¸ ë§¤ë‹ˆì € ì´ˆê¸°í™”
                incrementalManager = initializeIncrementalManager(APPS_SCRIPT_URL);

                // ì ì‘í˜• í´ë§ ë§¤ë‹ˆì € ì´ˆê¸°í™”
                adaptivePollingManager = initializeAdaptivePolling(incrementalManager);

                // UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupEventListeners();

                // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸ ì‹œì‘
                startMetricsUpdate();

                console.log('âœ… ëª¨ë“  ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // í´ë§ ì œì–´ ë²„íŠ¼
            document.getElementById('start-adaptive').addEventListener('click', () => {
                if (adaptivePollingManager) {
                    adaptivePollingManager.startPolling();
                    logActivity('ì ì‘í˜• í´ë§ ì‹œì‘');
                }
            });

            document.getElementById('stop-polling').addEventListener('click', () => {
                if (adaptivePollingManager) {
                    adaptivePollingManager.stopPolling();
                    logActivity('í´ë§ ì¤‘ì§€');
                }
            });

            // ëª¨ë“œ ì „í™˜
            document.getElementById('polling-mode').addEventListener('change', (e) => {
                switchPollingMode(e.target.value);
            });

            // í™œë™ ë¡œê·¸ í† ê¸€
            document.getElementById('toggle-log').addEventListener('click', () => {
                const log = document.getElementById('activity-log');
                log.style.display = 'none';
            });

            // ë””ë²„ê¹…ìš© ë¡œê·¸ í‘œì‹œ (Ctrl+Shift+L)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                    const log = document.getElementById('activity-log');
                    log.style.display = log.style.display === 'none' ? 'block' : 'none';
                }
            });

            // ì ì‘í˜• í´ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            if (adaptivePollingManager) {
                adaptivePollingManager.on('stateChanged', updatePollingStatus);
                adaptivePollingManager.on('intervalChanged', updatePollingInterval);
            }
        }

        // í´ë§ ëª¨ë“œ ì „í™˜
        function switchPollingMode(mode) {
            currentMode = mode;

            // ê¸°ì¡´ í´ë§ ì¤‘ì§€
            if (adaptivePollingManager) {
                adaptivePollingManager.stopPolling();
            }

            switch (mode) {
                case 'adaptive':
                    if (adaptivePollingManager) {
                        adaptivePollingManager.startPolling();
                    }
                    break;

                case 'incremental':
                    // ì¦ë¶„ ëª¨ë“œë¡œ ì „í™˜
                    if (incrementalManager) {
                        startFixedPolling(10000, () => incrementalManager.fetchUpdate());
                    }
                    break;

                case 'checksum':
                    // ì²´í¬ì„¬ ëª¨ë“œë¡œ ì „í™˜ (êµ¬í˜„ í•„ìš”)
                    startFixedPolling(10000, () => console.log('Checksum polling'));
                    break;

                case 'legacy':
                    // ë ˆê±°ì‹œ ëª¨ë“œë¡œ ì „í™˜ (êµ¬í˜„ í•„ìš”)
                    startFixedPolling(10000, () => console.log('Legacy polling'));
                    break;
            }

            logActivity(`ëª¨ë“œ ì „í™˜: ${mode}`);
        }

        // ê³ ì • í´ë§ ì‹œì‘
        function startFixedPolling(interval, pollFunction) {
            if (window.fixedPollingTimer) {
                clearInterval(window.fixedPollingTimer);
            }

            window.fixedPollingTimer = setInterval(pollFunction, interval);
            console.log(`ê³ ì • í´ë§ ì‹œì‘: ${interval}ms`);
        }

        // í´ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePollingStatus(data) {
            const indicator = document.getElementById('polling-indicator');
            const text = document.getElementById('polling-text');

            // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            indicator.className = `status-indicator status-${data.newState}`;

            const stateNames = {
                'active': 'í™œì„± í¸ì§‘',
                'normal': 'ì¼ë°˜ í™œë™',
                'idle': 'ëŒ€ê¸° ìƒíƒœ',
                'background': 'ë°±ê·¸ë¼ìš´ë“œ'
            };

            text.textContent = stateNames[data.newState] || data.newState;

            // ìƒíƒœ ë³€ê²½ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const stateChanges = document.getElementById('state-changes');
            if (adaptivePollingManager) {
                const stats = adaptivePollingManager.getStats();
                stateChanges.textContent = stats.stateChanges;
            }

            logActivity(`ìƒíƒœ ë³€ê²½: ${data.oldState} â†’ ${data.newState}`);
        }

        // í´ë§ ê°„ê²© ì—…ë°ì´íŠ¸
        function updatePollingInterval(data) {
            const currentInterval = document.getElementById('current-interval');
            currentInterval.textContent = `${(data.interval / 1000).toFixed(1)}ì´ˆ`;

            logActivity(`í´ë§ ê°„ê²© ë³€ê²½: ${data.interval}ms`);
        }

        // ì‚¬ìš©ì í™œë™ ì—…ë°ì´íŠ¸
        function updateUserActivity() {
            if (!adaptivePollingManager) return;

            const tracker = adaptivePollingManager.activityTracker;
            if (!tracker) return;

            const activity = tracker.getActivityLevel();

            // í™œë™ ì ìˆ˜ ë° ë°” ì—…ë°ì´íŠ¸
            document.getElementById('activity-score').textContent = activity.score;
            document.getElementById('activity-bar').style.width = Math.min(parseFloat(activity.score), 100) + '%';

            // ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('last-activity').textContent = formatDuration(activity.lastActivity);
            document.getElementById('last-editing').textContent = formatDuration(activity.lastEditing);
            document.getElementById('current-activity').textContent = tracker.getCurrentState();
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        function updateMetrics() {
            if (performanceMonitor) {
                const metrics = performanceMonitor.getMetrics();

                document.getElementById('api-calls-per-hour').textContent =
                    Math.round((metrics.totalRequests / metrics.uptime) * 3600);

                document.getElementById('data-transferred').textContent =
                    formatBytes(metrics.totalDataTransferred);

                document.getElementById('avg-response-time').textContent =
                    metrics.averageResponseTime.toFixed(0) + 'ms';

                document.getElementById('uptime').textContent =
                    formatDuration(metrics.uptime * 1000);
            }

            if (adaptivePollingManager) {
                const stats = adaptivePollingManager.getStats();

                document.getElementById('total-polls').textContent = stats.totalPolls;
                document.getElementById('saved-polls').textContent = stats.savedPolls;
                document.getElementById('efficiency').textContent = stats.efficiency;

                // ë°°í„°ë¦¬ ì ˆì•½ ê³„ì‚° (ê°„ê²©ì´ ê¸¸ìˆ˜ë¡ ì ˆì•½)
                const baseInterval = 10000; // ê¸°ë³¸ 10ì´ˆ
                const currentInterval = adaptivePollingManager.currentInterval;
                const savings = Math.max(0, ((currentInterval - baseInterval) / currentInterval) * 100);
                document.getElementById('battery-savings').textContent = savings.toFixed(1) + '%';
            }

            // ì‚¬ìš©ì í™œë™ ì—…ë°ì´íŠ¸
            updateUserActivity();
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸ ì‹œì‘
        function startMetricsUpdate() {
            setInterval(updateMetrics, 1000);
        }

        // í™œë™ ë¡œê·¸
        function logActivity(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = 'text-gray-300';
            logEntry.textContent = `${timestamp}: ${message}`;

            logContent.appendChild(logEntry);

            // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
            while (logContent.children.length > 50) {
                logContent.removeChild(logContent.firstChild);
            }

            logContent.scrollTop = logContent.scrollHeight;
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatDuration(ms) {
            if (ms < 1000) return ms + 'ms';
            if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
            if (ms < 3600000) return (ms / 60000).toFixed(1) + 'm';
            return (ms / 3600000).toFixed(1) + 'h';
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }

        // ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        window.updatePollingStatus = updatePollingStatus;
        window.logActivity = logActivity;
    </script>
</body>
</html>