<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ v10.2.0 - Checksum Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="performance_monitor.js"></script>
  <script src="checksum_manager.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .metric-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <div class="bg-slate-900/95 border-b border-slate-700 p-4 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold">í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§</h1>
        <span class="text-xs text-gray-500">v10.2.0 Checksum</span>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="toggleChecksumMode()" id="checksum-toggle" class="px-3 py-1 bg-green-600 text-white rounded text-sm">
          âœ… Checksum ON
        </button>
        <button onclick="showStats()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
          ğŸ“Š í†µê³„
        </button>
        <button onclick="forceRefresh()" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="max-w-7xl mx-auto p-6">
    <!-- ìƒíƒœ ëŒ€ì‹œë³´ë“œ -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">API í˜¸ì¶œ ê°ì†Œìœ¨</div>
        <div id="api-reduction" class="text-2xl font-bold text-green-400">0%</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">ìºì‹œ íˆíŠ¸ìœ¨</div>
        <div id="cache-hit-rate" class="text-2xl font-bold text-blue-400">0%</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">Checksum í˜¸ì¶œ</div>
        <div id="checksum-calls" class="text-2xl font-bold">0</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-gray-400 mb-1">ë°ì´í„° í˜¸ì¶œ</div>
        <div id="data-calls" class="text-2xl font-bold">0</div>
      </div>
    </div>

    <!-- ë°ì´í„° í…Œì´ë¸” -->
    <div class="metric-card">
      <h2 class="text-lg font-bold mb-4">ì‹œíŠ¸ ë°ì´í„°</h2>
      <div id="data-container" class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-700">
              <th class="text-left p-2">í–‰</th>
              <th class="text-left p-2">Aì—´</th>
              <th class="text-left p-2">Bì—´</th>
              <th class="text-left p-2">Cì—´</th>
              <th class="text-left p-2">Dì—´</th>
              <th class="text-left p-2">Eì—´ (ìƒíƒœ)</th>
              <th class="text-left p-2">Checksum</th>
            </tr>
          </thead>
          <tbody id="data-tbody">
            <tr>
              <td colspan="7" class="text-center p-4 text-gray-500">ë°ì´í„° ë¡œë”© ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="metric-card mt-6">
      <h2 class="text-lg font-bold mb-4">ì‹¤ì‹œê°„ ë¡œê·¸</h2>
      <div id="log-container" class="h-48 overflow-y-auto bg-black/30 rounded p-3 font-mono text-xs">
        <div class="text-green-400">[ì‹œìŠ¤í…œ] Checksum ëª¨ë“œ ì¤€ë¹„ ì™„ë£Œ</div>
      </div>
    </div>
  </div>

  <!-- í†µê³„ ëª¨ë‹¬ -->
  <div id="stats-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-bold mb-4">ğŸ“Š ì„±ëŠ¥ í†µê³„</h3>
      <div id="stats-content" class="space-y-2 text-sm">
        <!-- ë™ì  ìƒì„± -->
      </div>
      <button onclick="closeStats()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded w-full">
        ë‹«ê¸°
      </button>
    </div>
  </div>

  <script>
    // Google Apps Script URL (ì‹¤ì œ URLë¡œ êµì²´ í•„ìš”)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

    // Checksum Manager ì¸ìŠ¤í„´ìŠ¤
    let checksumManager = null;
    let checksumEnabled = true;
    let legacyInterval = null;

    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const timestamp = new Date().toLocaleTimeString('ko-KR');

      let prefix = '[ì •ë³´]';
      let colorClass = 'text-gray-300';

      if (type === 'success') {
        prefix = '[ì„±ê³µ]';
        colorClass = 'text-green-400';
      } else if (type === 'error') {
        prefix = '[ì˜¤ë¥˜]';
        colorClass = 'text-red-400';
      } else if (type === 'warning') {
        prefix = '[ê²½ê³ ]';
        colorClass = 'text-yellow-400';
      }

      const entry = document.createElement('div');
      entry.className = colorClass;
      entry.textContent = `${timestamp} ${prefix} ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // UI ì—…ë°ì´íŠ¸
    function updateUI(data) {
      const tbody = document.getElementById('data-tbody');

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
      }

      // ìµœëŒ€ 10ê°œ í–‰ë§Œ í‘œì‹œ
      const displayData = data.slice(0, 10);

      tbody.innerHTML = displayData.map((row, index) => `
        <tr class="border-b border-gray-700/50 hover:bg-gray-800/30">
          <td class="p-2">${index + 1}</td>
          <td class="p-2">${row[0] || '-'}</td>
          <td class="p-2">${row[1] || '-'}</td>
          <td class="p-2">${row[2] || '-'}</td>
          <td class="p-2">${row[3] || '-'}</td>
          <td class="p-2">
            <span class="px-2 py-1 rounded text-xs ${
              row[4] === 'ì™„ë£Œ' ? 'bg-green-600' : 'bg-gray-600'
            }">
              ${row[4] || 'ëŒ€ê¸°'}
            </span>
          </td>
          <td class="p-2 text-xs text-gray-500">${
            checksumManager ? checksumManager.getChecksum()?.substring(0, 8) + '...' : '-'
          }</td>
        </tr>
      `).join('');

      addLog(`UI ì—…ë°ì´íŠ¸: ${displayData.length}ê°œ í–‰ í‘œì‹œ`, 'success');
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      if (!checksumManager) return;

      const stats = checksumManager.getStats();

      document.getElementById('api-reduction').textContent = stats.apiReduction || '0%';
      document.getElementById('cache-hit-rate').textContent = stats.cacheHitRate || '0%';
      document.getElementById('checksum-calls').textContent = stats.checksumCalls || '0';
      document.getElementById('data-calls').textContent = stats.dataCalls || '0';
    }

    // Checksum ëª¨ë“œ ì´ˆê¸°í™”
    async function initializeChecksumMode() {
      addLog('Checksum Manager ì´ˆê¸°í™” ì‹œì‘', 'warning');

      try {
        // ChecksumManager ìƒì„±
        checksumManager = new ChecksumManager(APPS_SCRIPT_URL);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        checksumManager.on('dataChanged', (event) => {
          addLog(`ë°ì´í„° ë³€ê²½ ê°ì§€: ${event.timestamp}`, 'success');
          updateUI(event.data);
          updateStats();
        });

        checksumManager.on('checksumChecked', (event) => {
          addLog(`Checksum í™•ì¸: ${event.responseTime.toFixed(0)}ms`, 'info');
          updateStats();
        });

        checksumManager.on('error', (error) => {
          addLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
        });

        // í´ë§ ì‹œì‘ (10ì´ˆ ê°„ê²©)
        checksumManager.startPolling(10000);

        addLog('Checksum ëª¨ë“œ í™œì„±í™” ì™„ë£Œ', 'success');

        // ì „ì—­ ë“±ë¡
        window.checksumManager = checksumManager;
        window.updateUI = updateUI;

      } catch (error) {
        addLog(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // ë ˆê±°ì‹œ ëª¨ë“œ (ê¸°ì¡´ 10ì´ˆ í´ë§)
    function initializeLegacyMode() {
      addLog('ë ˆê±°ì‹œ ëª¨ë“œ ì‹œì‘ (10ì´ˆ í´ë§)', 'warning');

      const fetchData = async () => {
        try {
          const response = await fetch(APPS_SCRIPT_URL);
          const data = await response.json();

          if (data && data.data) {
            updateUI(data.data);
            addLog('ë ˆê±°ì‹œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ', 'success');
          }
        } catch (error) {
          addLog(`ë ˆê±°ì‹œ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
      };

      // ì¦‰ì‹œ ì‹¤í–‰
      fetchData();

      // 10ì´ˆë§ˆë‹¤ ë°˜ë³µ
      legacyInterval = setInterval(fetchData, 10000);
    }

    // Checksum ëª¨ë“œ í† ê¸€
    function toggleChecksumMode() {
      checksumEnabled = !checksumEnabled;
      const button = document.getElementById('checksum-toggle');

      if (checksumEnabled) {
        // Checksum ëª¨ë“œ í™œì„±í™”
        button.textContent = 'âœ… Checksum ON';
        button.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm';

        if (legacyInterval) {
          clearInterval(legacyInterval);
          legacyInterval = null;
        }

        if (checksumManager) {
          checksumManager.startPolling();
        } else {
          initializeChecksumMode();
        }

        addLog('Checksum ëª¨ë“œ í™œì„±í™”', 'success');

      } else {
        // ë ˆê±°ì‹œ ëª¨ë“œ
        button.textContent = 'âŒ Checksum OFF';
        button.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm';

        if (checksumManager) {
          checksumManager.stopPolling();
        }

        initializeLegacyMode();
        addLog('ë ˆê±°ì‹œ ëª¨ë“œ ì „í™˜', 'warning');
      }
    }

    // ê°•ì œ ìƒˆë¡œê³ ì¹¨
    async function forceRefresh() {
      addLog('ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘', 'warning');

      if (checksumManager) {
        const result = await checksumManager.forceRefresh();
        if (result.updated) {
          addLog('ìƒˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ', 'success');
        } else {
          addLog('ë°ì´í„° ë³€ê²½ ì—†ìŒ', 'info');
        }
      } else {
        addLog('Checksum Managerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'error');
      }
    }

    // í†µê³„ í‘œì‹œ
    function showStats() {
      if (!checksumManager) {
        alert('Checksum Managerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return;
      }

      const stats = checksumManager.getStats();
      const status = checksumManager.getStatus();

      const content = `
        <div class="space-y-3">
          <div class="flex justify-between">
            <span>ì´ API í˜¸ì¶œ:</span>
            <span class="font-bold">${stats.totalCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>Checksum í˜¸ì¶œ:</span>
            <span class="font-bold text-green-400">${stats.checksumCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>ë°ì´í„° í˜¸ì¶œ:</span>
            <span class="font-bold text-blue-400">${stats.dataCalls}</span>
          </div>
          <div class="flex justify-between">
            <span>ìºì‹œ íˆíŠ¸:</span>
            <span class="font-bold text-yellow-400">${stats.cacheHits}</span>
          </div>
          <div class="flex justify-between">
            <span>ìºì‹œ íˆíŠ¸ìœ¨:</span>
            <span class="font-bold">${stats.cacheHitRate}</span>
          </div>
          <div class="flex justify-between">
            <span>API ê°ì†Œìœ¨:</span>
            <span class="font-bold text-green-400">${stats.apiReduction}</span>
          </div>
          <div class="flex justify-between">
            <span>ì‹¤í–‰ ì‹œê°„:</span>
            <span class="font-bold">${stats.runningTime}</span>
          </div>
          <div class="flex justify-between">
            <span>ë¶„ë‹¹ í˜¸ì¶œ:</span>
            <span class="font-bold">${stats.callsPerMinute}</span>
          </div>
          <hr class="border-gray-600">
          <div class="flex justify-between">
            <span>í´ë§ ìƒíƒœ:</span>
            <span class="font-bold ${status.isPolling ? 'text-green-400' : 'text-red-400'}">
              ${status.isPolling ? 'í™œì„±' : 'ë¹„í™œì„±'}
            </span>
          </div>
          <div class="flex justify-between">
            <span>í´ë§ ê°„ê²©:</span>
            <span class="font-bold">${status.pollInterval}ms</span>
          </div>
        </div>
      `;

      document.getElementById('stats-content').innerHTML = content;
      document.getElementById('stats-modal').classList.remove('hidden');
    }

    // í†µê³„ ëª¨ë‹¬ ë‹«ê¸°
    function closeStats() {
      document.getElementById('stats-modal').classList.add('hidden');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = () => {
      addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');

      // 5ì´ˆ í›„ ìë™ ì‹œì‘
      setTimeout(() => {
        if (checksumEnabled) {
          initializeChecksumMode();
        } else {
          initializeLegacyMode();
        }
      }, 2000);

      // 30ì´ˆë§ˆë‹¤ í†µê³„ ì—…ë°ì´íŠ¸
      setInterval(updateStats, 30000);
    };
  </script>
</body>
</html>