<!DOCTYPE html>
<!--
  í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - AI ë¶„ì„ ë° ì‹œíŠ¸ ì—°ë™
  Version: 13.3.3
  Last Updated: 2025-09-19
  Description: SSE(Server-Sent Events) ì‹¤ì‹œê°„ ìƒˆ í•¸ë“œ ê°ì§€ ì‹œìŠ¤í…œ êµ¬í˜„
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title id="page-title">í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ v13.3.3 - AI ë¶„ì„ ì‹œìŠ¤í…œ [SSE LIVE]</title>
  <script src="https://cdn.tailwindcss.com?v=9.6.8"></script>
  <!-- Papa Parse for accurate CSV parsing (multiline support) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- ğŸ†• ëª¨ë“ˆí™”ëœ íŒŒì¼ (íŒŒì¼ëª… ê´€ë¦¬ + AI ë¶„ì„) -->
  <script src="src/modules/filename-manager.js"></script>
  <script src="src/modules/ai-analyzer.js"></script>
  <script src="src/modules/filename-adapter.js"></script>
  <!-- ëª¨ë“ˆí™” ì™„ë£Œ: ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ëª¨ë“ˆë¡œ ëŒ€ì²´ë¨ -->

  <!-- ğŸ†• SSE ì‹¤ì‹œê°„ í•¸ë“œ ê°ì§€ í´ë¼ì´ì–¸íŠ¸ -->
  <script src="sse-client.js"></script>

  <!-- ğŸ†• CORS í”„ë¡ì‹œ ëª¨ë“ˆ -->
  <script src="cors-proxy.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .mono {
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* ì»´íŒ©íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card-mini {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 48px;
      background-color: #FFFFFF !important;
      color-scheme: light;
      border: 1px solid #6b7280;
      border-radius: 4px;
      font-weight: 800;
      font-size: 16px;
      margin: 0 1px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      position: relative;
    }
    
    /* ìŠ¤í˜ì´ë“œ, í´ëŸ½ - ì§„í•œ ê²€ì€ìƒ‰ */
    .card-mini.spade, .card-mini.club { 
      color: #000000 !important;
    }
    
    /* í•˜íŠ¸, ë‹¤ì´ì•„ëª¬ë“œ - ì§„í•œ ë¹¨ê°„ìƒ‰ */
    .card-mini.heart, .card-mini.diamond { 
      color: #dc2626 !important;
    }
    
    /* ë³´ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .board-card {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 60px;
      background-color: #FFFFFF !important;
      color-scheme: light;
      border: 2px solid #f59e0b;
      border-radius: 6px;
      font-weight: 900;
      font-size: 20px;
      margin: 0 2px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative;
    }
    
    /* ìŠ¤í˜ì´ë“œ, í´ëŸ½ - ì§„í•œ ê²€ì€ìƒ‰ */
    .board-card.spade, .board-card.club { 
      color: #000000 !important;
    }
    
    /* í•˜íŠ¸, ë‹¤ì´ì•„ëª¬ë“œ - ì§„í•œ ë¹¨ê°„ìƒ‰ */
    .board-card.heart, .board-card.diamond { 
      color: #dc2626 !important;
    }
    
    /* ì•¡ì…˜ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .action-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .action-badge.fold { background: #64748b; color: white; }
    .action-badge.check { background: #0ea5e9; color: white; }
    .action-badge.call { background: #22c55e; color: white; }
    .action-badge.bet { background: #f97316; color: white; }
    .action-badge.raise { background: #ef4444; color: white; }
    .action-badge.allin { background: #fbbf24; color: #000; }
    
    /* í¬ì§€ì…˜ ë°°ì§€ */
    .pos-badge {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .pos-badge.btn { background: #fbbf24; color: #000; }
    .pos-badge.sb { background: #10b981; color: white; }
    .pos-badge.bb { background: #3b82f6; color: white; }
    .pos-badge.utg { background: #8b5cf6; color: white; }
    .pos-badge.mp { background: #ec4899; color: white; }
    .pos-badge.co { background: #f97316; color: white; }
    
    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1e293b;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    
    /* ì»´íŒ©íŠ¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .compact-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      padding: 12px;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    @media (max-width: 1440px) {
      .compact-grid {
        grid-template-columns: 300px 1fr;
      }
    }
    
    /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .section {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
    }
    
    .section-header {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #334155;
    }
    
    /* í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ */
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .player-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid #334155;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .player-item:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
    }
    
    .player-item.folded {
      opacity: 0.5;
    }
    
    /* ì•¡ì…˜ íƒ€ì„ë¼ì¸ ì»´íŒ©íŠ¸ */
    .action-line {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      font-size: 12px;
      border-left: 2px solid transparent;
    }
    
    .action-line.preflop { border-left-color: #8b5cf6; }
    .action-line.flop { border-left-color: #3b82f6; }
    .action-line.turn { border-left-color: #10b981; }
    .action-line.river { border-left-color: #f97316; }
    .action-line.showdown { border-left-color: #fbbf24; }
    
    /* íŒŸ ë””ìŠ¤í”Œë ˆì´ */
    .pot-display {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      border-radius: 6px;
      font-weight: 700;
      font-size: 16px;
    }

    /* í•¸ë“œ ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .status-indicator {
      font-size: 16px;
      transition: all 0.3s ease;
      cursor: help;
    }

    .status-empty {
      color: #94a3b8; /* gray-400 */
    }

    .status-pending {
      color: #fbbf24; /* yellow-400 */
      animation: pulse 2s infinite;
    }

    .status-completed {
      color: #10b981; /* green-500 */
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
  <!-- Force deploy update: 2025-09-22T15:05:30.000Z -->
<body>
  <!-- ì´ˆê¸° ë¡œë“œ ë™ê¸°í™” íŒì—… -->
  <div id="initSyncOverlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]" style="display: none;">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
      <div class="flex items-center gap-3 mb-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <h3 class="text-xl font-bold text-white">Virtual Table DB ì´ˆê¸°í™” ì¤‘</h3>
      </div>

      <div class="space-y-3 mb-4">
        <div class="sync-step flex items-center gap-2" data-step="settings">
          <span class="step-icon text-gray-500">â³</span>
          <span class="step-text text-gray-400">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°...</span>
          <span class="step-time text-xs text-gray-600 ml-auto"></span>
        </div>
        <div class="sync-step flex items-center gap-2" data-step="sheets">
          <span class="step-icon text-gray-500">â³</span>
          <span class="step-text text-gray-400">Google Sheets ì—°ê²°...</span>
          <span class="step-time text-xs text-gray-600 ml-auto"></span>
        </div>
        <div class="sync-step flex items-center gap-2" data-step="data">
          <span class="step-icon text-gray-500">â³</span>
          <span class="step-text text-gray-400">ë°ì´í„° ë™ê¸°í™”...</span>
          <span class="step-time text-xs text-gray-600 ml-auto"></span>
        </div>
        <div class="sync-step flex items-center gap-2" data-step="cache">
          <span class="step-icon text-gray-500">â³</span>
          <span class="step-text text-gray-400">ìºì‹œ êµ¬ì¶•...</span>
          <span class="step-time text-xs text-gray-600 ml-auto"></span>
        </div>
        <div class="sync-step flex items-center gap-2" data-step="complete">
          <span class="step-icon text-gray-500">â³</span>
          <span class="step-text text-gray-400">ì™„ë£Œ ì¤€ë¹„...</span>
          <span class="step-time text-xs text-gray-600 ml-auto"></span>
        </div>
      </div>

      <div class="bg-gray-900 rounded p-3 max-h-32 overflow-y-auto">
        <div id="initSyncLogs" class="text-xs font-mono space-y-1 text-gray-400">
          <!-- ë¡œê·¸ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
        </div>
      </div>

      <div class="mt-4 text-center">
        <p class="text-sm text-gray-400">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        <div class="mt-2 bg-gray-700 rounded-full h-2 overflow-hidden">
          <div id="initProgressBar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- í—¤ë” -->
  <div class="app-header" style="background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #334155; padding: 10px 16px; position: sticky; top: 0; z-index: 100;">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-bold">í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§</h1>
        <span id="version-display" class="text-xs text-gray-500">v13.3.3</span>
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          <span class="text-xs text-gray-400">ì—°ê²°ë¨</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="debug-sheet-btn" class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700" title="ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ë””ë²„ê·¸">
          ğŸ” ë””ë²„ê·¸
        </button>
        <button id="refresh-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
          ìƒˆë¡œê³ ì¹¨
        </button>
        <button id="settings-btn" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
          ì„¤ì •
        </button>
        <button id="perf-btn" onclick="togglePerformanceDashboard()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
          ğŸ“Š ì„±ëŠ¥
        </button>
        <button id="test-btn" onclick="toggleTestPanel()" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
          ğŸ§ª í…ŒìŠ¤íŠ¸
        </button>
      </div>
    </div>
  </div>

  <!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ -->
  <div id="performance-dashboard" style="display: none; background: rgba(30, 41, 59, 0.95); border: 1px solid #334155; border-radius: 8px; padding: 12px; margin: 16px; position: fixed; top: 60px; right: 16px; z-index: 90; min-width: 300px;">
    <!-- ëŒ€ì‹œë³´ë“œ ë‚´ìš©ì€ performance_monitor.jsì—ì„œ ìë™ ìƒì„± -->
  </div>

  <!-- í…ŒìŠ¤íŠ¸ íŒ¨ë„ -->
  <div id="test-panel" style="display: none; background: rgba(30, 41, 59, 0.95); border: 1px solid #334155; border-radius: 8px; padding: 16px; margin: 16px; position: fixed; bottom: 16px; right: 16px; z-index: 90; max-width: 500px; max-height: 300px; overflow-y: auto;">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-bold">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h3>
      <button onclick="runDay1Tests()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Day 1 í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
    </div>
    <div id="test-results" class="text-xs mono" style="color: #94a3b8;">
      <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ -->
    </div>
  </div>

  <!-- Phase 2: ìºì‹œ í†µê³„ íŒ¨ë„ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
  <div id="cache-stats-panel" class="fixed bottom-4 left-4 bg-gray-900 bg-opacity-95 rounded-lg p-3 text-xs max-w-xs z-40 border border-gray-700" style="display: none;">
    <div class="flex items-center justify-between mb-2">
      <span class="font-bold text-yellow-400">ğŸ“Š ì„±ëŠ¥ ìµœì í™” í†µê³„</span>
      <button onclick="toggleCacheStats()" class="text-gray-400 hover:text-white">Ã—</button>
    </div>

    <!-- Phase 2 ìºì‹œ í†µê³„ -->
    <div class="mb-3 pb-2 border-b border-gray-700">
      <div class="text-blue-400 font-bold mb-1">Phase 2: ìºì‹±</div>
      <div class="space-y-1 text-gray-300">
        <div>ìºì‹œ í¬ê¸°: <span id="cache-size" class="text-white">0</span>ê°œ</div>
        <div>ì ì¤‘ë¥ : <span id="cache-hit-rate" class="text-green-400">0</span>%</div>
        <div>ì ì¤‘/ë¯¸ìŠ¤: <span id="cache-hits" class="text-green-400">0</span>/<span id="cache-misses" class="text-red-400">0</span></div>
        <div>TTL: <span id="cache-ttl" class="text-white">300ì´ˆ</span></div>
      </div>
    </div>

    <!-- Phase 3 ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ í†µê³„ -->
    <div class="mb-3 pb-2 border-b border-gray-700">
      <div class="text-green-400 font-bold mb-1">Phase 3: ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨</div>
      <div class="space-y-1 text-gray-300">
        <div>ê°„ê²©: <span id="refresh-interval" class="text-white">30ì´ˆ</span></div>
        <div>ìƒíƒœ: <span id="refresh-status" class="text-yellow-400">í™œì„±</span></div>
        <div>ë§ˆì§€ë§‰: <span id="last-refresh" class="text-white">-</span></div>
      </div>
    </div>

    <!-- Phase 3 ë¡œì»¬ ì €ì¥ì†Œ í†µê³„ -->
    <div class="mb-3">
      <div class="text-purple-400 font-bold mb-1">Phase 3: ë¡œì»¬ ì €ì¥ì†Œ</div>
      <div class="space-y-1 text-gray-300">
        <div>ì‚¬ìš©ëŸ‰: <span id="storage-usage" class="text-white">0 MB</span></div>
        <div>í• ë‹¹ëŸ‰: <span id="storage-quota" class="text-white">0 GB</span></div>
        <div>ì‚¬ìš©ë¥ : <span id="storage-percent" class="text-white">0%</span></div>
      </div>
    </div>

    <!-- ì œì–´ ë²„íŠ¼ -->
    <div class="pt-2 grid grid-cols-2 gap-2">
      <button onclick="refreshCacheManually()"
              class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">ğŸ”„ ìºì‹œ ê°±ì‹ </button>
      <button onclick="clearAllData()"
              class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      <button onclick="toggleSmartRefresh()"
              class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs col-span-2">
              <span id="smart-refresh-toggle">â¸ï¸ ìƒˆë¡œê³ ì¹¨ ì •ì§€</span>
      </button>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="compact-grid">
    
    <!-- ì™¼ìª½: í•¸ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="section overflow-hidden">
      <div class="section-header flex items-center justify-between">
        <span>í•¸ë“œ ëª©ë¡</span>
        <span id="hand-count" class="text-xs">0</span>
      </div>
      <div class="flex gap-2 mb-2">
        <select id="table-filter" class="bg-gray-700 text-xs px-2 py-1 rounded flex-1">
          <option value="">ëª¨ë“  í…Œì´ë¸”</option>
        </select>
        <select id="status-filter" class="bg-gray-700 text-xs px-2 py-1 rounded">
          <option value="">ì „ì²´</option>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="completed">ì™„ë£Œ</option>
        </select>
      </div>
      <div id="hand-list" class="flex-1 overflow-y-auto" style="max-height: calc(100vh - 180px);">
        <!-- í•¸ë“œ ë¦¬ìŠ¤íŠ¸ ë™ì  ìƒì„± -->
      </div>
    </div>

    <!-- ì¤‘ì•™: í•¸ë“œ ìƒì„¸ ì •ë³´ -->
    <div class="section overflow-hidden">
      <!-- í•¸ë“œ í—¤ë” ì •ë³´ -->
      <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-700">
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-3">
            <span class="text-sm font-bold">Hand #<span id="hand-number">-</span></span>
            <span class="text-xs text-gray-400">Table: <span id="table-name">-</span></span>
            <span class="text-xs text-gray-400">Blinds: <span id="blinds">-</span></span>
          </div>
          <div class="text-xs text-blue-300">
            ğŸ“¹ <span id="camera-files">-</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="edit-btn" class="px-2 py-1 bg-yellow-600 text-xs rounded" disabled>í¸ì§‘</button>
          <button id="complete-btn" class="px-2 py-1 bg-green-600 text-xs rounded" disabled>ì™„ë£Œ</button>
        </div>
      </div>


      <!-- íŒŸ ì •ë³´ -->
      <div class="pot-display mb-3">
        POT: <span id="pot-amount">0</span>
      </div>

      <!-- ë³´ë“œ ì¹´ë“œ -->
      <div class="mb-3">
        <div class="section-header">Board</div>
        <div id="board-cards" class="flex justify-center gap-1">
          <!-- ë³´ë“œ ì¹´ë“œ ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- í”Œë ˆì´ì–´ ì¹´ë“œ ì„¹ì…˜ -->
      <div class="mb-3">
        <div class="section-header">Players</div>
        <div id="players-section" class="player-list" style="max-height: 180px; overflow-y: auto;">
          <!-- í”Œë ˆì´ì–´ ì •ë³´ ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- ì•¡ì…˜ íˆìŠ¤í† ë¦¬ -->
      <div class="flex-1">
        <div class="section-header">Actions</div>
        <div id="action-history" style="max-height: calc(100vh - 520px); overflow-y: auto;">
          <!-- ì•¡ì…˜ íˆìŠ¤í† ë¦¬ ë™ì  ìƒì„± -->
        </div>

        <!-- ğŸ“Š Virtual ì‹œíŠ¸ ë“±ë¡ ì •ë³´ (Actions ë°”ë¡œ ë‹¤ìŒ) -->
        <div id="virtual-sheet-info" class="mt-3 p-3 bg-gray-800 rounded-lg border border-gray-600 hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-sm font-bold text-blue-300">ğŸ“‹ Virtual ì‹œíŠ¸ ìƒì„¸ì •ë³´</span>
          <span id="sheet-status-icon" class="text-lg">âšª</span>
        </div>
        <button id="sheet-info-toggle" class="text-xs text-blue-400 hover:text-blue-300" onclick="toggleSheetInfoDetails()">
          ìƒì„¸ë³´ê¸° â–¼
        </button>
      </div>

      <!-- ê¸°ë³¸ Virtual ì‹œíŠ¸ ì •ë³´ -->
      <div id="sheet-basic-info" class="grid grid-cols-2 gap-3 text-xs text-gray-300">
        <div>ğŸ“Š ìƒíƒœ: <span id="sheet-status" class="font-semibold">-</span></div>
        <div>ğŸ“ í–‰ë²ˆí˜¸: <span id="sheet-row-number" class="text-yellow-300">-</span></div>
      </div>

      <!-- íŒŒì¼ ì •ë³´ (ë³„ë„ ì¤„ë¡œ í‘œì‹œ) -->
      <div id="sheet-file-info" class="mt-2 text-xs text-gray-300">
        <div>ğŸ“ Virtual íŒŒì¼ëª…: <span id="sheet-filename" class="text-blue-300 font-mono">-</span></div>
        <div id="camera-file-list" class="mt-1">ğŸ“¹ ì¹´ë©”ë¼ íŒŒì¼: <span id="camera-filenames" class="text-green-300">-</span></div>
      </div>

      <!-- ìƒì„¸ Virtual ì‹œíŠ¸ ì •ë³´ (ì ‘ì´ì‹) -->
      <div id="sheet-detailed-info" class="mt-3 pt-3 border-t border-gray-600 text-xs text-gray-400 hidden">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-gray-300 font-semibold mb-1">ğŸ“ ë“±ë¡ ì •ë³´</div>
            <div>ğŸ”¢ í•¸ë“œë²ˆí˜¸: <span id="sheet-hand-number">-</span></div>
            <div>â° ë“±ë¡ì‹œê°„: <span id="sheet-registered-time">-</span></div>
            <div>ğŸ”„ ìˆ˜ì •ì‹œê°„: <span id="sheet-modified-time">-</span></div>
          </div>
          <div>
            <div class="text-gray-300 font-semibold mb-1">ğŸ” ë§¤ì¹­ ì •ë³´</div>
            <div>ğŸ¯ ë§¤ì¹­ë°©ì‹: <span id="sheet-match-method">-</span></div>
            <div>ğŸ“ ì‹œê°„ì°¨ì´: <span id="sheet-time-diff">-</span></div>
            <div>ğŸ”— CSV í–‰: <span id="sheet-csv-row">-</span></div>
          </div>
        </div>

        <!-- AI ë¶„ì„ ì •ë³´ (Virtual ì‹œíŠ¸ì—ì„œ) -->
        <div id="sheet-ai-info" class="mt-3 p-2 bg-gray-700 rounded text-xs hidden">
          <div class="text-green-300 mb-1">ğŸ¤– Virtual ì‹œíŠ¸ AI ë¶„ì„</div>
          <div id="sheet-ai-content" class="text-gray-300">-</div>
        </div>

        <!-- ì›ë³¸ ë°ì´í„° í™•ì¸ -->
        <div class="mt-3 p-2 bg-gray-700 rounded text-xs">
          <div class="text-orange-300 mb-1">ğŸ” ì›ë³¸ CSV ë°ì´í„°</div>
          <div id="sheet-raw-data" class="font-mono text-gray-400 text-xs break-all">-</div>
        </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ì™„ë£Œ íŒŒì¼ëª… ì…ë ¥ ëª¨ë‹¬ -->
  <div id="completion-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ“ í•¸ë“œ í¸ì§‘ ì™„ë£Œ</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">ìµœì¢… íŒŒì¼ëª…</label>
          <input type="text" id="final-filename" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 placeholder="ì˜ˆ: 2025-09-05_Hand91_Final.mp4">
        </div>
        <div>
          <label class="block text-sm mb-2">í•¸ë“œ ì‹œê°„ (ì‹œ:ë¶„:ì´ˆ)</label>
          <input type="text" id="hand-timestamp" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm mono" 
                 readonly>
        </div>
        <div>
          <label class="block text-sm mb-2">ë§¤ì¹­ëœ Virtual ì‹œíŠ¸ í–‰ (ì‹œê°„ ì •ë³´)</label>
          <input type="text" id="matched-row" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 readonly>
        </div>
        <div>
          <label class="block text-sm mb-2">AI ë¶„ì„ ìš”ì•½ (3ì¤„)</label>
          <textarea id="ai-summary" 
                    class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                    rows="3"
                    placeholder="AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ìš”ì•½í•©ë‹ˆë‹¤..."
                    readonly></textarea>
        </div>
        <div class="text-xs text-gray-400">
          <p>âœ… Virtual ì‹œíŠ¸ì˜ ê°€ì¥ ë¹„ìŠ·í•œ ì‹œê°„ í–‰ì„ ì°¾ì•„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤</p>
          <p>âœ… Fì—´: íŒŒì¼ëª…, Hì—´: AI ìš”ì•½ì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤</p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-completion" class="px-4 py-2 bg-gray-600 rounded text-sm">ì·¨ì†Œ</button>
        <button id="open-sheet-update" class="px-4 py-2 bg-blue-600 rounded text-sm">ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸</button>
        <button id="confirm-completion" class="px-4 py-2 bg-green-600 rounded text-sm">ì™„ë£Œ ì²˜ë¦¬</button>
      </div>
    </div>
  </div>

  <!-- ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ -->
  <div id="sheet-update-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ“Š Virtual ì‹œíŠ¸ ì—…ë°ì´íŠ¸</h2>
      <div class="space-y-4">
        <div class="bg-gray-700 rounded p-3 mb-4">
          <h3 class="text-sm font-bold mb-2">ğŸ¯ ë§¤ì¹­ ì •ë³´</h3>
          <div class="text-sm space-y-1">
            <div>ğŸ“ ë§¤ì¹­ëœ í–‰: <span id="update-matched-row" class="font-mono">-</span></div>
            <div>ğŸ”¢ í•¸ë“œ ë²ˆí˜¸: <span id="update-hand-number" class="font-mono">-</span></div>
            <div>â° ë§¤ì¹­ ì‹œê°„: <span id="update-matched-time" class="font-mono">-</span></div>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2">ğŸ“ Fì—´ - íŒŒì¼ëª…</label>
          <input type="text" id="update-filename" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 placeholder="íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">
          <p class="text-xs text-gray-400 mt-1">
            ğŸ“ ì˜ˆ: "hand_001_river_bluff.mp4"
          </p>
        </div>
        <div>
          <label class="block text-sm mb-2">ğŸ¤– Hì—´ - AI ë¶„ì„ ë‚´ìš©</label>
          <textarea id="update-ai-analysis" 
                    class="w-full bg-gray-700 rounded px-3 py-2 text-sm h-24 resize-none"
                    placeholder="AI ë¶„ì„ ê²°ê³¼ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥..."
                    readonly>ë¶„ì„ ì‹¤íŒ¨</textarea>
          <p class="text-xs text-gray-400 mt-1">
            ğŸ“Š í˜„ì¬ëŠ” "ë¶„ì„ ì‹¤íŒ¨"ë¡œ ê³ ì • (ì¶”í›„ AI ë¶„ì„ ì—°ë™ ì˜ˆì •)
          </p>
        </div>
        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-yellow-400">âš ï¸</span>
            <span class="text-sm font-semibold">ì—…ë°ì´íŠ¸ í™•ì¸</span>
          </div>
          <div class="text-xs text-gray-300 space-y-1">
            <div>â€¢ <strong>ì½ê¸° ì‹œíŠ¸:</strong> Bì—´ ê¸°ì¤€ ì‹œê°„ ë§¤ì¹­</div>
            <div>â€¢ <strong>ì“°ê¸° ì‹œíŠ¸:</strong> Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„) ì—…ë°ì´íŠ¸</div>
            <div>â€¢ <strong>Apps Script:</strong> ìë™ ì—…ë°ì´íŠ¸ ì‹¤í–‰</div>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-sheet-update" class="px-4 py-2 bg-gray-600 rounded text-sm hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="confirm-sheet-update" class="px-4 py-2 bg-blue-600 rounded text-sm hover:bg-blue-700">
          ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        </button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-lg font-bold mb-4">ì„¤ì •</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">ìƒˆë¡œê³ ì¹¨ ê°„ê²©</label>
          <select id="refresh-interval" class="w-full bg-gray-700 rounded px-3 py-2">
            <option value="5000">5ì´ˆ</option>
            <option value="10000" selected>10ì´ˆ</option>
            <option value="30000">30ì´ˆ</option>
            <option value="60000">1ë¶„</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="enable-notifications" checked>
          <label for="enable-notifications" class="text-sm">ìƒˆ í•¸ë“œ ì•Œë¦¼ í™œì„±í™”</label>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="enable-sound" checked>
          <label for="enable-sound" class="text-sm">ì†Œë¦¬ ì•Œë¦¼ í™œì„±í™”</label>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-bold mb-2">ğŸ“Š Apps Script ì‹œíŠ¸ ì—°ë™</h3>
          <div class="mb-2">
            <label class="block text-xs mb-1">ğŸ“‹ ë©”ì¸ ì‹œíŠ¸ URL (í†µí•©)</label>
            <input type="text" id="main-sheet-url" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm border-2 border-gray-600" 
                   placeholder="Google Sheets URL ì…ë ¥..."
                   value="https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/edit?gid=561799849#gid=561799849"
                   title="í†µí•© ì‹œíŠ¸ - Bì—´(ì‹œê°„), Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„)">
            <div id="main-sheet-url-feedback" class="text-xs mt-1 text-gray-400">
              âœ… Bì—´: ì‹œê°„ ë§¤ì¹­ (ì½ê¸°)
              <br>âœ… Fì—´: íŒŒì¼ëª… ì—…ë°ì´íŠ¸ (ì“°ê¸°)
              <br>âœ… Hì—´: AI ë¶„ì„ ì—…ë°ì´íŠ¸ (ì“°ê¸°)
            </div>
          </div>
          <!-- í˜¸í™˜ì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ í•„ë“œ -->
          <input type="hidden" id="read-sheet-url" />
          <input type="hidden" id="write-sheet-url" />
          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ”— Apps Script Web App URL</label>
            <input type="text" id="apps-script-url" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm border-2 border-gray-600" 
                   placeholder="Apps Script ì›¹ì•± URL..."
                   title="ì‹œíŠ¸ ì—…ë°ì´íŠ¸ìš© Apps Script URL">
            <div id="apps-script-url-feedback" class="text-xs mt-1 text-gray-400">
              ğŸ“ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì „ìš© Apps Script
            </div>
          </div>
          <button id="test-apps-script" class="w-full px-4 py-2 bg-green-600 rounded text-sm hover:bg-green-700 transition mb-2">
            ğŸ§ª Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
        
        <!-- AI API ì„¤ì • ì„¹ì…˜ (Gemini ì „ìš©) -->
        <div class="mt-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-bold mb-2">ğŸ¤– AI ë¶„ì„ ì„¤ì •</h3>
          <div class="mb-2">
            <label class="block text-xs mb-1">ğŸ”‘ Gemini API Key</label>
            <input type="password" id="gemini-api-key" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm" 
                   placeholder="AIzaSy...">
            <div class="text-xs mt-1 text-gray-400">
              <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">
                API í‚¤ ë°œê¸‰í•˜ê¸° â†’
              </a>
            </div>
          </div>
          <div class="text-xs text-gray-500 bg-gray-700 rounded p-2">
            ğŸ’¡ <strong>Gemini API ì‚¬ìš©</strong><br>
            â€¢ Googleì˜ ìµœì‹  AI ëª¨ë¸ë¡œ í•¸ë“œ ë¶„ì„ ìˆ˜í–‰<br>
            â€¢ ë¬´ë£Œ í• ë‹¹ëŸ‰: ì›” 100ë§Œ í† í° (ì¶©ë¶„í•œ ì‚¬ìš©ëŸ‰)
          </div>
          <button id="test-gemini-api" class="w-full mt-2 px-3 py-1 bg-blue-600 rounded text-xs hover:bg-blue-700 transition">
            ğŸ§ª API í‚¤ ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
        
        <!-- íŒŒì¼ëª… ì»¤ìŠ¤í„°ë§ˆì´ì§• ì„¤ì • -->
        <div class="mt-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-bold mb-2">ğŸ“ íŒŒì¼ëª… ì»¤ìŠ¤í„°ë§ˆì´ì§•</h3>

          <!-- í…œí”Œë¦¿ ì„¤ì • ì„¹ì…˜ -->
          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ¨ íŒŒì¼ëª… í…œí”Œë¦¿</label>
            <textarea id="filename-template"
                      class="w-full bg-gray-700 rounded px-3 py-2 text-sm font-mono"
                      rows="2"
                      placeholder="{prefix}{handNumber}_{position}_{action}">{prefix}{handNumber}</textarea>
            <div class="text-xs mt-1 text-gray-400">
              ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:
              <br>â€¢ {prefix} - ì ‘ë‘ì‚¬ ì„¤ì •ê°’
              <br>â€¢ {suffix} - ì ‘ë¯¸ì‚¬ ì„¤ì •ê°’
              <br>â€¢ {handNumber} - í•¸ë“œ ë²ˆí˜¸
              <br>â€¢ {date} - í˜„ì¬ ë‚ ì§œ (YYYYMMDD)
              <br>â€¢ {timestamp} - íƒ€ì„ìŠ¤íƒ¬í”„
              <br>â€¢ {position} - í¬ì§€ì…˜ (BTN, SB, BB ë“±)
              <br>â€¢ {action} - ì£¼ìš” ì•¡ì…˜ (3bet, fold, allin ë“±)
              <br>â€¢ {result} - ê²°ê³¼ (win, lose, chop)
              <br>â€¢ {ai_summary} - AI 3ë‹¨ì–´ ìš”ì•½ (AI ì‚¬ìš©ì‹œ)
            </div>
          </div>

          <!-- í…œí”Œë¦¿ í”„ë¦¬ì…‹ -->
          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ“‹ í…œí”Œë¦¿ í”„ë¦¬ì…‹</label>
            <select id="template-preset" class="w-full bg-gray-700 rounded px-3 py-1 text-sm">
              <option value="simple">ê°„ë‹¨ - {prefix}{handNumber}</option>
              <option value="detailed">ìƒì„¸ - {prefix}{handNumber}_{position}_{action}</option>
              <option value="timestamped">ì‹œê°„í¬í•¨ - {prefix}{handNumber}_{date}_{timestamp}</option>
              <option value="ai">AIë¶„ì„ - {prefix}{handNumber}_{ai_summary}</option>
              <option value="custom">ì»¤ìŠ¤í…€</option>
            </select>
          </div>

          <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</label>
            <div id="filename-preview" class="p-2 bg-gray-700 rounded text-xs font-mono text-green-300">
              H142_BTN_3bet
            </div>
          </div>

          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ¤– AI ìš”ì•½ ê¸°ëŠ¥</label>

            <div class="flex items-center gap-2 mb-2">
              <input type="checkbox" id="ai-filename-enable">
              <label for="ai-filename-enable" class="text-sm">íŒŒì¼ëª… AI ìš”ì•½ ì‚¬ìš©</label>
            </div>
            <div class="text-xs mb-2 text-gray-400">
              ì˜ˆ: H143_Santa_AK_Villain_QQ_ë¸”ëŸ¬í”„_ìºì¹˜
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="ai-hcolumn-enable">
              <label for="ai-hcolumn-enable" class="text-sm">Hì—´ AI ë¶„ì„ ì‚¬ìš©</label>
            </div>
            <div class="text-xs mt-1 text-gray-400">
              3ë²ˆì§¸ ì¤„ë§Œ AIë¡œ ì „ëµ ë¶„ì„
            </div>
          </div>

          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ“Œ íŒŒì¼ëª… ì ‘ë‘ì‚¬</label>
            <input type="text" id="filename-prefix"
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm"
                   placeholder="ì˜ˆ: POK_"
                   oninput="updateFilenamePreview()">
          </div>

          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ“Œ íŒŒì¼ëª… ì ‘ë¯¸ì‚¬</label>
            <input type="text" id="filename-suffix"
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm"
                   placeholder="ì˜ˆ: _final"
                   oninput="updateFilenamePreview()">
          </div>

          <button id="preview-filename" class="w-full px-3 py-1 bg-purple-600 rounded text-xs hover:bg-purple-700 transition">
            ğŸ‘ï¸ íŒŒì¼ëª… ë¯¸ë¦¬ë³´ê¸°
          </button>
          <div id="filename-preview" class="mt-2 p-2 bg-gray-700 rounded text-xs font-mono text-green-300 hidden">
            <!-- ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-700">
          <button id="clear-notification-history" class="w-full px-4 py-2 bg-red-600 rounded text-sm hover:bg-red-700 transition">
            ğŸ”„ ë²„í¼ ì´ˆê¸°í™”
          </button>
          <p class="text-xs text-gray-400 mt-2">
            ìµœê·¼ í•¸ë“œ ë²„í¼(ìµœëŒ€ 100ê°œ)ê°€ ì´ˆê¸°í™”ë˜ë©°, ë‹¤ìŒ ë¡œë“œì‹œ ê¸°ì¡´ í•¸ë“œë„ ìƒˆ í•¸ë“œë¡œ ì¸ì‹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-settings" class="px-4 py-2 bg-gray-600 rounded text-sm">ì·¨ì†Œ</button>
        <button id="save-settings" class="px-4 py-2 bg-blue-600 rounded text-sm">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© íŒì—… ëª¨ë‹¬ -->
  <div id="loading-popup" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full">
      <div class="flex items-center space-x-3">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
        <div>
          <h3 id="loading-title" class="text-lg font-semibold">ì‘ì—… ì¤‘...</h3>
          <p id="loading-message" class="text-sm text-gray-400 mt-1">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
        </div>
      </div>
      <div id="loading-progress" class="mt-4 hidden">
        <div class="w-full bg-gray-700 rounded-full h-2">
          <div id="loading-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Virtual ì‹œíŠ¸ ë§¤ì¹­ ì§„í–‰ë¥  ëª¨ë‹¬ -->
  <div id="progress-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ” Virtual ì‹œíŠ¸ ë§¤ì¹­ ì¤‘...</h2>
      <div class="space-y-4">
        <div class="bg-gray-700 rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm">ì§„í–‰ë¥ </span>
            <span id="progress-percentage" class="text-sm font-bold">0%</span>
          </div>
          <div class="w-full bg-gray-600 rounded-full h-2.5">
            <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="text-sm space-y-1">
          <div>ğŸ“ í˜„ì¬ í–‰: <span id="current-row" class="font-mono">-</span></div>
          <div>ğŸ“Š ì´ í–‰ ìˆ˜: <span id="total-rows" class="font-mono">-</span></div>
          <div>â±ï¸ ë‚¨ì€ ì‹œê°„: <span id="remaining-time" class="font-mono">ê³„ì‚° ì¤‘...</span></div>
          <div>ğŸ¯ í˜„ì¬ ìƒíƒœ: <span id="current-status">ì‹œì‘ ì¤‘...</span></div>
        </div>
        
        <div class="text-xs text-gray-400 space-y-1">
          <div>â€¢ Bì—´ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì—¬ ê°€ì¥ ìœ ì‚¬í•œ í–‰ì„ ì°¾ìŠµë‹ˆë‹¤</div>
          <div>â€¢ 30ì´ˆ íƒ€ì„ì•„ì›ƒì´ ì ìš©ë©ë‹ˆë‹¤</div>
        </div>
      </div>
      
      <div class="flex justify-center mt-6">
        <button id="cancel-progress" class="px-4 py-2 bg-red-600 rounded text-sm hover:bg-red-700">ì‘ì—… ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ====================================
    // í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - Gemini AI ë¶„ì„ ì‹œìŠ¤í…œ
    // ====================================

    // ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ ì„¤ì • (false = í”„ë¡œë•ì…˜, true = ê°œë°œ)
    window.DEBUG_MODE = false;  // í”„ë¡œë•ì…˜ì—ì„œëŠ” falseë¡œ ì„¤ì •

    /* ========================================================================
     * ğŸ†• ëª¨ë“ˆí™” ì•Œë¦¼: ì•„ë˜ íŒŒì¼ëª… ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ëª¨ë“ˆë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.
     *
     * ì´ë™ëœ ìœ„ì¹˜:
     * - generateCustomFilename â†’ src/modules/filename-manager.js
     * - extractHandNumberFromFilename â†’ src/modules/filename-manager.js
     * - saveHandFilenameMapping â†’ src/modules/filename-manager.js
     *
     * filename-adapter.jsê°€ ìë™ìœ¼ë¡œ ê¸°ì¡´ í˜¸ì¶œì„ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ë¯€ë¡œ
     * ì½”ë“œ ìˆ˜ì • ì—†ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.
     *
     * [ì´ ì„¹ì…˜ì€ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì‚­ì œ ì˜ˆì •]
     * ======================================================================== */

    /**
     * @deprecated ëª¨ë“ˆí™” ì™„ë£Œ - src/modules/filename-adapter.jsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     * íŒŒì¼ëª… ìƒì„± í•¨ìˆ˜ - í†µí•© ë¶„ì„ ë°ì´í„° í™œìš©
     * í˜•ì‹: ì ‘ë‘ì‚¬(í•¸ë“œë²ˆí˜¸)_í”Œë ˆì´ì–´Aì´ë¦„_í•¸ë“œ_í”Œë ˆì´ì–´Bì´ë¦„_í•¸ë“œ_(3ë‹¨ì–´ ìš”ì•½)
     */
    async function generateCustomFilename(handNumber) {
      console.warn('âš ï¸ [DEPRECATED] generateCustomFilename - ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨');
      try {
        // localStorageì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        const prefix = localStorage.getItem('filenamePrefix') || 'H';
        const suffix = localStorage.getItem('filenameSuffix') || '';

        const useAI = localStorage.getItem('useAIForFilename') === 'true';
        // ğŸ” ê°•í™”ëœ ë””ë²„ê¹…
        console.log(`ğŸ” [generateCustomFilename] í•¨ìˆ˜ í˜¸ì¶œ - í•¸ë“œ #${handNumber}`);
        console.log(`ğŸ” localStorage.useAIForFilename: "${localStorage.getItem('useAIForFilename')}"`);
        console.log(`ğŸ” useAI boolean: ${useAI}`);
        console.log(`ğŸ” CONFIG.GEMINI_API_KEY ì¡´ì¬: ${!!CONFIG.GEMINI_API_KEY}`);
        debugLog(`ğŸ¤– íŒŒì¼ëª… AI ì„¤ì • í™•ì¸: useAI=${useAI}, APIí‚¤=${!!CONFIG.GEMINI_API_KEY}`);

        // í†µí•© ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œë¨)
        const analysis = await getUnifiedHandAnalysis(handNumber);

        // ê¸°ë³¸ íŒŒì¼ëª… êµ¬ì¡°: H{handNumber}
        let filename = `${prefix}${handNumber}`;

        if (analysis) {
          // ëª¨ë“  í”Œë ˆì´ì–´ì™€ í•¸ë“œ ì •ë³´ ì¶”ê°€ (ì „ì²´ í”Œë ˆì´ì–´ í¬í•¨)
          if (analysis.players && analysis.players.length > 0) {
            // ëª¨ë“  í”Œë ˆì´ì–´ ì •ë³´ë¥¼ íŒŒì¼ëª…ì— ì¶”ê°€
            analysis.players.forEach(player => {
              if (player && player.name && player.cards) {
                filename += `_${player.name}_${player.cards}`;
              }
            });
          } else {
            // í”Œë ˆì´ì–´ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ì¡´ hero/villain ë°©ì‹ í´ë°±
            if (analysis.hero) {
              filename += `_${analysis.hero.name}_${analysis.hero.cards}`;
            }
            if (analysis.villain) {
              filename += `_${analysis.villain.name}_${analysis.villain.cards}`;
            }
          }

          // AI ìš”ì•½ ë° í‚¤ì›Œë“œ ë¡œì§ ì œê±° - í”Œë ˆì´ì–´ ì •ë³´ë§Œ ì‚¬ìš©
        }

        // ì ‘ë¯¸ì‚¬ ì¶”ê°€
        filename = filename + suffix;

        // íŒŒì¼ëª…ì—ì„œ íŠ¹ìˆ˜ë¬¸ì ì œê±° (ì•ˆì „í•œ íŒŒì¼ëª…)
        filename = filename.replace(/[^a-zA-Z0-9_-]/g, '_');

        // ğŸ§¹ ì—°ì†ëœ ë°‘ì¤„ê³¼ ë¹ˆ ë°‘ì¤„ ì •ë¦¬
        filename = filename
          .replace(/_+/g, '_')           // ì—°ì† ë°‘ì¤„ì„ í•˜ë‚˜ë¡œ
          .replace(/(_){2,}/g, '_')      // 2ê°œ ì´ìƒ ë°‘ì¤„ì„ 1ê°œë¡œ
          .replace(/_$/g, '')            // ëì˜ ë°‘ì¤„ ì œê±°
          .replace(/^_/g, '');           // ì‹œì‘ì˜ ë°‘ì¤„ ì œê±°

        // ğŸ”— í•¸ë“œë²ˆí˜¸-íŒŒì¼ëª… ë§¤í•‘ ì¦‰ì‹œ ì €ì¥ (ì¤‘ë³µ ì¶”ì¶œ ë°©ì§€)
        saveHandFilenameMapping(handNumber, filename);

        debugLog(`âœ… ì»¤ìŠ¤í…€ íŒŒì¼ëª… ìƒì„± ì™„ë£Œ: ${filename} (ë§¤í•‘ ì €ì¥ë¨)`);
        return filename;
      } catch (error) {
        console.error('íŒŒì¼ëª… ìƒì„± ì˜¤ë¥˜:', error);
        // ê¸°ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ í´ë°±
        const fallbackFilename = `H${handNumber}_${new Date().toISOString().slice(0,10).replace(/-/g, '')}`;
        saveHandFilenameMapping(handNumber, fallbackFilename); // í´ë°± íŒŒì¼ëª…ë„ ë§¤í•‘ ì €ì¥
        return fallbackFilename;
      }
    }

    /**
     * í•¸ë“œ ìƒì„¸ ì •ë³´ì—ì„œ í”Œë ˆì´ì–´ì™€ ì¹´ë“œ ì •ë³´ ì¶”ì¶œ
     */
    async function getHandDetailsForFilename(handNumber) {
      try {
        const hand = allHands.find(h => h.handNumber === handNumber);
        if (!hand) return null;

        // í˜„ì¬ ì„ íƒëœ í•¸ë“œì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        const handPanel = document.getElementById('hand-panel');
        const playersSection = document.getElementById('players-section');

        if (!handPanel || !playersSection) return null;

        // í”Œë ˆì´ì–´ ì •ë³´ ì¶”ì¶œ
        const playerElements = playersSection.querySelectorAll('.player-info');
        const players = [];

        playerElements.forEach(elem => {
          const name = elem.querySelector('.player-name')?.textContent || '';
          const cards = elem.querySelector('.player-cards')?.textContent || '';
          const isSanta = name.toLowerCase().includes('santa') || name.toLowerCase().includes('hero');

          if (name && cards) {
            // ì¹´ë“œ í˜•ì‹ ì •ë¦¬ (ì˜ˆ: Aâ™ Kâ™¦ -> AK)
            const cleanCards = cards.replace(/[â™ â™¥â™¦â™£]/g, '').trim();
            players.push({
              name: name.replace(/[^a-zA-Z0-9]/g, ''),
              cards: cleanCards,
              isSanta: isSanta
            });
          }
        });

        // Heroì™€ Villain êµ¬ë¶„
        const hero = players.find(p => p.isSanta) || players[0];
        const villain = players.find(p => !p.isSanta && p !== hero) || players[1];

        // AI ìš”ì•½ ìƒì„± (3ë‹¨ì–´ ì´ë‚´)
        const summary = await generateHandSummary(handNumber);

        return {
          hero: hero,
          villain: villain,
          summary: summary
        };
      } catch (error) {
        console.error('í•¸ë“œ ìƒì„¸ ì •ë³´ ì¶”ì¶œ ì˜¤ë¥˜:', error);
        return null;
      }
    }

    /**
     * í•¸ë“œ ë¶„ì„ ë°ì´í„° ìºì‹œ (ì¤‘ë³µ ë¡œë“œ ë°©ì§€)
     */
    let handAnalysisCache = new Map();

    /**
     * í†µí•© í•¸ë“œ ë¶„ì„ í•¨ìˆ˜ - Hì—´ê³¼ íŒŒì¼ëª… ìƒì„±ì— ëª¨ë‘ ì‚¬ìš©
     */
    async function getUnifiedHandAnalysis(handNumber) {
      // ìºì‹œ í™•ì¸
      if (handAnalysisCache.has(handNumber)) {
        debugLog(`âœ… í•¸ë“œ #${handNumber} ìºì‹œì—ì„œ ë¡œë“œ`);
        return handAnalysisCache.get(handNumber);
      }

      try {
        debugLog(`ğŸ”„ í•¸ë“œ #${handNumber} ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘`);

        // 1. í•¸ë“œ ë°ì´í„° í•œ ë²ˆë§Œ ë¡œë“œ
        const handData = await loadHandData(handNumber);
        if (!handData) {
          console.warn(`í•¸ë“œ #${handNumber} ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          return null;
        }

        // 2. í”Œë ˆì´ì–´ ì •ë³´ í•œ ë²ˆë§Œ ì¶”ì¶œ
        const players = extractPlayersInfo(handData);

        // 3. íˆì–´ë¡œì™€ ë¹ŒëŸ° ì‹ë³„
        const hero = players.find(p => p.isSanta || p.name.toLowerCase().includes('santa')) || players[0];
        const villain = players.find(p => p !== hero) || players[1];

        // 4. ë¶„ì„ ê²°ê³¼ êµ¬ì¡°í™” (í‚¤ì›Œë“œ ì œê±°)
        const analysis = {
          handData: handData,
          players: players,
          hero: hero,
          villain: villain,
          fullAnalysis: null // AI ë¶„ì„ í…ìŠ¤íŠ¸ (í•„ìš”ì‹œ ìƒì„±)
        };

        // ìºì‹œì— ì €ì¥
        handAnalysisCache.set(handNumber, analysis);
        debugLog(`âœ… í•¸ë“œ #${handNumber} ë¶„ì„ ì™„ë£Œ ë° ìºì‹œ ì €ì¥`);

        return analysis;
      } catch (error) {
        console.error(`í†µí•© í•¸ë“œ ë¶„ì„ ì˜¤ë¥˜ (í•¸ë“œ #${handNumber}):`, error);
        return null;
      }
    }

    /**
     * í”Œë ˆì´ì–´ ì •ë³´ ì¶”ì¶œ í—¬í¼
     */
    function extractPlayersInfo(handData) {
      if (!handData || !handData.players) return [];

      const players = [];

      handData.players.forEach(player => {
        if (player && player.name) {
          const cleanName = player.name.replace(/[^a-zA-Z0-9]/g, '');
          const cleanCards = player.cards ?
            player.cards.map(c => c.replace(/[â™ â™¥â™¦â™£]/g, '')).join('') : '??';
          const isSanta = cleanName.toLowerCase().includes('santa') ||
                          cleanName.toLowerCase().includes('hero');

          players.push({
            name: cleanName,
            cards: cleanCards,
            isSanta: isSanta,
            position: player.position || '',
            chips: player.chips || 0
          });
        }
      });

      return players;
    }

    /**
     * ì•¡ì…˜ í‚¤ì›Œë“œ ì¶”ì¶œ í—¬í¼
     */
    function extractActionKeywords(handData) {
      if (!handData || !handData.actions) return [];

      const keywords = [];
      const actionsText = handData.actions.map(a => a.action).join(' ').toUpperCase();

      // í‚¤ì›Œë“œ ë§¤í•‘ í…Œì´ë¸” (ì¤‘ë³µ ì œê±°)
      const keywordMap = {
        'ALL-IN': 'allin',
        'ALL IN': 'allin',
        'FOLD': 'fold',
        'BLUFF': 'bluff',
        'RAISE': 'raise',
        'CALL': 'call',
        'CHECK': 'check',
        'BET': 'bet',
        'RIVER': 'river',
        'TURN': 'turn',
        'FLOP': 'flop',
        'PREFLOP': 'preflop',
        'SHOWDOWN': 'showdown',
        'WIN': 'win',
        'LOSE': 'lose'
      };

      // ì•¡ì…˜ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
      for (const [pattern, keyword] of Object.entries(keywordMap)) {
        if (actionsText.includes(pattern) && !keywords.includes(keyword)) {
          keywords.push(keyword);
        }
      }

      // ìŠ¤íŠ¸ë¦¬íŠ¸ ì •ë³´ë„ ì¶”ê°€
      if (handData.street) {
        const street = handData.street.toLowerCase();
        if (!keywords.includes(street)) {
          keywords.push(street);
        }
      }

      // ê²°ê³¼ ì •ë³´ë„ ì¶”ê°€
      if (handData.result) {
        const resultText = handData.result.toUpperCase();
        if (resultText.includes('WIN') && !keywords.includes('win')) {
          keywords.push('win');
        } else if (resultText.includes('LOSE') && !keywords.includes('lose')) {
          keywords.push('lose');
        }
      }

      return keywords;
    }

    // ë²„ì „ ì •ë³´ (í•œ ê³³ì—ì„œë§Œ ê´€ë¦¬)
    const APP_VERSION = '13.3.3'; // Google API Key ê´€ë¦¬ ìµœì í™” - localStorage í‚¤ í†µì¼ ë° ì¤‘ë³µ ë¡œì§ ì œê±°
    const BUILD_TIME = '2025-09-22T15:00:00Z';

    // ====================================
    // ìë§‰ ìƒì„± ì‹œìŠ¤í…œ
    // ====================================

    /**
     * Hand ì‹œíŠ¸ì—ì„œ í‚¤ í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ ìë§‰ ìƒì„±
     * @param {number} handNumber - í•¸ë“œ ë²ˆí˜¸
     * @returns {string} ìë§‰ í…ìŠ¤íŠ¸
     */
    async function generateSubtitle(handNumber) {
      try {
        console.log(`ğŸ¬ ìë§‰ ìƒì„± ì‹œì‘: í•¸ë“œ #${handNumber}`);

        // Hand ì‹œíŠ¸ CSV ë°ì´í„° ë¡œë“œ
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        console.log(`ğŸ“¥ Hand ì‹œíŠ¸ ì‘ë‹µ ìƒíƒœ: ${response.status}`);

        const text = await response.text();
        console.log(`ğŸ“ CSV í…ìŠ¤íŠ¸ ê¸¸ì´: ${text.length} ë¬¸ì`);

        const rows = parseCSV(text);
        console.log(`ğŸ“Š íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}`);

        // í•´ë‹¹ í•¸ë“œì˜ í‚¤ í”Œë ˆì´ì–´ ì°¾ê¸°
        let inTargetHand = false;
        let keyPlayer = null;
        let bigBlind = 0;

        console.log(`ğŸ” í•¸ë“œ #${handNumber} ê²€ìƒ‰ ì‹œì‘...`);

        for (const row of rows) {
          // HAND í–‰ìœ¼ë¡œ í•¸ë“œ ì‹œì‘ í™•ì¸
          if (row[1] === 'HAND' && row[2] === handNumber.toString()) {
            inTargetHand = true;
            bigBlind = parseInt(row[5]) || 1000; // Fì—´: ë¹…ë¸”ë¼ì¸ë“œ
            console.log(`ğŸ¯ í•¸ë“œ #${handNumber} ë°œê²¬! ë¹…ë¸”ë¼ì¸ë“œ: ${bigBlind}`);
            continue;
          }

          // ë‹¤ë¥¸ í•¸ë“œ ì‹œì‘ ì‹œ ì¢…ë£Œ
          if (inTargetHand && row[1] === 'HAND' && row[2] !== handNumber.toString()) {
            break;
          }

          // í˜„ì¬ í•¸ë“œì˜ PLAYER í–‰ ì²˜ë¦¬
          if (inTargetHand && row[1] === 'PLAYER') {
            const playerName = row[2];         // Cì—´: í”Œë ˆì´ì–´ ì´ë¦„
            const position = row[4];           // Eì—´: í¬ì§€ì…˜
            const startStack = parseInt(row[5]) || 0;   // Fì—´: ì‹œì‘ ìŠ¤íƒ
            const currentStack = parseInt(row[6]) || 0; // Gì—´: í˜„ì¬ ìŠ¤íƒ
            const cards = row[7];              // Hì—´: ì¹´ë“œ
            const isKeyPlayer = row[9];        // Jì—´: í‚¤ í”Œë ˆì´ì–´ ì—¬ë¶€ (True/False)
            const country = row[10];           // Kì—´: êµ­ê°€

            // í‚¤ í”Œë ˆì´ì–´ í™•ì¸
            if (isKeyPlayer === 'True' || isKeyPlayer === 'TRUE' || isKeyPlayer === 'true') {
              keyPlayer = {
                name: playerName,
                position: position,
                startStack: startStack,
                currentStack: currentStack,
                cards: cards,
                country: country || 'Unknown'
              };
              break; // í‚¤ í”Œë ˆì´ì–´ ì°¾ì•˜ìœ¼ë¯€ë¡œ ì¢…ë£Œ
            }
          }
        }

        // í‚¤ í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
        if (!keyPlayer) {
          console.log(`âš ï¸ í•¸ë“œ #${handNumber}ì—ì„œ í‚¤ í”Œë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          console.log(`ğŸ” ë””ë²„ê·¸: í•´ë‹¹ í•¸ë“œì˜ ëª¨ë“  PLAYER í–‰ì„ í™•ì¸í•˜ì„¸ìš”`);
          return '';
        }

        console.log(`ğŸ¯ í‚¤ í”Œë ˆì´ì–´ ë°œê²¬: ${keyPlayer.name} (${keyPlayer.country})`);
        console.log(`ğŸ’° ìŠ¤íƒ ì •ë³´: ${keyPlayer.currentStack} / BB: ${bigBlind}`);

        // ë¹…ë¸”ë¼ì¸ë“œëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì¶”ì¶œí–ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì¶”ì¶œí•  í•„ìš” ì—†ìŒ
        if (!bigBlind) {
          // í˜¹ì‹œ ë†“ì¹œ ê²½ìš°ë¥¼ ìœ„í•œ ì¬ì¶”ì¶œ
          for (const row of rows) {
            if (row[1] === 'HAND' && row[2] === handNumber.toString()) {
              bigBlind = parseInt(row[5]) || 1000; // Fì—´: ë¹…ë¸”ë¼ì¸ë“œ
              console.log(`ğŸ² ë¹…ë¸”ë¼ì¸ë“œ ì¬ì¶”ì¶œ: ${bigBlind}`);
              break;
            }
          }
        }

        // BB ê³„ì‚°
        const stackInBB = Math.round(keyPlayer.currentStack / bigBlind);
        const stackFormatted = keyPlayer.currentStack.toLocaleString();

        // ìë§‰ ìƒì„±: í°ë”°ì˜´í‘œë„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì²˜ë¦¬
        const subtitle = `"
${keyPlayer.country}
${keyPlayer.name.toUpperCase()}
${stackFormatted} (${stackInBB}BB)
"`;

        console.log(`âœ… ìë§‰ ìƒì„± ì™„ë£Œ (í•¸ë“œ #${handNumber}):`, subtitle);
        return subtitle;

      } catch (error) {
        console.error(`âŒ ìë§‰ ìƒì„± ì˜¤ë¥˜ (í•¸ë“œ #${handNumber}):`, error);
        return '';
      }
    }

    // ====================================
    // AI ë¶„ì„ ì‹œìŠ¤í…œ
    // ====================================

    // AI ë¶„ì„ ìºì‹œ
    const aiAnalysisCache = new Map();
    const AI_CACHE_TTL = 24 * 60 * 60 * 1000; // 24ì‹œê°„ ìºì‹œ

    /**
     * Gemini API í˜¸ì¶œ
     */
    // ğŸ”„ í†µì¼ëœ callGeminiAPI - ë” ê²¬ê³ í•œ ë‘ ë²ˆì§¸ í•¨ìˆ˜ ì‚¬ìš©
    async function callGeminiAPI(prompt) {
      const apiKey = CONFIG.GEMINI_API_KEY;
      if (!apiKey) {
        console.warn('âš ï¸ Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
        return null;
      }

      // ë” ê²¬ê³ í•œ ë‘ ë²ˆì§¸ í•¨ìˆ˜ í˜¸ì¶œ (ì—¬ëŸ¬ ëª¨ë¸ fallback ì§€ì›)
      return await callGeminiAPIAdvanced(prompt, apiKey);
    }

    /**
     * @deprecated ëª¨ë“ˆí™” ì™„ë£Œ - src/modules/ai-analyzer.jsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     * AIë¥¼ ì‚¬ìš©í•œ íŒŒì¼ëª… ìš”ì•½ ìƒì„± (3ë‹¨ì–´)
     */
    async function generateAIFileSummary(analysis) {
      console.warn('âš ï¸ [DEPRECATED] generateAIFileSummary - AIAnalyzer.generateFileSummary ì‚¬ìš© ê¶Œì¥');

      // AIAnalyzer ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (window.AIAnalyzer && typeof window.AIAnalyzer.generateFileSummary === 'function') {
        return await window.AIAnalyzer.generateFileSummary(analysis);
      }

      // í´ë°±: ê¸°ë³¸ ìš”ì•½
      return analysis?.keywords ? analysis.keywords.slice(0, 3).join('_') : 'hand';
    }

    /**
     * AIë¥¼ ì‚¬ìš©í•œ Hì—´ ìƒì„¸ ë¶„ì„ (1ì¤„)
     */
    async function generateAIDetailedAnalysis(analysis) {
      // ìºì‹œ í™•ì¸
      const cacheKey = `detail_${analysis.handData.handNumber}`;
      const cached = aiAnalysisCache.get(cacheKey);
      if (cached && (Date.now() - cached.timestamp < AI_CACHE_TTL)) {
        debugLog(`âœ… AI ìƒì„¸ë¶„ì„ ìºì‹œ ì‚¬ìš©`);
        return cached.value;
      }

      // í”„ë¡¬í”„íŠ¸ ìƒì„±
      const pot = analysis.handData.pot || 0;
      const actions = analysis.keywords ? analysis.keywords.join(', ') : '';
      const prompt = `í¬ì»¤ í•¸ë“œ ê²°ê³¼ë¥¼ 1ì¤„ë¡œ ê°„ë‹¨íˆ ë¶„ì„í•˜ì„¸ìš”.

ì•¡ì…˜: ${actions}
íŒŸ: ${pot}

ê·œì¹™:
- ë¶„ì„ ë¶ˆê°€ëŠ¥í•˜ë©´ "${Math.round(pot/2000)}BB íšë“" ê°™ì€ BB ê²°ê³¼ë§Œ ì¶œë ¥
- 1ì¤„ë§Œ ì‘ì„±, ì¥í™©í•œ ì„¤ëª… ê¸ˆì§€
- êµ¬ì²´ì  ì „ëµë³´ë‹¤ ê²°ê³¼ ìœ„ì£¼ë¡œ ì‘ì„±

ì˜ˆì‹œ: "í”ŒëŸ½ íˆ¬í˜ì–´ë¡œ ì••ë°•ì„±ê³µ", "ë¦¬ë²„ ì˜¬ì¸ìœ¼ë¡œ ìµœëŒ€ë°¸ë¥˜", "15BB íšë“"
ë‹µ:`;

      // API í˜¸ì¶œ
      const result = await callGeminiAPI(prompt);

      if (result) {
        // ìºì‹œ ì €ì¥
        aiAnalysisCache.set(cacheKey, {
          value: result,
          timestamp: Date.now()
        });
        debugLog(`ğŸ¤– AI ìƒì„¸ë¶„ì„ ìƒì„±`);
        return result;
      }

      // í´ë°±: ê¸°ë³¸ ë¬¸êµ¬
      const fallback = `${actions} ì•¡ì…˜ìœ¼ë¡œ ${pot} íŒŸ íšë“`;
      return fallback;
    }

    // ====================================
    // ì™„ì „ ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ ì „ì—­ ë³€ìˆ˜
    // ====================================
    window.preloadedHandStatuses = new Map();  // í•¸ë“œë²ˆí˜¸ â†’ ìƒíƒœ ë§¤í•‘
    window.preloadedTimeMapping = new Map();   // ì‹œê°„ â†’ í•¸ë“œë²ˆí˜¸ ë§¤í•‘

    // ğŸš€ í•¸ë“œë²ˆí˜¸ â†” íŒŒì¼ëª… ì‹¤ì‹œê°„ ë§¤í•‘ í…Œì´ë¸”
    window.handToFilenameMapping = new Map();  // í•¸ë“œë²ˆí˜¸ â†’ íŒŒì¼ëª…
    window.filenameToHandMapping = new Map();  // íŒŒì¼ëª… â†’ í•¸ë“œë²ˆí˜¸

    window.isPreloadingInProgress = false;      // ì‚¬ì „ ë¡œë”© ì§„í–‰ ìƒíƒœ
    window.preloadStartTime = null;             // ì„±ëŠ¥ ì¸¡ì •ìš©

    // ====================================
    // ì´ˆê¸° ë¡œë“œ ë™ê¸°í™” ë§¤ë‹ˆì €
    // ====================================
    class InitSyncManager {
      constructor() {
        this.overlay = document.getElementById('initSyncOverlay');
        this.logsContainer = document.getElementById('initSyncLogs');
        this.progressBar = document.getElementById('initProgressBar');
        this.startTime = null;
        this.currentStep = 0;
        this.totalSteps = 5;
        this.stepTimers = {};
      }

      show() {
        this.overlay.style.display = 'flex';
        this.startTime = performance.now();
        this.logsContainer.innerHTML = '';
        this.addLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
      }

      hide() {
        setTimeout(() => {
          this.overlay.style.display = 'none';
          const totalTime = ((performance.now() - this.startTime) / 1000).toFixed(2);
          console.log(`âœ… ì´ˆê¸°í™” ì™„ë£Œ - ì´ ì†Œìš” ì‹œê°„: ${totalTime}ì´ˆ`);
        }, 500);
      }

      updateStep(stepName, status = 'running', message = '') {
        const stepElement = document.querySelector(`.sync-step[data-step="${stepName}"]`);
        if (!stepElement) return;

        const iconElement = stepElement.querySelector('.step-icon');
        const textElement = stepElement.querySelector('.step-text');
        const timeElement = stepElement.querySelector('.step-time');

        switch (status) {
          case 'running':
            iconElement.textContent = 'â³';
            iconElement.className = 'step-icon text-yellow-400 animate-pulse';
            textElement.className = 'step-text text-yellow-400';
            this.stepTimers[stepName] = performance.now();
            if (message) textElement.textContent = message;
            break;

          case 'complete':
            iconElement.textContent = 'âœ…';
            iconElement.className = 'step-icon text-green-400';
            textElement.className = 'step-text text-green-400';
            if (this.stepTimers[stepName]) {
              const elapsed = ((performance.now() - this.stepTimers[stepName]) / 1000).toFixed(1);
              timeElement.textContent = `${elapsed}s`;
            }
            if (message) textElement.textContent = message;
            this.currentStep++;
            this.updateProgress();
            break;

          case 'error':
            iconElement.textContent = 'âŒ';
            iconElement.className = 'step-icon text-red-400';
            textElement.className = 'step-text text-red-400';
            if (message) textElement.textContent = message;
            break;
        }
      }

      updateProgress() {
        const progress = (this.currentStep / this.totalSteps) * 100;
        this.progressBar.style.width = `${progress}%`;
      }

      addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ko-KR', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const colorClass = type === 'error' ? 'text-red-400' :
                          type === 'success' ? 'text-green-400' :
                          type === 'warning' ? 'text-yellow-400' :
                          'text-gray-400';

        const logEntry = document.createElement('div');
        logEntry.className = colorClass;
        logEntry.innerHTML = `[${timestamp}] ${message}`;

        this.logsContainer.appendChild(logEntry);
        this.logsContainer.scrollTop = this.logsContainer.scrollHeight;
      }

      async simulateStep(stepName, duration = 1000) {
        this.updateStep(stepName, 'running');
        await new Promise(resolve => setTimeout(resolve, duration));
        this.updateStep(stepName, 'complete');
      }
    }

    // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
    const initSyncManager = new InitSyncManager();

    // ====================================
    // Phase 2: ìºì‹± ì‹œìŠ¤í…œ êµ¬í˜„
    // ====================================

    /**
     * ì‹œíŠ¸ ë°ì´í„° ìºì‹± ê´€ë¦¬ì
     * TTL(Time To Live) ê¸°ë°˜ìœ¼ë¡œ ìë™ ê°±ì‹ 
     */
    class SheetDataCache {
      constructor() {
        this.cache = new Map();
        this.timeIndex = new Map(); // ì‹œê°„ ê¸°ë°˜ ë¹ ë¥¸ ê²€ìƒ‰ìš© ì¸ë±ìŠ¤
        this.ttl = 5 * 60 * 1000; // 5ë¶„ ìºì‹œ ìœ íš¨ì‹œê°„
        this.lastUpdate = 0;
        this.isLoading = false;
        this.isUpdating = false;  // ê°±ì‹  ì¤‘ í”Œë˜ê·¸
        this.maxCacheSize = 2000; // ìµœëŒ€ ìºì‹œ í–‰ ìˆ˜ (v12.4.0ì—ì„œ í™•ì¥)
        this.hitCount = 0;
        this.missCount = 0;
        this.lastRowCount = 0;  // ë§ˆì§€ë§‰ í–‰ ìˆ˜ (ì‹ ê·œ í•¸ë“œ ê°ì§€ìš©)
        this.updateInterval = null;  // ìë™ ê°±ì‹  ì¸í„°ë²Œ
      }

      /**
       * ìºì‹œ ìœ íš¨ì„± í™•ì¸
       */
      isExpired() {
        return Date.now() - this.lastUpdate > this.ttl;
      }

      /**
       * ìºì‹œ ì ì¤‘ë¥  ê³„ì‚°
       */
      getHitRate() {
        const total = this.hitCount + this.missCount;
        return total > 0 ? (this.hitCount / total * 100).toFixed(1) : 0;
      }

      /**
       * í•¸ë“œ ë²ˆí˜¸ë¡œ ì§ì ‘ í–‰ ì°¾ê¸° (ê³ ìœ  ID ê¸°ë°˜ ë§¤ì¹­)
       * @param {number} handNumber - ì°¾ì„ í•¸ë“œ ë²ˆí˜¸
       * @returns {object|null} - ë§¤ì¹­ëœ í–‰ ë°ì´í„°
       */
      findRowByHandNumber(handNumber) {
        if (this.cache.size === 0 || this.isExpired()) {
          this.missCount++;
          return null;
        }

        const handNumStr = String(handNumber);
        console.log(`ğŸ” í•¸ë“œ ë²ˆí˜¸ë¡œ ê²€ìƒ‰: #${handNumber}`);

        // ëª¨ë“  ìºì‹œ í•­ëª©ì„ ìˆœíšŒí•˜ë©° í•¸ë“œ ë²ˆí˜¸ í™•ì¸
        for (const [rowNum, data] of this.cache) {
          if (data.handNumber === handNumStr) {
            this.hitCount++;
            console.log(`âœ… í•¸ë“œ ë§¤ì¹­ ì„±ê³µ: #${handNumber} â†’ í–‰ ${rowNum}, ì‹œê°„="${data.time}", ìƒíƒœ="${data.status || ''}"`);
            return data;
          }
        }

        // ë§¤ì¹­ ì‹¤íŒ¨
        this.missCount++;
        console.log(`âŒ í•¸ë“œ ë§¤ì¹­ ì‹¤íŒ¨: #${handNumber}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return null;
      }

      /**
       * ì „ì²´ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ë° ìºì‹±
       */
      async refreshCache() {
        if (this.isLoading) {
          console.log('â³ ìºì‹œ ê°±ì‹  ì¤‘... ëŒ€ê¸°');
          return;
        }

        this.isLoading = true;
        const startTime = performance.now();

        try {
          console.log('ğŸ”„ [Phase 2] ìºì‹œ ê°±ì‹  ì‹œì‘...');

          const sheetUrl = getSheetUrl();
          if (!sheetUrl) {
            throw new Error('ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
          }

          // CSV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const csvUrl = convertToCSVUrl(sheetUrl);
          const response = await fetch(csvUrl + '&random=' + Math.random());
          const csvText = await response.text();

          // CSV íŒŒì‹± (parseCSV í•¨ìˆ˜ ì‚¬ìš© - RFC 4180 ì¤€ìˆ˜)
          const rows = parseCSV(csvText);

          console.log(`ğŸ“‹ CSV íŒŒì‹± ì™„ë£Œ: ${rows.length}ê°œ í–‰`);

          // ë©€í‹°ë¼ì¸ ê²€ì¦
          if (rows.length > 0) {
            const firstRow = rows[0];
            const lastRow = rows[rows.length - 1];
            console.log(`   ì²« í–‰: ${firstRow[1]} (${firstRow.length}ê°œ í•„ë“œ)`);
            console.log(`   ë§ˆì§€ë§‰ í–‰: ${lastRow[1]} (${lastRow.length}ê°œ í•„ë“œ)`);

            // 17ì‹œ ì´í›„ ë°ì´í„° í™•ì¸
            let after17Count = 0;
            rows.forEach(row => {
              const time = row[1]; // Bì—´
              if (time && time.match(/^(1[7-9]|2[0-3]):/)) {
                after17Count++;
              }
            });
            console.log(`   17ì‹œ ì´í›„ ë°ì´í„°: ${after17Count}ê°œ í–‰`);
          }

          // ì²˜ìŒ 3ê°œ í–‰ ë””ë²„ê¹…
          if (rows.length > 0) {
            console.log('ğŸ” CSV ìƒ˜í”Œ (ì²˜ìŒ 3í–‰):');
            for (let i = 0; i < Math.min(3, rows.length); i++) {
              console.log(`   í–‰ ${i + 1}: Bì—´="${rows[i][1]}", Eì—´="${rows[i][4]}"`);
            }
          }

          // ìºì‹œ ì´ˆê¸°í™”
          this.cache.clear();
          this.timeIndex.clear();

          // ë°ì´í„° íŒŒì‹± ë° ì¸ë±ì‹±
          for (let i = 0; i < rows.length && i <= this.maxCacheSize; i++) {
            const cols = rows[i];
            if (!cols || cols.length < 8) continue; // ìµœì†Œ ì—´ ê°œìˆ˜ í™•ì¸

            const timeStr = cols[1]?.trim(); // Bì—´ (ì¸ë±ìŠ¤ 1)
            if (!timeStr) continue;

            // ì‹œê°„ íŒŒì‹±
            const timestamp = this.parseTimeToTimestamp(timeStr);
            if (!timestamp) continue;

            // Eì—´ ìƒíƒœê°’ ì •ë¦¬ (ì¸ë±ìŠ¤ 4)
            let status = cols[4]?.trim() || '';
            // ë”°ì˜´í‘œ ì œê±°
            if (status.startsWith('"') && status.endsWith('"')) {
              status = status.slice(1, -1);
            }

            // Virtual ì‹œíŠ¸ëŠ” í•¸ë“œ ë²ˆí˜¸ê°€ ëª…í™•í•˜ì§€ ì•ŠìŒ - ì¼ë‹¨ ë¹ˆê°’ìœ¼ë¡œ ì²˜ë¦¬
            // ì‹¤ì œë¡œëŠ” ì‹œê°„ ë§¤ì¹­ìœ¼ë¡œë§Œ ì‘ë™í•˜ëŠ” ê²ƒì´ ë§ìŒ
            const handNumber = '';

            const rowData = {
              row: i + 1, // í–‰ ë²ˆí˜¸ (1-based)
              time: timeStr,
              timestamp: timestamp,
              handNumber: handNumber, // Cì—´ - í•¸ë“œ ë²ˆí˜¸
              status: status, // Eì—´
              filename: cols[5]?.trim() || '', // Fì—´
              analysis: cols[7]?.trim() || '' // Hì—´
            };

            this.cache.set(i + 1, rowData);

            // ì‹œê°„ ì¸ë±ìŠ¤ì— ì¶”ê°€
            if (!this.timeIndex.has(timestamp)) {
              this.timeIndex.set(timestamp, []);
            }
            this.timeIndex.get(timestamp).push(i + 1);

            // ë””ë²„ê¹…: "ë¯¸ì™„ë£Œ" ìƒíƒœ ë¡œê·¸
            if (status === 'ë¯¸ì™„ë£Œ') {
              console.log(`ğŸŸ¡ ìºì‹œ: í–‰ ${i + 1}ì—ì„œ "ë¯¸ì™„ë£Œ" ë°œê²¬ - í•¸ë“œ #${handNumber}, ì‹œê°„: ${timeStr}`);
            }

            // í•¸ë“œ ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš° ì¶”ê°€ ë¡œê·¸ (ëª¨ë“  ì—´ ì •ë³´ í¬í•¨)
            if (i < 5) { // ì²˜ìŒ 5í–‰ ìƒì„¸ ë¡œê·¸
              console.log(`   ğŸ“ í–‰ ${i + 1}:`, {
                A: cols[0]?.trim() || '(ë¹ˆê°’)',
                B: cols[1]?.trim() || '(ë¹ˆê°’)',
                C: cols[2]?.trim() || '(ë¹ˆê°’)',
                D: cols[3]?.trim() || '(ë¹ˆê°’)',
                E: cols[4]?.trim() || '(ë¹ˆê°’)',
                í•¸ë“œë²ˆí˜¸: handNumber,
                ì‹œê°„: timeStr,
                ìƒíƒœ: status
              });
            }
          }

          this.lastUpdate = Date.now();
          const duration = performance.now() - startTime;

          // "ë¯¸ì™„ë£Œ" ìƒíƒœ ì¹´ìš´íŠ¸
          let incompleteCount = 0;
          let completeCount = 0;
          let emptyCount = 0;
          for (const [rowNum, data] of this.cache) {
            if (data.status === 'ë¯¸ì™„ë£Œ') incompleteCount++;
            else if (data.status === 'ë³µì‚¬ì™„ë£Œ') completeCount++;
            else if (!data.status) emptyCount++;
          }

          console.log(`âœ… [Phase 2] ìºì‹œ ê°±ì‹  ì™„ë£Œ: ${this.cache.size}ê°œ í–‰, ${duration.toFixed(0)}ms`);

          // ë””ë²„ê¹… ëª¨ë“œì—ì„œë§Œ ìƒì„¸ ì •ë³´
          if (window.DEBUG_MODE) {
            console.log(`   - ì‹œê°„ ì¸ë±ìŠ¤: ${this.timeIndex.size}ê°œ`);
            console.log(`   - ìƒíƒœ ë¶„í¬: ë¯¸ì™„ë£Œ(${incompleteCount}), ë³µì‚¬ì™„ë£Œ(${completeCount}), ë¹ˆê°’(${emptyCount})`);
            console.log(`   - TTL: ${this.ttl / 1000}ì´ˆ`);
            // ìºì‹œ ë°ì´í„° ë¶„ì„ (ë””ë²„ê¹…)
            this.analyzeCache();
          }

          // Phase 3: IndexedDBì— ìºì‹œ ì €ì¥
          if (typeof localStore !== 'undefined' && localStore.db) {
            localStore.saveSheetCache(this.cache);
          }

        } catch (error) {
          console.error('âŒ [Phase 2] ìºì‹œ ê°±ì‹  ì‹¤íŒ¨:', error);
          // ìºì‹œ ì‹¤íŒ¨í•´ë„ ê¸°ì¡´ ë°ì´í„° ìœ ì§€
        } finally {
          this.isLoading = false;
        }
      }

      /**
       * ì‹œê°„ ë¬¸ìì—´ì„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜ (ì˜¤í”„ì…‹ ë³´ì • í¬í•¨)
       */
      parseTimeToTimestamp(timeStr) {
        if (!timeStr) return null;

        // ë¬¸ìì—´ë¡œ ë³€í™˜ (ìˆ«ìì¼ ìˆ˜ë„ ìˆìŒ)
        const str = String(timeStr).trim();

        // ì´ë¯¸ íƒ€ì„ìŠ¤íƒ¬í”„ì¸ ê²½ìš° (10ìë¦¬ ìˆ«ì)
        const numValue = parseInt(str);
        if (!isNaN(numValue) && numValue > 1000000000 && str.match(/^\d+$/)) {
          return numValue;
        }

        // HH:MM:SS ë˜ëŠ” HH:MM í˜•ì‹ (Virtual ì‹œíŠ¸ì˜ ê¸°ë³¸ í˜•ì‹)
        const timeParts = str.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
        if (timeParts) {
          const today = new Date();
          const hours = parseInt(timeParts[1]);
          const minutes = parseInt(timeParts[2]);
          const seconds = parseInt(timeParts[3] || 0);

          today.setHours(hours, minutes, seconds, 0);

          // ë‚ ì§œ ë³´ì • ë¡œì§ ê°œì„ 
          const now = new Date();
          const currentHour = now.getHours();

          // ì¼€ì´ìŠ¤ 1: ìƒˆë²½ ì‹œê°„(0-3ì‹œ)ì¸ë° í˜„ì¬ê°€ ë°¤(21-23ì‹œ)ì´ë©´ ë‚´ì¼ ë‚ ì§œ
          if (hours <= 3 && currentHour >= 21) {
            today.setDate(today.getDate() + 1);
            console.log(`   ğŸŒ™ ìƒˆë²½ ì‹œê°„ ë³´ì •: ${hours}ì‹œ â†’ ë‚´ì¼ ë‚ ì§œë¡œ ì„¤ì •`);
          }
          // ì¼€ì´ìŠ¤ 2: ë°¤ ì‹œê°„(21-23ì‹œ)ì¸ë° í˜„ì¬ê°€ ìƒˆë²½(0-3ì‹œ)ì´ë©´ ì–´ì œ ë‚ ì§œ
          else if (hours >= 21 && currentHour <= 3) {
            today.setDate(today.getDate() - 1);
            console.log(`   ğŸŒƒ ë°¤ ì‹œê°„ ë³´ì •: ${hours}ì‹œ â†’ ì–´ì œ ë‚ ì§œë¡œ ì„¤ì •`);
          }
          // ì¼€ì´ìŠ¤ 3: ì‹œê°„ì´ ë¯¸ë˜ì¸ ê²½ìš° ì–´ì œë¡œ ì„¤ì • (24ì‹œê°„ ì´ë‚´ëŠ” í—ˆìš©)
          else if (today > now && (today - now) > 24 * 60 * 60 * 1000) {
            today.setDate(today.getDate() - 1);
            console.log(`   ğŸ“… ë¯¸ë˜ ì‹œê°„ ë³´ì •: ${hours}ì‹œ â†’ ì–´ì œ ë‚ ì§œë¡œ ì„¤ì •`);
          }

          const timestamp = Math.floor(today.getTime() / 1000);

          // ì•Œë ¤ì§„ ì˜¤í”„ì…‹ ì ìš© (í•„ìš”í•œ ê²½ìš°)
          const KNOWN_OFFSET = 0; // í•„ìš”ì‹œ 4000 ë“±ìœ¼ë¡œ ì„¤ì •
          const adjustedTimestamp = timestamp + KNOWN_OFFSET;

          // ì²˜ìŒ ëª‡ ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
          if (this.cache.size < 3) {
            console.log(`â° ì‹œê°„ ë³€í™˜: "${str}" â†’ ${adjustedTimestamp} (${new Date(adjustedTimestamp * 1000).toLocaleString()})`);
          }

          return adjustedTimestamp;
        }

        // ë””ë²„ê¹…: íŒŒì‹± ì‹¤íŒ¨í•œ ê°’ ë¡œê·¸
        console.log(`âš ï¸ ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨: "${str}"`);
        return null;
      }

      /**
       * ì‹œê°„ê°’ ë§¤ì¹­ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ í–‰ ì°¾ê¸° (ë‚ ì§œ ë¬´ê´€ ë‹¨ìˆœí™” ë²„ì „ v12.4.0)
       * ë‚ ì§œì™€ ìƒê´€ì—†ì´ ì‹œê°„ê°’(HH:MM)ë§Œìœ¼ë¡œ ë§¤ì¹­í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ ë° ë¡œì§ ë‹¨ìˆœí™”
       */
      findClosestRow(targetTimestamp, tolerance = 180) {
        // ìºì‹œê°€ ë¹„ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìœ¼ë©´ null
        if (this.cache.size === 0 || this.isExpired()) {
          this.missCount++;
          return null;
        }

        // Hand ì‹œíŠ¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ì—ì„œ ì‹œê°„ ë¶€ë¶„ë§Œ ì¶”ì¶œ (HH:MM í˜•ì‹)
        const targetDate = new Date(targetTimestamp * 1000);
        const targetHours = targetDate.getHours();
        const targetMinutes = targetDate.getMinutes();
        const targetTimeString = `${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}`;

        if (window.DEBUG_MODE) {
          console.log(`ğŸ” [ì‹œê°„ ë§¤ì¹­] íƒ€ê²Ÿ: ${targetTimeString}`);
        }

        let bestMatch = null;
        let minTimeDiff = Infinity;
        let matchType = '';

        // 1. ì‹œê°„ ì¸ë±ìŠ¤ì—ì„œ ì •í™•í•œ ë§¤ì¹­ ìš°ì„  ê²€ìƒ‰
        const exactMatches = this.timeIndex.get(targetTimeString) || [];
        for (const rowNum of exactMatches) {
          const data = this.cache.get(rowNum);
          if (data && data.status) {
            this.hitCount++;
            if (window.DEBUG_MODE) {
              console.log(`âœ… [ì •í™• ë§¤ì¹­] í–‰ ${rowNum}, ì‹œê°„: ${data.time}`);
            }
            return { row: rowNum, ...data };
          }
        }

        // 2. ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ëª¨ë“  ìºì‹œ ë°ì´í„°ì—ì„œ ì‹œê°„ ì°¨ì´ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒ ì°¾ê¸°
        const targetTotalMinutes = targetHours * 60 + targetMinutes;

        for (const [rowNum, data] of this.cache) {
          if (!data.time || !data.status) continue;

          // Virtual ì‹œíŠ¸ì˜ ì‹œê°„ì„ íŒŒì‹± (HH:MM ë˜ëŠ” HH:MM:SS í˜•ì‹)
          const timeParts = data.time.split(':');
          if (timeParts.length < 2) continue;

          const rowHours = parseInt(timeParts[0]);
          const rowMinutes = parseInt(timeParts[1]);

          if (isNaN(rowHours) || isNaN(rowMinutes)) continue;

          const rowTotalMinutes = rowHours * 60 + rowMinutes;

          // 24ì‹œê°„ ê²½ê³„ë¥¼ ê³ ë ¤í•œ ìµœì†Œ ì‹œê°„ ì°¨ì´ ê³„ì‚°
          let timeDiff = Math.abs(targetTotalMinutes - rowTotalMinutes);

          // ìì • ê²½ê³„ ì²˜ë¦¬: 23:50ê³¼ 00:10ì˜ ì°¨ì´ëŠ” 20ë¶„ (1440-1420 = 20)
          if (timeDiff > 720) { // 12ì‹œê°„ ì´ìƒ ì°¨ì´ë‚˜ë©´ ìì • ê²½ê³„ì¼ ê°€ëŠ¥ì„±
            timeDiff = 1440 - timeDiff; // 24ì‹œê°„(1440ë¶„)ì—ì„œ ë¹¼ì„œ ì‹¤ì œ ê±°ë¦¬ ê³„ì‚°
          }

          if (timeDiff < minTimeDiff) {
            minTimeDiff = timeDiff;
            bestMatch = { row: rowNum, ...data, timeDiff: timeDiff };
            matchType = `ê·¼ì‚¬ ë§¤ì¹­ (${timeDiff}ë¶„ ì°¨ì´)`;
          }
        }

        // 3. í—ˆìš© ì˜¤ì°¨ ë‚´ì˜ ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¹­ ë°˜í™˜
        const toleranceMinutes = Math.floor(tolerance / 60); // ì´ˆë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜

        if (bestMatch && minTimeDiff <= toleranceMinutes) {
          this.hitCount++;
          if (window.DEBUG_MODE) {
            console.log(`âœ… [${matchType}] í–‰ ${bestMatch.row}, ì‹œê°„: ${bestMatch.time}, ì°¨ì´: ${minTimeDiff}ë¶„`);
          }
          return bestMatch;
        }

        // 4. ë§¤ì¹­ ì‹¤íŒ¨
        this.missCount++;
        if (window.DEBUG_MODE) {
          console.log(`âŒ [ë§¤ì¹­ ì‹¤íŒ¨] íƒ€ê²Ÿ: ${targetTimeString}, ìµœì†Œ ì°¨ì´: ${minTimeDiff}ë¶„ (í—ˆìš©: ${toleranceMinutes}ë¶„)`);
        }

        return null;
      }

      /**
       * ìºì‹œ ë°ì´í„° ë¶„ì„ (ë””ë²„ê¹…ìš©)
       */
      analyzeCache() {
        const timeDistribution = new Map();
        const hourDistribution = new Map();

        for (const [rowNum, data] of this.cache) {
          if (data.time) {
            const hour = parseInt(data.time.split(':')[0]);
            hourDistribution.set(hour, (hourDistribution.get(hour) || 0) + 1);

            // ì „ì²´ ì‹œê°„ ì €ì¥
            if (!timeDistribution.has(data.time)) {
              timeDistribution.set(data.time, []);
            }
            timeDistribution.get(data.time).push(rowNum);
          }
        }

        console.log('ğŸ“Š Virtual ì‹œíŠ¸ ì‹œê°„ëŒ€ ë¶„í¬:');
        const sortedHours = Array.from(hourDistribution.keys()).sort((a, b) => a - b);
        sortedHours.forEach(hour => {
          console.log(`   ${String(hour).padStart(2, '0')}ì‹œ: ${hourDistribution.get(hour)}ê°œ í–‰`);
        });

        console.log('ğŸ“Š ì‹œê°„ ë²”ìœ„:');
        const times = Array.from(timeDistribution.keys()).sort();
        console.log(`   ìµœì´ˆ: ${times[0]}`);
        console.log(`   ìµœì¢…: ${times[times.length - 1]}`);
        console.log(`   ì´ ê³ ìœ  ì‹œê°„: ${times.length}ê°œ`);

        // 22ì‹œ ì´í›„ ë°ì´í„° í™•ì¸
        const nightTimes = times.filter(time => {
          const hour = parseInt(time.split(':')[0]);
          return hour >= 22 || hour <= 2;
        });
        console.log(`   ë°¤ ì‹œê°„ëŒ€ (22-02ì‹œ): ${nightTimes.length}ê°œ`);
        if (nightTimes.length > 0) {
          console.log(`   ë°¤ ì‹œê°„ ì˜ˆì‹œ:`, nightTimes.slice(0, 5));
        }

        return { hourDistribution, timeDistribution, times };
      }

      /**
       * ì—¬ëŸ¬ í•¸ë“œì˜ ìƒíƒœë¥¼ ìºì‹œì—ì„œ í™•ì¸
       */
      async checkMultipleHandsFromCache(handNumbers) {
        // ìºì‹œ ìë™ ê°±ì‹ 
        if (this.isExpired()) {
          await this.refreshCache();
        }

        const results = {};
        const notInCache = [];

        // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
        for (const handNum of handNumbers) {
          const timestamp = await getHandTimestamp(handNum);
          if (!timestamp) continue;

          const cachedRow = this.findClosestRow(timestamp);
          if (cachedRow) {
            results[handNum] = cachedRow.status;
          } else {
            notInCache.push(handNum);
          }
        }

        // âš ï¸ ìºì‹œ í†µê³„ ë¡œê·¸ ë¹„í™œì„±í™” - ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“Š [Phase 2] ìºì‹œ ì ì¤‘ë¥ : ${this.getHitRate()}%`);
        // console.log(`   - ìºì‹œ ì ì¤‘: ${Object.keys(results).length}ê°œ`);
        // console.log(`   - ìºì‹œ ë¯¸ìŠ¤: ${notInCache.length}ê°œ`);

        // ìºì‹œì— ì—†ëŠ” í•­ëª©ì€ Phase 1 ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
        if (notInCache.length > 0) {
          const apiResults = await checkAllHandsStatus(notInCache);
          Object.assign(results, apiResults);
        }

        return results;
      }

      /**
       * ìºì‹œ ê°±ì‹  í™•ì¸ ë° ìë™ ìƒˆë¡œê³ ì¹¨
       */
      async ensureFresh() {
        if (this.isExpired() || this.cache.size === 0) {
          console.log('ğŸ”„ [Phase 2] ìºì‹œ ë§Œë£Œ ë˜ëŠ” ë¹„ì–´ìˆìŒ - ìë™ ê°±ì‹ ');
          await this.refreshCache();
        }
      }

      /**
       * ìºì‹œ í†µê³„ ì •ë³´
       */
      getStats() {
        return {
          size: this.cache.size,
          hitRate: this.getHitRate(),
          hitCount: this.hitCount,
          missCount: this.missCount,
          lastUpdate: new Date(this.lastUpdate).toLocaleTimeString(),
          ttl: this.ttl / 1000 + 'ì´ˆ',
          isExpired: this.isExpired()
        };
      }

      /**
       * ìºì‹œ ê°•ì œ ì´ˆê¸°í™”
       */
      clear() {
        this.cache.clear();
        this.timeIndex.clear();
        this.lastUpdate = 0;
        this.hitCount = 0;
        this.missCount = 0;
        this.lastRowCount = 0;
        this.stopAutoUpdate();  // ìë™ ê°±ì‹  ì¤‘ì§€
        console.log('ğŸ§¹ [Phase 2] ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ');
      }

      /**
       * ìŠ¤ë§ˆíŠ¸ ìºì‹œ ê°±ì‹  ì‹œì‘ (30ì´ˆë§ˆë‹¤ ì¦ë¶„ ì—…ë°ì´íŠ¸)
       */
      startSmartUpdate() {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
        if (this.updateInterval) return;

        console.log('ğŸ”„ ìŠ¤ë§ˆíŠ¸ ìºì‹œ ê°±ì‹  ì‹œì‘ (30ì´ˆ ê°„ê²©)');

        this.updateInterval = setInterval(async () => {
          await this.incrementalUpdate();
        }, 30000);  // 30ì´ˆë§ˆë‹¤ ì‹¤í–‰
      }

      /**
       * ìë™ ê°±ì‹  ì¤‘ì§€
       */
      stopAutoUpdate() {
        if (this.updateInterval) {
          clearInterval(this.updateInterval);
          this.updateInterval = null;
          console.log('â¹ï¸ ìŠ¤ë§ˆíŠ¸ ìºì‹œ ê°±ì‹  ì¤‘ì§€');
        }
      }

      /**
       * ì¦ë¶„ ì—…ë°ì´íŠ¸ (ì‹ ê·œ í•¸ë“œë§Œ ì¶”ê°€)
       */
      async incrementalUpdate() {
        if (this.isUpdating) {
          console.log('â³ ì´ë¯¸ ê°±ì‹  ì¤‘...');
          return;
        }

        this.isUpdating = true;
        const startTime = performance.now();

        try {
          console.log('ğŸ”„ ì¦ë¶„ ìºì‹œ ê°±ì‹  ì‹œì‘...');

          // CSV ë°ì´í„° ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
          const csvUrl = getSheetUrl();
          if (!csvUrl) {
            this.isUpdating = false;
            return;
          }

          const response = await fetch(csvUrl);
          if (!response.ok) {
            throw new Error('CSV ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
          }

          const csvText = await response.text();
          const rows = parseCSV(csvText);

          // ì‹ ê·œ í–‰ë§Œ ì°¾ê¸°
          const currentRowCount = rows.length;
          const newRowCount = currentRowCount - this.lastRowCount;

          if (newRowCount > 0) {
            console.log(`ğŸ†• ${newRowCount}ê°œ ì‹ ê·œ í–‰ ë°œê²¬`);

            // ì‹ ê·œ í–‰ë§Œ ìºì‹œì— ì¶”ê°€
            const newRows = rows.slice(this.lastRowCount);
            newRows.forEach((row, index) => {
              const rowNum = this.lastRowCount + index + 2;  // í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)
              this.cache.set(rowNum, row);
            });

            this.lastRowCount = currentRowCount;
            this.lastUpdate = Date.now();

            // ì‹ ê·œ í•¸ë“œ ì•Œë¦¼
            if (newRowCount > 0 && !isInitialLoad) {
              showNotification(`${newRowCount}ê°œ ì‹ ê·œ í•¸ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'info');
            }

            console.log(`âœ… ì¦ë¶„ ê°±ì‹  ì™„ë£Œ (${((performance.now() - startTime) / 1000).toFixed(2)}ì´ˆ)`);
          } else {
            console.log('â„¹ï¸ ì‹ ê·œ í–‰ ì—†ìŒ');
          }

        } catch (error) {
          console.error('âŒ ì¦ë¶„ ê°±ì‹  ì‹¤íŒ¨:', error);
        } finally {
          this.isUpdating = false;
        }
      }
    }

    // ì „ì—­ ìºì‹œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const sheetDataCache = new SheetDataCache();

    // ====================================
    // ì™„ì „í•œ ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ
    // ====================================

    /**
     * Virtual ì‹œíŠ¸ ì „ì²´ë¥¼ í•œ ë²ˆì— ë¡œë”©í•˜ì—¬ ë©”ëª¨ë¦¬ì— ì €ì¥
     * í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰í•˜ì—¬ í•¸ë“œ í´ë¦­ ì‹œ ì¦‰ì‹œ ì‘ë‹µ ê°€ëŠ¥
     */
    async function preloadAllHandStatuses() {
      if (window.isPreloadingInProgress) {
        console.log('ğŸ”„ ì´ë¯¸ ì‚¬ì „ ë¡œë”©ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        return;
      }

      window.isPreloadingInProgress = true;
      window.preloadStartTime = performance.now();

      try {
        console.log('ğŸš€ Virtual ì‹œíŠ¸ ì „ì²´ ì‚¬ì „ ë¡œë”© ì‹œì‘...');

        // CSV ë°ì´í„° ë¡œë”©
        const csvUrl = getSheetCsvUrl();
        if (!csvUrl) {
          console.error('âŒ CSV URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }

        console.log('ğŸ“¥ CSV ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...');
        const response = await fetch(csvUrl + '&v=' + Date.now());
        const csvText = await response.text();

        // CSV íŒŒì‹±
        console.log('ğŸ“Š CSV ë°ì´í„° íŒŒì‹± ì¤‘...');
        const parsedData = parseCSV(csvText);

        // ë©”ëª¨ë¦¬ ë§µ êµ¬ì¶•
        console.log('ğŸ—‚ï¸ ë©”ëª¨ë¦¬ ë§¤í•‘ í…Œì´ë¸” êµ¬ì¶• ì¤‘...');
        window.preloadedHandStatuses.clear();
        window.preloadedTimeMapping.clear();

        let processedCount = 0;
        let statusCount = { 'ë³µì‚¬ì™„ë£Œ': 0, 'ë¯¸ì™„ë£Œ': 0, 'ë¯¸ì²˜ë¦¬': 0 };

        for (const row of parsedData) {
          try {
            // ğŸš€ íŒŒì¼ëª…ì—ì„œ í•¸ë“œë²ˆí˜¸ íšë“ (Fì—´ = ì¸ë±ìŠ¤ 5)
            const filename = row[5] ? row[5].trim() : '';

            // 1. ì €ì¥ëœ ë§¤í•‘ì—ì„œ ìš°ì„  ì¡°íšŒ (ê°€ì¥ ì •í™• - íŒŒì¼ëª… ìƒì„± ì‹œ ì €ì¥ë¨)
            let handNumber = getHandNumberFromMapping(filename);

            // 2. ë§¤í•‘ì— ì—†ìœ¼ë©´ íŒ¨í„´ ì¶”ì¶œ (í´ë°± - ë ˆê±°ì‹œ íŒŒì¼ëª…ìš©)
            if (!handNumber) {
              handNumber = extractHandNumberFromFilename(filename);

              // ì¶”ì¶œ ì„±ê³µ ì‹œ ë§¤í•‘ ì €ì¥ (ë‹¤ìŒë²ˆì—” 1ë²ˆì—ì„œ ë°”ë¡œ ì¡°íšŒë¨)
              if (handNumber) {
                saveHandFilenameMapping(handNumber, filename);
                debugLog(`ğŸ”— ë ˆê±°ì‹œ íŒŒì¼ëª… ë§¤í•‘ ì €ì¥: ${filename} â†’ #${handNumber}`);
              }
            } else {
              debugLog(`âš¡ ë§¤í•‘ì—ì„œ ì¦‰ì‹œ ì¡°íšŒ: ${filename} â†’ #${handNumber}`);
            }

            // í•¸ë“œë²ˆí˜¸ê°€ íšë“ë˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ í–‰ ê±´ë„ˆë›°ê¸°
            if (!handNumber || handNumber <= 0) {
              if (filename) {
                console.warn(`âš ï¸ í•¸ë“œë²ˆí˜¸ íšë“ ì‹¤íŒ¨ - íŒŒì¼ëª…: "${filename}"`);
              }
              continue;
            }

            // ìƒíƒœ ì¶”ì¶œ (Eì—´ = ì¸ë±ìŠ¤ 4)
            const status = row[4] ? row[4].trim() : null;

            // ì‹œê°„ ì¶”ì¶œ (Bì—´ = ì¸ë±ìŠ¤ 1)
            const timeStr = row[1] ? row[1].trim() : '';

            // í•¸ë“œ ë²ˆí˜¸ â†’ ìƒíƒœ ë§¤í•‘
            window.preloadedHandStatuses.set(handNumber, status);

            // ì‹œê°„ â†’ í•¸ë“œ ë²ˆí˜¸ ë§¤í•‘ (ê¸°ì¡´ ë¡œì§ê³¼ í˜¸í™˜ì„± ìœ ì§€)
            if (timeStr) {
              window.preloadedTimeMapping.set(timeStr, handNumber);
            }

            processedCount++;

            // ìƒíƒœë³„ ì¹´ìš´íŠ¸
            if (status === 'ë³µì‚¬ì™„ë£Œ') statusCount['ë³µì‚¬ì™„ë£Œ']++;
            else if (status === 'ë¯¸ì™„ë£Œ') statusCount['ë¯¸ì™„ë£Œ']++;
            else statusCount['ë¯¸ì²˜ë¦¬']++;

            // ğŸ” ìƒì„¸ ë””ë²„ê¹… ë¡œê·¸ (ì²˜ìŒ 10ê°œ í–‰ë§Œ)
            if (processedCount <= 10) {
              console.log(`ğŸ” í–‰ ${processedCount}: íŒŒì¼ëª…="${filename}" â†’ í•¸ë“œ#${handNumber} â†’ ìƒíƒœ="${status}"`);
            }

          } catch (error) {
            console.warn('âš ï¸ í–‰ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
          }
        }

        const duration = performance.now() - window.preloadStartTime;
        console.log(`âœ… ì‚¬ì „ ë¡œë”© ì™„ë£Œ! (${duration.toFixed(0)}ms)`);
        console.log(`ğŸ“Š ì²˜ë¦¬ëœ í•¸ë“œ: ${processedCount}ê°œ`);
        console.log(`ğŸ“ˆ ìƒíƒœ ë¶„í¬:`, statusCount);
        console.log(`ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${(processedCount * 50 / 1024).toFixed(1)}KB`);

        // ğŸ” ë¯¸ì™„ë£Œ ìƒíƒœ í•¸ë“œë“¤ì„ êµ¬ì²´ì ìœ¼ë¡œ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
        if (statusCount['ë¯¸ì™„ë£Œ'] > 0) {
          console.log(`ğŸŸ¡ 'ë¯¸ì™„ë£Œ' ìƒíƒœ í•¸ë“œ ëª©ë¡:`);
          const incompleteHands = [];
          for (const [handNumber, status] of window.preloadedHandStatuses) {
            if (status === 'ë¯¸ì™„ë£Œ') {
              incompleteHands.push(handNumber);
              console.log(`   - í•¸ë“œ #${handNumber}: "${status}"`);
            }
          }
          // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë””ë²„ê¹… ë° ì ‘ê·¼ í¸ì˜)
          window.incompleteHandsList = incompleteHands;
          console.log(`ğŸ” ë¯¸ì™„ë£Œ í•¸ë“œ ë²ˆí˜¸ ë°°ì—´: [${incompleteHands.join(', ')}]`);
        } else {
          window.incompleteHandsList = [];
          console.log(`â„¹ï¸ 'ë¯¸ì™„ë£Œ' ìƒíƒœì¸ í•¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.`);
        }

        return true;

      } catch (error) {
        console.error('âŒ ì‚¬ì „ ë¡œë”© ì‹¤íŒ¨:', error);
        return false;
      } finally {
        window.isPreloadingInProgress = false;
      }
    }

    /**
     * ë°±ê·¸ë¼ìš´ë“œì—ì„œ 30ì´ˆë§ˆë‹¤ ì‚¬ì „ ë¡œë”© ë°ì´í„° ê°±ì‹ 
     */
    function startBackgroundRefresh() {
      // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
      if (window.preloadRefreshInterval) {
        clearInterval(window.preloadRefreshInterval);
      }

      window.preloadRefreshInterval = setInterval(async () => {
        console.log('ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ê°±ì‹  ì¤‘...');
        await preloadAllHandStatuses();
      }, 30000); // 30ì´ˆë§ˆë‹¤

      console.log('â° ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘ (30ì´ˆ ê°„ê²©)');
    }

    /**
     * localStorageì—ì„œ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
     */
    function loadHandFilenameMappings() {
      try {
        const handToFilename = localStorage.getItem('handToFilenameMapping');
        const filenameToHand = localStorage.getItem('filenameToHandMapping');

        if (handToFilename) {
          const data = JSON.parse(handToFilename);
          Object.entries(data).forEach(([key, value]) => {
            window.handToFilenameMapping.set(parseInt(key), value);
          });
          console.log(`ğŸ“¥ í•¸ë“œâ†’íŒŒì¼ëª… ë§¤í•‘ ë¡œë“œ: ${Object.keys(data).length}ê°œ`);
        }

        if (filenameToHand) {
          const data = JSON.parse(filenameToHand);
          Object.entries(data).forEach(([key, value]) => {
            window.filenameToHandMapping.set(key, value);
          });
          console.log(`ğŸ“¥ íŒŒì¼ëª…â†’í•¸ë“œ ë§¤í•‘ ë¡œë“œ: ${Object.keys(data).length}ê°œ`);
        }
      } catch (error) {
        console.warn('âš ï¸ ë§¤í•‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    /**
     * localStorageì— ë§¤í•‘ ë°ì´í„° ì €ì¥
     */
    function saveHandFilenameMappingsToStorage() {
      try {
        // Mapì„ Objectë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
        const handToFilenameObj = Object.fromEntries(window.handToFilenameMapping);
        const filenameToHandObj = Object.fromEntries(window.filenameToHandMapping);

        localStorage.setItem('handToFilenameMapping', JSON.stringify(handToFilenameObj));
        localStorage.setItem('filenameToHandMapping', JSON.stringify(filenameToHandObj));

        console.log(`ğŸ’¾ localStorage ì €ì¥: í•¸ë“œâ†’íŒŒì¼ëª… ${window.handToFilenameMapping.size}ê°œ, íŒŒì¼ëª…â†’í•¸ë“œ ${window.filenameToHandMapping.size}ê°œ`);
      } catch (error) {
        console.warn('âš ï¸ localStorage ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    /**
     * @deprecated ëª¨ë“ˆí™” ì™„ë£Œ - FilenameManager ë‚´ë¶€ì—ì„œ ìë™ ì²˜ë¦¬
     * í•¸ë“œë²ˆí˜¸ì™€ íŒŒì¼ëª… ë§¤í•‘ ì €ì¥ í•¨ìˆ˜ (íŒŒì¼ëª… ìƒì„± ì‹œ í˜¸ì¶œ)
     */
    function saveHandFilenameMapping(handNumber, filename) {
      if (!handNumber || !filename) return;

      const handNum = parseInt(handNumber);
      if (isNaN(handNum) || handNum <= 0) return;

      // ë©”ëª¨ë¦¬ì— ì–‘ë°©í–¥ ë§¤í•‘ ì €ì¥
      window.handToFilenameMapping.set(handNum, filename);
      window.filenameToHandMapping.set(filename, handNum);

      // localStorageì— ì˜êµ¬ ì €ì¥
      saveHandFilenameMappingsToStorage();

      console.log(`ğŸ’¾ ë§¤í•‘ ì €ì¥ (ë©”ëª¨ë¦¬+localStorage): í•¸ë“œ #${handNum} â†” "${filename}"`);
    }

    /**
     * ì €ì¥ëœ ë§¤í•‘ì—ì„œ í•¸ë“œë²ˆí˜¸ ì¡°íšŒ (ìµœìš°ì„ )
     */
    function getHandNumberFromMapping(filename) {
      if (!filename) return null;
      return window.filenameToHandMapping.get(filename) || null;
    }

    /**
     * @deprecated ëª¨ë“ˆí™” ì™„ë£Œ - src/modules/filename-adapter.jsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     * íŒŒì¼ëª…ì—ì„œ í•¸ë“œë²ˆí˜¸ ì¶”ì¶œ í•¨ìˆ˜ (í´ë°±ìš©)
     */
    function extractHandNumberFromFilename(filename) {
      console.warn('âš ï¸ [DEPRECATED] extractHandNumberFromFilename - ëª¨ë“ˆë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨');
      // ëª¨ë“ˆí™” í›„ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ (filename-adapter.jsì—ì„œ ì²˜ë¦¬)
      return null;
    }

    /**
     * íŠ¹ì • ìƒíƒœë¥¼ ê°€ì§„ ëª¨ë“  í•¸ë“œ ë²ˆí˜¸ ê²€ìƒ‰ (ì—­ë°©í–¥)
     */
    function findHandsByStatus(targetStatus) {
      const result = [];
      if (window.preloadedHandStatuses) {
        for (const [handNumber, status] of window.preloadedHandStatuses) {
          if (status === targetStatus) {
            result.push(handNumber);
          }
        }
      }
      console.log(`ğŸ” ìƒíƒœ "${targetStatus}" í•¸ë“œ ê²€ìƒ‰ ê²°ê³¼: [${result.join(', ')}]`);
      return result;
    }

    /**
     * ì‚¬ì „ ë¡œë”©ëœ ìƒíƒœ ì¡°íšŒ (ì¦‰ì‹œ ì‘ë‹µ)
     */
    function getPreloadedHandStatus(handNumber) {
      const startTime = performance.now();
      const status = window.preloadedHandStatuses.get(parseInt(handNumber));
      const duration = performance.now() - startTime;

      console.log(`âš¡ ë©”ëª¨ë¦¬ ì¡°íšŒ: í•¸ë“œ #${handNumber} = ${status || 'ë¯¸ì²˜ë¦¬'} (${duration.toFixed(2)}ms)`);
      return status;
    }

    /**
     * ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ í†µê³„
     */
    function getPreloadingStats() {
      return {
        totalHands: window.preloadedHandStatuses.size,
        memoryUsage: window.preloadedHandStatuses.size * 50, // bytes
        isLoading: window.isPreloadingInProgress,
        lastUpdate: window.preloadStartTime
      };
    }

    // ====================================
    // Phase 3: ì‹¤ì‹œê°„ì„± ê°œì„  - ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨
    // ====================================

    /**
     * ìŠ¤ë§ˆíŠ¸ ìë™ ìƒˆë¡œê³ ì¹¨ ê´€ë¦¬ì
     * ì‚¬ìš©ì í™œë™ê³¼ ë°ì´í„° ë³€ê²½ì„ ê°ì§€í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
     */
    class SmartRefreshManager {
      constructor() {
        this.refreshInterval = 30 * 1000; // ê¸°ë³¸ 30ì´ˆ
        this.minInterval = 10 * 1000; // ìµœì†Œ 10ì´ˆ
        this.maxInterval = 5 * 60 * 1000; // ìµœëŒ€ 5ë¶„
        this.lastRefresh = 0;
        this.lastActivity = Date.now();
        this.refreshTimer = null;
        this.isActive = true;
        this.changeCount = 0;
        this.noChangeCount = 0;
      }

      /**
       * ì‚¬ìš©ì í™œë™ ê°ì§€
       */
      detectActivity() {
        this.lastActivity = Date.now();
        this.isActive = true;

        // í™œë™ ê°ì§€ ì‹œ ìƒˆë¡œê³ ì¹¨ ê°„ê²© ë‹¨ì¶•
        if (this.refreshInterval > this.minInterval * 2) {
          this.refreshInterval = Math.max(this.minInterval * 2, this.refreshInterval / 2);
          console.log(`âš¡ í™œë™ ê°ì§€ - ìƒˆë¡œê³ ì¹¨ ê°„ê²© ë‹¨ì¶•: ${this.refreshInterval / 1000}ì´ˆ`);
          this.scheduleNext();
        }
      }

      /**
       * ë°ì´í„° ë³€ê²½ ê°ì§€ í›„ ê°„ê²© ì¡°ì •
       */
      onDataChange(hasChanges) {
        if (hasChanges) {
          this.changeCount++;
          this.noChangeCount = 0;

          // ë³€ê²½ì´ ìì£¼ ë°œìƒí•˜ë©´ ê°„ê²© ë‹¨ì¶•
          if (this.changeCount > 2) {
            this.refreshInterval = Math.max(this.minInterval, this.refreshInterval * 0.8);
            console.log(`ğŸ“ˆ ì¦ì€ ë³€ê²½ ê°ì§€ - ê°„ê²© ë‹¨ì¶•: ${this.refreshInterval / 1000}ì´ˆ`);
          }
        } else {
          this.noChangeCount++;
          this.changeCount = 0;

          // ë³€ê²½ì´ ì—†ìœ¼ë©´ ê°„ê²© ì¦ê°€
          if (this.noChangeCount > 3) {
            this.refreshInterval = Math.min(this.maxInterval, this.refreshInterval * 1.5);
            console.log(`ğŸ“‰ ë³€ê²½ ì—†ìŒ - ê°„ê²© ì¦ê°€: ${this.refreshInterval / 1000}ì´ˆ`);
          }
        }
      }

      /**
       * ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰
       */
      async performRefresh() {
        const startTime = performance.now();

        try {
          // 1. ìºì‹œ ê°±ì‹ 
          const cachePromise = sheetDataCache.refreshCache();

          // 2. ì¸ë±ìŠ¤ ë°ì´í„° ë¡œë“œ
          const indexPromise = loadIndexData(true); // suppress notification

          // ë³‘ë ¬ ì‹¤í–‰
          await Promise.all([cachePromise, indexPromise]);

          // 3. ë³´ì´ëŠ” í•¸ë“œë§Œ ìƒíƒœ ì—…ë°ì´íŠ¸
          await updateVisibleHandsStatus();

          const duration = performance.now() - startTime;
          // console.log(`âœ… [Phase 3] ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${duration.toFixed(0)}ms`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€

          // ë³€ê²½ ê°ì§€
          const hasChanges = allHands.length > 0;
          this.onDataChange(hasChanges);

        } catch (error) {
          console.error('âŒ [Phase 3] ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
        }

        this.lastRefresh = Date.now();
        this.scheduleNext();
      }

      /**
       * ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ì˜ˆì•½
       */
      scheduleNext() {
        if (this.refreshTimer) {
          clearTimeout(this.refreshTimer);
        }

        // ë¹„í™œì„± ì‹œê°„ ì²´í¬
        const inactiveTime = Date.now() - this.lastActivity;
        if (inactiveTime > 10 * 60 * 1000) { // 10ë¶„ ì´ìƒ ë¹„í™œì„±
          this.isActive = false;
          this.refreshInterval = this.maxInterval;
          console.log('ğŸ˜´ ë¹„í™œì„± ìƒíƒœ - ìƒˆë¡œê³ ì¹¨ ê°„ê²© ìµœëŒ€í™”');
        }

        this.refreshTimer = setTimeout(() => {
          this.performRefresh();
        }, this.refreshInterval);

        // console.log(`â±ï¸ ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨: ${this.refreshInterval / 1000}ì´ˆ í›„`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      }

      /**
       * ë§¤ë‹ˆì € ì‹œì‘
       */
      start() {
        console.log('âš ï¸ [Phase 3] ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ë§¤ë‹ˆì € ë¹„í™œì„±í™” - í‘¸ì‹œ ê¸°ë°˜ ì‹œìŠ¤í…œ ì‚¬ìš©');

        // âš ï¸ ëª¨ë“  ìë™ ìƒˆë¡œê³ ì¹¨ ë¡œì§ ì™„ì „ ë¹„í™œì„±í™”
        // ì•±ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìƒˆ ë°ì´í„° ë°œìƒ ì‹œ ì›¹í›…ìœ¼ë¡œ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì „í™˜

        // ì‚¬ìš©ì í™œë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
        // ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
        //   document.addEventListener(event, () => this.detectActivity(), { passive: true });
        // });

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€ ë¹„í™œì„±í™”
        // document.addEventListener('visibilitychange', () => {
        //   if (document.hidden) {
        //     this.refreshInterval = this.maxInterval;
        //     console.log('ğŸŒ™ í˜ì´ì§€ ìˆ¨ê¹€ - ìƒˆë¡œê³ ì¹¨ ì¼ì‹œì •ì§€');
        //   } else {
        //     this.detectActivity();
        //     this.performRefresh();
        //   }
        // });

        // ì´ˆê¸° ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”
        // setTimeout(() => this.performRefresh(), 5000);
      }

      /**
       * ë§¤ë‹ˆì € ì¤‘ì§€
       */
      stop() {
        if (this.refreshTimer) {
          clearTimeout(this.refreshTimer);
        }
        console.log('ğŸ›‘ [Phase 3] ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ë§¤ë‹ˆì € ì¤‘ì§€');
      }

      /**
       * í†µê³„ ì •ë³´
       */
      getStats() {
        return {
          interval: this.refreshInterval / 1000 + 'ì´ˆ',
          isActive: this.isActive,
          lastRefresh: new Date(this.lastRefresh).toLocaleTimeString(),
          changeCount: this.changeCount,
          noChangeCount: this.noChangeCount
        };
      }
    }

    // ì „ì—­ ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ë§¤ë‹ˆì € ìƒì„± (ë¹„í™œì„±í™”ë¨ - v12.0.0)
    // const smartRefresh = new SmartRefreshManager();
    // ìë™ ìƒˆë¡œê³ ì¹¨ ì™„ì „ ë¹„í™œì„±í™” - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ ì‚¬ìš©
    const smartRefresh = null;

    // ====================================
    // Phase 3: IndexedDB ë¡œì»¬ ì˜êµ¬ ì €ì¥ì†Œ
    // ====================================

    /**
     * IndexedDBë¥¼ í™œìš©í•œ ì˜êµ¬ ë¡œì»¬ ìºì‹œ
     * ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ë°ì´í„° ìœ ì§€
     */
    class LocalDataStore {
      constructor() {
        this.dbName = 'PokerHandDB';
        this.version = 1;
        this.db = null;
        this.isSupported = 'indexedDB' in window;
      }

      /**
       * ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
       */
      async init() {
        if (!this.isSupported) {
          console.warn('âš ï¸ IndexedDB ë¯¸ì§€ì›');
          return false;
        }

        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.version);

          request.onerror = () => {
            console.error('âŒ IndexedDB ì—´ê¸° ì‹¤íŒ¨');
            reject(request.error);
          };

          request.onsuccess = () => {
            this.db = request.result;
            console.log('âœ… [Phase 3] IndexedDB ì—°ê²° ì„±ê³µ');
            resolve(true);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // í•¸ë“œ ë°ì´í„° ì €ì¥ì†Œ
            if (!db.objectStoreNames.contains('hands')) {
              const handStore = db.createObjectStore('hands', { keyPath: 'handNumber' });
              handStore.createIndex('timestamp', 'timestamp', { unique: false });
              handStore.createIndex('status', 'status', { unique: false });
            }

            // ì‹œíŠ¸ ìºì‹œ ì €ì¥ì†Œ
            if (!db.objectStoreNames.contains('sheetCache')) {
              const cacheStore = db.createObjectStore('sheetCache', { keyPath: 'row' });
              cacheStore.createIndex('timestamp', 'timestamp', { unique: false });
            }

            // ì„¤ì • ì €ì¥ì†Œ
            if (!db.objectStoreNames.contains('settings')) {
              db.createObjectStore('settings', { keyPath: 'key' });
            }

            console.log('âœ… IndexedDB ìŠ¤í‚¤ë§ˆ ìƒì„± ì™„ë£Œ');
          };
        });
      }

      /**
       * í•¸ë“œ ë°ì´í„° ì €ì¥
       */
      async saveHand(handData) {
        if (!this.db) return;

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction(['hands'], 'readwrite');
          const store = transaction.objectStore('hands');
          const request = store.put(handData);

          request.onsuccess = () => resolve(true);
          request.onerror = () => reject(request.error);
        });
      }

      /**
       * ì—¬ëŸ¬ í•¸ë“œ ì¼ê´„ ì €ì¥
       */
      async saveMultipleHands(handsArray) {
        if (!this.db) return;

        const transaction = this.db.transaction(['hands'], 'readwrite');
        const store = transaction.objectStore('hands');

        const promises = handsArray.map(hand => {
          return new Promise((resolve, reject) => {
            const request = store.put(hand);
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
          });
        });

        try {
          await Promise.all(promises);
          console.log(`ğŸ’¾ [Phase 3] ${handsArray.length}ê°œ í•¸ë“œ ë¡œì»¬ ì €ì¥ ì™„ë£Œ`);
        } catch (error) {
          console.error('âŒ í•¸ë“œ ì €ì¥ ì‹¤íŒ¨:', error);
        }
      }

      /**
       * ì‹œíŠ¸ ìºì‹œ ì €ì¥
       */
      async saveSheetCache(cacheData) {
        if (!this.db) return;

        const transaction = this.db.transaction(['sheetCache'], 'readwrite');
        const store = transaction.objectStore('sheetCache');

        // ê¸°ì¡´ ë°ì´í„° í´ë¦¬ì–´
        await new Promise((resolve) => {
          const clearRequest = store.clear();
          clearRequest.onsuccess = () => resolve();
        });

        // ìƒˆ ë°ì´í„° ì €ì¥
        const promises = Array.from(cacheData.entries()).map(([row, data]) => {
          return new Promise((resolve, reject) => {
            const request = store.put({ row, ...data });
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
          });
        });

        try {
          await Promise.all(promises);
          console.log(`ğŸ’¾ [Phase 3] ì‹œíŠ¸ ìºì‹œ IndexedDB ì €ì¥: ${promises.length}í–‰`);
        } catch (error) {
          console.error('âŒ ì‹œíŠ¸ ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
        }
      }

      /**
       * ì‹œíŠ¸ ìºì‹œ ë¡œë“œ
       */
      async loadSheetCache() {
        if (!this.db) return new Map();

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction(['sheetCache'], 'readonly');
          const store = transaction.objectStore('sheetCache');
          const request = store.getAll();

          request.onsuccess = () => {
            const cacheMap = new Map();
            request.result.forEach(item => {
              cacheMap.set(item.row, item);
            });
            console.log(`ğŸ“‚ [Phase 3] IndexedDBì—ì„œ ìºì‹œ ë¡œë“œ: ${cacheMap.size}í–‰`);
            resolve(cacheMap);
          };

          request.onerror = () => reject(request.error);
        });
      }

      /**
       * ì„¤ì • ì €ì¥
       */
      async saveSetting(key, value) {
        if (!this.db) return;

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction(['settings'], 'readwrite');
          const store = transaction.objectStore('settings');
          const request = store.put({ key, value, timestamp: Date.now() });

          request.onsuccess = () => resolve(true);
          request.onerror = () => reject(request.error);
        });
      }

      /**
       * ì„¤ì • ë¡œë“œ
       */
      async loadSetting(key) {
        if (!this.db) return null;

        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction(['settings'], 'readonly');
          const store = transaction.objectStore('settings');
          const request = store.get(key);

          request.onsuccess = () => resolve(request.result?.value);
          request.onerror = () => reject(request.error);
        });
      }

      /**
       * ì „ì²´ ë°ì´í„° í¬ê¸° í™•ì¸
       */
      async getStorageSize() {
        if (!navigator.storage?.estimate) {
          return 0;
        }

        try {
          const estimate = await navigator.storage.estimate();
          return estimate.usage || 0; // bytes ë‹¨ìœ„ë¡œ ë°˜í™˜
        } catch (error) {
          console.error('Storage í¬ê¸° í™•ì¸ ì‹¤íŒ¨:', error);
          return 0;
        }
      }

      /**
       * ëª¨ë“  ë°ì´í„° ì‚­ì œ
       */
      async clearAll() {
        if (!this.db) return;

        return new Promise((resolve, reject) => {
          try {
            const transaction = this.db.transaction(['hands', 'sheetCache', 'settings'], 'readwrite');

            // ê° ìŠ¤í† ì–´ í´ë¦¬ì–´
            const handsStore = transaction.objectStore('hands');
            const sheetStore = transaction.objectStore('sheetCache');
            const settingsStore = transaction.objectStore('settings');

            handsStore.clear();
            sheetStore.clear();
            settingsStore.clear();

            transaction.oncomplete = () => {
              console.log('âœ… IndexedDB ëª¨ë“  ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
              resolve();
            };

            transaction.onerror = () => reject(transaction.error);
          } catch (error) {
            reject(error);
          }
        });
      }

      /**
       * ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
       */
      async clear() {
        if (!this.db) return;

        const stores = ['hands', 'sheetCache', 'settings'];
        const transaction = this.db.transaction(stores, 'readwrite');

        const promises = stores.map(storeName => {
          return new Promise((resolve) => {
            const store = transaction.objectStore(storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
          });
        });

        await Promise.all(promises);
        console.log('ğŸ§¹ [Phase 3] IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');
      }
    }

    // ì „ì—­ ë¡œì»¬ ì €ì¥ì†Œ ì¸ìŠ¤í„´ìŠ¤
    const localStore = new LocalDataStore();

    /**
     * Google Sheets URLì„ CSV ë‹¤ìš´ë¡œë“œ URLë¡œ ë³€í™˜
     */
    function convertToCSVUrl(sheetUrl) {
      if (!sheetUrl) return null;

      // ì´ë¯¸ CSV URLì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
      if (sheetUrl.includes('/export?format=csv')) {
        return sheetUrl;
      }

      // ì‹œíŠ¸ ID ì¶”ì¶œ
      const idMatch = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!idMatch) {
        console.error('ì˜ëª»ëœ ì‹œíŠ¸ URL í˜•ì‹:', sheetUrl);
        return null;
      }

      const spreadsheetId = idMatch[1];

      // GID ì¶”ì¶œ (ì˜µì…˜)
      const gidMatch = sheetUrl.match(/[#&]gid=([0-9]+)/);
      const gid = gidMatch ? gidMatch[1] : '0';

      // CSV ë‹¤ìš´ë¡œë“œ URL ìƒì„±
      return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
    }

    // ë²„ì „ ì²´í¬ ë° ê°•ì œ ì—…ë°ì´íŠ¸
    function checkVersion() {
      const storedVersion = localStorage.getItem('app_version');
      if (storedVersion !== APP_VERSION) {
        console.log(`ğŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸ ê°ì§€: ${storedVersion || 'ì—†ìŒ'} â†’ ${APP_VERSION}`);

        // ë²„ì „ ë¹„êµ í•¨ìˆ˜ (ë¬¸ìì—´ ë²„ì „ì„ ìˆ«ìë¡œ ë³€í™˜)
        const compareVersions = (v1, v2) => {
          const parts1 = v1.split('.').map(Number);
          const parts2 = v2.split('.').map(Number);

          for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const part1 = parts1[i] || 0;
            const part2 = parts2[i] || 0;

            if (part1 > part2) return 1;
            if (part1 < part2) return -1;
          }
          return 0;
        };

        // ë²„ì „ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ (ì €ì¥ëœ ë²„ì „ì´ ì—†ê±°ë‚˜ í˜„ì¬ ë²„ì „ë³´ë‹¤ ë‚®ì„ ë•Œë§Œ)
        if (!storedVersion || compareVersions(storedVersion, APP_VERSION) < 0) {
          console.log('ğŸ§¹ ìºì‹œ ì´ˆê¸°í™” ì¤‘...');
          // ì¤‘ìš”í•œ ì„¤ì •ì€ ë³´ì¡´
          const keepSettings = {
            'GEMINI_API_KEY': localStorage.getItem('GEMINI_API_KEY'),
            'read_sheet_url': localStorage.getItem('read_sheet_url'),
            'write_sheet_url': localStorage.getItem('write_sheet_url'),
            'sheet_update_script_url': localStorage.getItem('sheet_update_script_url')
          };

          // ìºì‹œ í´ë¦¬ì–´
          localStorage.clear();
          sessionStorage.clear();

          // ì¤‘ìš” ì„¤ì • ë³µì›
          Object.keys(keepSettings).forEach(key => {
            if (keepSettings[key]) {
              localStorage.setItem(key, keepSettings[key]);
            }
          });

          // ìƒˆ ë²„ì „ ì €ì¥
          localStorage.setItem('app_version', APP_VERSION);
          localStorage.setItem('build_time', BUILD_TIME);

          // ìƒˆ ë²„ì „ ê°ì§€ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨
          console.log('ğŸš€ ìƒˆ ë²„ì „ ê°ì§€ - í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...');

          // ê°•ì œ ë¦¬ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
          setTimeout(() => {
            location.reload(true);
          }, 1000);
          return true;
        } else {
          // ë²„ì „ì´ ê°™ê±°ë‚˜ ë†’ìœ¼ë©´ ì €ì¥ë§Œ í•˜ê³  ë¦¬ë¡œë“œí•˜ì§€ ì•ŠìŒ
          localStorage.setItem('app_version', APP_VERSION);
          localStorage.setItem('build_time', BUILD_TIME);
        }
      }
      return false;
    }
    
    const CONFIG = {
      // Google Sheets CSV URLs
      CSV_HAND_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1906746276&single=true&output=csv',
      CSV_INDEX_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1354012271&single=true&output=csv',
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzbya-VriY5oEDOEO4W80VJz4GaY6QhBb38-3JvSrwl5Qo-7K8D0jqbjTO06bO6VAYj/exec',
      
      // ì„¤ì •
      REFRESH_INTERVAL: 10000,
      ENABLE_NOTIFICATIONS: true,
      ENABLE_SOUND: true,
      DEBUG_MODE: false, // ìš´ì˜ í™˜ê²½ìš©
      
      // AI API ì„¤ì • (Gemini ì „ìš©)
      AI_PROVIDER: 'gemini',
      GEMINI_API_KEY: '', // GitHub Secretsì—ì„œ ìë™ ì„¤ì •ë¨
      
      // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„¤ì • (ë‹¨ì¼ ì‹œíŠ¸ë¡œ í†µí•©)
      MAIN_SHEET_URL: 'https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/edit?gid=561799849#gid=561799849', // ë©”ì¸ ì‹œíŠ¸ URL (ì½ê¸°/ì“°ê¸° ëª¨ë‘ ì‚¬ìš©)
      SHEET_UPDATE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzbya-VriY5oEDOEO4W80VJz4GaY6QhBb38-3JvSrwl5Qo-7K8D0jqbjTO06bO6VAYj/exec', // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì „ìš© Apps Script URL (APPS_SCRIPT_URLê³¼ í†µì¼)
      
      // ê¸°ì¡´ URLë“¤ (í˜¸í™˜ì„± ìœ ì§€ìš© - ì¶”í›„ ì œê±° ì˜ˆì •)
      READ_SHEET_URL: '', // Deprecated - MAIN_SHEET_URL ì‚¬ìš©
      WRITE_SHEET_URL: '' // Deprecated - MAIN_SHEET_URL ì‚¬ìš©
    };
    
    // ì‹œíŠ¸ URL í—¬í¼ í•¨ìˆ˜ (ë‹¨ì¼ ì‹œíŠ¸ ê´€ë¦¬)
    function getSheetUrl() {
      // MAIN_SHEET_URLì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ WRITE_SHEET_URL ì‚¬ìš© (í˜¸í™˜ì„±)
      return CONFIG.MAIN_SHEET_URL || CONFIG.WRITE_SHEET_URL || CONFIG.READ_SHEET_URL;
    }

    function getAppsScriptUrl() {
      // Apps Script URL ê°€ì ¸ì˜¤ê¸° (DOM ìš°ì„ , ì—†ìœ¼ë©´ CONFIG)
      const appsScriptUrlInput = document.getElementById('apps-script-url');
      let url = appsScriptUrlInput ? appsScriptUrlInput.value.trim() : '';

      // ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ CONFIG ì‚¬ìš©
      if (!url) {
        url = CONFIG.SHEET_UPDATE_SCRIPT_URL || '';
      }

      // ë””ë²„ê·¸ ë¡œê·¸
      if (!url) {
        console.warn('âš ï¸ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        console.log('   ì…ë ¥ í•„ë“œ:', appsScriptUrlInput ? appsScriptUrlInput.value : 'N/A');
        console.log('   CONFIG ê°’:', CONFIG.SHEET_UPDATE_SCRIPT_URL);
      }

      return url;
    }

    function getSheetCsvUrl() {
      const sheetUrl = getSheetUrl();
      if (!sheetUrl) return null;
      
      // ì´ë¯¸ CSV URLì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
      if (sheetUrl.includes('/pub?') && sheetUrl.includes('output=csv')) {
        return sheetUrl;
      }
      
      // ì¼ë°˜ URLì„ ì›¹ ê²Œì‹œ CSV URLë¡œ ë³€í™˜
      const sheetIdMatch = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      const gidMatch = sheetUrl.match(/[#&]gid=([0-9]+)/);
      
      if (sheetIdMatch) {
        const sheetId = sheetIdMatch[1];
        const gid = gidMatch ? gidMatch[1] : '0';
        
        // ë¨¼ì € ì›¹ ê²Œì‹œ URL ì‹œë„ (2PACX í˜•ì‹ì´ ìˆë‹¤ë©´)
        // ì—†ìœ¼ë©´ export URL ì‚¬ìš©
        return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
      }
      
      return null;
    }
    
    // ì „ì—­ ìƒíƒœ
    let currentHand = null;
    let allHands = [];
    let masterHandList = new Map(); // ì˜êµ¬ ì €ì¥ìš© ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡
    const MASTER_LIST_KEY = 'poker_master_hand_list_v1';
    let handData = {};
    let refreshTimerInitial = null;  // ì´ˆê¸° setTimeoutìš©
    let refreshTimerInterval = null;  // ë°˜ë³µ setIntervalìš©
    let lastHandCount = 0;
    let isInitialLoad = true; // ì²« ë¡œë”©ì¸ì§€ í™•ì¸
    
    // ìµœê·¼ 5ê°œ í•¸ë“œë§Œ ì¶”ì í•˜ëŠ” ê°„ë‹¨í•œ ë²„í¼
    class RecentHandsBuffer {
      constructor() {
        this.buffer = [];
        this.maxSize = 100; // 5ê°œëŠ” ë„ˆë¬´ ì ìŒ, 100ê°œë¡œ ì¦ê°€
        this.storageKey = 'poker_recent_hands_buffer_v2'; // ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
        this.loadFromStorage();
      }
      
      // ìƒˆ í•¸ë“œ ì¶”ê°€ (ì¤‘ë³µ ì²´í¬ í¬í•¨)
      addHand(handNumber) {
        const handStr = String(handNumber);
        
        // ì´ë¯¸ ë²„í¼ì— ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        if (this.buffer.includes(handStr)) {
          return false; // ì¤‘ë³µ
        }
        
        // ë²„í¼ì— ì¶”ê°€
        this.buffer.push(handStr);
        
        // ìµœëŒ€ í¬ê¸° ì´ˆê³¼ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°
        while (this.buffer.length > this.maxSize) {
          this.buffer.shift();
        }
        
        this.saveToStorage();
        return true; // ìƒˆ í•¸ë“œ
      }
      
      // í•¸ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      hasHand(handNumber) {
        return this.buffer.includes(String(handNumber));
      }
      
      // ë²„í¼ ìƒíƒœ í™•ì¸
      getStatus() {
        return {
          buffer: [...this.buffer],
          size: this.buffer.length,
          maxSize: this.maxSize
        };
      }
      
      // localStorageì—ì„œ ë¡œë“œ
      loadFromStorage() {
        try {
          const stored = localStorage.getItem(this.storageKey);
          if (stored) {
            this.buffer = JSON.parse(stored) || [];
            console.log(`ğŸ’¾ ìµœê·¼ í•¸ë“œ ë²„í¼ ë¡œë“œ: ${this.buffer.length}ê°œ`);
          }
        } catch (e) {
          console.error('ë²„í¼ ë¡œë“œ ì‹¤íŒ¨:', e);
          this.buffer = [];
        }
      }
      
      // localStorageì— ì €ì¥
      saveToStorage() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.buffer));
        } catch (e) {
          console.error('ë²„í¼ ì €ì¥ ì‹¤íŒ¨:', e);
        }
      }
      
      // ë²„í¼ ì´ˆê¸°í™”
      clear() {
        this.buffer = [];
        this.saveToStorage();
        console.log('ğŸ”„ ìµœê·¼ í•¸ë“œ ë²„í¼ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    }
    
    // ì „ì—­ ë²„í¼ ì¸ìŠ¤í„´ìŠ¤
    const recentHandsBuffer = new RecentHandsBuffer();
    
    // ê¸°ì¡´ ì•Œë¦¼ ê´€ë ¨ ì„¤ì •
    const STORAGE_KEY = 'poker_notified_hands_v3';
    const MAX_STORED_HANDS = 500;
    const NOTIFICATION_COOLDOWN = 30000; // 30ì´ˆ ì¿¨ë‹¤ìš´
    
    // ë””ë²„ê·¸ ëª¨ë“œ
    const DEBUG_MODE = true; // ì½˜ì†”ì— ìƒì„¸ ë¡œê·¸ ì¶œë ¥
    
    
    // ì•Œë¦¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹œê°„ ì •ë³´ í¬í•¨)
    function getNotifiedHands() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          // ê°ì²´ í˜•íƒœë¡œ ì €ì¥ (handNumber: timestamp)
          const hands = data.hands || {};
          console.log(`ğŸ“š ì•Œë¦¼ ê¸°ë¡ ë¡œë“œ: ${Object.keys(hands).length}ê°œ í•¸ë“œ`);
          return hands;
        }
      } catch (e) {
        console.error('ì•Œë¦¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
      }
      console.log('ğŸ“š ì•Œë¦¼ ê¸°ë¡ ì—†ìŒ - ìƒˆë¡œ ì‹œì‘');
      return {};
    }
    
    // ì•Œë¦¼ ê¸°ë¡ ì €ì¥ (ì‹œê°„ ì •ë³´ í¬í•¨)
    // ì¤‘ìš”: í•œ ë²ˆ ì•Œë¦¼ì„ í‘œì‹œí•œ í•¸ë“œëŠ” CSVì—ì„œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ë¼ì ¸ë„ 
    // ìµœì†Œ 24ì‹œê°„ ë™ì•ˆì€ ê¸°ë¡ì„ ìœ ì§€í•˜ì—¬ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€
    function saveNotifiedHands(handsMap) {
      try {
        // ë„ˆë¬´ ì˜¤ë˜ëœ ê¸°ë¡ë§Œ ì œê±° (24ì‹œê°„ ì´ìƒ)
        // CSV ì§€ì—°ìœ¼ë¡œ ì¸í•´ í•¸ë“œê°€ ì ì‹œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
        // 7ì¼ì´ ì•„ë‹Œ 24ì‹œê°„ìœ¼ë¡œ ë‹¨ì¶•í•˜ì—¬ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ
        const now = Date.now();
        const oneDayAgo = now - (24 * 60 * 60 * 1000);
        const cleanedHands = {};
        
        // ê¸°ì¡´ ì €ì¥ëœ ëª¨ë“  í•¸ë“œ ìœ ì§€ (24ì‹œê°„ ë‚´)
        const existingData = getNotifiedHands();
        for (const [handNumber, timestamp] of Object.entries(existingData)) {
          if (timestamp > oneDayAgo) {
            cleanedHands[handNumber] = timestamp;
          }
        }
        
        // ìƒˆë¡œìš´ í•¸ë“œ ì¶”ê°€/ì—…ë°ì´íŠ¸
        for (const [handNumber, timestamp] of Object.entries(handsMap)) {
          cleanedHands[handNumber] = timestamp;
        }
        
        // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
        const entries = Object.entries(cleanedHands);
        if (entries.length > MAX_STORED_HANDS) {
          // ê°€ì¥ ì˜¤ë˜ëœ ê²ƒë“¤ ì œê±°
          entries.sort((a, b) => a[1] - b[1]);
          const toKeep = entries.slice(-MAX_STORED_HANDS);
          const finalHands = {};
          toKeep.forEach(([handNumber, timestamp]) => {
            finalHands[handNumber] = timestamp;
          });
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            hands: finalHands,
            lastUpdated: new Date().toISOString()
          }));
        } else {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            hands: cleanedHands,
            lastUpdated: new Date().toISOString()
          }));
        }
        
        if (DEBUG_MODE) {
          console.log(`ğŸ’¾ ì•Œë¦¼ ê¸°ë¡ ì €ì¥: ì´ ${Object.keys(cleanedHands).length}ê°œ í•¸ë“œ ê¸°ë¡ ìœ ì§€`);
        }
      } catch (e) {
        console.error('ì•Œë¦¼ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }
    
    // ì•Œë¦¼ ê¸°ë¡ ì´ˆê¸°í™” (ê°ì²´ í˜•íƒœ: {handNumber: timestamp})
    let notifiedHands = getNotifiedHands();
    let lastDataSnapshot = ''; // ë§ˆì§€ë§‰ ë°ì´í„° ìŠ¤ëƒ…ìƒ· (ë°ì´í„° ë³€ê²½ ê°ì§€ìš©)
    
    // ====================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ====================================
    
    // Google Sheets CSV Fetch í•¨ìˆ˜ (GitHub ì €ì¥ì†Œ ë°©ì‹ + í”„ë¡ì‹œ fallback)
    async function fetchCsvWithFallback(url) {
      // console.log(`ğŸ”„ CSV ê°€ì ¸ì˜¤ê¸° ì‹œë„: ${url}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      
      try {
        // ë°©ë²• 1: GitHub ì €ì¥ì†Œì™€ ë™ì¼í•œ ì§ì ‘ fetch
        console.log('ğŸ”„ ë°©ë²• 1: ì§ì ‘ fetch ì‹œë„ (GitHub ë°©ì‹)');
        const res = await fetch(url);
        
        // console.log(`ğŸ“Š HTTP ì‘ë‹µ: ${res.status} ${res.statusText}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        if (!res.ok) {
          throw new Error(`CSV fetch failed: ${res.status}`);
        }
        
        const txt = await res.text();
        // console.log(`âœ… ì§ì ‘ ë°©ë²• ì„±ê³µ: ${txt.length}ê¸€ì`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        return { 
          response: {
            ok: true,
            status: res.status,
            statusText: res.statusText,
            headers: { get: (key) => res.headers.get(key) }
          },
          fetchMethod: 'ì§ì ‘ fetch (GitHub ë°©ì‹)',
          csvText: txt
        };
        
      } catch (error) {
        console.log(`âŒ ì§ì ‘ ë°©ë²• ì‹¤íŒ¨: ${error.message}`);
        console.log('ğŸ’¡ CORS ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í”„ë¡ì‹œ ë°©ë²•ì„ ì‹œë„í•©ë‹ˆë‹¤.');
        
        // ë°©ë²• 2: í”„ë¡ì‹œ (CORS ìš°íšŒ)
        try {
          console.log('ğŸ”„ ë°©ë²• 2: AllOrigins í”„ë¡ì‹œ ì‹œë„');
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
          const proxyResponse = await fetch(proxyUrl);
          
          if (!proxyResponse.ok) {
            throw new Error(`í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: ${proxyResponse.status}`);
          }
          
          const proxyData = await proxyResponse.json();
          
          if (!proxyData.contents) {
            throw new Error('í”„ë¡ì‹œì—ì„œ ë¹ˆ ë°ì´í„° ë°˜í™˜');
          }
          
          let csvText = proxyData.contents;
          
          // Base64ë¡œ ì¸ì½”ë”©ëœ ë°ì´í„°ì¸ì§€ í™•ì¸ ë° ë””ì½”ë”©
          if (csvText.startsWith('data:text/csv;base64,')) {
            console.log('ğŸ”„ Base64 ì¸ì½”ë”© ë°ì´í„° ê°ì§€ - ë””ì½”ë”© ì¤‘...');
            const base64Data = csvText.replace('data:text/csv;base64,', '');
            try {
              csvText = atob(base64Data);
              console.log(`âœ… Base64 ë””ì½”ë”© ì„±ê³µ: ${csvText.length}ê¸€ì`);
            } catch (decodeError) {
              console.error(`âŒ Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`);
              throw new Error(`Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`);
            }
          }
          
          console.log(`âœ… í”„ë¡ì‹œ ë°©ë²• ì„±ê³µ: ${csvText.length}ê¸€ì`);
          
          return {
            response: {
              ok: true,
              status: 200,
              statusText: 'OK (via Proxy)'
            },
            fetchMethod: 'AllOrigins í”„ë¡ì‹œ',
            csvText: csvText
          };
          
        } catch (error2) {
          console.log(`âŒ í”„ë¡ì‹œ ë°©ë²• ì‹¤íŒ¨: ${error2.message}`);
          
          // ë°©ë²• 3: cors-anywhere ë°±ì—… í”„ë¡ì‹œ
          try {
            console.log('ğŸ”„ ë°©ë²• 3: cors-anywhere í”„ë¡ì‹œ ì‹œë„');
            const corsUrl = `https://cors-anywhere.herokuapp.com/${url}`;
            const corsResponse = await fetch(corsUrl);
            
            if (!corsResponse.ok) {
              throw new Error(`CORS í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: ${corsResponse.status}`);
            }
            
            const corsTxt = await corsResponse.text();
            console.log(`âœ… CORS í”„ë¡ì‹œ ë°©ë²• ì„±ê³µ: ${corsTxt.length}ê¸€ì`);
            
            return {
              response: {
                ok: true,
                status: 200,
                statusText: 'OK (via CORS Proxy)'
              },
              fetchMethod: 'CORS Anywhere í”„ë¡ì‹œ',
              csvText: corsTxt
            };
            
          } catch (error3) {
            console.log(`âŒ CORS í”„ë¡ì‹œ ë°©ë²• ì‹¤íŒ¨: ${error3.message}`);
            throw new Error(`ëª¨ë“  CSV fetch ë°©ë²• ì‹¤íŒ¨. ì§ì ‘: ${error.message}, AllOrigins: ${error2.message}, CORS-Anywhere: ${error3.message}`);
          }
        }
      }
    }

    // CSV íŒŒì‹± ê²°ê³¼ ìºì‹œ (v12.5.0 ì„±ëŠ¥ ìµœì í™”)
    const csvParseCache = new Map();

    function parseCSV(text) {
      // ìºì‹œ í‚¤ ìƒì„± (í…ìŠ¤íŠ¸ í•´ì‹œ ëŒ€ì‹  ê¸¸ì´ì™€ ì²«/ë§ˆì§€ë§‰ 100ì ì‚¬ìš©)
      const cacheKey = `${text.length}_${text.substring(0, 100)}_${text.substring(text.length - 100)}`;

      // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
      if (csvParseCache.has(cacheKey)) {
        const cached = csvParseCache.get(cacheKey);
        console.log(`ğŸš€ CSV íŒŒì‹± ìºì‹œ íˆíŠ¸: ${cached.length}ê°œ í–‰ (ìºì‹œ í¬ê¸°: ${csvParseCache.size})`);
        return cached;
      }

      // Papa Parseê°€ ìˆìœ¼ë©´ ì‚¬ìš© (RFC 4180 í‘œì¤€ ì¤€ìˆ˜)
      if (typeof Papa !== 'undefined') {
        const result = Papa.parse(text, {
          header: false,           // í—¤ë” ì—†ìŒ
          skipEmptyLines: true,    // ë¹ˆ ì¤„ ê±´ë„ˆë›°ê¸°
          quotes: true,            // í°ë”°ì˜´í‘œ ì²˜ë¦¬ í™œì„±í™”
          quoteChar: '"',          // í°ë”°ì˜´í‘œ ë¬¸ì
          escapeChar: '"',         // ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì
          delimiter: ',',          // êµ¬ë¶„ì
          newline: '',             // ìë™ ê°ì§€
          dynamicTyping: false     // íƒ€ì… ìë™ ë³€í™˜ ë¹„í™œì„±í™”
        });

        if (result.errors.length > 0) {
          console.warn('CSV íŒŒì‹± ê²½ê³ :', result.errors);
        }

        console.log(`ğŸ“Š Papa Parse ì‚¬ìš©: ${result.data.length}ê°œ í–‰ íŒŒì‹± ì™„ë£Œ`);

        // ìºì‹œì— ì €ì¥ (ìµœëŒ€ 5ê°œê¹Œì§€ ìœ ì§€)
        if (csvParseCache.size >= 5) {
          const firstKey = csvParseCache.keys().next().value;
          csvParseCache.delete(firstKey);
        }
        csvParseCache.set(cacheKey, result.data);
        console.log(`ğŸ’¾ CSV íŒŒì‹± ê²°ê³¼ ìºì‹œ ì €ì¥ (ìºì‹œ í¬ê¸°: ${csvParseCache.size})`);

        return result.data;
      }

      // Papa Parseê°€ ì—†ìœ¼ë©´ ê°œì„ ëœ ì»¤ìŠ¤í…€ íŒŒì„œ ì‚¬ìš© (RFC 4180 ì¤€ìˆ˜)
      console.log('ğŸ“Š ì»¤ìŠ¤í…€ CSV íŒŒì„œ ì‚¬ìš© (RFC 4180 ì¤€ìˆ˜)');

      const rows = [];
      let currentRow = [];
      let currentField = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (char === '"') {
          if (inQuotes) {
            if (nextChar === '"') {
              // ì´ìŠ¤ì¼€ì´í”„ëœ í°ë”°ì˜´í‘œ ("" â†’ ")
              currentField += '"';
              i++; // ë‹¤ìŒ ë”°ì˜´í‘œ ê±´ë„ˆë›°ê¸°
            } else {
              // í•„ë“œ ì¢…ë£Œ í°ë”°ì˜´í‘œ
              inQuotes = false;
            }
          } else if (currentField === '' || i === 0 || text[i-1] === ',' || text[i-1] === '\n') {
            // í•„ë“œ ì‹œì‘ í°ë”°ì˜´í‘œ
            inQuotes = true;
          } else {
            // ì¼ë°˜ ë¬¸ìë¡œì„œì˜ í°ë”°ì˜´í‘œ (í‘œì¤€ ìœ„ë°˜ì´ì§€ë§Œ ì²˜ë¦¬)
            currentField += char;
          }
        } else if (char === ',' && !inQuotes) {
          // í•„ë“œ êµ¬ë¶„ì
          currentRow.push(currentField);
          currentField = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          // í–‰ êµ¬ë¶„ì
          if (char === '\r' && nextChar === '\n') {
            i++; // CRLFì˜ ê²½ìš° LF ê±´ë„ˆë›°ê¸°
          }
          if (currentField !== '' || currentRow.length > 0) {
            currentRow.push(currentField);
            if (currentRow.some(field => field !== '')) {
              rows.push(currentRow);
            }
            currentRow = [];
            currentField = '';
          }
        } else if (char === '\r' && nextChar !== '\n' && !inQuotes) {
          // ë‹¨ë… CR (êµ¬ì‹ Mac)
          currentRow.push(currentField);
          if (currentRow.some(field => field !== '')) {
            rows.push(currentRow);
          }
          currentRow = [];
          currentField = '';
        } else {
          // ì¼ë°˜ ë¬¸ì (ì¤„ë°”ê¿ˆ í¬í•¨)
          currentField += char;
        }
      }

      // ë§ˆì§€ë§‰ í•„ë“œì™€ í–‰ ì²˜ë¦¬
      if (currentField !== '' || currentRow.length > 0) {
        currentRow.push(currentField);
        if (currentRow.some(field => field !== '')) {
          rows.push(currentRow);
        }
      }

      console.log(`ğŸ“Š ì»¤ìŠ¤í…€ íŒŒì„œ: ${rows.length}ê°œ í–‰ íŒŒì‹± ì™„ë£Œ`);

      // ìºì‹œì— ì €ì¥ (ìµœëŒ€ 5ê°œê¹Œì§€ ìœ ì§€)
      if (csvParseCache.size >= 5) {
        const firstKey = csvParseCache.keys().next().value;
        csvParseCache.delete(firstKey);
      }
      csvParseCache.set(cacheKey, rows);
      console.log(`ğŸ’¾ CSV íŒŒì‹± ê²°ê³¼ ìºì‹œ ì €ì¥ (ìºì‹œ í¬ê¸°: ${csvParseCache.size})`);

      return rows;
    }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(num);
    }
    
    function getSuitSymbol(suit) {
      const symbols = {
        's': 'â™ ', 'h': 'â™¥', 'd': 'â™¦', 'c': 'â™£',
        'S': 'â™ ', 'H': 'â™¥', 'D': 'â™¦', 'C': 'â™£',
        '1': 'â™ ', '2': 'â™¥', '3': 'â™¦', '4': 'â™£'  // ìˆ«ì í˜•ì‹ë„ ì§€ì›
      };
      return symbols[suit] || symbols[suit.toLowerCase()] || '';
    }
    
    function getSuitClass(suit) {
      const classes = {
        's': 'spade', 'h': 'heart', 'd': 'diamond', 'c': 'club'
      };
      return classes[suit.toLowerCase()] || '';
    }
    
    function createCardElement(card, type = 'mini') {
      if (!card || card === '?' || card.length < 2) {
        // ì•Œ ìˆ˜ ì—†ëŠ” ì¹´ë“œë„ í°ìƒ‰ ë°”íƒ•ìœ¼ë¡œ í‘œì‹œ (ë‹¤í¬ëª¨ë“œ ë¬´ì‹œ)
        return `<div class="${type === 'board' ? 'board-card' : 'card-mini'}" style="background-color: #FFFFFF !important; color: #6b7280; border-style: dashed; color-scheme: light;">?</div>`;
      }
      
      // 10ê³¼ T ëª¨ë‘ ì²˜ë¦¬ ê°€ëŠ¥í•œ íŒŒì‹±
      let rank, suit;
      if (card.startsWith('10')) {
        rank = 'T';  // 10ì„ Të¡œ í‘œì‹œ
        suit = card.substring(2);
      } else if (card[0] === 'T' || card[0] === 't') {
        rank = 'T';  // TëŠ” ê·¸ëŒ€ë¡œ Të¡œ í‘œì‹œ
        suit = card.slice(-1);
      } else {
        rank = card.slice(0, -1);
        suit = card.slice(-1);
      }
      
      // ë­í¬ ëŒ€ë¬¸ì ë³€í™˜
      rank = rank.toUpperCase();
      
      const suitClass = getSuitClass(suit);
      const suitSymbol = getSuitSymbol(suit);
      
      // ìŠ¤í˜ì´ë“œ/í´ë¡œë²„ëŠ” ê²€ì€ìƒ‰, í•˜íŠ¸/ë‹¤ì´ì•„ëŠ” ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ê°•ì œ ì„¤ì •
      const textColor = (suit === 's' || suit === 'c') ? '#000000' : '#dc2626';
      
      // ì¹´ë“œì— ë­í¬ì™€ ë¬¸ì–‘ í‘œì‹œ
      return `<div class="${type === 'board' ? 'board-card' : 'card-mini'} ${suitClass}" style="background-color: #FFFFFF !important; color: ${textColor} !important; color-scheme: light;">
        <div style="display: flex; align-items: center; gap: 2px; color: ${textColor} !important;">
          <span style="font-weight: 900; color: ${textColor} !important;">${rank}</span>
          <span style="font-size: ${type === 'board' ? '16px' : '12px'}; color: ${textColor} !important;">${suitSymbol}</span>
        </div>
      </div>`;
    }
    
    function getActionBadgeClass(action) {
      const actionMap = {
        'FOLD': 'fold',
        'CHECK': 'check',
        'CALL': 'call',
        'CHECK/CALL': 'call',  // CHECK/CALL í†µí•© ì²˜ë¦¬
        'BET': 'bet',
        'RAISE': 'raise',
        'RAISE TO': 'raise',
        'ALL-IN': 'allin',
        'ALLIN': 'allin'
      };
      return actionMap[action.toUpperCase()] || 'check';
    }
    
    // ì•¡ì…˜ í‘œì‹œ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜ (ì´ë¯¸ ë³€í™˜ëœ ë°ì´í„°ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜)
    function getActionDisplayText(action) {
      if (!action) return '-';
      // ì´ë¯¸ íŒŒì‹± ë‹¨ê³„ì—ì„œ CHECK/CALLë¡œ ë³€í™˜ë˜ì—ˆìŒ
      return action.toUpperCase();
    }
    
    function getPositionBadgeClass(position) {
      const posMap = {
        'BTN': 'btn',
        'SB': 'sb',
        'BB': 'bb',
        'UTG': 'utg',
        'MP': 'mp',
        'CO': 'co'
      };
      return posMap[position] || '';
    }
    
    // ì¹´ë©”ë¼ íŒŒì¼ëª… ë³€í™˜ í•¨ìˆ˜
    function formatCameraFileName(camFiles) {
      if (!camFiles || camFiles.length === 0) return [];
      
      const formattedFiles = [];
      
      // ì¹´ë©”ë¼ ì´ë¦„ê³¼ ë²ˆí˜¸ë¥¼ í˜ì–´ë¡œ ì²˜ë¦¬
      for (let i = 0; i < camFiles.length; i += 2) {
        const camName = camFiles[i];
        const camNumber = camFiles[i + 1];
        
        if (camName && camNumber) {
          // ìˆ«ìë¥¼ 4ìë¦¬ë¡œ íŒ¨ë”© (ì˜ˆ: 115 -> 0115)
          const paddedNumber = String(camNumber).padStart(4, '0');
          formattedFiles.push(camName + paddedNumber);
        } else if (camName && !camNumber) {
          // ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì¶”ê°€
          formattedFiles.push(camName);
        }
      }
      
      return formattedFiles;
    }
    
    // ====================================
    // ê°„ë‹¨í•œ ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
    // ====================================
    
    function isCSVDataValid(newData) {
      // ê¸°ë³¸ì ì¸ ë°ì´í„° ìœ íš¨ì„±ë§Œ ì²´í¬
      if (!newData || newData.length === 0) {
        console.warn('âš ï¸ CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');
        return false;
      }
      
      // í•¸ë“œ ë²ˆí˜¸ê°€ ìˆëŠ” ë°ì´í„° í™•ì¸
      const validHands = newData.filter(h => h.handNumber && !isNaN(parseInt(h.handNumber)));
      if (validHands.length === 0) {
        console.warn('âš ï¸ ìœ íš¨í•œ í•¸ë“œê°€ ì—†ìŒ');
        return false;
      }
      
      return true;
    }
    
    // ====================================
    // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    // ====================================
    
    async function loadIndexData(suppressNotification = false) {
      console.log(`ğŸ”„ loadIndexData í˜¸ì¶œ - ì•Œë¦¼ ì–µì œ: ${suppressNotification}, ì´ˆê¸°ë¡œë“œ: ${isInitialLoad}`);
      console.log(`ğŸ“Š CONFIG.CSV_INDEX_URL: ${CONFIG.CSV_INDEX_URL}`); // ë””ë²„ê¹…ìš© í™œì„±í™”

      // ì´ˆê¸° ë¡œë“œ ì‹œ ë™ê¸°í™” íŒì—… í‘œì‹œ
      if (isInitialLoad && !suppressNotification) {
        initSyncManager.updateStep('data', 'running', 'ë°ì´í„° ë™ê¸°í™” ì¤‘...');
        initSyncManager.addLog('Google Sheets ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
      }

      try {
        // ëœë¤ íŒŒë¼ë¯¸í„° ì¶”ê°€ë¡œ ìºì‹œ ë°©ì§€ ê°•í™”
        const randomParam = Math.random().toString(36).substring(7);
        const csvUrl = CONFIG.CSV_INDEX_URL + '&t=' + Date.now() + '&r=' + randomParam;
        console.log(`ğŸŒ CSV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°: ${csvUrl.substring(0, 100)}...`); // ë””ë²„ê¹…ìš© í™œì„±í™”
        
        // CORS ë¬¸ì œë¥¼ ìœ„í•œ ëŒ€ì•ˆ ì‹œë„
        let text;
        try {
          const response = await fetch(csvUrl);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          text = await response.text();
        } catch (error) {
          if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
            console.log('ğŸ”„ CORS ì˜¤ë¥˜ ê°ì§€, í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•œ ì¬ì‹œë„...');
            // ê°„ë‹¨í•œ CORS í”„ë¡ì‹œ ì‹œë„
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl);
            const proxyResponse = await fetch(proxyUrl);
            if (!proxyResponse.ok) {
              throw new Error(`í”„ë¡ì‹œ ì„œë²„ ì˜¤ë¥˜: ${proxyResponse.status}`);
            }
            text = await proxyResponse.text();
            console.log('âœ… í”„ë¡ì‹œë¥¼ í†µí•œ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
          } else {
            throw error;
          }
        }
        // console.log(`ğŸ“„ CSV ì›ë³¸ ë°ì´í„° í¬ê¸°: ${text.length}ë¬¸ì`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        const rows = parseCSV(text);
        console.log(`ğŸ“„ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}ê°œ`);
        console.log(`ğŸ“„ ì²« ë²ˆì§¸ í–‰:`, rows[0]);
        console.log(`ğŸ“„ ë‘ ë²ˆì§¸ í–‰:`, rows[1]);
        
        const dataRows = rows.slice(1);
        
        // CSVì—ì„œ ì½ì€ ìƒˆë¡œìš´ í•¸ë“œ ë°ì´í„°
        const newHandsFromCSV = dataRows.map(row => {
          // lastActionì—ì„œë„ CHECK/CALL í†µí•©
          let lastAction = row[15];
          if (lastAction === 'CHECK' || lastAction === 'CALL') {
            lastAction = 'CHECK/CALL';
          }
          
          return {
            handNumber: row[0],
            startRow: parseInt(row[1]),
            endRow: parseInt(row[2]),
            handUpdatedAt: row[3],
            handEdit: row[4] === 'TRUE',
            handEditTime: row[5],
            table: row[7],
            cam: row[9], // Jì—´ - Cam ì •ë³´
            camFiles: formatCameraFileName([row[10], row[11], row[12], row[13]].filter(file => file && file.trim())), // K-Nì—´ - CamFile ì •ë³´ë¥¼ ë³€í™˜
            lastStreet: row[14],
            lastAction: lastAction,
            workStatus: row[16] || 'ëŒ€ê¸°ì¤‘'
          };
        });
        
        // ê¸°ë³¸ì ì¸ ë°ì´í„° ìœ íš¨ì„± ì²´í¬
        if (!isCSVDataValid(newHandsFromCSV)) {
          console.warn('ğŸš« ë¹„ì–´ìˆëŠ” CSV ë°ì´í„°, ëŒ€ê¸°ì¤‘...');
          return;
        }
        
        console.log(`ğŸ“„ CSVì—ì„œ ${newHandsFromCSV.length}ê°œ í•¸ë“œ ë¡œë“œ ì™„ë£Œ`); // ë””ë²„ê¹… í™œì„±í™”
        if (DEBUG_MODE && newHandsFromCSV.length > 0) {
          // console.log('ğŸ” ë¡œë“œëœ í•¸ë“œ ë²ˆí˜¸:', newHandsFromCSV.map(h => h.handNumber).slice(0, 5)); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        }
        
        // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ì— ë³‘í•© (ì‚­ì œí•˜ì§€ ì•Šê³  ì¶”ê°€ë§Œ)
        for (const hand of newHandsFromCSV) {
          masterHandList.set(hand.handNumber, hand);
        }
        
        // í‘œì‹œìš© ë°°ì—´ ìƒì„± (ë§ˆìŠ¤í„° ëª©ë¡ì—ì„œ)
        allHands = Array.from(masterHandList.values());
        allHands.sort((a, b) => parseInt(b.handNumber) - parseInt(a.handNumber));
        
        console.log(`ğŸ“ ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡: ì´ ${masterHandList.size}ê°œ í•¸ë“œ`);
        
        // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥
        saveMasterHandList();
        
        // ìƒˆ í•¸ë“œ ê°ì§€ ë° ì•Œë¦¼ ì²˜ë¦¬
        if (!isInitialLoad && !suppressNotification) {
          const handsToNotify = [];
          
          // ê¸°ì¡´ ì•Œë¦¼ ê¸°ë¡ í™•ì¸
          const existingNotified = getNotifiedHands();
          
          for (const hand of newHandsFromCSV) {
            const handNumber = hand.handNumber;
            
            // ì´ë¯¸ ì•Œë¦¼ëœ í•¸ë“œê°€ ì•„ë‹ˆê³ , ë²„í¼ì— ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” ê²½ìš°ë§Œ
            if (!existingNotified[handNumber] && recentHandsBuffer.addHand(handNumber)) {
              handsToNotify.push(handNumber);
            }
          }
          
          // ì•Œë¦¼ ë°œì†¡
          if (handsToNotify.length > 0 && CONFIG.ENABLE_NOTIFICATIONS) {
            console.log(`ğŸ”” ìƒˆë¡œìš´ í•¸ë“œ ì•Œë¦¼: ${handsToNotify.join(', ')}`);
            showNotification(`${handsToNotify.length}ê°œì˜ ìƒˆë¡œìš´ í•¸ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (${handsToNotify.join(', ')})`);
            playSound('notification');
            
            // ê¸°ì¡´ ì•Œë¦¼ ì‹œìŠ¤í…œì—ë„ ê¸°ë¡ (í˜¸í™˜ì„±)
            const now = Date.now();
            for (const handNumber of handsToNotify) {
              notifiedHands[handNumber] = now;
            }
            saveNotifiedHands(notifiedHands);
          }
        } else if (isInitialLoad) {
          // ì´ˆê¸° ë¡œë”©ì‹œ ëª¨ë“  í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€ (ì•Œë¦¼ ì—†ì´)
          // console.log(`ğŸ” ì´ˆê¸° ë¡œë”©: ${newHandsFromCSV.length}ê°œ í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          
          // ëª¨ë“  í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€ (ìµœëŒ€ 100ê°œê¹Œì§€ ì €ì¥)
          for (const hand of newHandsFromCSV) {
            recentHandsBuffer.addHand(hand.handNumber);
          }
          
          // ì´ˆê¸° ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
          isInitialLoad = false;
          const bufferStatus = recentHandsBuffer.getStatus();
          // console.log(`ğŸš€ ì´ˆê¸° ë¡œë”© ì™„ë£Œ. í•¸ë“œ ìˆ˜: ${newHandsFromCSV.length}ê°œ, ë²„í¼: ${bufferStatus.size}ê°œ`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        }
        
        updateHandList();
        updateStats();
        
      } catch (error) {
        console.error('Index ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }
    
    async function loadHandData(handNumber) {
      try {
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        const hand = allHands.find(h => h.handNumber === handNumber);
        if (!hand) return null;
        
        // ğŸ” ë””ë²„ê·¸: í–‰ ë²ˆí˜¸ ë§¤í•‘ í™•ì¸
        console.log(`ğŸ“Œ í•¸ë“œ ${handNumber} ë¡œë”© ì¤‘...`);
        console.log(`   Index ì •ë³´: startRow=${hand.startRow}, endRow=${hand.endRow}`);
        
        // ì‹¤ì œ í•¸ë“œ ìœ„ì¹˜ ì°¾ê¸°
        let actualStartRow = -1;
        rows.forEach((row, index) => {
          if (row[1] === 'HAND' && row[2] === handNumber) {
            actualStartRow = index + 1;
            console.log(`   âœ… ì‹¤ì œ ìœ„ì¹˜: í–‰ ${actualStartRow}`);
          }
        });
        
        if (actualStartRow !== hand.startRow) {
          console.warn(`   âš ï¸ í–‰ ë²ˆí˜¸ ë¶ˆì¼ì¹˜! Index: ${hand.startRow}, ì‹¤ì œ: ${actualStartRow}`);
        }
        
        // ì‹¤ì œ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ìŠ¬ë¼ì´ì‹± (Indexê°€ í‹€ë ¸ì„ ê²½ìš° ëŒ€ë¹„)
        let handRows;
        if (actualStartRow > 0 && actualStartRow !== hand.startRow) {
          console.warn('   ğŸ“ ì‹¤ì œ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì¬ìŠ¬ë¼ì´ì‹±...');
          // ì‹¤ì œ í•¸ë“œ ìœ„ì¹˜ì—ì„œ ì‹œì‘í•˜ì—¬ ë‹¤ìŒ í•¸ë“œê¹Œì§€ ì°¾ê¸°
          let actualEndRow = actualStartRow;
          for (let i = actualStartRow; i < rows.length; i++) {
            if (i > actualStartRow && rows[i][1] === 'HAND') {
              actualEndRow = i;
              break;
            }
            if (i === rows.length - 1) {
              actualEndRow = i + 1;
            }
          }
          handRows = rows.slice(actualStartRow - 1, actualEndRow);
          console.log(`   ìƒˆ ìŠ¬ë¼ì´ì‹± ë²”ìœ„: [${actualStartRow - 1}:${actualEndRow}]`);
        } else {
          handRows = rows.slice(hand.startRow - 1, hand.endRow);
          console.log(`   ìŠ¬ë¼ì´ì‹± ë²”ìœ„: [${hand.startRow - 1}:${hand.endRow}]`);
        }
        
        console.log('   ì²« 3í–‰:', handRows.slice(0, 3));
        
        // ë³´ë“œ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°
        const boardPreview = [];
        handRows.forEach(row => {
          if (row[1] === 'EVENT' && (row[2] === 'BOARD' || row[2].includes('OARD'))) {
            boardPreview.push(row[4]);
          }
        });
        console.log('   ğŸ´ ë³´ë“œ ì¹´ë“œ:', boardPreview);
        
        return parseHandDetails(handRows);
        
      } catch (error) {
        console.error('Hand ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        return null;
      }
    }
    
    function parseHandDetails(rows) {
      const hand = {
        number: '',
        table: '',
        blinds: { sb: 0, bb: 0 },
        players: [],
        actions: [],
        communityCards: [],
        pot: 0,
        winner: null,
        streets: {
          preflop: [],
          flop: [],
          turn: [],
          river: [],
          showdown: []
        },
        potContributions: {} // ê° í”Œë ˆì´ì–´ë³„ íŒŸ ê¸°ì—¬ë„ ì¶”ì 
      };
      
      let currentStreet = 'preflop';
      let streetBetAmount = {}; // ê° ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ í˜„ì¬ ë² íŒ… ê¸ˆì•¡ ì¶”ì 
      streetBetAmount['preflop'] = 0;
      streetBetAmount['flop'] = 0;
      streetBetAmount['turn'] = 0;
      streetBetAmount['river'] = 0;
      
      for (const row of rows) {
        const rowType = row[1];
        
        switch (rowType) {
          case 'HAND':
            hand.number = row[2];
            hand.timestamp = row[3];
            // Iì—´(row[8])=SB, Jì—´(row[9])=BB
            if (row[8] && row[9]) {
              hand.blinds.sb = parseFloat(row[8]) || 0;
              hand.blinds.bb = parseFloat(row[9]) || 0;
              // ì´ˆê¸° íŒŸì— SBì™€ BB ì¶”ê°€
              hand.pot = hand.blinds.sb + hand.blinds.bb;
              console.log(`ğŸ’° ë¸”ë¼ì¸ë“œ íŒŒì‹±: Iì—´ SB=${hand.blinds.sb}, Jì—´ BB=${hand.blinds.bb}, ì´ˆê¸°íŒŸ=${hand.pot}`);
              if (DEBUG_MODE) {
                console.log(`ğŸ’° ì´ˆê¸° íŒŸ ì„¤ì •: SB(${hand.blinds.sb}) + BB(${hand.blinds.bb}) = ${hand.pot}`);
              }
            } else {
              console.warn(`âš ï¸ ë¸”ë¼ì¸ë“œ ì •ë³´ ì—†ìŒ: Iì—´=${row[8]}, Jì—´=${row[9]}`);
              hand.blinds.sb = 0;
              hand.blinds.bb = 0;
              hand.pot = 0;
            }
            hand.table = row[16] || '';
            break;
          
          case 'PLAYER':
            const playerName = row[2];
            const seat = parseInt(row[3]) || 0;
            const chips = parseInt(row[5]) || parseInt(row[6]) || 0;
            // ì¹´ë“œ íŒŒì‹± ê°œì„  - ê³µë°±ì´ ì—†ëŠ” ê²½ìš°ë„ ì²˜ë¦¬
            let cards = null;
            if (row[7]) {
              // ê³µë°±ì´ ìˆìœ¼ë©´ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
              if (row[7].includes(' ')) {
                cards = row[7].split(' ');
              } 
              // ê³µë°±ì´ ì—†ê³  ê¸¸ì´ê°€ 4 ì´ìƒì´ë©´ 2ê°œì”© ë¶„ë¦¬ (ex: Qs2h)
              else if (row[7].length >= 4) {
                const cardStr = row[7];
                const cards_temp = [];
                let i = 0;
                while (i < cardStr.length) {
                  // 10 ì²˜ë¦¬
                  if (cardStr.substring(i, i+2) === '10') {
                    cards_temp.push(cardStr.substring(i, i+3));
                    i += 3;
                  } 
                  // T ë˜ëŠ” ì¼ë°˜ ì¹´ë“œ
                  else if (i + 1 < cardStr.length) {
                    cards_temp.push(cardStr.substring(i, i+2));
                    i += 2;
                  } else {
                    i++;
                  }
                }
                cards = cards_temp;
              } else {
                cards = [row[7]];
              }
            }
            
            hand.players.push({
              seat: seat,
              name: playerName,
              chips: chips,
              cards: cards && cards.length >= 2 ? cards : (cards && cards.length === 1 ? [cards[0], '?'] : null),
              position: '',
              status: 'active'
            });
            break;
          
          case 'EVENT':
            const eventType = row[2];
            
            // BOARD ì˜¤íƒ€ ì²˜ë¦¬ (BO\ARD ë“±)
            if (eventType === 'BOARD' || eventType.includes('OARD')) {
              const boardNum = parseInt(row[3]) || 0;
              const card = row[4];
              
              // ë³´ë“œ ì¹´ë“œ ì¶”ê°€
              if (card) {
                hand.communityCards.push(card);
                
                // ìŠ¤íŠ¸ë¦¬íŠ¸ íŒë‹¨ (ì¹´ë“œ ê°œìˆ˜ ê¸°ë°˜)
                const cardCount = hand.communityCards.length;
                if (cardCount === 1) {
                  currentStreet = 'flop';
                  streetBetAmount['flop'] = 0;
                } else if (cardCount === 4) {
                  currentStreet = 'turn';
                  streetBetAmount['turn'] = 0;
                } else if (cardCount === 5) {
                  currentStreet = 'river';
                  streetBetAmount['river'] = 0;
                }
                
                if (DEBUG_MODE) {
                  console.log(`ğŸ´ BOARD: ${card} (ì¹´ë“œ ${cardCount}ê°œ, ${currentStreet})`);
                }
              }
            } else if (eventType === 'POT CORRECTION') {
              // POT CORRECTION íŠ¹ìˆ˜ ì²˜ë¦¬
              const amount = parseInt(row[4]) || 0;
              if (amount > 0) {
                hand.pot += amount;
                if (DEBUG_MODE) {
                  console.log(`ğŸ’° POT CORRECTION: +${amount} (ì´ íŒŸ: ${hand.pot})`);
                }
              }
            } else {
              const playerNum = parseInt(row[3]) || 0;
              const amount = parseInt(row[4]) || 0;
              
              // í”Œë ˆì´ì–´ ì°¾ê¸° - seat ë²ˆí˜¸ë¡œ ë§¤ì¹­
              const playerObj = hand.players.find(p => p.seat === playerNum);
              const playerName = playerObj ? playerObj.name : `Player ${playerNum}`;
              
              // CHECKì™€ CALLì„ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ êµ¬ë¶„
              let displayAction = eventType;
              const currentBet = streetBetAmount[currentStreet] || 0;
              
              // CALL ì•¡ì…˜ ì²˜ë¦¬
              if (eventType === 'CALL') {
                // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ…ì´ ì—†ê³  amountê°€ 0ì´ê±°ë‚˜ ì‘ìœ¼ë©´ CHECK
                // ë˜ëŠ” CALLí•˜ë ¤ëŠ” ê¸ˆì•¡ì´ í˜„ì¬ ë² íŒ…ê³¼ ê°™ìœ¼ë©´ CHECK
                if ((currentBet === 0 && amount <= hand.blinds.bb) || amount === currentBet) {
                  displayAction = 'CHECK/CALL';
                  if (DEBUG_MODE) {
                    console.log(`âœ… CHECK ê°ì§€: ${playerName} (${currentStreet}, bet=${currentBet}, amount=${amount})`);
                  }
                } else {
                  // ì§„ì§œ CALL
                  displayAction = 'CHECK/CALL';
                  if (DEBUG_MODE) {
                    console.log(`ğŸ“ CALL ê°ì§€: ${playerName} ${amount} (${currentStreet}, bet=${currentBet})`);
                  }
                }
              } else if (eventType === 'CHECK') {
                displayAction = 'CHECK/CALL';
              }
              
              // BETì´ë‚˜ RAISEê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ ë² íŒ… ê¸ˆì•¡ ì—…ë°ì´íŠ¸
              if (eventType === 'BET' || eventType === 'RAISE' || eventType === 'RAISE TO') {
                streetBetAmount[currentStreet] = amount;
                if (DEBUG_MODE) {
                  console.log(`ğŸ“Š ${currentStreet} ë² íŒ… ì—…ë°ì´íŠ¸: ${amount}`);
                }
              }
              
              const action = {
                player: playerName,
                action: displayAction,
                amount: amount,
                street: currentStreet
              };
              
              hand.actions.push(action);
              hand.streets[currentStreet].push(action);
              
              // ê°œì„ ëœ pot ê³„ì‚° ë¡œì§
              if (amount > 0) {
                // í”Œë ˆì´ì–´ë³„ ê¸°ì—¬ë„ ì¶”ì 
                if (!hand.potContributions[playerName]) {
                  hand.potContributions[playerName] = 0;
                }
                
                // ëª¨ë“  ë² íŒ… ì•¡ì…˜ì€ ê¸°ë¡ëœ amountë¥¼ ê·¸ëŒ€ë¡œ íŒŸì— ì¶”ê°€
                // CSV ë°ì´í„°ê°€ ì´ë¯¸ ì •í™•í•œ ê¸ˆì•¡ì„ ê¸°ë¡í•˜ê³  ìˆë‹¤ê³  ê°€ì •
                if (eventType === 'BET' || eventType === 'CALL' || eventType === 'RAISE' || 
                    eventType === 'RAISE TO' || eventType === 'ALL-IN' || eventType === 'ALLIN') {
                  hand.pot += amount;
                  hand.potContributions[playerName] += amount;
                  
                  if (DEBUG_MODE) {
                    console.log(`ğŸ’° POT ì¶”ê°€: ${playerName} ${displayAction} ${amount} (í˜„ì¬ POT: ${hand.pot}, ${playerName} ì´ ê¸°ì—¬: ${hand.potContributions[playerName]})`);
                  }
                }
              }
              
              if (eventType === 'FOLD' && playerObj) {
                playerObj.status = 'folded';
              }
            }
            break;
          
          case 'WIN':
            const winnerNum = row[2];
            const winAmount = parseInt(row[3]) || 0;
            const winnerObj = hand.players.find(p => p.seat === parseInt(winnerNum));
            
            hand.winner = {
              player: winnerObj ? winnerObj.name : `Player ${winnerNum}`,
              amount: winAmount,
              hand: row[4] || ''
            };
            break;
        }
      }
      
      calculatePositions(hand);
      return hand;
    }
    
    function calculatePositions(hand) {
      const playerCount = hand.players.length;
      if (playerCount < 2) return;
      
      const positions = getPositionNames(playerCount);
      hand.players.forEach((player, index) => {
        player.position = positions[index];
      });
    }
    
    function getPositionNames(playerCount) {
      const positions = {
        2: ['BTN', 'BB'],
        3: ['BTN', 'SB', 'BB'],
        4: ['BTN', 'SB', 'BB', 'CO'],
        5: ['BTN', 'SB', 'BB', 'UTG', 'CO'],
        6: ['BTN', 'SB', 'BB', 'UTG', 'MP', 'CO'],
        7: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'MP', 'CO'],
        8: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'MP', 'MP+1', 'CO'],
        9: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'UTG+2', 'MP', 'MP+1', 'CO']
      };
      
      return positions[playerCount] || Array(playerCount).fill('').map((_, i) => `Seat ${i + 1}`);
    }
    
    // ====================================
    // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    // ====================================

    // ====================================
    // Phase 1 ì„±ëŠ¥ ìµœì í™” - ì¼ê´„ ìƒíƒœ í™•ì¸
    // ====================================

    /**
     * ì—¬ëŸ¬ í•¸ë“œì˜ ìƒíƒœë¥¼ í•œ ë²ˆì— í™•ì¸ (Phase 1 ìµœì í™”)
     * @param {Array} handNumbers - í™•ì¸í•  í•¸ë“œ ë²ˆí˜¸ ë°°ì—´
     * @returns {Object} í•¸ë“œë³„ ìƒíƒœ ì •ë³´
     */
    async function checkAllHandsStatus(handNumbers) {
      const startTime = performance.now();
      console.log(`ğŸš€ [Phase 1] ${handNumbers.length}ê°œ í•¸ë“œ ì¼ê´„ ìƒíƒœ í™•ì¸ ì‹œì‘...`);

      // batchDataë¥¼ try ë¸”ë¡ ë°–ì—ì„œ ì„ ì–¸
      let batchData = null;

      try {
        // 1. ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (API í˜¸ì¶œ ì „ì— ìºì‹œ ìš°ì„ )
        const cachedResults = {};
        const uncachedHands = [];

        for (const handNum of handNumbers) {
          // ì „ì—­ ìºì‹œ í™•ì¸
          if (window.handStatusCache && window.handStatusCache.has(handNum)) {
            const cached = window.handStatusCache.get(handNum);
            cachedResults[handNum] = cached.status || '';
          } else {
            uncachedHands.push(handNum);
          }
        }

        console.log(`ğŸ“¦ ìºì‹œ íˆíŠ¸: ${Object.keys(cachedResults).length}ê°œ, ë¯¸ìŠ¤: ${uncachedHands.length}ê°œ`);

        // ëª¨ë“  í•¸ë“œê°€ ìºì‹œì— ìˆìœ¼ë©´ ë°”ë¡œ ë°˜í™˜
        if (uncachedHands.length === 0) {
          console.log('âœ… ëª¨ë“  í•¸ë“œê°€ ìºì‹œì—ì„œ ë°œê²¬ë¨');
          return cachedResults;
        }

        // 2. ìºì‹œë˜ì§€ ì•Šì€ í•¸ë“œë§Œ API í˜¸ì¶œ
        const timestamps = await Promise.all(
          uncachedHands.map(async (handNum) => {
            const time = await getHandTimestamp(handNum);
            return { handNumber: handNum, timestamp: time };
          })
        );

        // ìœ íš¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ë§Œ í•„í„°ë§
        const validHands = timestamps.filter(item => item.timestamp);
        if (validHands.length === 0) {
          console.log('âš ï¸ ìœ íš¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìŒ');
          return cachedResults;
        }

        // 3. ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ ë²ˆí˜¸ ì°¾ê¸° (ë³‘ë ¬ ì²˜ë¦¬)
        const sheetUrl = getSheetUrl();
        const rowMatches = await Promise.all(
          validHands.map(async (item) => {
            const result = await findMatchingRowInVirtualSheet(sheetUrl, item.timestamp, false);
            const row = result?.matchedRow?.row;
            return { handNumber: item.handNumber, row: row };
          })
        );

        // ìœ íš¨í•œ í–‰ ë²ˆí˜¸ë§Œ ì¶”ì¶œ
        const validRows = rowMatches.filter(item => item.row);
        if (validRows.length === 0) {
          console.log('âš ï¸ ë§¤ì¹­ë˜ëŠ” í–‰ì´ ì—†ìŒ');
          return cachedResults;
        }

        // 4. Apps Scriptì— ì¼ê´„ ìƒíƒœ í™•ì¸ ìš”ì²­
        batchData = {
          action: 'batchVerify', // ê¸°ì¡´ì— ë™ì‘í•˜ë˜ ì•¡ì…˜ ì‚¬ìš©
          sheetUrl: sheetUrl,
          rows: validRows.map(item => item.row)
        };

        const response = await fetch(getAppsScriptUrl(), {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(batchData)
        });

        const batchResult = await response.json();

        if (batchResult.status !== 'success') {
          throw new Error(batchResult.message || 'ì¼ê´„ í™•ì¸ ì‹¤íŒ¨');
        }

        // 5. ê²°ê³¼ë¥¼ í•¸ë“œ ë²ˆí˜¸ë³„ë¡œ ë§¤í•‘ ë° ìºì‹œ ì—…ë°ì´íŠ¸
        const statusMap = { ...cachedResults };
        validRows.forEach(item => {
          const rowData = batchResult.data?.[item.row];
          if (rowData) {
            const status = rowData.status || '';
            statusMap[item.handNumber] = status;

            // ì „ì—­ ìºì‹œ ì—…ë°ì´íŠ¸
            if (!window.handStatusCache) {
              window.handStatusCache = new Map();
            }
            const existing = window.handStatusCache.get(item.handNumber) || {};
            window.handStatusCache.set(item.handNumber, {
              ...existing,
              status: status,
              rowNumber: item.row
            });
          }
        });

        const duration = performance.now() - startTime;
        console.log(`âœ… [Phase 1] ì¼ê´„ í™•ì¸ ì™„ë£Œ: ${duration.toFixed(0)}ms`);
        console.log(`ğŸ“Š ì„±ëŠ¥: ${handNumbers.length}ê°œ í•¸ë“œ, ${validRows.length}ê°œ API í™•ì¸, 1íšŒ í˜¸ì¶œ`);

        return statusMap;

      } catch (error) {
        console.error('âŒ [Phase 1] ì¼ê´„ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        console.error('ğŸ“‹ ìš”ì²­ URL:', getAppsScriptUrl());
        if (batchData) {
          console.error('ğŸ“‹ ìš”ì²­ ë°ì´í„°:', batchData);
        }
        // ğŸ”´ Apps Script ì˜¤ë¥˜ ì‹œ ìºì‹œë§Œ ì‚¬ìš© (ê°œë³„ API í˜¸ì¶œ ë°©ì§€)
        console.log('ğŸ“Š ìºì‹œ ì „ìš© ëª¨ë“œë¡œ ì „í™˜');
        const results = {};
        for (const handNum of handNumbers) {
          const time = await getHandTimestamp(handNum);
          if (time) {
            const cached = sheetDataCache.findClosestRow(time);
            results[handNum] = cached ? cached.status : '';
          }
        }
        return results;
      }
    }

    /**
     * í´ë°±: ê¸°ì¡´ ê°œë³„ í™•ì¸ ë°©ì‹
     */
    async function checkHandsStatusFallback(handNumbers) {
      console.log('âš ï¸ í´ë°± ëª¨ë“œ: ê°œë³„ ìƒíƒœ í™•ì¸');
      const results = {};

      for (const handNum of handNumbers) {
        results[handNum] = await checkHandStatusInSheet(handNum);
      }

      return results;
    }

    // ê°œë³„ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (Apps Script ì§ì ‘ í˜¸ì¶œë¡œ CSV ìºì‹± ìš°íšŒ)
    async function checkHandStatusInSheet(handNumber) {
      try {
        console.log(`ğŸ” í•¸ë“œ #${handNumber} ìƒíƒœ í™•ì¸: Apps Script ì‹¤ì‹œê°„ ëª¨ë“œ`);

        const handTime = await getHandTimestamp(handNumber);
        if (!handTime) {
          console.log(`âŒ í•¸ë“œ #${handNumber} íƒ€ì„ìŠ¤íƒ¬í”„ ì¡°íšŒ ì‹¤íŒ¨`);
          return null;
        }

        // Apps Script URL í™•ì¸
        const appsScriptUrl = getAppsScriptUrl();
        if (!appsScriptUrl) {
          console.log('âš ï¸ Apps Script URL ë¯¸ì„¤ì • - CSV í´ë°± ëª¨ë“œë¡œ ì „í™˜');

          // í´ë°±: CSVì—ì„œ ì§ì ‘ í™•ì¸
          const virtualSheetUrl = getSheetUrl();
          if (!virtualSheetUrl) {
            console.log(`âš ï¸ Virtual ì‹œíŠ¸ URL ë¯¸ì„¤ì • - í¸ì§‘ ê°€ëŠ¥ ìƒíƒœë¡œ ì„¤ì •`);
            return null;
          }

          const matchResult = await findClosestVirtualRow(handTime, virtualSheetUrl, false);
          if (matchResult && matchResult.row) {
            let status = matchResult.status || '';
            if (status.startsWith('"') && status.endsWith('"')) {
              status = status.slice(1, -1).trim();
            }
            return status;
          }
          return null;
        }

        // Apps Scriptë¥¼ í†µí•œ ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸
        console.log(`ğŸš€ Apps Scriptë¡œ ì‹¤ì‹œê°„ Eì—´ ìƒíƒœ í™•ì¸: í•¸ë“œ #${handNumber}`);

        const requestData = {
          action: 'getHandStatus', // Apps Script v3.4.4 ì´ìƒ í•„ìš”
          sheetUrl: getSheetUrl(),
          handNumber: handNumber,
          handTime: handTime
        };

        console.log('ğŸ”— Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', {
          url: getAppsScriptUrl(),
          action: requestData.action
        });

        // ë¨¼ì € test ì•¡ì…˜ìœ¼ë¡œ ë²„ì „ í™•ì¸
        const versionTest = {
          action: 'test'
        };

        console.log('ğŸ“‹ Apps Script ë²„ì „ í™•ì¸ ì¤‘...');
        try {
          const versionResponse = await fetch(getAppsScriptUrl(), {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(versionTest)
          });
          const versionResult = await versionResponse.json();
          console.log('ğŸ“Š í˜„ì¬ ë°°í¬ëœ Apps Script ë²„ì „:', versionResult.version || 'Unknown');
          console.log('ğŸ“Š ì§€ì› ê¸°ëŠ¥:', versionResult.features || []);
        } catch (versionError) {
          console.warn('âš ï¸ ë²„ì „ í™•ì¸ ì‹¤íŒ¨:', versionError);
        }

        try {
          const response = await fetch(appsScriptUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'text/plain',
            },
            body: JSON.stringify(requestData)
          });

          // ì‘ë‹µì´ okê°€ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.status === 'success' && result.data) {
            const handStatus = result.data.handStatus || '';
            console.log(`âœ… Apps Script ì‘ë‹µ: í•¸ë“œ #${handNumber}`);
            console.log(`   - í–‰ ë²ˆí˜¸: ${result.data.row}`);
            console.log(`   - Eì—´ ìƒíƒœ: "${handStatus}"`);
            console.log(`   - ì›ë³¸ ê°’: "${result.data.rawStatus}"`);

            return handStatus;
          } else if (result.status === 'not_found') {
            console.log(`âš ï¸ í•¸ë“œ #${handNumber}ë¥¼ ì‹œíŠ¸ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return null;
          } else {
            console.error('âŒ Apps Script ì˜¤ë¥˜:', result.message);
            console.error('ğŸ“‹ ìš”ì²­ ë°ì´í„°:', requestData);
            console.error('ğŸ“‹ ì‘ë‹µ ì „ì²´:', result);
            return null;
          }
        } catch (fetchError) {
          console.error('âŒ Apps Script í†µì‹  ì˜¤ë¥˜:', fetchError);

          // ì˜¤ë¥˜ ì‹œ CSV í´ë°±
          console.log('ğŸ”„ CSV í´ë°± ëª¨ë“œë¡œ ì „í™˜...');
          const virtualSheetUrl = getSheetUrl();
          if (!virtualSheetUrl) return null;

          const matchResult = await findClosestVirtualRow(handTime, virtualSheetUrl, false);
          if (matchResult && matchResult.row) {
            let status = matchResult.status || '';
            if (status.startsWith('"') && status.endsWith('"')) {
              status = status.slice(1, -1).trim();
            }
            return status;
          }
          return null;
        }

      } catch (error) {
        console.error('âŒ Eì—´ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        return null;
      }
    }

    /**
     * ì™„ì „í•œ ì‚¬ì „ ë¡œë”© ë°©ì‹: ë©”ëª¨ë¦¬ ê¸°ë°˜ ì¦‰ì‹œ ì¡°íšŒ
     * API í˜¸ì¶œ ì—†ì´ ì™„ì „íˆ ë¡œì»¬ ë©”ëª¨ë¦¬ì—ì„œë§Œ ìƒíƒœ í™•ì¸
     */
    async function updateButtonStates(handNumber) {
      const startTime = performance.now();
      const editBtn = document.getElementById('edit-btn');
      const completeBtn = document.getElementById('complete-btn');

      if (!editBtn || !completeBtn) return;

      if (!handNumber) {
        editBtn.disabled = true;
        completeBtn.disabled = true;
        return;
      }

      try {
        // ì™„ì „í•œ ë©”ëª¨ë¦¬ ê¸°ë°˜ ì¡°íšŒ (API í˜¸ì¶œ ì—†ìŒ)
        const status = window.preloadedHandStatuses ?
          window.preloadedHandStatuses.get(parseInt(handNumber)) : null;

        const duration = performance.now() - startTime;
        console.log(`âš¡ [ì¦‰ì‹œ ë©”ëª¨ë¦¬ ì¡°íšŒ] í•¸ë“œ #${handNumber}: ${status || 'ë¯¸ì²˜ë¦¬'} (${duration.toFixed(1)}ms)`);

        // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        updateButtonStatesFromStatus(handNumber, status);

      } catch (error) {
        console.error('âŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);

        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìƒíƒœë¡œ
        editBtn.disabled = false;
        editBtn.textContent = 'í¸ì§‘';
        completeBtn.disabled = true;
        completeBtn.textContent = 'ì™„ë£Œ';
      }
    }

    /**
     * ìƒíƒœ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸ (í—¬í¼ í•¨ìˆ˜)
     */
    function updateButtonStatesFromStatus(handNumber, status) {
      try {
        const editBtn = document.getElementById('edit-btn');
        const completeBtn = document.getElementById('complete-btn');

        if (!editBtn || !completeBtn) return;

        // ğŸ” ìƒíƒœ ê°’ ìƒì„¸ ë””ë²„ê¹… (íƒ€ì…, ê¸¸ì´, ë‚´ìš© í™•ì¸)
        console.log(`ğŸ” í•¸ë“œ #${handNumber} ìƒíƒœ ë¶„ì„:`, {
          status: status,
          type: typeof status,
          length: status?.length,
          rawValue: JSON.stringify(status),
          trimmed: status?.trim?.(),
          isEmpty: status === null || status === undefined || status === '',
          isIncomplete: status === 'ë¯¸ì™„ë£Œ'
        });

        switch(status) {
            case null:
            case '':
              editBtn.disabled = false;
              editBtn.textContent = 'í¸ì§‘';
              completeBtn.disabled = true;
              completeBtn.textContent = 'ì™„ë£Œ';
              console.log('ğŸ”´ ë¯¸ì²˜ë¦¬ - í¸ì§‘ ê°€ëŠ¥');
              break;

            case 'ë¯¸ì™„ë£Œ':
              editBtn.disabled = true;
              editBtn.textContent = 'í¸ì§‘';
              completeBtn.disabled = false;
              completeBtn.textContent = 'ì™„ë£Œ';
              console.log('ğŸŸ¡ ë¯¸ì™„ë£Œ - ì™„ë£Œ ê°€ëŠ¥');
              break;

            case 'ë³µì‚¬ì™„ë£Œ':
              editBtn.disabled = true;
              editBtn.textContent = 'í¸ì§‘';
              completeBtn.disabled = true;
              completeBtn.textContent = 'ì™„ë£Œ';
              console.log('ğŸŸ¢ ë³µì‚¬ì™„ë£Œ - ëª¨ë‘ ë¹„í™œì„±í™”');
              break;

            default:
              editBtn.disabled = false;
              editBtn.textContent = 'í¸ì§‘';
              completeBtn.disabled = true;
              completeBtn.textContent = 'ì™„ë£Œ';
          }

          // ğŸ“Š ìƒíƒœ ì •ë³´ ì„¹ì…˜ ì—…ë°ì´íŠ¸
          updateHandStatusSection(handNumber, status);

      } catch (error) {
        console.error('âŒ ë²„íŠ¼ ìƒíƒœ ì˜¤ë¥˜:', error);

        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ DOM ìš”ì†Œ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì„¤ì •
        const editBtn = document.getElementById('edit-btn');
        const completeBtn = document.getElementById('complete-btn');

        if (editBtn && completeBtn) {
          editBtn.disabled = false;
          editBtn.textContent = 'í¸ì§‘';
          completeBtn.disabled = true;
          completeBtn.textContent = 'ì™„ë£Œ';
        }
      }
    }

    /**
     * Phase 2 ìµœì í™” - ìºì‹œ ìš°ì„ , API í´ë°±
     */
    async function updateVisibleHandsStatus() {
      const startTime = performance.now();

      // í™”ë©´ì— ë³´ì´ëŠ” í•¸ë“œ ìš”ì†Œ ì°¾ê¸°
      const handElements = document.querySelectorAll('#hand-list > div');
      const visibleHands = [];

      handElements.forEach(el => {
        const rect = el.getBoundingClientRect();
        // ë·°í¬íŠ¸ ë‚´ì— ìˆê±°ë‚˜ ê³§ ë³´ì¼ ìœ„ì¹˜ì— ìˆëŠ” ìš”ì†Œ
        if (rect.top < window.innerHeight + 200 && rect.bottom > -200) {
          const handNum = el.dataset.handNumber;
          if (handNum) {
            visibleHands.push(handNum);
          }
        }
      });

      if (visibleHands.length === 0) return;

      // ë””ë²„ê¹… ëª¨ë“œì—ì„œë§Œ ë¡œê·¸
      if (window.DEBUG_MODE) {
        console.log(`ğŸ‘ï¸ ${visibleHands.length}ê°œì˜ ë³´ì´ëŠ” í•¸ë“œ ìƒíƒœ í™•ì¸`);
      }

      // ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ: ë©”ëª¨ë¦¬ì—ì„œ ì¦‰ì‹œ ì¡°íšŒ
      const statuses = {};
      visibleHands.forEach(handNum => {
        const status = window.preloadedHandStatuses ?
          window.preloadedHandStatuses.get(parseInt(handNum)) : null;
        statuses[handNum] = status || '';
      });

      // UI ì—…ë°ì´íŠ¸
      for (const [handNum, status] of Object.entries(statuses)) {
        const element = document.querySelector(`[data-hand-number="${handNum}"]`);
        if (element) {
          // ìƒíƒœì— ë”°ë¥¸ ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
          updateHandElementStatus(element, status);
        }
      }

      const duration = performance.now() - startTime;
      if (window.DEBUG_MODE) {
        console.log(`âœ… ë³´ì´ëŠ” í•¸ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${duration.toFixed(0)}ms`);
      }
    }

    /**
     * í•¸ë“œ ìš”ì†Œì˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
     */
    function updateHandElementStatus(element, status) {
      // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
      element.classList.remove('border-green-500', 'border-yellow-500', 'border-gray-600');
      element.classList.remove('bg-green-900/20', 'bg-yellow-900/20', 'bg-gray-800');

      // ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
      const statusIcon = element.querySelector('.status-icon') || document.createElement('span');
      statusIcon.className = 'status-icon';

      switch(status) {
        case 'ë³µì‚¬ì™„ë£Œ':
          element.classList.add('border-green-500', 'bg-green-900/20');
          statusIcon.innerHTML = '<span class="text-green-400">âœ“</span>';
          break;
        case 'ë¯¸ì™„ë£Œ':
          element.classList.add('border-yellow-500', 'bg-yellow-900/20');
          statusIcon.innerHTML = '<span class="text-yellow-400">âš¡</span>';
          break;
        default:
          element.classList.add('border-gray-600', 'bg-gray-800');
          statusIcon.innerHTML = '';
      }

      // ìƒíƒœ ì•„ì´ì½˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€
      if (!element.querySelector('.status-icon')) {
        const header = element.querySelector('.flex.items-center.justify-between');
        if (header) {
          header.appendChild(statusIcon);
        }
      }
    }

    async function updateHandList() {
      console.log(`ğŸ“‹ updateHandList í˜¸ì¶œ - ì´ í•¸ë“œ ìˆ˜: ${allHands.length}`);
      const listEl = document.getElementById('hand-list');
      const tableFilter = document.getElementById('table-filter').value;
      const statusFilter = document.getElementById('status-filter').value;

      let filteredHands = allHands;

      if (tableFilter) {
        filteredHands = filteredHands.filter(h => h.table === tableFilter);
      }

      if (statusFilter) {
        filteredHands = filteredHands.filter(h => {
          if (statusFilter === 'completed') return h.handEdit;
          if (statusFilter === 'pending') return !h.handEdit;
          return true;
        });
      }

      // Phase 1 ìµœì í™”: data-hand-number ì†ì„± ì¶”ê°€
      listEl.innerHTML = filteredHands.map(hand => {
        // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
        const statusColor = hand.handEdit ? 'border-green-500 bg-green-900/20' : 
                          hand.workStatus === 'ì§„í–‰ì¤‘' ? 'border-yellow-500 bg-yellow-900/20' : 
                          'border-gray-600 bg-gray-800';
        
        // ìŠ¤íŠ¸ë¦¬íŠ¸ë³„ ìƒ‰ìƒ
        const streetColors = {
          'preflop': 'text-purple-400',
          'flop': 'text-blue-400', 
          'turn': 'text-green-400',
          'river': 'text-orange-400',
          'showdown': 'text-yellow-400'
        };
        const streetColor = streetColors[hand.lastStreet?.toLowerCase()] || 'text-gray-400';
        
        // ì‹œê°„ í‘œì‹œ í¬ë§· (ì‹œ:ë¶„:ì´ˆ)
        let time = '-';
        if (hand.handUpdatedAt) {
          // timestampì¸ ê²½ìš° ë³€í™˜
          const timestamp = typeof hand.handUpdatedAt === 'string' ? 
            Date.parse(hand.handUpdatedAt) : hand.handUpdatedAt;
          const handDate = new Date(timestamp);
          if (!isNaN(handDate.getTime())) {
            const h = String(handDate.getHours()).padStart(2, '0');
            const m = String(handDate.getMinutes()).padStart(2, '0');
            const s = String(handDate.getSeconds()).padStart(2, '0');
            time = `${h}:${m}:${s}`;
          }
        }
        
        // ì¹´ë©”ë¼ íŒŒì¼ëª… ì •ë³´ (ì´ë¯¸ ë³€í™˜ëœ í˜•íƒœ)
        const camFilesText = hand.camFiles && hand.camFiles.length > 0 ? 
          hand.camFiles.slice(0, 2).join(', ') + 
          (hand.camFiles.length > 2 ? ` (+${hand.camFiles.length - 2})` : '') : 
          'íŒŒì¼ ì—†ìŒ';

        return `
        <div class="hand-item rounded-lg p-3 cursor-pointer hover:scale-105 transition-all border ${statusColor}"
             onclick="selectHand('${hand.handNumber}')"
             data-hand-number="${hand.handNumber}">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-bold text-white">Hand #${hand.handNumber}</span>
            <span class="status-indicator status-empty" title="ìƒíƒœ í™•ì¸ ì¤‘">âšª</span>
          </div>
          <div class="flex items-center justify-between text-xs">
            <span class="text-gray-300">${hand.table || 'í…Œì´ë¸” -'}</span>
            <span class="${streetColor} font-semibold">${hand.lastStreet || 'Preflop'}</span>
          </div>
          <div class="flex items-center justify-between text-xs mt-1">
            <span class="text-gray-500">${hand.lastAction || '-'}</span>
            <span class="text-gray-500 font-mono">${time}</span>
          </div>
          <div class="text-xs text-blue-300 mt-1 truncate" title="${hand.camFiles?.join(', ') || ''}">
            ğŸ“¹ ${camFilesText}
          </div>

          <!-- ğŸ“Š Virtual ì‹œíŠ¸ ì •ë³´ (í•¸ë“œ ì¹´ë“œ ë‚´ë¶€) -->
          <div id="hand-sheet-info-${hand.handNumber}" class="mt-2 pt-2 border-t border-gray-700 text-xs">
            <div class="flex items-center justify-between mb-1">
              <span class="text-gray-400">ğŸ“‹ Virtual ì‹œíŠ¸</span>
              <span id="sheet-status-${hand.handNumber}" class="sheet-status-icon">âšª</span>
            </div>
            <div class="grid grid-cols-2 gap-1 text-xs text-gray-500">
              <div>ìƒíƒœ: <span id="sheet-status-text-${hand.handNumber}" class="sheet-status-text">-</span></div>
              <div>í–‰: <span id="sheet-row-${hand.handNumber}" class="sheet-row-number">-</span></div>
            </div>
            <div class="text-xs text-gray-500 mt-1 truncate">
              ğŸ“ <span id="sheet-filename-${hand.handNumber}" class="sheet-filename">Virtual íŒŒì¼ëª… í™•ì¸ ì¤‘...</span>
            </div>
          </div>
        </div>
      `;
      }).join('');
      
      document.getElementById('hand-count').textContent = filteredHands.length;
      
      // í…Œì´ë¸” í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì„ íƒëœ ê°’ ìœ ì§€)
      const tables = [...new Set(allHands.map(h => h.table).filter(t => t))];
      const tableFilterEl = document.getElementById('table-filter');
      const currentTable = tableFilterEl.value;
      
      // í…Œì´ë¸” ëª©ë¡ì´ ë‹¬ë¼ì¡Œì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
      const currentOptions = Array.from(tableFilterEl.options).slice(1).map(opt => opt.value);
      const hasChanged = tables.length !== currentOptions.length || 
                        tables.some(t => !currentOptions.includes(t));
      
      if (hasChanged) {
        tableFilterEl.innerHTML = '<option value="">ëª¨ë“  í…Œì´ë¸”</option>' +
          tables.map(table => `<option value="${table}">${table}</option>`).join('');
      }
      
      // í˜„ì¬ ì„ íƒëœ ê°’ ë³µì›
      if (currentTable && tables.includes(currentTable)) {
        tableFilterEl.value = currentTable;
      }

      // Phase 1: í•¸ë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ì™„ë£Œ í›„ ìƒíƒœ í™•ì¸
      // ğŸ”´ ì¤‘ìš”: í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³€ê²½ (ë°±ê·¸ë¼ìš´ë“œ ë¬´í•œ í˜¸ì¶œ ë°©ì§€)
      if (!window.statusUpdateInProgress) {
        window.statusUpdateInProgress = true;
        setTimeout(() => {
          updateVisibleHandsStatus().finally(() => {
            window.statusUpdateInProgress = false;
          });
          // ğŸ“Š í•¸ë“œ ì¹´ë“œë³„ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
          updateHandCardSheetInfo(filteredHands);
        }, 100);
      }
    }
    
    function updateStats() {
      // í†µê³„ ì„¹ì…˜ ì œê±°ë¨
    }
    
    async function selectHand(handNumber) {
      currentHand = handNumber;
      
      const hand = await loadHandData(handNumber);
      if (!hand) return;
      
      // ì¸ë±ìŠ¤ì—ì„œ ì¹´ë©”ë¼ íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const indexHand = allHands.find(h => h.handNumber === handNumber);
      
      // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('hand-number').textContent = hand.number;
      document.getElementById('table-name').textContent = hand.table || '-';
      document.getElementById('blinds').textContent = `${hand.blinds.sb}/${hand.blinds.bb}`;
      document.getElementById('pot-amount').textContent = formatNumber(hand.pot);
      
      // ì¹´ë©”ë¼ íŒŒì¼ëª… ì—…ë°ì´íŠ¸ (ì´ë¯¸ ë³€í™˜ëœ í˜•íƒœ)
      const cameraFilesEl = document.getElementById('camera-files');
      if (indexHand && indexHand.camFiles && indexHand.camFiles.length > 0) {
        cameraFilesEl.textContent = indexHand.camFiles.join(', ');
        cameraFilesEl.title = indexHand.camFiles.join('\n');
      } else {
        cameraFilesEl.textContent = 'íŒŒì¼ ì—†ìŒ';
        cameraFilesEl.title = '';
      }
      
      // ë³´ë“œ ì¹´ë“œ í‘œì‹œ
      updateBoardCards(hand.communityCards);
      
      // í”Œë ˆì´ì–´ ì¹´ë“œ í‘œì‹œ
      updatePlayersSection(hand.players);
      
      // ì•¡ì…˜ íˆìŠ¤í† ë¦¬ í‘œì‹œ
      updateActionHistory(hand);
      
      // í•¸ë“œ ê²°ê³¼ í‘œì‹œ
      updateHandResult(hand);
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì™„ë£Œ ìƒíƒœì— ë”°ë¼)
      updateHandStatus(indexHand ? indexHand.handEdit : false);

      // ğŸ“Š Virtual ì‹œíŠ¸ ë“±ë¡ ì •ë³´ í‘œì‹œ (ìµœí•˜ë‹¨ í™•ì¸ìš©)
      await loadVirtualSheetInfo(handNumber);

      // Eì—´ ìƒíƒœ ê¸°ë°˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸°)
      console.log(`ğŸ”„ í•¸ë“œ #${handNumber} ì„ íƒ ì™„ë£Œ - ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜ˆì•½`);
      setTimeout(() => updateButtonStates(handNumber), 200); // ì•½ê°„ì˜ ë”±ë ˆì´ë¡œ UI ì™„ì„± í›„ ì‹¤í–‰
    }
    
    function updateBoardCards(cards) {
      const container = document.getElementById('board-cards');
      
      // 5ì¥ì˜ ì¹´ë“œ ìŠ¬ë¡¯ í‘œì‹œ (ë¹„ì–´ìˆëŠ” ê²ƒì€ í°ìƒ‰ ì ì„ )
      let html = '';
      for (let i = 0; i < 5; i++) {
        if (cards && cards[i]) {
          html += createCardElement(cards[i], 'board');
        } else {
          html += '<div class="board-card" style="background-color: #FFFFFF !important; color: #9ca3af; border: 2px dashed #d1d5db; color-scheme: light;">?</div>';
        }
      }
      
      container.innerHTML = html;
    }
    
    function updatePlayersSection(players) {
      const container = document.getElementById('players-section');
      
      container.innerHTML = players.map(player => `
        <div class="player-item ${player.status === 'folded' ? 'folded' : ''}">
          <div class="flex items-center gap-2">
            <span class="pos-badge ${getPositionBadgeClass(player.position)}">${player.position}</span>
            <span class="text-xs font-semibold">${player.name}</span>
          </div>
          <div class="flex items-center gap-2">
            ${player.cards && player.cards.length > 0 
              ? player.cards.map(card => createCardElement(card)).join('') 
              : '<span class="text-xs text-gray-500">ì¹´ë“œ ì •ë³´ ì—†ìŒ</span>'}
            <span class="text-xs text-gray-400">${formatNumber(player.chips)}</span>
          </div>
        </div>
      `).join('');
    }
    
    function updateActionHistory(hand) {
      const container = document.getElementById('action-history');
      const streets = ['preflop', 'flop', 'turn', 'river', 'showdown'];
      
      let html = '';
      
      streets.forEach(street => {
        if (hand.streets[street] && hand.streets[street].length > 0) {
          html += `<div class="mb-2">`;
          html += `<div class="text-xs font-semibold text-gray-400 uppercase mb-1">${street}</div>`;
          hand.streets[street].forEach(action => {
            html += `
              <div class="action-line ${street}">
                <span class="text-xs">${action.player}</span>
                <span class="action-badge ${getActionBadgeClass(action.action)}">${action.action}</span>
                ${action.amount > 0 ? `<span class="text-xs text-gray-400">${formatNumber(action.amount)}</span>` : ''}
              </div>
            `;
          });
          html += `</div>`;
        }
      });
      
      container.innerHTML = html || '<div class="text-xs text-gray-500">ì•¡ì…˜ ê¸°ë¡ ì—†ìŒ</div>';
    }
    
    function updateHandResult(hand) {
      // ê²°ê³¼ íƒ­ì´ ì œê±°ë˜ì–´ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      return;
    }
    
    // ====================================
    // ì•Œë¦¼ í•¨ìˆ˜
    // ====================================
    
    function showNotification(message) {
      if (!CONFIG.ENABLE_NOTIFICATIONS) return;
      
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§', {
          body: message,
          icon: '/favicon.ico'
        });
      }
    }
    
    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í˜¸ì¶œ ê°ì§€
    let userInteracted = false;
    document.addEventListener('click', () => { userInteracted = true; }, { once: true });
    document.addEventListener('keydown', () => { userInteracted = true; }, { once: true });
    
    function playSound(type = 'notification') {
      if (!CONFIG.ENABLE_SOUND) {
        console.log('ğŸ”‡ ì†Œë¦¬ ë¹„í™œì„±í™” ìƒíƒœ');
        return;
      }
      
      if (!userInteracted) {
        console.log('ğŸ”‡ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ëŒ€ê¸° ì¤‘ - ì†Œë¦¬ ì¬ìƒ ê±´ë„ˆë›°ê¸°');
        return;
      }
      
      console.log(`ğŸ”” ì†Œë¦¬ ì¬ìƒ ì‹œë„: ${type}`);
      
      const soundMap = {
        // ë¶€ë“œëŸ¬ìš´ ë²¨ ì†Œë¦¬ (ìƒˆ í•¸ë“œ ì•Œë¦¼ìš©)
        notification: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE',
        
        // ì„±ê³µ ì†Œë¦¬ (ì™„ë£Œ/ì—…ë°ì´íŠ¸ ì„±ê³µì‹œ)
        success: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE',
        
        // ì°¨ì„ë²¨ ì†Œë¦¬ (ë” ë¶€ë“œëŸ¬ìš´ ì•Œë¦¼)
        chime: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE'
      };
      
      // Web Audio APIë¥¼ ì‚¬ìš©í•œ ë” ì˜ˆìœ ì†Œë¦¬ ìƒì„±
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (type === 'chime') {
          // ë¶€ë“œëŸ¬ìš´ ì°¨ì„ë²¨ ì†Œë¦¬
          playChimeSound(audioContext);
        } else if (type === 'success') {
          // ì„±ê³µ ì†Œë¦¬ (ìƒìŠ¹í•˜ëŠ” í†¤)
          playSuccessSound(audioContext);
        } else {
          // ê¸°ë³¸ ì•Œë¦¼ ì†Œë¦¬ (ë¶€ë“œëŸ¬ìš´ ë²¨)
          playBellSound(audioContext);
        }
        console.log('âœ… ì†Œë¦¬ ì¬ìƒ ì„±ê³µ');
      } catch (error) {
        console.log('âš ï¸ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', error.message);
        // Web Audio API ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ì˜¤ë””ì˜¤ ì‚¬ìš©
        const audio = new Audio(soundMap[type] || soundMap.notification);
        audio.volume = 0.5;
        audio.play().catch(e => console.log('ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', e));
      }
    }
    
    // ë¶€ë“œëŸ¬ìš´ ë²¨ ì†Œë¦¬ ìƒì„±
    function playBellSound(audioContext) {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.3);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
      
      oscillator.type = 'sine';
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.8);
    }
    
    // ì„±ê³µ ì†Œë¦¬ ìƒì„± (ìƒìŠ¹í•˜ëŠ” 3ìŒê³„)
    function playSuccessSound(audioContext) {
      const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
      const duration = 0.15;
      
      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + (index * duration));
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime + (index * duration));
        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + (index * duration) + 0.02);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (index * duration) + duration);
        
        oscillator.start(audioContext.currentTime + (index * duration));
        oscillator.stop(audioContext.currentTime + (index * duration) + duration);
      });
    }
    
    // ì°¨ì„ë²¨ ì†Œë¦¬ ìƒì„± (í™”ìŒ)
    function playChimeSound(audioContext) {
      const frequencies = [523.25, 659.25, 783.99, 1046.5]; // C5, E5, G5, C6 í™”ìŒ
      
      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        oscillator.type = 'sine';
        
        const volume = 0.15 / (index + 1); // ë†’ì€ ìŒì¼ìˆ˜ë¡ ì‘ê²Œ
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 1.2);
      });
    }
    
    // ====================================
    // í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
    // ====================================
    
    // í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function getHandTimestamp(handNumber) {
      try {
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        for (const row of rows) {
          if (row[1] === 'HAND' && row[2] === String(handNumber)) {
            const timestamp = parseInt(row[3]);
            if (!isNaN(timestamp) && timestamp > 0) {
              return timestamp;
            }
          }
        }
      } catch (error) {
        console.error('í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
      return null;
    }
    


    // Virtual ì‹œíŠ¸ì—ì„œ ê°€ì¥ ë¹„ìŠ·í•œ ì‹œê°„ ì°¾ê¸° (ë‚ ì§œ ì œì™¸, ì‹œê°„ë§Œ ë¹„êµ)
    async function findClosestVirtualRow(targetTime, virtualSheetUrl, showProgress = true) {
      // console.log('ğŸ” === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹œì‘ ==='); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      // console.log(`ğŸ“‹ ì…ë ¥ URL: ${virtualSheetUrl}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      // console.log(`â° íƒ€ê²Ÿ íƒ€ì„ìŠ¤íƒ¬í”„: ${targetTime} (${new Date(targetTime * 1000)})`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      // console.log(`ğŸ“Š ì§„í–‰ë¥  í‘œì‹œ: ${showProgress}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€

      // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ (ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­ëœ ê²½ìš°ë§Œ)
      if (showProgress) {
        showProgressModal();
      }
      let isAborted = false;
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
      const timeoutId = setTimeout(() => {
        isAborted = true;
        if (showProgress) {
          hideProgressModal();
        }
        console.error('âŒ Virtual ì‹œíŠ¸ ë§¤ì¹­ íƒ€ì„ì•„ì›ƒ (30ì´ˆ ì´ˆê³¼)');
      }, 30000);
      
      try {
        let csvUrl = '';
        
        // URL í˜•ì‹ ê°ì§€ ë° ì ì ˆí•œ CSV URL ìƒì„±
        // console.log('\nğŸ“„ === Virtual Sheet CSV ë°ì´í„° ìš”ì²­ ==='); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ”— ì…ë ¥ URL: ${virtualSheetUrl}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log('ğŸ” URL í˜•ì‹ ë¶„ì„ ì¤‘...'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        let urlType = '';
        
        // 1. ì´ë¯¸ ì›¹ ê²Œì‹œëœ CSV URLì¸ì§€ í™•ì¸ (ê°€ì¥ ê¶Œì¥í•˜ëŠ” í˜•ì‹)
        if (virtualSheetUrl.includes('/pub?') && virtualSheetUrl.includes('output=csv')) {
          // console.log('âœ… ì›¹ ê²Œì‹œ CSV URL ê°ì§€ (ê¶Œì¥ í˜•ì‹!)'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          csvUrl = virtualSheetUrl;
          urlType = 'published-csv';
        }
        // 2. ì›¹ ê²Œì‹œëœ ì¼ë°˜ URLì¸ì§€ í™•ì¸ (2PACX í˜•ì‹)
        else if (virtualSheetUrl.includes('/spreadsheets/d/e/2PACX-')) {
          // console.log('ğŸ”„ ì›¹ ê²Œì‹œ ì¼ë°˜ URL ê°ì§€ - CSV ë³€í™˜ ì¤‘'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // gid ì¶”ì¶œ
          const gidMatch = virtualSheetUrl.match(/gid=(\d+)/);
          const gid = gidMatch ? gidMatch[1] : '0';
          const publishedIdMatch = virtualSheetUrl.match(/\/spreadsheets\/d\/e\/(2PACX-[a-zA-Z0-9-_]+)/);
          if (publishedIdMatch) {
            csvUrl = `https://docs.google.com/spreadsheets/d/e/${publishedIdMatch[1]}/pub?gid=${gid}&single=true&output=csv`;
            // console.log('âœ… ì›¹ ê²Œì‹œ CSV URLë¡œ ìë™ ë³€í™˜ë¨'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            urlType = 'published-converted';
          } else {
            throw new Error('ì›¹ ê²Œì‹œ URLì—ì„œ IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        }
        // 3. ì¼ë°˜ ì‹œíŠ¸ í¸ì§‘ URLì¸ì§€ í™•ì¸ (ë¹„ì¶”ì²œ - CORS ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)
        else if (virtualSheetUrl.includes('/spreadsheets/d/') && !virtualSheetUrl.includes('/pub?')) {
          // console.log('âš ï¸ ì¼ë°˜ í¸ì§‘ URL ê°ì§€ - Export URLë¡œ ë³€í™˜ ì‹œë„'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // console.log('â— ì£¼ì˜: ì´ ë°©ì‹ì€ CORS ë° ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          const sheetIdMatch = virtualSheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
          if (sheetIdMatch) {
            const sheetId = sheetIdMatch[1];
            // gid ì¶”ì¶œ ì‹œë„
            const gidMatch = virtualSheetUrl.match(/gid=(\d+)/);
            const gid = gidMatch ? gidMatch[1] : '0';
            csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
            // console.log('ğŸ”„ Export CSV URLë¡œ ë³€í™˜ë¨'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            // console.log('\nğŸ’¡ ê¶Œì¥ í•´ê²°ì±…:'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            // console.log('1. Google Sheets ì—´ê¸°'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            // console.log('2. íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            // console.log('3. "ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê°’(.csv)" ì„ íƒ'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            // console.log('4. ê²Œì‹œ í›„ ìƒì„±ëœ CSV ë§í¬ ì‚¬ìš©'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            urlType = 'export-url';
          } else {
            throw new Error('ì‹œíŠ¸ IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        }
        else {
          throw new Error('ì§€ì›ë˜ì§€ ì•ŠëŠ” Google Sheets URL í˜•ì‹ì…ë‹ˆë‹¤.\n\nğŸ“ ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•:\n1. Google Sheets â†’ íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ\n2. "ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê°’(.csv)" ì„ íƒ\n3. ê²Œì‹œ í›„ ìƒì„±ëœ CSV ë§í¬ ì‚¬ìš©\n\nâœ… ì˜¬ë°”ë¥¸ í˜•ì‹ ì˜ˆì‹œ:\nhttps://docs.google.com/spreadsheets/d/e/2PACX-.../pub?gid=0&single=true&output=csv');
        }
        
        // console.log(`ğŸ“¡ ìµœì¢… ìš”ì²­ URL: ${csvUrl}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“‹ URL í˜•ì‹: ${urlType}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // console.log('ğŸ“¥ Google Sheets CSV ìš”ì²­ ì¤‘... (ë‹¤ì¤‘ ë°©ë²• ì‹œë„)'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        const csvData = await fetchCsvWithFallback(csvUrl);
        const text = csvData.csvText;
        
        // console.log(`ğŸ“Š ì‚¬ìš©ëœ ë°©ë²•: ${csvData.fetchMethod}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${csvData.response.status} ${csvData.response.statusText}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“„ CSV ë°ì´í„° í¬ê¸°: ${text.length} characters`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“„ CSV ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²« 500ì):`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(text.substring(0, 500) + (text.length > 500 ? '...' : '')); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        const rows = parseCSV(text);
        // console.log(`ğŸ“‹ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        if (rows.length === 0) {
          throw new Error('CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ì²« 5í–‰ ë°ì´í„° ìƒ˜í”Œ ë¡œê·¸
        // console.log('ğŸ“‹ CSV ë°ì´í„° ìƒ˜í”Œ (ì²« 5í–‰):'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // for (let i = 0; i < Math.min(5, rows.length); i++) {
        //   console.log(`   í–‰ ${i+1}: A="${rows[i][0] || ''}", B="${rows[i][1] || ''}", C="${rows[i][2] || ''}", D="${rows[i][3] || ''}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // }
        
        // íƒ€ê²Ÿ ì‹œê°„ ì§ì ‘ ì‚¬ìš© (ì‹œê°„ëŒ€ ë³€í™˜ ì œê±°)
        // console.log('â° === ì‹œê°„ ë¶„ì„ ì‹œì‘ ==='); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        const targetDate = new Date(targetTime * 1000);
        // console.log(`ğŸ“… íƒ€ê²Ÿ ì‹œê°„: ${targetDate.toLocaleString()}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ë¡œì»¬ ì‹œê°„ ì§ì ‘ ì‚¬ìš© (ì‹œê°„ëŒ€ ë³€í™˜í•˜ì§€ ì•ŠìŒ)
        // CSV íŒŒì¼ê³¼ í•¸ë“œ ì‹œê°„ì´ ëª¨ë‘ ë™ì¼í•œ ì‹œê°„ëŒ€ë¼ê³  ê°€ì •
        const targetHours = targetDate.getHours();
        const targetMinutes = targetDate.getMinutes();
        const targetSeconds = targetDate.getSeconds();
        
        // console.log(`ğŸ¯ ë§¤ì¹­í•  ì‹œê°„: ${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}:${targetSeconds.toString().padStart(2, '0')}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì •í™•í•œ íƒ€ê²Ÿ ì‹œê°„ ê³„ì‚°
        const targetTotalSeconds = targetHours * 3600 + targetMinutes * 60 + targetSeconds;
        
        // console.log(`ğŸ¯ íƒ€ê²Ÿ ì‹œê°„ (Seoul): ${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}:${targetSeconds.toString().padStart(2, '0')} (${targetTotalSeconds}ì´ˆ)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        let closestRow = null;
        let minDiff = Infinity;
        let rowIndex = -1;
        let matchedTime = '';
        let validTimeFoundCount = 0;
        
        // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ ì§€ì›ì„ ìœ„í•œ ì •ê·œì‹ë“¤
        const timePatterns = [
          // í‘œì¤€ ì‹œê°„ í˜•ì‹
          { pattern: /(\d{1,2}):(\d{2}):(\d{2})/, name: 'HH:MM:SS' },
          { pattern: /(\d{1,2}):(\d{2})/, name: 'HH:MM' },
          // í•œêµ­ì–´ í˜•ì‹
          { pattern: /(\d{1,2})ì‹œ\s*(\d{2})ë¶„\s*(\d{2})ì´ˆ/, name: 'í•œêµ­ì–´ ì‹œë¶„ì´ˆ' },
          { pattern: /(\d{1,2})ì‹œ\s*(\d{2})ë¶„/, name: 'í•œêµ­ì–´ ì‹œë¶„' },
          // ì¶”ê°€ í˜•ì‹ë“¤ (ê³µë°±, ì , AM/PM)
          { pattern: /(\d{1,2})\s*:\s*(\d{2})\s*:\s*(\d{2})/, name: 'HH : MM : SS (ê³µë°±)' },
          { pattern: /(\d{1,2})\s*:\s*(\d{2})/, name: 'HH : MM (ê³µë°±)' },
          { pattern: /(\d{1,2})\.(\d{2})\.(\d{2})/, name: 'HH.MM.SS' },
          { pattern: /(\d{1,2})\.(\d{2})/, name: 'HH.MM' },
          // ë‚ ì§œ-ì‹œê°„ í˜¼í•© í˜•ì‹ (ì¼ë¶€ ì‹œíŠ¸ì—ì„œ ì‚¬ìš©)
          { pattern: /\d{1,2}\/\d{1,2}\s+(\d{1,2}):(\d{2})/, name: 'M/D HH:MM' },
          { pattern: /\d{4}-\d{2}-\d{2}\s+(\d{1,2}):(\d{2}):(\d{2})/, name: 'YYYY-MM-DD HH:MM:SS' }
        ];
        
        // console.log(`ğŸ” === Bì—´ ì‹œê°„ ë°ì´í„° ë§¤ì¹­ ì‹œì‘ ===`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ” ì´ ${rows.length}ê°œ í–‰ì—ì„œ ê²€ìƒ‰ ì¤‘...`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ” íƒ€ê²Ÿ ì‹œê°„: ${targetHours}:${targetMinutes}:${targetSeconds} (ì´ ${targetTotalSeconds}ì´ˆ)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ í–‰ì˜ ì „ì²´ ë°ì´í„° í™•ì¸
        // console.log(`ğŸ“‹ ì²˜ìŒ 5ê°œ í–‰ì˜ ì „ì²´ ë°ì´í„° ìƒ˜í”Œ:`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // for (let i = 0; i < Math.min(5, rows.length); i++) {
        //   console.log(`   í–‰ ${i+1}:`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        //   console.log(`      Aì—´: "${rows[i][0] || '(ë¹„ì–´ìˆìŒ)'}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        //   console.log(`      Bì—´: "${rows[i][1] || '(ë¹„ì–´ìˆìŒ)'}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        //   console.log(`      Cì—´: "${rows[i][2] || '(ë¹„ì–´ìˆìŒ)'}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        //   console.log(`      Dì—´: "${rows[i][3] || '(ë¹„ì–´ìˆìŒ)'}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          
        //   // ê° ì—´ì—ì„œ ì‹œê°„ í˜•ì‹ ì°¾ê¸°
        //   for (let j = 0; j < Math.min(4, rows[i].length); j++) {
        //     const value = rows[i][j];
        //     if (value && value.match(/\d{1,2}:\d{2}/)) {
        //       console.log(`      ğŸ• ${String.fromCharCode(65+j)}ì—´ì— ì‹œê°„ í˜•ì‹ ë°œê²¬: "${value}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        //     }
        //   }
        // }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ - ì´ í–‰ ìˆ˜ ì„¤ì •
        updateProgress(0, rows.length, 0, 'ì‹œê°„ ë°ì´í„° ê²€ìƒ‰ ì¤‘...');
        const startTime = Date.now();
        
        // ë¨¼ì € Bì—´ì„ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë‹¤ë¥¸ ì—´ë„ í™•ì¸
        let columnToCheck = 1; // ê¸°ë³¸ê°’: Bì—´ (index 1)
        let columnName = 'B';
        
        // ì²˜ìŒ ëª‡ í–‰ì„ í™•ì¸í•˜ì—¬ ì‹œê°„ ë°ì´í„°ê°€ ìˆëŠ” ì—´ ì°¾ê¸°
        for (let col = 0; col < Math.min(4, rows[0].length); col++) {
          let timeFoundInColumn = 0;
          for (let row = 0; row < Math.min(10, rows.length); row++) {
            const value = rows[row][col];
            if (value && value.match(/\d{1,2}:\d{2}/)) {
              timeFoundInColumn++;
            }
          }
          if (timeFoundInColumn > 3) { // 10ê°œ ì¤‘ 3ê°œ ì´ìƒ ì‹œê°„ í˜•ì‹ì´ë©´ í•´ë‹¹ ì—´ ì‚¬ìš©
            columnToCheck = col;
            columnName = String.fromCharCode(65 + col);
            // console.log(`ğŸ¯ ì‹œê°„ ë°ì´í„°ê°€ ${columnName}ì—´(index ${col})ì—ì„œ ë°œê²¬ë¨ (${timeFoundInColumn}/10ê°œ)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            break;
          }
        }
        
        // console.log(`ğŸ“ ${columnName}ì—´(index ${columnToCheck})ì—ì„œ ì‹œê°„ ë°ì´í„° ê²€ìƒ‰ ì‹œì‘`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ì„ íƒëœ ì—´ì—ì„œ ê²€ìƒ‰
        for (let i = 0; i < rows.length; i++) {
          // ì¤‘ë‹¨ ì‹ í˜¸ í™•ì¸
          if (isAborted) {
            console.log('âŒ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
            break;
          }
          
          // ì£¼ê¸°ì ìœ¼ë¡œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ë§¤ 10í–‰ë§ˆë‹¤)
          if (i % 10 === 0) {
            const elapsed = Date.now() - startTime;
            const estimatedTotal = (elapsed / (i + 1)) * rows.length;
            const remaining = Math.max(0, estimatedTotal - elapsed);
            updateProgress(i, rows.length, remaining, `í–‰ ${i+1}/${rows.length} ê²€ì‚¬ ì¤‘...`);
          }
          
          const cellValue = rows[i][columnToCheck]; // ì„ íƒëœ ì—´ í™•ì¸
          if (!cellValue || !cellValue.trim()) {
            // ë¹ˆ ì…€ì€ ë¡œê·¸ ìƒëµ
            continue;
          }
          
          // console.log(`ğŸ” í–‰ ${i+1} ${columnName}ì—´ ê²€ì‚¬: "${cellValue}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€ (1468í–‰ ëª¨ë‘ ë¡œê·¸)
          
          let hours, minutes, seconds = 0;
          let timeMatch = null;
          let matchedPatternName = '';
          
          // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ íŒŒì‹±
          for (const {pattern, name} of timePatterns) {
            timeMatch = cellValue.match(pattern);
            if (timeMatch) {
              hours = parseInt(timeMatch[1]);
              minutes = parseInt(timeMatch[2]);
              seconds = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
              matchedPatternName = name;
              // console.log(`   âœ… íŒ¨í„´ ë§¤ì¹­: ${name} â†’ ${hours}:${minutes}:${seconds}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              break;
            }
          }
          
          if (!timeMatch) {
            // console.log(`   âŒ ì‹œê°„ í˜•ì‹ ë§¤ì¹­ ì‹¤íŒ¨`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            continue;
          }
          
          validTimeFoundCount++;
          
          // ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì •í™•í•œ ì‹œê°„ ê³„ì‚°
          const cellTotalSeconds = hours * 3600 + minutes * 60 + seconds;
          const diff = Math.abs(cellTotalSeconds - targetTotalSeconds);
          
          // console.log(`   ğŸ“Š ì‹œê°„ ì°¨ì´: ${diff}ì´ˆ (í˜„ì¬ ìµœì†Œ: ${minDiff}ì´ˆ)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          
          // ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„ ì—…ë°ì´íŠ¸
          if (diff < minDiff) {
            minDiff = diff;
            closestRow = rows[i];
            rowIndex = i + 1;
            matchedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // console.log(`   ğŸ¯ ìƒˆë¡œìš´ ìµœì  ë§¤ì¹­: í–‰ ${rowIndex}, ì°¨ì´ ${diff}ì´ˆ`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ ë§¤ìš° ê°€ê¹Œìš´ ê²½ìš° (5ì´ˆ ì´ë‚´) ì¦‰ì‹œ ì¢…ë£Œ
            if (diff <= 5) {
              // console.log(`âœ… === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì„±ê³µ! ===`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`   ğŸ“ ìœ„ì¹˜: í–‰ ${rowIndex}, Bì—´ (Cyprus ì‹œê°„)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`   ğŸ• ì‹œê°„: ${matchedTime} (${diff}ì´ˆ ì°¨ì´)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`   ğŸ“‹ ì „ì²´ í–‰ ë°ì´í„°:`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`      Aì—´(Blinds): "${rows[i][0] || ''}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`      Bì—´(Cyprus): "${rows[i][1] || ''}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`      Cì—´(Seoul): "${rows[i][2] || ''}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              // console.log(`      Dì—´(#): "${rows[i][3] || ''}"`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
              break;
            }
          }
        }
        
        // console.log(`ğŸ“Š === ë§¤ì¹­ ê²°ê³¼ ìš”ì•½ ===`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“Š ìœ íš¨í•œ ì‹œê°„ ë°ì´í„° ë°œê²¬: ${validTimeFoundCount}ê°œ`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“Š ìµœì†Œ ì‹œê°„ ì°¨ì´: ${minDiff === Infinity ? 'ë¬´í•œ' : minDiff + 'ì´ˆ'}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        // console.log(`ğŸ“Š ìµœì  ë§¤ì¹­ í–‰: ${rowIndex > 0 ? rowIndex : 'ì—†ìŒ'}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ê²°ê³¼ ë¡œê¹…
        if (minDiff > 5) {
          const diffMinutes = Math.floor(minDiff / 60);
          const diffSeconds = minDiff % 60;
          let timeDiffStr = '';
          
          if (diffMinutes > 0) {
            timeDiffStr = `${diffMinutes}ë¶„ ${diffSeconds}ì´ˆ`;
          } else {
            timeDiffStr = `${diffSeconds}ì´ˆ`;
          }
          
          // console.log(`âš ï¸ ì •í™•í•œ ë§¤ì¹˜ ì—†ìŒ. ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„:`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // console.log(`   ğŸ“ í–‰ ${rowIndex}, Bì—´: ${matchedTime} (${timeDiffStr} ì°¨ì´)`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        }
        
        // ìµœì¢… ê²°ê³¼ ì²˜ë¦¬ ë° ë°˜í™˜
        clearTimeout(timeoutId);
        if (showProgress) {
          hideProgressModal();
        }
        
        if (isAborted) {
          // console.error(`âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì·¨ì†Œ ===`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          return null;
        }
        
        if (closestRow && minDiff !== Infinity) {
          // console.log(`âœ… === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì™„ë£Œ ===`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // console.log(`âœ… ë§¤ì¹­ ì„±ê³µ: í–‰ ${rowIndex}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // console.log(`âœ… ì‹œê°„ ì°¨ì´: ${minDiff}ì´ˆ`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          // console.log(`âœ… ì •í™•ë„: ${minDiff <= 5 ? 'ì •í™• (5ì´ˆ ì´ë‚´)' : minDiff <= 30 ? 'ê·¼ì‚¬ (30ì´ˆ ì´ë‚´)' : 'ëŒ€ëµì  (30ì´ˆ ì´ˆê³¼)'}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
          
          // ë§¤ì¹­ëœ í–‰ì—ì„œ Eì—´ ìƒíƒœê°’ ì¶”ì¶œ
          const cols = closestRow;
          let status = cols[4]?.trim() || ''; // Eì—´
          let filename = cols[5]?.trim() || ''; // Fì—´

          // CSV íŒŒì‹± ì‹œ ë”°ì˜´í‘œ ì œê±° ì²˜ë¦¬
          if (status.startsWith('"') && status.endsWith('"')) {
            status = status.slice(1, -1).trim();
          }
          if (filename.startsWith('"') && filename.endsWith('"')) {
            filename = filename.slice(1, -1).trim();
          }

          console.log(`ğŸ” [ë””ë²„ê·¸] Eì—´ ì›ë³¸: "${cols[4]}" â†’ íŒŒì‹± í›„: "${status}"`);
          console.log(`ğŸ” [ë””ë²„ê·¸] Fì—´ ì›ë³¸: "${cols[5]}" â†’ íŒŒì‹± í›„: "${filename}"`);

          return {
            row: rowIndex,  // í–‰ ë²ˆí˜¸ (1-based index)
            rowData: closestRow,  // ì „ì²´ í–‰ ë°ì´í„°
            rowIndex: rowIndex,
            timeDiff: minDiff,
            targetTime: `${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}:${targetSeconds.toString().padStart(2, '0')}`,
            matchedTime: matchedTime,
            accuracy: minDiff <= 5 ? 'exact' : minDiff <= 30 ? 'close' : 'approximate',
            status: status, // Eì—´ ìƒíƒœê°’ ì¶”ê°€
            filename: filename, // Fì—´ íŒŒì¼ëª… ì¶”ê°€
            timestamp: targetTime // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
          };
        } else {
          console.error(`âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹¤íŒ¨ ===`);
          console.error(`âŒ ë§¤ì¹­í•  ìˆ˜ ìˆëŠ” ì‹œê°„ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
          console.error(`âŒ ìœ íš¨í•œ ì‹œê°„ ë°ì´í„°: ${validTimeFoundCount}ê°œ`);
          console.error(`âŒ ê²€ì‚¬í•œ í–‰ ìˆ˜: ${rows.length}ê°œ`);
          console.error(`âŒ íƒ€ê²Ÿ ì‹œê°„: ${targetHours}:${targetMinutes}:${targetSeconds}`);
          
          // Bì—´ ë°ì´í„° ìƒ˜í”Œ í‘œì‹œ
          console.error(`ğŸ“‹ Bì—´ ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 10ê°œ):`);
          for (let i = 0; i < Math.min(10, rows.length); i++) {
            const value = rows[i][1];
            if (value && value.trim()) {
              console.error(`   í–‰ ${i+1}: "${value}"`);
            }
          }
          
          console.error(`âŒ ê°€ëŠ¥í•œ ì›ì¸:`);
          console.error(`   - Bì—´ì— ì˜¬ë°”ë¥¸ ì‹œê°„ í˜•ì‹ì˜ ë°ì´í„°ê°€ ì—†ìŒ`);
          console.error(`   - ì§€ì›ë˜ëŠ” í˜•ì‹: HH:MM, HH:MM:SS, Nì‹œ Në¶„, Nì‹œ Në¶„ Nì´ˆ, HH.MM, M/D HH:MM ë“±`);
          console.error(`   - ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ ì—´ì„ ì°¸ì¡°í•˜ê³  ìˆìŒ`);
          
          if (validTimeFoundCount === 0) {
            console.error(`ğŸ’¡ í•´ê²°ì±…:`);
            console.error(`   1. Bì—´ì— ì‹œê°„ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”`);
            console.error(`   2. Virtual ì‹œíŠ¸ URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”`);
            console.error(`   3. ì‹œíŠ¸ê°€ ê³µê°œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”`);
            console.error(`   4. Bì—´ì— "14:35" ë˜ëŠ” "14ì‹œ 35ë¶„" í˜•ì‹ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
          } else {
            console.error(`ğŸ’¡ í•´ê²°ì±…: íƒ€ê²Ÿ ì‹œê°„(${targetHours}:${targetMinutes})ê³¼ ìœ ì‚¬í•œ ì‹œê°„ëŒ€ì˜ ë°ì´í„°ë¥¼ Bì—´ì— ì¶”ê°€í•˜ì„¸ìš”.`);
          }
          
          return null;
        }
      } catch (error) {
        clearTimeout(timeoutId);
        if (showProgress) {
          hideProgressModal();
        }
        
        console.error('âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹¤íŒ¨ ===');
        console.error('âŒ ì˜¤ë¥˜ íƒ€ì…:', error.name || 'Unknown');
        console.error('âŒ ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        console.error('âŒ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack || 'ìŠ¤íƒ ì •ë³´ ì—†ìŒ');
        console.error('âŒ ì…ë ¥ URL:', virtualSheetUrl);
        console.error('âŒ ì…ë ¥ íƒ€ì„ìŠ¤íƒ¬í”„:', targetTime);
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì›ì¸ ì•ˆë‚´
        if (error.message.includes('HTTP ì˜¤ë¥˜')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: Google Sheetsê°€ "ë§í¬ê°€ ìˆëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ê¸° ê¶Œí•œ"ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error.message.includes('ì˜¬ë°”ë¥¸ Google Sheets URLì´ ì•„ë‹™ë‹ˆë‹¤')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: URLì´ https://docs.google.com/spreadsheets/d/[ID]/... í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error.message.includes('CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€, ì˜¬ë°”ë¥¸ gidë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error instanceof TypeError) {
          console.error('ğŸ’¡ í•´ê²°ì±…: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ CORS ì •ì±… ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
        
        return null;
      }
    }
    
    // ì§„í–‰ë¥  ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    function showProgressModal() {
      const modal = document.getElementById('progress-modal');
      modal.classList.remove('hidden');
      
      // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ì¶”ê°€)
      const cancelBtn = document.getElementById('cancel-progress');
      cancelBtn.onclick = function() {
        isAborted = true;
        hideProgressModal();
        console.log('ğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
      };
    }
    
    function hideProgressModal() {
      const modal = document.getElementById('progress-modal');
      modal.classList.add('hidden');
      
      // ì§„í–‰ë¥  ì´ˆê¸°í™”
      document.getElementById('progress-bar').style.width = '0%';
      document.getElementById('progress-percentage').textContent = '0%';
      document.getElementById('current-row').textContent = '-';
      document.getElementById('total-rows').textContent = '-';
      document.getElementById('remaining-time').textContent = 'ê³„ì‚° ì¤‘...';
      document.getElementById('current-status').textContent = 'ì‹œì‘ ì¤‘...';
    }
    
    function updateProgress(currentRow, totalRows, remainingMs, status) {
      const percentage = Math.min(100, Math.round((currentRow / totalRows) * 100));
      
      // Progress Bar ì—…ë°ì´íŠ¸
      document.getElementById('progress-bar').style.width = percentage + '%';
      document.getElementById('progress-percentage').textContent = percentage + '%';
      
      // ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('current-row').textContent = currentRow;
      document.getElementById('total-rows').textContent = totalRows;
      document.getElementById('current-status').textContent = status;
      
      // ë‚¨ì€ ì‹œê°„ ê³„ì‚° ë° í‘œì‹œ
      if (remainingMs > 0) {
        const remainingSeconds = Math.ceil(remainingMs / 1000);
        if (remainingSeconds > 60) {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          document.getElementById('remaining-time').textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
        } else {
          document.getElementById('remaining-time').textContent = `${remainingSeconds}ì´ˆ`;
        }
      } else {
        document.getElementById('remaining-time').textContent = 'ì™„ë£Œ ì¤‘...';
      }
    }
    
    // í•¸ë“œ ì„¸ë¶€ ì •ë³´ UI ì´ˆê¸°í™”
    function clearHandDetails() {
      console.log('ğŸ§¹ í•¸ë“œ ì„¸ë¶€ ì •ë³´ ì´ˆê¸°í™”...');
      
      // í—¤ë” ì •ë³´ ì´ˆê¸°í™”
      document.getElementById('hand-number').textContent = '-';
      document.getElementById('table-name').textContent = '-';
      document.getElementById('blinds').textContent = '-/-';
      document.getElementById('pot-amount').textContent = '-';
      
      // ì¹´ë©”ë¼ íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
      const cameraFilesEl = document.getElementById('camera-files');
      cameraFilesEl.textContent = 'ì„ íƒëœ í•¸ë“œ ì—†ìŒ';
      cameraFilesEl.title = '';
      
      // ë³´ë“œ ì¹´ë“œ ì´ˆê¸°í™”
      const boardEl = document.getElementById('community-cards');
      if (boardEl) {
        boardEl.innerHTML = '<div class="card-placeholder">ë³´ë“œ ì¹´ë“œ</div>';
      }
      
      // í”Œë ˆì´ì–´ ì„¹ì…˜ ì´ˆê¸°í™”
      const playersEl = document.getElementById('players-section');
      if (playersEl) {
        playersEl.innerHTML = '<div class="text-gray-500 text-center py-4">ì„ íƒëœ í•¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      // ì•¡ì…˜ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
      const historyEl = document.getElementById('action-history');
      if (historyEl) {
        historyEl.innerHTML = '<div class="text-gray-500 text-center py-4">ì•¡ì…˜ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      // í•¸ë“œ ê²°ê³¼ ì´ˆê¸°í™”
      const resultEl = document.getElementById('hand-result');
      if (resultEl) {
        resultEl.innerHTML = '<div class="text-gray-500 text-center py-4">í•¸ë“œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      console.log('âœ… í•¸ë“œ ì„¸ë¶€ ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ===== URL ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ë“¤ =====
    
    // CSV URL ìœ íš¨ì„± ê²€ì‚¬
    function validateCsvUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Google Sheets CSV ê²Œì‹œ URL í˜•ì‹
      if (url.includes('docs.google.com/spreadsheets/d/e/') && url.includes('/pub?') && url.includes('output=csv')) {
        return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ CSV ê²Œì‹œ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'csv' };
      }
      
      // ì¼ë°˜ Google Sheets í¸ì§‘ URL
      if (url.includes('docs.google.com/spreadsheets/d/') && url.includes('/edit')) {
        return { 
          valid: false, 
          message: 'âš ï¸ í¸ì§‘ URLì´ ì•„ë‹Œ CSV ê²Œì‹œ URLì´ í•„ìš”í•©ë‹ˆë‹¤', 
          type: 'edit',
          suggestion: 'ğŸ“ íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ â†’ CSV ì„ íƒ í›„ ê²Œì‹œí•˜ì„¸ìš”' 
        };
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Google Sheets CSV ê²Œì‹œ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // Google Sheets í¸ì§‘ URL ìœ íš¨ì„± ê²€ì‚¬
    function validateSheetUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Google Sheets í¸ì§‘ URL í˜•ì‹
      if (url.includes('docs.google.com/spreadsheets/d/') && url.includes('/edit')) {
        if (url.includes('gid=')) {
          return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Google Sheets URLì…ë‹ˆë‹¤ (íŠ¹ì • ì‹œíŠ¸ ì§€ì •)', type: 'sheet_gid' };
        } else {
          return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Google Sheets URLì…ë‹ˆë‹¤', type: 'sheet' };
        }
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Google Sheets í¸ì§‘ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // Apps Script URL ìœ íš¨ì„± ê²€ì‚¬
    function validateAppsScriptUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Apps Script Web App URL í˜•ì‹
      if (url.includes('script.google.com/macros/s/') && url.endsWith('/exec')) {
        return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Apps Script Web App URLì…ë‹ˆë‹¤', type: 'apps_script' };
      }
      
      // Apps Script í¸ì§‘ URL
      if (url.includes('script.google.com/') && url.includes('/edit')) {
        return { 
          valid: false, 
          message: 'âš ï¸ í¸ì§‘ URLì´ ì•„ë‹Œ Web App ë°°í¬ URLì´ í•„ìš”í•©ë‹ˆë‹¤', 
          type: 'edit',
          suggestion: 'ğŸ“ ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ì›¹ ì•± ë°°í¬ URL ì‚¬ìš©í•˜ì„¸ìš”' 
        };
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Apps Script Web App URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // UI í”¼ë“œë°± ì—…ë°ì´íŠ¸
    function updateUrlFeedback(inputId, feedbackId, validation) {
      const input = document.getElementById(inputId);
      const feedback = document.getElementById(feedbackId);
      
      if (!input || !feedback) return;
      
      // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      input.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500', 'border-gray-600');
      
      if (validation.valid) {
        input.classList.add('border-green-500');
        feedback.className = 'text-xs mt-1 text-green-400';
        feedback.textContent = validation.message;
      } else {
        if (validation.type === 'empty') {
          input.classList.add('border-gray-600');
          feedback.className = 'text-xs mt-1 text-gray-400';
          feedback.textContent = validation.message;
        } else if (validation.type === 'edit' || validation.suggestion) {
          input.classList.add('border-yellow-500');
          feedback.className = 'text-xs mt-1 text-yellow-400';
          feedback.textContent = validation.message;
          if (validation.suggestion) {
            feedback.textContent += '\n' + validation.suggestion;
          }
        } else {
          input.classList.add('border-red-500');
          feedback.className = 'text-xs mt-1 text-red-400';
          feedback.textContent = validation.message;
        }
      }
    }
    
    // ===== Apps Script ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ =====
    
    // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testAppsScriptConnection() {
      // ì‹¤ì‹œê°„ìœ¼ë¡œ ì…ë ¥ í•„ë“œì—ì„œ URL ê°€ì ¸ì˜¤ê¸° (CONFIG ëŒ€ì‹ )
      const appsScriptUrlInput = document.getElementById('apps-script-url');
      const appsScriptUrl = appsScriptUrlInput ? appsScriptUrlInput.value : CONFIG.SHEET_UPDATE_SCRIPT_URL;
      
      console.log('ğŸ” Apps Script URL ë””ë²„ê¹…:', appsScriptUrl);
      console.log('ğŸ” ì…ë ¥ í•„ë“œ ê°’:', appsScriptUrlInput ? appsScriptUrlInput.value : 'N/A');
      console.log('ğŸ” CONFIG ê°’:', CONFIG.SHEET_UPDATE_SCRIPT_URL);
      console.log('ğŸ” ì‚¬ìš©í•  URL:', appsScriptUrl);
      
      if (!appsScriptUrl || appsScriptUrl.trim() === '') {
        alert('âš ï¸ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nì„¤ì • ë‹¨ê³„:\n1. ì„¤ì • ë²„íŠ¼ í´ë¦­\n2. "Apps Script ì‹œíŠ¸ ì—°ë™" ì„¹ì…˜ ì°¾ê¸°\n3. "Apps Script Web App URL" í•„ë“œì— URL ì…ë ¥\n4. ì„¤ì • ì €ì¥ í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸');
        return false;
      }
      
      // URL í˜•ì‹ ê²€ì¦
      if (!appsScriptUrl.includes('script.google.com') || !appsScriptUrl.includes('/exec')) {
        alert('âš ï¸ Apps Script URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì˜¬ë°”ë¥¸ í˜•ì‹:\nhttps://script.google.com/macros/s/[SCRIPT_ID]/exec\n\ní˜„ì¬ URL:\n' + appsScriptUrl);
        return false;
      }
      
      console.log('ğŸ§ª Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      console.log('ğŸŒ ìš”ì²­ URL:', appsScriptUrl);
      
      // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      const testBtn = document.getElementById('test-apps-script');
      const originalText = testBtn.textContent;
      testBtn.disabled = true;
      testBtn.textContent = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
      
      try {
        // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ (POST ì‚¬ìš© - CORS íšŒí”¼)
        console.log('ğŸ“¡ POST ìš”ì²­ ì „ì†¡ ì¤‘...');
        
        const testData = {
          action: 'test',
          timestamp: new Date().toISOString(),
          source: 'connection_test'
        };
        
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          mode: 'no-cors',  // CORS ì •ì±… ìš°íšŒ
          headers: {
            'Content-Type': 'text/plain',  // CORS íšŒí”¼ìš©
          },
          body: JSON.stringify(testData)
        });
        
        console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);
        console.log('ğŸ“¡ ì‘ë‹µ í—¤ë”:', response.headers);
        
        if (response.ok) {
          const responseText = await response.text();
          console.log('ğŸ“¡ ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);
          
          try {
            const data = JSON.parse(responseText);
            console.log('âœ… Apps Script ì—°ê²° ì„±ê³µ:', data);
            
            alert(`âœ… Apps Script ì—°ê²° ì„±ê³µ!\n\nğŸ”— ì„œë¹„ìŠ¤: ${data.service || 'Virtual Table Sheet Updater'}\nğŸ“Š ìƒíƒœ: ${data.status}\nğŸ“ˆ ë²„ì „: ${data.version || 'v1.1'}\nâ° ì‹œê°„: ${data.timestamp ? new Date(data.timestamp).toLocaleString() : new Date().toLocaleString()}\nğŸ“  ë©”ì‹œì§€: ${data.message || 'ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™'}`);
            return true;
            
          } catch (jsonError) {
            console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', jsonError);
            console.log('ğŸ“„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜. HTML ì‘ë‹µì¼ ìˆ˜ ìˆìŒ:', responseText.substring(0, 200));
            alert(`âš ï¸ Apps Script ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‘ë‹µ ìƒíƒœ: ${response.status}\nì‘ë‹µ ë‚´ìš©: ${responseText.substring(0, 100)}...\n\ní•´ê²°ì±…:\nâ€¢ Apps Scriptê°€ ì˜¬ë°”ë¥´ê²Œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ doGet í•¨ìˆ˜ê°€ JSON ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸`);
            return false;
          }
          
        } else {
          console.error('âŒ Apps Script ì—°ê²° ì‹¤íŒ¨:', response.status, response.statusText);
          const responseText = await response.text();
          console.log('âŒ ì˜¤ë¥˜ ì‘ë‹µ:', responseText);
          
          alert(`âŒ Apps Script ì—°ê²° ì‹¤íŒ¨\n\nğŸ“Š ìƒíƒœ ì½”ë“œ: ${response.status}\nâŒ ì˜¤ë¥˜: ${response.statusText}\nğŸ“„ ìƒì„¸: ${responseText.substring(0, 200)}...\n\ní•´ê²°ì±…:\nâ€¢ Apps Script URLì´ ì •í™•í•œì§€ í™•ì¸\nâ€¢ ì›¹ì•±ì´ "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ Apps Script ì‹¤í–‰ ê¶Œí•œ í™•ì¸`);
          return false;
        }
        
      } catch (error) {
        console.error('âŒ Apps Script ì—°ê²° ì˜¤ë¥˜:', error);
        
        let errorMessage = `âŒ Apps Script ì—°ê²° ì˜¤ë¥˜\n\nğŸ” ì˜¤ë¥˜ ìœ í˜•: ${error.name}\nğŸ’¬ ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}\n\n`;
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += `ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í•´ê²°ì±…:\nâ€¢ ì¸í„°ë„· ì—°ê²° ìƒíƒœ í™•ì¸\nâ€¢ Apps Script URLì´ ì •í™•í•œì§€ í™•ì¸\nâ€¢ ì›¹ì•±ì´ ë°°í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸\nâ€¢ ë°©í™”ë²½/ë³´ì•ˆ í”„ë¡œê·¸ë¨ í™•ì¸`;
        } else if (error.name === 'TypeError' && error.message.includes('CORS')) {
          errorMessage += `ğŸ”’ CORS ì˜¤ë¥˜ í•´ê²°ì±…:\nâ€¢ Apps Script ì›¹ì•±ì„ "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ë¡œ ì¬ë°°í¬\nâ€¢ Apps Script URLì´ /execë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸`;
        } else {
          errorMessage += `ğŸ”§ ì¼ë°˜ì ì¸ í•´ê²°ì±…:\nâ€¢ Apps Script URL í˜•ì‹ í™•ì¸:\n  https://script.google.com/macros/s/[SCRIPT_ID]/exec\nâ€¢ ì›¹ì•± ë°°í¬ ìƒíƒœ í™•ì¸\nâ€¢ ì‹¤í–‰ ê¶Œí•œ ì„¤ì • í™•ì¸\nâ€¢ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ í›„ ì¬ì‹œë„`;
        }
        
        alert(errorMessage);
        return false;
        
      } finally {
        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë³µêµ¬
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      }
    }

    // ğŸ§ª ê°„ë‹¨í•œ AI API í…ŒìŠ¤íŠ¸ (ì½˜ì†”ìš©)
    window.quickAITest = async function() {
      console.log('ğŸ§ª ë¹ ë¥¸ AI API í…ŒìŠ¤íŠ¸ ì‹œì‘');

      if (!CONFIG.GEMINI_API_KEY) {
        console.error('âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
        return 'âŒ API í‚¤ ì—†ìŒ';
      }

      const testPrompt = "í¬ì»¤ í•¸ë“œ: AA vs KK. ê²°ê³¼ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.";
      console.log('ğŸ“ í…ŒìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸:', testPrompt);

      try {
        const result = await callGeminiAPIAdvanced(testPrompt, CONFIG.GEMINI_API_KEY);
        console.log('âœ… AI ì‘ë‹µ:', result);
        return result;
      } catch (error) {
        console.error('âŒ AI í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        return `âŒ ì˜¤ë¥˜: ${error.message}`;
      }
    };

    // ğŸ’¾ ëª¨ë“  ì„¤ì • ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    async function loadAllSettings() {
      console.log('ğŸ’¾ ì„¤ì • ë¡œë“œ ì‹œì‘...');

      try {
        // 1. ê¸°ë³¸ ì„¤ì • ë¡œë“œ
        const refreshInterval = localStorage.getItem('refreshInterval');
        const enableNotifications = localStorage.getItem('enableNotifications');
        const enableSound = localStorage.getItem('enableSound');

        if (refreshInterval) {
          CONFIG.REFRESH_INTERVAL = parseInt(refreshInterval);
          const elem = document.getElementById('refresh-interval');
          if (elem) elem.value = refreshInterval;
        }

        if (enableNotifications !== null) {
          CONFIG.ENABLE_NOTIFICATIONS = enableNotifications === 'true';
          const elem = document.getElementById('enable-notifications');
          if (elem) elem.checked = CONFIG.ENABLE_NOTIFICATIONS;
        }

        if (enableSound !== null) {
          CONFIG.ENABLE_SOUND = enableSound === 'true';
          const elem = document.getElementById('enable-sound');
          if (elem) elem.checked = CONFIG.ENABLE_SOUND;
        }

        // 2. ì‹œíŠ¸ URL ì„¤ì • ë¡œë“œ
        const savedMainSheetUrl = localStorage.getItem('main_sheet_url');
        const savedAppsScriptUrl = localStorage.getItem('sheet_update_script_url');

        if (savedMainSheetUrl) {
          CONFIG.MAIN_SHEET_URL = savedMainSheetUrl;
          CONFIG.READ_SHEET_URL = savedMainSheetUrl; // í˜¸í™˜ì„±
          CONFIG.WRITE_SHEET_URL = savedMainSheetUrl; // í˜¸í™˜ì„±

          const elem = document.getElementById('main-sheet-url');
          if (elem) elem.value = savedMainSheetUrl;
          console.log(`ğŸ“‹ ë©”ì¸ ì‹œíŠ¸ URL ë¡œë“œ: ${savedMainSheetUrl.substring(0, 50)}...`);
        }

        if (savedAppsScriptUrl) {
          CONFIG.SHEET_UPDATE_SCRIPT_URL = savedAppsScriptUrl;
          const elem = document.getElementById('apps-script-url');
          if (elem) elem.value = savedAppsScriptUrl;
          console.log(`ğŸ”§ Apps Script URL ë¡œë“œ: ${savedAppsScriptUrl.substring(0, 50)}...`);
        }

        // 3. íŒŒì¼ëª… ì»¤ìŠ¤í„°ë§ˆì´ì§• ì„¤ì • ë¡œë“œ
        const filenamePrefix = localStorage.getItem('filenamePrefix');
        const filenameSuffix = localStorage.getItem('filenameSuffix');

        if (filenamePrefix !== null) {
          const elem = document.getElementById('filename-prefix');
          if (elem) elem.value = filenamePrefix;
          console.log(`ğŸ“ íŒŒì¼ëª… ì ‘ë‘ì‚¬ ë¡œë“œ: "${filenamePrefix}"`);
        }

        if (filenameSuffix !== null) {
          const elem = document.getElementById('filename-suffix');
          if (elem) elem.value = filenameSuffix;
          console.log(`ğŸ“ íŒŒì¼ëª… ì ‘ë¯¸ì‚¬ ë¡œë“œ: "${filenameSuffix}"`);
        }

        // 4. AI ê¸°ëŠ¥ ì„¤ì • ë¡œë“œ (ê°€ì¥ ì¤‘ìš”!)
        const useAIForFilename = localStorage.getItem('useAIForFilename');
        const useAIForHColumn = localStorage.getItem('useAIForHColumn');

        console.log(`ğŸ¤– localStorage AI ì„¤ì • í™•ì¸:`);
        console.log(`   - useAIForFilename: "${useAIForFilename}"`);
        console.log(`   - useAIForHColumn: "${useAIForHColumn}"`);

        if (useAIForFilename !== null && useAIForFilename !== 'null') {
          const elem = document.getElementById('ai-filename-enable');
          const isEnabled = useAIForFilename === 'true';
          if (elem) {
            elem.checked = isEnabled;
            console.log(`ğŸ¤– AI íŒŒì¼ëª… ì²´í¬ë°•ìŠ¤: ${isEnabled}`);
          }
        }

        if (useAIForHColumn !== null && useAIForHColumn !== 'null') {
          const elem = document.getElementById('ai-hcolumn-enable');
          const isEnabled = useAIForHColumn === 'true';
          if (elem) {
            elem.checked = isEnabled;
            console.log(`ğŸ¤– AI Hì—´ ì²´í¬ë°•ìŠ¤: ${isEnabled}`);
          }
        }

        // 5. Gemini API í‚¤ ë¡œë“œ (ì´ë¯¸ loadAPIKeysì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ UIë„ ì—…ë°ì´íŠ¸)
        if (CONFIG.GEMINI_API_KEY) {
          const elem = document.getElementById('gemini-api-key');
          if (elem && !elem.value) { // ì´ë¯¸ ì…ë ¥ëœ ê°’ì´ ì—†ì„ ë•Œë§Œ
            elem.value = CONFIG.GEMINI_API_KEY;
            console.log(`ğŸ”‘ API í‚¤ UI ë³µì› ì™„ë£Œ (ê¸¸ì´: ${CONFIG.GEMINI_API_KEY.length})`);
          }
        }

        console.log('âœ… ëª¨ë“  ì„¤ì • ë¡œë“œ ì™„ë£Œ');

      } catch (error) {
        console.error('âŒ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ğŸ¨ íŒŒì¼ëª… í…œí”Œë¦¿ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function updateFilenamePreview() {
      const template = document.getElementById('filename-template')?.value || '{prefix}{handNumber}';
      const prefix = document.getElementById('filename-prefix')?.value || '';
      const suffix = document.getElementById('filename-suffix')?.value || '';
      const previewElement = document.getElementById('filename-preview');

      if (!previewElement) return;

      // ì˜ˆì‹œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
      const sampleData = {
        prefix: prefix,
        suffix: suffix,
        handNumber: 142,
        date: new Date().toISOString().slice(0, 10).replace(/-/g, ''),
        timestamp: Date.now(),
        position: 'BTN',
        action: '3bet',
        result: 'win',
        ai_summary: 'bluff_catch_win'
      };

      // í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜
      let preview = template;
      Object.entries(sampleData).forEach(([key, value]) => {
        preview = preview.replace(new RegExp(`\\{${key}\\}`, 'g'), value || '');
      });

      // ì—°ì†ëœ ë°‘ì¤„ ì •ë¦¬
      preview = preview.replace(/_{2,}/g, '_').replace(/^_+|_+$/g, '');

      previewElement.textContent = preview || 'H142';
    }

    // í…œí”Œë¦¿ í”„ë¦¬ì…‹ ë³€ê²½ ì²˜ë¦¬
    function handleTemplatePresetChange(event) {
      const templateField = document.getElementById('filename-template');
      if (!templateField) return;

      const presets = {
        'simple': '{prefix}{handNumber}',
        'detailed': '{prefix}{handNumber}_{position}_{action}',
        'timestamped': '{prefix}{handNumber}_{date}_{timestamp}',
        'ai': '{prefix}{handNumber}_{ai_summary}',
        'custom': templateField.value // í˜„ì¬ ê°’ ìœ ì§€
      };

      const selectedPreset = event.target.value;
      if (selectedPreset !== 'custom') {
        templateField.value = presets[selectedPreset];
        updateFilenamePreview();
      }
    }

    // ğŸ’¾ ëª¨ë“  ì„¤ì • ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
    function saveAllSettings() {
      console.log('ğŸ’¾ ëª¨ë“  ì„¤ì • ì €ì¥ ì‹œì‘...');

      try {
        // 1. ê¸°ë³¸ ì„¤ì • ì €ì¥
        const refreshInterval = document.getElementById('refresh-interval')?.value;
        const enableNotifications = document.getElementById('enable-notifications')?.checked;
        const enableSound = document.getElementById('enable-sound')?.checked;

        if (refreshInterval) {
          localStorage.setItem('refreshInterval', refreshInterval);
          CONFIG.REFRESH_INTERVAL = parseInt(refreshInterval);
        }

        localStorage.setItem('enableNotifications', String(enableNotifications));
        localStorage.setItem('enableSound', String(enableSound));
        CONFIG.ENABLE_NOTIFICATIONS = enableNotifications;
        CONFIG.ENABLE_SOUND = enableSound;

        // 2. ì‹œíŠ¸ URL ì €ì¥
        const mainSheetUrl = document.getElementById('main-sheet-url')?.value;
        const appsScriptUrl = document.getElementById('apps-script-url')?.value;

        if (mainSheetUrl) {
          localStorage.setItem('main_sheet_url', mainSheetUrl);
          CONFIG.MAIN_SHEET_URL = mainSheetUrl;
          CONFIG.READ_SHEET_URL = mainSheetUrl;
          CONFIG.WRITE_SHEET_URL = mainSheetUrl;
        }

        if (appsScriptUrl) {
          localStorage.setItem('sheet_update_script_url', appsScriptUrl);
          CONFIG.SHEET_UPDATE_SCRIPT_URL = appsScriptUrl;
        }

        // 3. íŒŒì¼ëª… ì„¤ì • ì €ì¥ (í…œí”Œë¦¿ í¬í•¨)
        const filenamePrefix = document.getElementById('filename-prefix')?.value || '';
        const filenameSuffix = document.getElementById('filename-suffix')?.value || '';
        const filenameTemplate = document.getElementById('filename-template')?.value || '{prefix}{handNumber}';
        const templatePreset = document.getElementById('template-preset')?.value || 'simple';

        localStorage.setItem('filenamePrefix', filenamePrefix);
        localStorage.setItem('filenameSuffix', filenameSuffix);
        localStorage.setItem('filenameTemplate', filenameTemplate);
        localStorage.setItem('templatePreset', templatePreset);

        // FilenameManagerì— í…œí”Œë¦¿ ì„¤ì • ì „ë‹¬
        if (window.FilenameManager) {
          window.FilenameManager.config.template = filenameTemplate;
          window.FilenameManager.config.prefix = filenamePrefix;
          window.FilenameManager.config.suffix = filenameSuffix;
        }

        // 4. AI ì„¤ì • ì €ì¥ (ì¤‘ìš”!)
        const aiFilenameEnabled = document.getElementById('ai-filename-enable')?.checked || false;
        const aiHColumnEnabled = document.getElementById('ai-hcolumn-enable')?.checked || false;

        localStorage.setItem('useAIForFilename', String(aiFilenameEnabled));
        localStorage.setItem('useAIForHColumn', String(aiHColumnEnabled));

        console.log(`ğŸ¤– AI ì„¤ì • ì €ì¥:`);
        console.log(`   - useAIForFilename: ${aiFilenameEnabled}`);
        console.log(`   - useAIForHColumn: ${aiHColumnEnabled}`);

        // 5. API í‚¤ ì €ì¥
        const apiKey = document.getElementById('gemini-api-key')?.value?.trim() || '';
        CONFIG.GEMINI_API_KEY = apiKey;

        console.log('âœ… ëª¨ë“  ì„¤ì • ì €ì¥ ì™„ë£Œ');

        // ì €ì¥ ì™„ë£Œ ì•Œë¦¼
        showNotification('âœ… ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

      } catch (error) {
        console.error('âŒ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
        showNotification('âŒ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // Gemini API ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testGeminiAPIConnection() {
      console.log('ğŸ§ª Gemini API í…ŒìŠ¤íŠ¸ ì‹œì‘');
      
      // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      const testBtn = document.getElementById('test-gemini-api');
      const originalText = testBtn.textContent;
      testBtn.disabled = true;
      testBtn.textContent = 'ğŸ”„ API í…ŒìŠ¤íŠ¸ ì¤‘...';
      
      try {
        // ë¨¼ì € í˜„ì¬ ì…ë ¥ê°’ì„ CONFIGì— ì„ì‹œ ì €ì¥
        const apiKeyInput = document.getElementById('gemini-api-key').value.trim();
        if (apiKeyInput) {
          CONFIG.GEMINI_API_KEY = apiKeyInput;
          console.log('ğŸ’¾ ì…ë ¥ëœ API í‚¤ë¥¼ CONFIGì— ì„ì‹œ ì €ì¥:', apiKeyInput.length + 'ê¸€ì');
        }
        
        // CONFIGì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸° (ì €ì¥ëœ ê°’ ë˜ëŠ” ë°©ê¸ˆ ì…ë ¥í•œ ê°’)
        const apiKeyToTest = CONFIG.GEMINI_API_KEY;
        console.log('ğŸ”‘ í…ŒìŠ¤íŠ¸í•  API í‚¤:', apiKeyToTest ? `ì„¤ì •ë¨ (ê¸¸ì´: ${apiKeyToTest.length})` : 'ì—†ìŒ');
        
        // API í‚¤ ê¸°ë³¸ ê²€ì¦
        if (!apiKeyToTest || apiKeyToTest.trim() === '') {
          alert('âš ï¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\ní˜„ì¬ ìƒíƒœ:\nâ€¢ ì…ë ¥ í•„ë“œì— API í‚¤ë¥¼ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸\nâ€¢ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸');
          return false;
        }
        
        if (!apiKeyToTest.startsWith('AIza')) {
          alert('âš ï¸ Gemini API í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nAIzaë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.\n\ní˜„ì¬ í‚¤ ì‹œì‘: ' + apiKeyToTest.substring(0, 10) + '...');
          return false;
        }
        
        // í…ŒìŠ¤íŠ¸ìš© ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸
        const testPrompt = "ì•ˆë…•í•˜ì„¸ìš”. ì´ê²ƒì€ API ì—°ê²° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. 'í…ŒìŠ¤íŠ¸ ì„±ê³µ'ì´ë¼ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”.";
        
        console.log('ğŸŒ Gemini API í…ŒìŠ¤íŠ¸ í˜¸ì¶œ ì¤‘...');
        const result = await callGeminiAPIAdvanced(testPrompt, apiKeyToTest);
        
        console.log('ğŸ“¦ í…ŒìŠ¤íŠ¸ ì‘ë‹µ:', result);
        
        if (result.includes('âŒ')) {
          alert(`âŒ Gemini API ì—°ê²° ì‹¤íŒ¨\n\n${result}\n\ní•´ê²°ì±…:\nâ€¢ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\nâ€¢ Gemini API ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ í• ë‹¹ëŸ‰ì´ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸`);
          return false;
        } else {
          alert(`âœ… Gemini API ì—°ê²° ì„±ê³µ!\n\nì‘ë‹µ ë‚´ìš©:\n${result.substring(0, 100)}${result.length > 100 ? '...' : ''}\n\nAPI í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.`);
          return true;
        }
        
      } catch (error) {
        console.error('âŒ API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
        alert(`âŒ API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n${error.message}`);
        return false;
        
      } finally {
        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë³µêµ¬
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      }
    }
    
    // ì‹œíŠ¸ì— ë°ì´í„° ì—…ë°ì´íŠ¸ (Fì—´: íŒŒì¼ëª…, Hì—´: AIë¶„ì„)
    async function updateSheetData(matchedRow, handNumber, filename, aiAnalysis, customData = null) {
      // getAppsScriptUrl() í•¨ìˆ˜ë¥¼ í†µí•´ URL ê°€ì ¸ì˜¤ê¸°
      const appsScriptUrl = getAppsScriptUrl();
      const sheetUrl = getSheetUrl(); // í†µí•©ëœ ì‹œíŠ¸ URL ì‚¬ìš©

      if (!appsScriptUrl) {
        throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }

      if (!sheetUrl) {
        throw new Error('ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }

      console.log('ğŸ“Š === ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
      console.log(`ğŸ“ ë§¤ì¹­ëœ í–‰: ${matchedRow}`);
      console.log(`ğŸ”¢ í•¸ë“œ ë²ˆí˜¸: ${handNumber}`);
      console.log(`ğŸ“ íŒŒì¼ëª…: ${filename}`);
      console.log(`ğŸ¤– AI ë¶„ì„: ${aiAnalysis}`);
      console.log(`ğŸ” customData:`, customData);
      console.log(`ğŸ¬ ìë§‰ ì •ë³´: ${customData?.subtitle || 'ì—†ìŒ'}`);

      // AI ë¶„ì„ í…ìŠ¤íŠ¸ë¥¼ CSV ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (í°ë”°ì˜´í‘œë¡œ ë¬¶ê³  ë‚´ë¶€ í°ë”°ì˜´í‘œëŠ” ì´ì¤‘í™”)
      let safeAiAnalysis = aiAnalysis || `í•¸ë“œ #${handNumber} - ${new Date().toLocaleString('ko-KR')}`;
      // ë©€í‹°ë¼ì¸ê³¼ íŠ¹ìˆ˜ë¬¸ìë¥¼ ìœ„í•´ í°ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
      if (safeAiAnalysis.includes('\n') || safeAiAnalysis.includes(',') || safeAiAnalysis.includes('"')) {
        safeAiAnalysis = `"${safeAiAnalysis.replace(/"/g, '""')}"`;  // RFC 4180 CSV í‘œì¤€
      }

      // customDataê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
      let updateData;
      if (customData) {
        // customDataê°€ ìˆëŠ” ê²½ìš°, aiAnalysisê°€ ì´ë¯¸ CSV ì•ˆì „ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
        updateData = { ...customData };
        // aiAnalysisê°€ CSV ì•ˆì „ ì²˜ë¦¬ê°€ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ì²˜ë¦¬
        if (!updateData.aiAnalysis ||
            (!updateData.aiAnalysis.startsWith('"') &&
             (updateData.aiAnalysis.includes('\n') ||
              updateData.aiAnalysis.includes(',') ||
              updateData.aiAnalysis.includes('"')))) {
          // ì´ë¯¸ ì²˜ë¦¬ëœ safeAiAnalysis ì‚¬ìš©
          updateData.aiAnalysis = safeAiAnalysis;
        }
      } else {
        updateData = {
          action: 'updateSheet',
          sheetUrl: sheetUrl,  // í†µí•©ëœ ì‹œíŠ¸ URL
          rowNumber: matchedRow,
          handNumber: handNumber,  // Dì—´
          filename: filename,  // Fì—´
          aiAnalysis: safeAiAnalysis,  // Hì—´ (CSV ì•ˆì „ ì²˜ë¦¬ë¨)
          subtitle: '',  // Jì—´ ìë§‰ (ê¸°ë³¸ê°’)
          status: 'ë³µì‚¬ì™„ë£Œ'  // âœ… ì™„ë£Œ ë²„íŠ¼ì—ì„œ ê¸°ë³¸ê°’ìœ¼ë¡œ 'ë³µì‚¬ì™„ë£Œ' ì„¤ì •
        };
      }

      console.log(`ğŸ“‹ Eì—´ ìƒíƒœ: ${updateData.status || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}`);
      console.log(`ğŸ¯ Action: ${updateData.action}`);
      console.log(`ğŸ¬ ìµœì¢… ìë§‰ í™•ì¸: ${updateData.subtitle || 'ì—†ìŒ'}`);

      // actionì´ ëˆ„ë½ëœ ê²½ìš° ê²½ê³ 
      if (!updateData.action) {
        console.error('âš ï¸ ê²½ê³ : actionì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        updateData.action = 'updateSheet';  // ê¸°ë³¸ê°’ ì„¤ì •
      }

      try {
        console.log('ğŸ“¤ Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ ì¤‘...');
        console.log('ğŸ“¤ ì „ì†¡ ë°ì´í„°:', JSON.stringify(updateData, null, 2));
        console.log(`ğŸ”„ ì—…ë°ì´íŠ¸ ìœ í˜•: ${updateData.status === 'ë¯¸ì™„ë£Œ' ? 'í¸ì§‘ ë‹¨ê³„' : 'ì™„ë£Œ ë‹¨ê³„'}`);
        
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(updateData)
        });
        
        console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('âœ… Apps Script ì‘ë‹µ:', result);

        // Apps Scriptì—ì„œ ë°›ì€ ì˜¤ë¥˜ ë©”ì‹œì§€ ë””ë²„ê¹…
        if (result.message && result.message.includes('ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜')) {
          console.error('âŒ Apps Script ì•¡ì…˜ ì¸ì‹ ì‹¤íŒ¨!');
          console.error('   ì „ì†¡í•œ action:', updateData.action);
          console.error('   ì „ì²´ í˜ì´ë¡œë“œ:', JSON.stringify(updateData));
          console.error('   Apps Script ë©”ì‹œì§€:', result.message);

          // actionì´ 'unknown'ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if (result.message.includes('unknown')) {
            console.error('âš ï¸ ê²½ê³ : actionì´ "unknown"ìœ¼ë¡œ ë³€ê²½ë¨!');
            console.error('   ì›ë³¸ action:', updateData.action);
          }
        }

        if (result.status === 'success') {
          console.log('âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!');
          console.log(`âœ… Eì—´ ìƒíƒœ ì„¤ì •: ${updateData.status}`);

          // ğŸš€ ì‚¬ì „ ë¡œë”© ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (CSV ì§€ì—° ë¬¸ì œ í•´ê²°)
          if (window.preloadedHandStatuses && updateData.handNumber) {
            const handNumber = parseInt(updateData.handNumber);
            const oldStatus = window.preloadedHandStatuses.get(handNumber);
            window.preloadedHandStatuses.set(handNumber, updateData.status);
            console.log(`ğŸ”„ ì‚¬ì „ ë¡œë”© ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸: í•¸ë“œ #${handNumber} "${oldStatus}" â†’ "${updateData.status}"`);
          }

          return {
            success: true,
            message: result.message || 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ',
            data: result,
            status: updateData.status  // ìƒíƒœ ì •ë³´ ì¶”ê°€
          };
        } else {
          console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', result.message);
          return {
            success: false,
            message: result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
            data: result
          };
        }
        
      } catch (error) {
        console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        return {
          success: false,
          message: error.message,
          error: error
        };
      }
    }
    
    
    // í•¸ë“œì—ì„œ í‚¤ í”Œë ˆì´ì–´ ì°¾ê¸°
    /**
     * @deprecated ëª¨ë“ˆí™” ì™„ë£Œ - AIAnalyzer.analyzeHand() ì‚¬ìš©
     * AI í•¸ë“œ ë¶„ì„ í•¨ìˆ˜
     */
    async function analyzeHandWithAI(handNumber) {
      try {
        debugLog('ğŸ” ì •í™•í•œ í•¸ë“œ ë¶„ì„ ì‹œì‘ - í•¸ë“œ #' + handNumber);

        // í†µí•© ë¶„ì„ ìºì‹œ ì‚¬ìš© (ì¤‘ë³µ ë¡œë“œ ë°©ì§€)
        const analysis = await getUnifiedHandAnalysis(handNumber);
        if (!analysis || !analysis.handData) {
          return 'âŒ í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        }

        // AI ì‚¬ìš© ì—¬ë¶€ í™•ì¸
        const useAI = localStorage.getItem('useAIForHColumn') === 'true';
        // ğŸ” ê°•í™”ëœ ë””ë²„ê¹…
        console.log(`ğŸ” [analyzeHandWithAI] í•¨ìˆ˜ í˜¸ì¶œ - í•¸ë“œ #${handNumber}`);
        console.log(`ğŸ” localStorage.useAIForHColumn: "${localStorage.getItem('useAIForHColumn')}"`);
        console.log(`ğŸ” useAI boolean: ${useAI}`);
        console.log(`ğŸ” CONFIG.GEMINI_API_KEY ì¡´ì¬: ${!!CONFIG.GEMINI_API_KEY}`);
        debugLog(`ğŸ¤– Hì—´ AI ì„¤ì • í™•ì¸: useAI=${useAI}, APIí‚¤=${!!CONFIG.GEMINI_API_KEY}`);
        let preciseAnalysis;

        if (useAI && CONFIG.GEMINI_API_KEY) {
          // AIë¥¼ ì‚¬ìš©í•œ ë¶„ì„
          preciseAnalysis = await createAIEnhancedSummary(analysis);
        } else {
          // ê·œì¹™ ê¸°ë°˜ 3ì¤„ ìš”ì•½
          preciseAnalysis = createPreciseThreeLineSummary(analysis.handData);
        }

        debugLog('âœ… í•¸ë“œ ë¶„ì„ ì™„ë£¼');
        return preciseAnalysis;

      } catch (error) {
        console.error('âŒ í•¸ë“œ ë¶„ì„ ì˜¤ë¥˜:', error);
        debugLog(`âŒ ë¶„ì„ ì‹¤íŒ¨: ${error.message}`);

        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì •ë³´ë¼ë„ ë°˜í™˜
        const fallbackSummary = createFallbackSummary({ players: [], pot: 0, blinds: { bb: 0 } });
        return fallbackSummary;
      }
    }
    
    // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìš”ì•½ ìƒì„±
    function createFallbackSummary(handData) {
      // BB ê³„ì‚° ê°œì„ : BBê°€ ì—†ê±°ë‚˜ 0ì¼ ë•Œ ì²˜ë¦¬
      let potInBB;
      if (handData.blinds && handData.blinds.bb && handData.blinds.bb > 0) {
        potInBB = Math.round((handData.pot / handData.blinds.bb) * 10) / 10;
      } else {
        // BB ì •ë³´ê°€ ì—†ìœ¼ë©´ íŒŸì„ 100ìœ¼ë¡œ ê°€ì • (ì¼ë°˜ì ì¸ 1/2 ë¸”ë¼ì¸ë“œ)
        const estimatedBB = 100;
        potInBB = Math.round((handData.pot / estimatedBB) * 10) / 10;
      }
      
      let line1 = 'í”Œë ˆì´ì–´ ì •ë³´ ë¶€ì¡±';
      if (handData.players && handData.players.length >= 1) {
        const player1 = handData.players[0];
        const player2 = handData.players[1] || { name: 'ìƒëŒ€ë°©', cards: ['?', '?'] };
        line1 = `${player1.name} (${player1.cards ? player1.cards.join('') : '??'}) vs ${player2.name} (${player2.cards ? player2.cards.join('') : '??'})`;
      }
      
      const board = handData.communityCards ? handData.communityCards.join(' ') : 'ë³´ë“œ ì—†ìŒ';
      const line2 = `ë³´ë“œ [${board}] ë¶„ì„ ë¶ˆê°€`;
      const line3 = `íŒŸ (${handData.pot || 0}) ${potInBB}BB - ê²°ê³¼ ì •ë³´ ì—†ìŒ`;
      
      return `${line1}\n${line2}\n${line3}`;
    }
    
    // ì •í™•í•œ 3ì¤„ ìš”ì•½ ìƒì„± (ê°„ëµí•˜ê³  ëª…í™•í•˜ê²Œ)
    function createPreciseThreeLineSummary(handData) {
      // BB ê³„ì‚° ê°œì„ 
      let potInBB;
      let bbValue = 0;

      if (handData.blinds && handData.blinds.bb && handData.blinds.bb > 0) {
        bbValue = handData.blinds.bb;
        potInBB = Math.round((handData.pot / bbValue) * 10) / 10;
      } else {
        // BB ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (1/2 NLì˜ ê²½ìš° BB=100)
        bbValue = 100; // ê¸°ë³¸ê°’
        potInBB = Math.round((handData.pot / bbValue) * 10) / 10;
        console.warn(`âš ï¸ BB ê°’ ì—†ìŒ, ê¸°ë³¸ê°’ ${bbValue} ì‚¬ìš©`);
      }

      // ë””ë²„ê¹…ì„ ìœ„í•´ ê³„ì‚° ê³¼ì • ì¶œë ¥
      console.log(`ğŸ² BB ê³„ì‚°: íŒŸ(${handData.pot}) / BB(${bbValue}) = ${potInBB}BB`);
      
      // ì¹´ë“œ ë¬¸ì–‘ ë³€í™˜ í•¨ìˆ˜
      const convertCardSuits = (cards) => {
        if (!cards || cards.length === 0) return '??';
        return cards.map(card => {
          if (!card || card === '?') return '?';
          // 10ê³¼ T ëª¨ë‘ ì²˜ë¦¬ ê°€ëŠ¥í•œ íŒŒì‹±
          let rank, suit;
          if (card.startsWith('10')) {
            rank = 'T';  // 10ì„ Të¡œ í‘œì‹œ
            suit = card.substring(2);
          } else if (card[0] === 'T' || card[0] === 't') {
            rank = 'T';  // TëŠ” ê·¸ëŒ€ë¡œ Të¡œ í‘œì‹œ
            suit = card.slice(-1);
          } else {
            rank = card.slice(0, -1).toUpperCase();
            suit = card.slice(-1);
          }
          const suitSymbol = getSuitSymbol(suit);
          return rank + suitSymbol;
        }).join('');
      };
      
      const board = handData.communityCards ? handData.communityCards.map(card => {
        if (!card || card === '?') return '?';
        // 10ê³¼ T ëª¨ë‘ ì²˜ë¦¬ ê°€ëŠ¥í•œ íŒŒì‹±
        let rank, suit;
        if (card.startsWith('10')) {
          rank = 'T';  // 10ì„ Të¡œ í‘œì‹œ
          suit = card.substring(2);
        } else if (card[0] === 'T' || card[0] === 't') {
          rank = 'T';  // TëŠ” ê·¸ëŒ€ë¡œ Të¡œ í‘œì‹œ
          suit = card.slice(-1);
        } else {
          rank = card.slice(0, -1).toUpperCase();
          suit = card.slice(-1);
        }
        const suitSymbol = getSuitSymbol(suit);
        return rank + suitSymbol;
      }).join(' ') : 'ë³´ë“œ ì—†ìŒ';
      
      // 1ì¤„: í”Œë ˆì´ì–´ ëŒ€ê²° (ê°„ëµí•˜ê²Œ)
      let line1 = '';
      if (handData.players.length >= 2) {
        const player1 = handData.players[0];
        const player2 = handData.players[1];
        const p1Cards = convertCardSuits(player1.cards);
        const p2Cards = convertCardSuits(player2.cards);
        line1 = `${player1.name}(${p1Cards}) vs ${player2.name}(${p2Cards})`;
      } else {
        line1 = 'í”Œë ˆì´ì–´ ì •ë³´ ë¶€ì¡±';
      }
      
      // 2ì¤„: ë³´ë“œë§Œ ê°„ë‹¨íˆ
      let line2 = `ë³´ë“œ: ${board}`;
      
      // 3ì¤„: íŒŸ ì‚¬ì´ì¦ˆ (BB í™˜ì‚° ë° ì›ë³¸ ê¸ˆì•¡)
      let line3;
      if (bbValue > 0 && bbValue !== 100) {
        // ì‹¤ì œ BB ê°’ì´ ìˆì„ ë•Œ
        line3 = `íŒŸ: ${potInBB}BB (${handData.pot.toLocaleString()})`;
      } else if (bbValue === 100) {
        // BB ê¸°ë³¸ê°’ ì‚¬ìš© ì‹œ
        line3 = `íŒŸ: ${handData.pot.toLocaleString()} (ì•½ ${potInBB}BB)`;
      } else {
        // BB ì •ë³´ ì—†ìŒ
        line3 = `íŒŸ: ${handData.pot.toLocaleString()}`;
      }
      
      return `${line1}\n${line2}\n${line3}`;
    }

    /**
     * AI ê°•í™” 3ì¤„ ìš”ì•½ ìƒì„±
     */
    async function createAIEnhancedSummary(analysis) {
      const handData = analysis.handData;

      // 1, 2ì¤„ì€ ê·œì¹™ ê¸°ë°˜
      const line1 = createPlayerMatchupLine(handData);
      const line2 = createBoardLine(handData);

      // 3ì¤„ë§Œ AI ì‚¬ìš©
      const aiAnalysis = await generateAIDetailedAnalysis(analysis);
      const line3 = aiAnalysis || createPotLine(handData);

      return `${line1}\n${line2}\n${line3}`;
    }

    /**
     * í”Œë ˆì´ì–´ ë§¤ì¹˜ì—… ë¼ì¸ ìƒì„±
     */
    function createPlayerMatchupLine(handData) {
      const convertCardSuits = (cards) => {
        if (!cards || cards.length === 0) return '??';
        return cards.map(card => {
          if (!card) return '?';
          return card.replace(/s/g, 'â™ ').replace(/h/g, 'â™¥').replace(/d/g, 'â™¦').replace(/c/g, 'â™£');
        }).join('');
      };

      if (!handData.players || handData.players.length < 2) {
        return 'í”Œë ˆì´ì–´ ì •ë³´ ë¶€ì¡±';
      }

      const player1 = handData.players[0];
      const player2 = handData.players[1] || { name: 'ìƒëŒ€ë°©', cards: ['?', '?'] };

      const p1Cards = convertCardSuits(player1.cards);
      const p2Cards = convertCardSuits(player2.cards);

      return `${player1.name}(${p1Cards}) vs ${player2.name}(${p2Cards})`;
    }

    /**
     * ë³´ë“œ ë¼ì¸ ìƒì„±
     */
    function createBoardLine(handData) {
      const convertCardSuits = (cards) => {
        if (!cards || cards.length === 0) return 'ë³´ë“œ ì—†ìŒ';
        return cards.map(card => {
          if (!card) return '?';
          return card.replace(/s/g, 'â™ ').replace(/h/g, 'â™¥').replace(/d/g, 'â™¦').replace(/c/g, 'â™£');
        }).join(' ');
      };

      const board = convertCardSuits(handData.communityCards);
      return `ë³´ë“œ [${board}]`;
    }

    /**
     * íŒŸ ë¼ì¸ ìƒì„± (í´ë°±)
     */
    function createPotLine(handData) {
      let potInBB;
      let bbValue = 0;

      if (handData.blinds && handData.blinds.bb && handData.blinds.bb > 0) {
        bbValue = handData.blinds.bb;
        potInBB = Math.round((handData.pot / bbValue) * 10) / 10;
      } else {
        bbValue = 100;
        potInBB = Math.round((handData.pot / bbValue) * 10) / 10;
      }

      if (bbValue > 0 && bbValue !== 100) {
        return `íŒŸ: ${potInBB}BB (${handData.pot.toLocaleString()})`;
      } else {
        return `íŒŸ: ${handData.pot.toLocaleString()}`;
      }
    }

    // ë³´ë“œ í…ìŠ¤ì²˜ ë¶„ì„
    function analyzeBoardTexture(board) {
      if (!board || board.length < 3) return 'ë³´ë“œ ë¶€ì¡±';
      
      // ìˆ˜íŠ¸ ë¶„ì„
      const suits = board.map(card => card.slice(-1));
      const suitCounts = {};
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      const maxSuitCount = Math.max(...Object.values(suitCounts));
      
      // ë­í¬ ë¶„ì„
      const ranks = board.map(card => {
        const rank = card.slice(0, -1);
        return rank === 'A' ? 14 : rank === 'K' ? 13 : rank === 'Q' ? 12 : rank === 'J' ? 11 : parseInt(rank);
      }).sort((a, b) => b - a);
      
      let texture = '';
      
      // í”ŒëŸ¬ì‹œ ë“œë¡œìš° ì²´í¬
      if (maxSuitCount >= 3) {
        texture += maxSuitCount >= 4 ? 'í”ŒëŸ¬ì‹œ ë³´ë“œ' : 'í”ŒëŸ¬ì‹œ ë“œë¡œìš° ë³´ë“œ';
      } else {
        texture += 'ë ˆì¸ë³´ìš° ë³´ë“œ';
      }
      
      // í˜ì–´ ì²´í¬
      const rankCounts = {};
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      const hasPair = Object.values(rankCounts).some(count => count >= 2);
      
      if (hasPair) {
        texture += ', í˜ì–´ ë³´ë“œ';
      }
      
      // ìŠ¤íŠ¸ë ˆì´íŠ¸ ê°€ëŠ¥ì„± ì²´í¬
      const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
      let hasConnectivity = false;
      
      for (let i = 0; i < uniqueRanks.length - 1; i++) {
        if (uniqueRanks[i] - uniqueRanks[i + 1] <= 2) {
          hasConnectivity = true;
          break;
        }
      }
      
      if (hasConnectivity) {
        texture += ', ì—°ê²°ì„± ë†’ìŒ';
      } else {
        texture += ', ë“œë¼ì´ ë³´ë“œ';
      }
      
      return texture;
    }
    
    // AI ë¶„ì„ìš© ê°„ì†Œí™”ëœ í”„ë¡¬í”„íŠ¸ (ë°±ì—…ìš©)
    function createAnalysisPrompt(handData) {
      // ì§ì ‘ ê³„ì‚°í•œ 3ì¤„ ìš”ì•½ì„ ë°˜í™˜
      return createPreciseThreeLineSummary(handData);
    }
    
    // Gemini API í˜¸ì¶œ (ì—¬ëŸ¬ ëª¨ë¸ fallback ì§€ì›)
    async function callGeminiAPIAdvanced(prompt, apiKey) {
      // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœ)
      const models = [
        'gemini-1.5-flash',
        'gemini-1.5-pro', 
        'gemini-pro',
        'models/gemini-pro'
      ];

      debugLog('ğŸŒ Gemini API í˜¸ì¶œ ì‹œì‘');
      debugLog('ğŸ“ í”„ë¡¬í”„íŠ¸ ê¸¸ì´:', prompt.length);

      // ê° ëª¨ë¸ì„ ìˆœì„œëŒ€ë¡œ ì‹œë„
      for (let i = 0; i < models.length; i++) {
        const model = models[i];
        try {
          debugLog(`ğŸ” ëª¨ë¸ ì‹œë„ ${i + 1}/${models.length}:`, model);
          debugLog('ğŸ”— API URL:', `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey.substring(0, 10)}...`);
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }]
          })
        });
        
          debugLog('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
          
          if (response.ok) {
            const data = await response.json();
            debugLog('ğŸ“¦ API ì‘ë‹µ ë°ì´í„°:', data);
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
              const result = data.candidates[0].content.parts[0].text;
              debugLog(`âœ… ëª¨ë¸ '${model}' ì„±ê³µ! ê²°ê³¼ ê¸¸ì´:`, result.length);
              return result;
            } else {
              debugLog(`âš ï¸ ëª¨ë¸ '${model}' ì‘ë‹µ êµ¬ì¡° ì´ìƒ:`, data);
              if (i === models.length - 1) {
                return 'âŒ API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: ' + JSON.stringify(data);
              }
              continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            }
          } else {
            const errorText = await response.text();
            debugLog(`âŒ ëª¨ë¸ '${model}' ì‹¤íŒ¨ (${response.status}):`, errorText);
            
            if (response.status === 404 && i < models.length - 1) {
              debugLog('ğŸ”„ ë‹¤ìŒ ëª¨ë¸ë¡œ fallback...');
              continue; // 404ë©´ ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            } else if (i === models.length - 1) {
              return `âŒ ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜ (${response.status}): ${errorText}`;
            } else {
              continue;
            }
          }
          
        } catch (modelError) {
          debugLog(`âŒ ëª¨ë¸ '${model}' ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:`, modelError);
          if (i === models.length - 1) {
            return 'âŒ ëª¨ë“  ëª¨ë¸ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + modelError.message;
          }
          continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
        }
      }
      
      return 'âŒ ëª¨ë“  Gemini ëª¨ë¸ì„ ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    }
    
    async function getKeyPlayerFromHand(handData) {
      try {
        // Type ì‹œíŠ¸ì—ì„œ Notable í”Œë ˆì´ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const TYPE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1127201192&single=true&output=csv';
        
        const response = await fetch(TYPE_CSV_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        const notablePlayers = [];
        for (let i = 1; i < rows.length; i++) {
          const playerName = rows[i][1]; // Bì—´: Player
          const isNotable = rows[i][3];  // Dì—´: Notable
          
          if (isNotable === 'Y' || isNotable === 'y' || isNotable === 'âœ“') {
            notablePlayers.push(playerName);
          }
        }
        
        // í•¸ë“œì—ì„œ Notable í”Œë ˆì´ì–´ ì°¾ê¸°
        for (const player of handData.players) {
          if (notablePlayers.includes(player.name)) {
            return player;
          }
        }
        
        // Notable í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜í™˜
        return handData.players[0];
        
      } catch (error) {
        console.error('í‚¤ í”Œë ˆì´ì–´ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜í™˜
        return handData.players[0];
      }
    }
    
    // ì›í´ë¦­ í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ í†µí•© í•¨ìˆ˜
    async function processHandCompletion(handNumber, timestamp, virtualSheetUrl) {
      showNotification('ğŸ”„ í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
      
      try {
        // 1. í•¸ë“œ ë°ì´í„° ë¡œë“œ
        const handData = await loadHandData(handNumber);
        if (!handData) {
          throw new Error('í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 2. Virtual ì‹œíŠ¸ ë§¤ì¹­ ì§„í–‰
        showNotification('ğŸ” Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ ì¤‘...', 'info');
        const { matchedRow, isExactMatch } = await findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp);
        
        if (!matchedRow) {
          throw new Error('Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 3. í‚¤ í”Œë ˆì´ì–´ ì‹ë³„
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        // 4. íŒŒì¼ëª… ìë™ ìƒì„±
        let filename = `${handNumber}`;
        if (keyPlayer) {
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
        
        // 5. AI í•¸ë“œ ë¶„ì„ ì‹¤í–‰
        showNotification('ğŸ¤– AIë¡œ í•¸ë“œ ë¶„ì„ ì¤‘...', 'info');
        const aiSummary = await analyzeHandWithAI(handData);
        
        // 6. í•¸ë“œ ì¡°í•© ê²°ê³¼ ë¶„ì„ ì¶”ê°€
        const handAnalysis = analyzePlayerHands(handData);
        
        // 7. Apps Scriptë¥¼ í†µí•œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        showNotification('ğŸ“ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘...', 'info');
        await updateHandInSheet(handNumber, {
          filename: filename,
          aiSummary: aiSummary,
          handAnalysis: handAnalysis,
          virtualRow: matchedRow.row,
          isExactMatch: isExactMatch
        });
        
        // 8. ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        const handIndex = allHands.findIndex(h => h.handNumber === handNumber);
        if (handIndex !== -1) {
          allHands[handIndex].handEdit = true;
          allHands[handIndex].handEditTime = new Date().toISOString();
        }
        
        // 9. UI ì—…ë°ì´íŠ¸
        updateHandStatus(true);
        updateHandList();
        updateStats();
        
        showNotification('âœ… í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        // ğŸš€ ë§¤í•‘ ì €ì¥
        saveHandFilenameMapping(handNumber, filename);

        console.log('âœ… í•¸ë“œ ì™„ë£Œ:', { handNumber, filename, aiSummary, handAnalysis });
        
      } catch (error) {
        throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
      }
    }
    
    // í”Œë ˆì´ì–´ í•¸ë“œ ì¡°í•© ë¶„ì„ í•¨ìˆ˜
    function analyzePlayerHands(handData) {
      if (!handData.communityCards || handData.communityCards.length === 0) {
        return 'ë³´ë“œ ì¹´ë“œ ì—†ìŒ - í•¸ë“œ ì¡°í•© ë¶„ì„ ë¶ˆê°€';
      }
      
      const board = handData.communityCards;
      const analyses = [];
      
      handData.players.forEach(player => {
        if (player.cards && player.cards.length >= 2) {
          const combination = evaluateHandStrength(player.cards, board);
          analyses.push(`${player.name}: ${combination}`);
        }
      });
      
      return analyses.join(' | ');
    }
    
    // ìŠ¹ë¶€ ê²°ê³¼ íŒì • í•¨ìˆ˜
    function determineWinner(handData) {
      if (!handData.communityCards || handData.communityCards.length < 5 || handData.players.length < 2) {
        return { winner: null, reason: 'ë¶ˆì™„ì „í•œ ì •ë³´' };
      }
      
      const playerHandRankings = handData.players.map(player => {
        if (!player.cards || player.cards.length < 2) {
          return { player: player, rank: -1, description: 'ì¹´ë“œ ì—†ìŒ' };
        }
        
        const handRank = getHandRanking(player.cards, handData.communityCards);
        return {
          player: player,
          rank: handRank.rank,
          description: handRank.description,
          combination: evaluateHandStrength(player.cards, handData.communityCards)
        };
      }).filter(p => p.rank >= 0); // ìœ íš¨í•œ í•¸ë“œë§Œ
      
      // í•¸ë“œ ë­í‚¹ìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
      playerHandRankings.sort((a, b) => b.rank - a.rank);
      
      if (playerHandRankings.length < 2) {
        return { winner: null, reason: 'ë¹„êµ ë¶ˆê°€' };
      }
      
      const winner = playerHandRankings[0];
      const runnerUp = playerHandRankings[1];
      
      // ë™ì ì¸ ê²½ìš° ì²˜ë¦¬
      if (winner.rank === runnerUp.rank) {
        return { 
          winner: null, 
          reason: 'ë™ì  (í‚¤ì»¤ ê³„ì‚° ë³µì¡)',
          topHand: winner.combination
        };
      }
      
      return {
        winner: winner.player,
        reason: winner.combination,
        defeated: runnerUp.combination
      };
    }
    
    // í•¸ë“œ ë­í‚¹ ê³„ì‚° (ìˆ«ìë¡œ ë°˜í™˜)
    function getHandRanking(playerCards, board) {
      const allCards = [...playerCards, ...board];
      
      if (allCards.length < 5) return { rank: -1, description: 'ë¶ˆì™„ì „' };
      
      // ì¹´ë“œë¥¼ íŒŒì‹±
      const parsedCards = allCards.map(card => {
        let rank, suit;
        // 10ê³¼ T ëª¨ë‘ ì²˜ë¦¬
        if (card.startsWith('10')) {
          rank = 'T';
          suit = card.substring(2);
        } else if (card[0] === 'T' || card[0] === 't') {
          rank = 'T';
          suit = card.slice(-1);
        } else {
          rank = card.slice(0, -1).toUpperCase();
          suit = card.slice(-1);
        }
        
        let numRank = parseInt(rank);
        if (rank === 'T') numRank = 10;
        else if (rank === 'J') numRank = 11;
        else if (rank === 'Q') numRank = 12;
        else if (rank === 'K') numRank = 13;
        else if (rank === 'A') numRank = 14;
        return { rank: numRank, suit: suit };
      }).sort((a, b) => b.rank - a.rank);
      
      const ranks = parsedCards.map(c => c.rank);
      const suits = parsedCards.map(c => c.suit);
      const rankCounts = {};
      const suitCounts = {};
      
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      
      const pairs = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 2);
      const threeOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 3);
      const fourOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 4);
      
      const isFlush = Object.values(suitCounts).some(count => count >= 5);
      const isStraight = checkStraight(ranks);
      
      // í•¸ë“œ ë­í‚¹ ë°˜í™˜ (ë†’ì„ìˆ˜ë¡ ê°•í•¨)
      if (isStraight && isFlush) {
        if (ranks[0] === 14 && ranks[1] === 13) return { rank: 9, description: 'ë¡œì–„ í”ŒëŸ¬ì‹œ' };
        return { rank: 8, description: 'ìŠ¤íŠ¸ë ˆì´íŠ¸ í”ŒëŸ¬ì‹œ' };
      }
      if (fourOfAKind.length > 0) return { rank: 7, description: 'í¬ì¹´ë“œ' };
      if (threeOfAKind.length > 0 && pairs.length >= 2) return { rank: 6, description: 'í’€í•˜ìš°ìŠ¤' };
      if (isFlush) return { rank: 5, description: 'í”ŒëŸ¬ì‹œ' };
      if (isStraight) return { rank: 4, description: 'ìŠ¤íŠ¸ë ˆì´íŠ¸' };
      if (threeOfAKind.length > 0) return { rank: 3, description: 'íŠ¸ë¦¬í”Œ' };
      if (pairs.length >= 2) return { rank: 2, description: 'íˆ¬í˜ì–´' };
      if (pairs.length === 1) return { rank: 1, description: 'ì›í˜ì–´' };
      return { rank: 0, description: 'í•˜ì´ì¹´ë“œ' };
    }
    
    // ì •í™•í•œ í¬ì»¤ í•¸ë“œ ê°•ë„ í‰ê°€ í•¨ìˆ˜
    function evaluateHandStrength(playerCards, board) {
      const allCards = [...playerCards, ...board];
      
      if (allCards.length < 5) return 'ë¶ˆì™„ì „í•œ í•¸ë“œ';
      
      // ì¹´ë“œë¥¼ ë­í¬ì™€ ìˆ˜íŠ¸ë¡œ íŒŒì‹±
      const parsedCards = allCards.map(card => {
        let rank, suit;
        // 10ê³¼ T ëª¨ë‘ ì²˜ë¦¬
        if (card.startsWith('10')) {
          rank = 'T';
          suit = card.substring(2);
        } else if (card[0] === 'T' || card[0] === 't') {
          rank = 'T';
          suit = card.slice(-1);
        } else {
          rank = card.slice(0, -1).toUpperCase();
          suit = card.slice(-1);
        }
        
        let numRank = parseInt(rank);
        if (rank === 'T') numRank = 10;
        else if (rank === 'J') numRank = 11;
        else if (rank === 'Q') numRank = 12;
        else if (rank === 'K') numRank = 13;
        else if (rank === 'A') numRank = 14;
        return { rank: numRank, suit: suit, original: card };
      }).sort((a, b) => b.rank - a.rank); // ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
      
      // 5ì¥ ì¡°í•©ìœ¼ë¡œ ê°€ëŠ¥í•œ ëª¨ë“  í•¸ë“œ í‰ê°€
      const bestHand = getBestPokerHand(parsedCards);
      return bestHand;
    }
    
    // ìµœê³ ì˜ í¬ì»¤ í•¸ë“œ ì°¾ê¸° (7ì¥ ì¤‘ 5ì¥ ì¡°í•©)
    function getBestPokerHand(cards) {
      if (cards.length < 5) return 'ë¶ˆì™„ì „í•œ í•¸ë“œ';
      
      // 7ì¥ì´ ìˆë‹¤ë©´ 5ì¥ ì¡°í•©ì„ ëª¨ë‘ ê³„ì‚°í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ì†Œí™”
      const hand5 = cards.slice(0, 5);
      
      const ranks = hand5.map(c => c.rank).sort((a, b) => b - a);
      const suits = hand5.map(c => c.suit);
      const rankCounts = {};
      const suitCounts = {};
      
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      
      const pairs = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 2);
      const threeOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 3);
      const fourOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 4);
      
      const isFlush = Object.values(suitCounts).some(count => count >= 5);
      const isStraight = checkStraight(ranks);
      
      // í•¸ë“œ ë­í‚¹ íŒì •
      if (isStraight && isFlush) {
        if (ranks[0] === 14 && ranks[1] === 13) return 'ë¡œì–„ í”ŒëŸ¬ì‹œ';
        return `ìŠ¤íŠ¸ë ˆì´íŠ¸ í”ŒëŸ¬ì‹œ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (fourOfAKind.length > 0) {
        return `í¬ì¹´ë“œ (${getRankName(parseInt(fourOfAKind[0]))})`;
      }
      
      if (threeOfAKind.length > 0 && pairs.length >= 2) {
        return `í’€í•˜ìš°ìŠ¤ (${getRankName(parseInt(threeOfAKind[0]))} over ${getRankName(parseInt(pairs.find(p => p !== threeOfAKind[0])))})`;
      }
      
      if (isFlush) {
        return `í”ŒëŸ¬ì‹œ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (isStraight) {
        return `ìŠ¤íŠ¸ë ˆì´íŠ¸ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (threeOfAKind.length > 0) {
        return `íŠ¸ë¦¬í”Œ (${getRankName(parseInt(threeOfAKind[0]))})`;
      }
      
      if (pairs.length >= 2) {
        const sortedPairs = pairs.map(p => parseInt(p)).sort((a, b) => b - a);
        return `íˆ¬í˜ì–´ (${getRankName(sortedPairs[0])}, ${getRankName(sortedPairs[1])})`;
      }
      
      if (pairs.length === 1) {
        return `ì›í˜ì–´ (${getRankName(parseInt(pairs[0]))})`;
      }
      
      return `${getRankName(ranks[0])} í•˜ì´`;
    }
    
    // ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
    function checkStraight(ranks) {
      const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
      if (uniqueRanks.length < 5) return false;
      
      // ì¼ë°˜ ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
      for (let i = 0; i < uniqueRanks.length - 4; i++) {
        let consecutive = true;
        for (let j = 1; j < 5; j++) {
          if (uniqueRanks[i] - j !== uniqueRanks[i + j]) {
            consecutive = false;
            break;
          }
        }
        if (consecutive) return true;
      }
      
      // A-2-3-4-5 ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
      if (uniqueRanks.includes(14) && uniqueRanks.includes(5) && uniqueRanks.includes(4) && uniqueRanks.includes(3) && uniqueRanks.includes(2)) {
        return true;
      }
      
      return false;
    }
    
    // ë­í¬ë¥¼ ë¬¸ìë¡œ ë³€í™˜
    function getRankName(rank) {
      if (rank === 14) return 'A';
      if (rank === 13) return 'K';
      if (rank === 12) return 'Q';
      if (rank === 11) return 'J';
      return rank.toString();
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (Apps Script í˜¸ì¶œ)
    async function updateHandInSheet(handNumber, data) {
      // ì˜¬ë°”ë¥¸ Apps Script URL ì‚¬ìš©
      const scriptUrl = CONFIG.SHEET_UPDATE_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL;
      
      if (!scriptUrl) {
        throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      
      // í–‰ ë²ˆí˜¸ í™•ì¸ ë° ê²€ì¦
      let rowNumber = data.virtualRow;
      
      // virtualRowê°€ ê°ì²´ì¸ ê²½ìš° ì²˜ë¦¬
      if (typeof rowNumber === 'object' && rowNumber !== null) {
        rowNumber = rowNumber.row || rowNumber.rowIndex || null;
      }
      
      // í–‰ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜
      if (!rowNumber || isNaN(parseInt(rowNumber))) {
        console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ë²ˆí˜¸:', data.virtualRow);
        throw new Error('ìœ íš¨í•œ í–‰ ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. Virtual ì‹œíŠ¸ ë§¤ì¹­ì„ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
      }
      
      // Apps Script í˜¸í™˜ ë°ì´í„° êµ¬ì¡°ë¡œ ë³€í™˜
      const payload = {
        action: 'updateSheet',  // updateHand ëŒ€ì‹  updateSheet ì‚¬ìš©
        sheetUrl: getSheetUrl(),  // í†µí•©ëœ ì‹œíŠ¸ URL ì‚¬ìš©
        rowNumber: parseInt(rowNumber),  // ì •ìˆ˜ë¡œ ë³€í™˜
        handNumber: handNumber,
        filename: data.filename,
        aiAnalysis: data.aiSummary,  // aiSummaryë¥¼ aiAnalysisë¡œ ë³€ê²½
        timestamp: new Date().toISOString()
      };
      
      console.log('ğŸ“¤ Apps Scriptë¡œ í•¸ë“œ ì—…ë°ì´íŠ¸ ì „ì†¡:', payload);
      console.log('ğŸ“¤ ì‚¬ìš© ì¤‘ì¸ Apps Script URL:', scriptUrl);
      
      try {
        const response = await fetch(scriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(payload)
        });
        
        console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`Apps Script ìš”ì²­ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“¦ Apps Script ì‘ë‹µ:', result);
        
        if (!result.success && result.status !== 'success') {
          throw new Error(result.error || result.message || 'Apps Script ì²˜ë¦¬ ì‹¤íŒ¨');
        }
        
        console.log('âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
        return result;
        
      } catch (error) {
        console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        throw error;
      }
    }
    
    // Virtual ì‹œíŠ¸ ë§¤ì¹­ ë˜í¼ í•¨ìˆ˜ (ê¸°ì¡´ findClosestVirtualRowë¥¼ ì‚¬ìš©)
    async function findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp, showProgress = false) {
      try {
        const result = await findClosestVirtualRow(timestamp, virtualSheetUrl, showProgress);
        
        if (result && result.rowIndex) {
          return {
            matchedRow: {
              row: result.rowIndex,
              data: result.data || {},
              time: result.matchedTime,
              filename: result.filename,  // Fì—´ íŒŒì¼ëª… ì¶”ê°€
              status: result.status,      // Eì—´ ìƒíƒœ ì¶”ê°€
              timestamp: result.timestamp,
              rowData: result.rowData     // ì „ì²´ í–‰ ë°ì´í„°
            },
            isExactMatch: result.accuracy === 'exact',
            accuracy: result.accuracy,
            timeDiff: result.timeDiff,
            timeDifference: result.timeDiff
          };
        } else {
          return {
            matchedRow: null,
            isExactMatch: false,
            accuracy: 'none',
            timeDiff: Infinity
          };
        }
      } catch (error) {
        console.error('âŒ Virtual ì‹œíŠ¸ ë§¤ì¹­ ë˜í¼ ì˜¤ë¥˜:', error);
        throw error;
      }
    }
    
    // ê°œì„ ëœ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ (ì²˜ë¦¬ ê³¼ì • ì‹¤ì‹œê°„ í™•ì¸)
    async function showImprovedCompletionModal(handNumber, timestamp, virtualSheetUrl) {
      // virtualSheetUrlì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
      if (!virtualSheetUrl) {
        virtualSheetUrl = getSheetCsvUrl();
      }
      const modal = document.getElementById('completion-modal');
      const timestampInput = document.getElementById('hand-timestamp');
      const filenameInput = document.getElementById('final-filename');
      const summaryTextarea = document.getElementById('ai-summary');
      const matchedRowInput = document.getElementById('matched-row');
      
      // ë§¤ì¹­ëœ í–‰ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
      window.currentMatchedRowData = null;
      
      // ì‹œê°„ í‘œì‹œ
      const handDate = new Date(timestamp * 1000);
      const hours = String(handDate.getHours()).padStart(2, '0');
      const minutes = String(handDate.getMinutes()).padStart(2, '0');
      const seconds = String(handDate.getSeconds()).padStart(2, '0');
      const timeString = `${hours}:${minutes}:${seconds}`;
      
      // ì´ˆê¸°ê°’ ì„¤ì •
      timestampInput.value = timestamp;
      filenameInput.value = `ì²˜ë¦¬ ì¤‘...`;
      summaryTextarea.value = `ğŸ”„ ì²˜ë¦¬ ì¤‘...\n\n1. í•¸ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...\n2. Virtual ì‹œíŠ¸ ë§¤ì¹­ ëŒ€ê¸°\n3. AI ë¶„ì„ ëŒ€ê¸°\n4. íŒŒì¼ëª… ìƒì„± ëŒ€ê¸°`;
      matchedRowInput.value = `í•¸ë“œ ì‹œê°„: ${timeString} - ë§¤ì¹­ ëŒ€ê¸° ì¤‘...`;
      
      modal.classList.remove('hidden');
      
      try {
        // 1ë‹¨ê³„: í•¸ë“œ ë°ì´í„° ë¡œë“œ
        summaryTextarea.value = `ğŸ”„ 1/4 í•¸ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...\n\ní•¸ë“œ #${handNumber} ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.`;
        const handData = await loadHandData(handNumber);
        if (!handData) {
          throw new Error('í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 2ë‹¨ê³„: Virtual ì‹œíŠ¸ ë§¤ì¹­
        summaryTextarea.value = `ğŸ” 2/4 Virtual ì‹œíŠ¸ ë§¤ì¹­ ì¤‘...\n\nì‹œê°„: ${timeString}\nVirtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`;
        const { matchedRow, isExactMatch } = await findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp);
        
        if (!matchedRow) {
          throw new Error('Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ë§¤ì¹­ëœ ì‹œê°„ í¬ë§·íŒ…
        let matchedTimeStr = matchedRow.time || '';
        if (matchedTimeStr && !matchedTimeStr.includes(':')) {
          // ìˆ«ìë§Œ ìˆìœ¼ë©´ timestampë¡œ ê°„ì£¼í•˜ê³  ë³€í™˜
          const matchedDate = new Date(parseInt(matchedTimeStr) * 1000);
          if (!isNaN(matchedDate.getTime())) {
            const h = String(matchedDate.getHours()).padStart(2, '0');
            const m = String(matchedDate.getMinutes()).padStart(2, '0');
            const s = String(matchedDate.getSeconds()).padStart(2, '0');
            matchedTimeStr = `${h}:${m}:${s}`;
          }
        }
        
        matchedRowInput.value = `ë§¤ì¹­: ${matchedRow.row}í–‰ [í•¸ë“œ ${timeString} â†” ì‹œíŠ¸ ${matchedTimeStr}] (${isExactMatch ? 'ì •í™•' : 'ê·¼ì‚¬'} ë§¤ì¹­)`;
        // ë§¤ì¹­ëœ í–‰ ì •ë³´ ì €ì¥
        window.currentMatchedRowData = {
          row: matchedRow.row,
          isExactMatch: isExactMatch,
          time: matchedRow.time,
          formattedTime: matchedTimeStr
        };
        
        // 3ë‹¨ê³„: AI ë¶„ì„ (ì •í™•í•œ ê³„ì‚°)
        summaryTextarea.value = `ğŸ¤– 3/4 í•¸ë“œ ë¶„ì„ ì¤‘...\n\ní”Œë ˆì´ì–´ ì¹´ë“œì™€ ë³´ë“œ ì¡°í•©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...\nìŠ¹ë¶€ ê²°ê³¼ë¥¼ ê³„ì‚° ì¤‘...`;
        const aiSummary = await analyzeHandWithAI(handNumber);
        
        // 4ë‹¨ê³„: íŒŒì¼ëª… ìƒì„±
        summaryTextarea.value = `ğŸ“ 4/4 íŒŒì¼ëª… ìƒì„± ì¤‘...\n\ní‚¤ í”Œë ˆì´ì–´ë¥¼ ì‹ë³„í•˜ê³  íŒŒì¼ëª…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        let filename = `${handNumber}`;
        if (keyPlayer) {
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
        
        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        filenameInput.value = filename;
        summaryTextarea.value = aiSummary;
        
        console.log('âœ… ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ:', {
          handNumber,
          filename,
          aiSummary,
          matchedRow: matchedRow.row,
          isExactMatch
        });
        
      } catch(error) {
        console.error('âŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        matchedRowInput.value = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
        summaryTextarea.value = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
        filenameInput.value = `ì˜¤ë¥˜_${handNumber}`;
      }
    }
    
    
    // ê¸°ì¡´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ (ë°±ì—…ìš©)
    async function showCompletionModal(handNumber, timestamp, virtualSheetUrl) {
      const modal = document.getElementById('completion-modal');
      const timestampInput = document.getElementById('hand-timestamp');
      const filenameInput = document.getElementById('final-filename');
      const summaryTextarea = document.getElementById('ai-summary');
      const matchedRowInput = document.getElementById('matched-row');
      
      // ì‹œê°„ í‘œì‹œ (ë‚ ì§œ ì œì™¸, ì‹œê°„ë§Œ)
      const handDate = new Date(timestamp * 1000);
      const hours = String(handDate.getHours()).padStart(2, '0');
      const minutes = String(handDate.getMinutes()).padStart(2, '0');
      const seconds = String(handDate.getSeconds()).padStart(2, '0');
      const timeString = `${hours}:${minutes}:${seconds}`;
      
      // í•¸ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const handData = await loadHandData(handNumber);
      
      // íŒŒì¼ëª… ìƒì„± (í•¸ë“œë²ˆí˜¸_í‚¤í”Œë ˆì´ì–´_ì¹´ë“œ_ìƒëŒ€_ì¹´ë“œ)
      let filename = `${handNumber}`;
      
      if (handData && handData.players && handData.players.length > 0) {
        // Notable í”Œë ˆì´ì–´ ì°¾ê¸° (ë˜ëŠ” ì²« ë²ˆì§¸ í”Œë ˆì´ì–´)
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        if (keyPlayer) {
          // í‚¤ í”Œë ˆì´ì–´ ì´ë¦„ê³¼ ì¹´ë“œ
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          // ìƒëŒ€ í”Œë ˆì´ì–´ (ì²« ë²ˆì§¸ ìƒëŒ€)
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
      }
      
      filename += '.mp4';
      
      // ì´ˆê¸°í™”
      timestampInput.value = timeString; // ì‹œê°„ë§Œ í‘œì‹œ
      filenameInput.value = filename;
      summaryTextarea.value = 'ë¶„ì„ ì¤‘...';
      matchedRowInput.value = 'ê²€ìƒ‰ ì¤‘...';
      
      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.remove('hidden');
      
      // ë””ë²„ê¹…: ëª¨ë‹¬ê³¼ DOM ìš”ì†Œ ìƒíƒœ í™•ì¸
      console.log('ğŸ” === ëª¨ë‹¬ í‘œì‹œ ì§í›„ DOM ìƒíƒœ ===');
      console.log('  ëª¨ë‹¬ í‘œì‹œ ìƒíƒœ:', !modal.classList.contains('hidden'));
      console.log('  matched-row input ì¡´ì¬:', !!matchedRowInput);
      console.log('  matched-row í˜„ì¬ ê°’:', matchedRowInput.value);
      console.log('  ai-summary ì¡´ì¬:', !!summaryTextarea);
      console.log('  ai-summary í˜„ì¬ ê°’:', summaryTextarea.value);
      
      // Virtual ì‹œíŠ¸ ë§¤ì¹­ ë° AI ë¶„ì„ ë¹„ë™ê¸° ì‹¤í–‰ - async/await ì‚¬ìš©
      try {
        // console.log('ğŸš€ Virtual ì‹œíŠ¸ ë§¤ì¹­ ë° AI ë¶„ì„ ì‹œì‘...'); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
        
        // ë³‘ë ¬ ì‹¤í–‰ (ì—¬ê¸°ì„œëŠ” ëª¨ë‹¬ì´ ì´ë¯¸ í‘œì‹œëœ ìƒíƒœì´ë¯€ë¡œ progress false)
        const [virtualMatch, aiSummary] = await Promise.all([
          findClosestVirtualRow(timestamp, virtualSheetUrl, false),  // ì§„í–‰ë¥  ëª¨ë‹¬ ìˆ¨ê¹€
          analyzeHandWithAI(handNumber)
        ]);
        console.log('âœ… Promise.all ì™„ë£Œ - UI ì—…ë°ì´íŠ¸ ì‹œì‘');
        console.log('ğŸ“Š virtualMatch:', virtualMatch);
        console.log('ğŸ“ aiSummary:', aiSummary);
        
        // ë””ë²„ê¹…: DOM ìš”ì†Œ ìƒíƒœ ì¬í™•ì¸
        console.log('ğŸ” === Promise ì™„ë£Œ í›„ DOM ìƒíƒœ ===');
        console.log('  ëª¨ë‹¬ í‘œì‹œ ìƒíƒœ:', !modal.classList.contains('hidden'));
        console.log('  matched-row input ì¡´ì¬:', !!matchedRowInput);
        console.log('  matched-row í˜„ì¬ ê°’:', matchedRowInput.value);
        
        if (virtualMatch && virtualMatch.row) {
          const diffMinutes = Math.floor(virtualMatch.timeDiff / 60);
          const diffSeconds = virtualMatch.timeDiff % 60;
          
          let timeDiffStr = '';
          if (diffMinutes > 0) {
            timeDiffStr = `${diffMinutes}ë¶„ ${diffSeconds}ì´ˆ`;
          } else {
            timeDiffStr = `${diffSeconds}ì´ˆ`;
          }
          
          // ë§¤ì¹­ ì •í™•ë„ì— ë”°ë¥¸ ì•„ì´ì½˜ ë° ìƒíƒœ í‘œì‹œ
          let accuracyIcon = '';
          let accuracyText = '';
          
          switch(virtualMatch.accuracy) {
            case 'exact':
              accuracyIcon = 'ğŸ¯';
              accuracyText = 'ì •í™• ë§¤ì¹­';
              break;
            case 'close':
              accuracyIcon = 'âœ…';
              accuracyText = 'ê·¼ì‚¬ ë§¤ì¹­';
              break;
            case 'approximate':
              accuracyIcon = 'âš ï¸';
              accuracyText = 'ëŒ€ëµì  ë§¤ì¹­';
              break;
            default:
              accuracyIcon = 'â“';
              accuracyText = 'ë§¤ì¹­ ìƒíƒœ ë¶ˆëª…';
          }
          
          // ì‹œê°„ í¬ë§·íŒ…
          let targetTimeFormatted = virtualMatch.targetTime;
          let matchedTimeFormatted = virtualMatch.matchedTime;
          
          // íƒ€ê²Ÿ ì‹œê°„ í¬ë§·íŒ… (timestampì¸ ê²½ìš°)
          if (targetTimeFormatted && !targetTimeFormatted.includes(':')) {
            const targetDate = new Date(parseInt(targetTimeFormatted) * 1000);
            if (!isNaN(targetDate.getTime())) {
              const h = String(targetDate.getHours()).padStart(2, '0');
              const m = String(targetDate.getMinutes()).padStart(2, '0');
              const s = String(targetDate.getSeconds()).padStart(2, '0');
              targetTimeFormatted = `${h}:${m}:${s}`;
            }
          }
          
          // ë§¤ì¹­ ì‹œê°„ í¬ë§·íŒ… (ì´ë¯¸ HH:MM:SS í˜•ì‹ì¼ ìˆ˜ ìˆìŒ)
          if (matchedTimeFormatted && matchedTimeFormatted.match(/^\d+$/)) {
            const matchedDate = new Date(parseInt(matchedTimeFormatted) * 1000);
            if (!isNaN(matchedDate.getTime())) {
              const h = String(matchedDate.getHours()).padStart(2, '0');
              const m = String(matchedDate.getMinutes()).padStart(2, '0');
              const s = String(matchedDate.getSeconds()).padStart(2, '0');
              matchedTimeFormatted = `${h}:${m}:${s}`;
            }
          }
          
          const matchedRowText = `${accuracyIcon} Row ${virtualMatch.rowIndex} [í•¸ë“œ ${targetTimeFormatted} â†” ì‹œíŠ¸ ${matchedTimeFormatted}] (ì°¨ì´: ${timeDiffStr}) - ${accuracyText}`;
          
          // UI ì—…ë°ì´íŠ¸
          console.log('ğŸ“ matched-row ì—…ë°ì´íŠ¸ ì‹œë„...');
          matchedRowInput.value = matchedRowText;
          
          console.log('âœ… matched-row ì—…ë°ì´íŠ¸ ì™„ë£Œ:', matchedRowText);
          console.log('âœ… ì‹¤ì œ ê°’ í™•ì¸:', matchedRowInput.value);
          console.log('âœ… DOMì— ë°˜ì˜ í™•ì¸:', document.getElementById('matched-row').value);
        } else {
          matchedRowInput.value = 'âŒ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ';
          console.log('âŒ ë§¤ì¹­ ì‹¤íŒ¨ - UI ì—…ë°ì´íŠ¸');
        }
        
        // AI ìš”ì•½ ì—…ë°ì´íŠ¸
        console.log('ğŸ“ ai-summary ì—…ë°ì´íŠ¸ ì‹œë„...');
        summaryTextarea.value = aiSummary || 'ë¶„ì„ ì‹¤íŒ¨';
        console.log('âœ… ai-summary ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
      } catch(error) {
        console.error('âŒ ë¹„ë™ê¸° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        matchedRowInput.value = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
        summaryTextarea.value = 'ë¶„ì„ ì‹¤íŒ¨';
      }
    }
    
    // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('cancel-completion').addEventListener('click', () => {
      document.getElementById('completion-modal').classList.add('hidden');
    });
    
    // ì™„ë£Œ ì²˜ë¦¬ í™•ì¸ (ê°œì„ ëœ ë²„ì „)
    document.getElementById('confirm-completion').addEventListener('click', async () => {
      const handNumber = currentHand;
      const filename = document.getElementById('final-filename').value;
      const summary = document.getElementById('ai-summary').value;
      const matchedRowInfo = document.getElementById('matched-row').value;

      if (!filename || filename.includes('ì²˜ë¦¬ ì¤‘') || filename.includes('ì˜¤ë¥˜')) {
        alert('ì²˜ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì‹œê±°ë‚˜, ì²˜ë¦¬ì— ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!summary || summary.includes('ì²˜ë¦¬ ì¤‘') || summary.includes('ì²˜ë¦¬ ì‹¤íŒ¨')) {
        alert('í•¸ë“œ ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì‹œê±°ë‚˜, ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      // í–‰ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: "ë§¤ì¹­: 5í–‰ [...]" â†’ 5)
      const rowMatch = matchedRowInfo.match(/ë§¤ì¹­:\s*(\d+)í–‰/);
      const rowNumber = rowMatch ? parseInt(rowMatch[1]) : null;

      if (!rowNumber) {
        alert('âš ï¸ ë§¤ì¹­ëœ í–‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në§¤ì¹­ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      // í™•ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
      const confirmBtn = document.getElementById('confirm-completion');
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';

      try {
        // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ë°ì´í„° ì¤€ë¹„ (Eì—´: 'ë³µì‚¬ì™„ë£Œ' í¬í•¨)
        const completeUpdateData = {
          action: 'updateSheet',
          sheetUrl: getSheetUrl(),
          rowNumber: rowNumber,
          handNumber: handNumber,
          filename: filename,
          aiAnalysis: summary,
          status: 'ë³µì‚¬ì™„ë£Œ',  // âœ… ì™„ë£Œ ë‹¨ê³„ì—ì„œ 'ë³µì‚¬ì™„ë£Œ' ì„¤ì •
          timestamp: new Date().toISOString()
        };

        console.log('ğŸ”„ ì™„ë£Œ ì²˜ë¦¬ ë°ì´í„°:', completeUpdateData);

        // Apps Scriptë¥¼ í†µí•œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (Eì—´ 'ë³µì‚¬ì™„ë£Œ' í¬í•¨)
        const updateResult = await updateSheetData(
          rowNumber,  // ìˆ«ì íƒ€ì… í–‰ ë²ˆí˜¸ ì „ë‹¬
          handNumber,
          filename,
          summary,
          completeUpdateData  // customDataë¡œ ì „ë‹¬
        );

        if (!updateResult.success) {
          throw new Error(updateResult.message || 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }

        console.log('âœ… ì™„ë£Œ ì²˜ë¦¬ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!');
        
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        const handIndex = allHands.findIndex(h => h.handNumber === handNumber);
        if (handIndex !== -1) {
          allHands[handIndex].handEdit = true;
          allHands[handIndex].handEditTime = new Date().toISOString();
        }
        
        // UI ì—…ë°ì´íŠ¸
        updateHandStatus(true);
        updateHandList();
        updateStats();
        
        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('completion-modal').classList.add('hidden');
        
        // ì„±ê³µ ì•Œë¦¼
        showNotification(`âœ… í•¸ë“œ #${handNumber} ì™„ë£Œ ì²˜ë¦¬ ì™„ë£Œ!`, 'success');
        alert(`âœ… í•¸ë“œ #${handNumber} ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ!\n\nğŸ“ íŒŒì¼ëª…: ${filename}\nğŸ¤– AI ë¶„ì„: ${String(summary).substring(0, 50)}...\nğŸ“‹ Eì—´ ìƒíƒœ: ë³µì‚¬ì™„ë£Œ\n\nëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
      } catch (error) {
        console.error('âŒ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showNotification('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
        alert(`âŒ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    });
    
    // ì™„ë£Œ ë²„íŠ¼ ì²˜ë¦¬ í•¨ìˆ˜ (ìºì‹œ ìš°ì„  ì‚¬ìš©)
    async function processCompleteButton(handNumber) {
      const editBtn = document.getElementById('edit-btn');
      const completeBtn = document.getElementById('complete-btn');

      // ë¡œë”© íŒì—… í‘œì‹œ
      showLoadingPopup('ì™„ë£Œ ì²˜ë¦¬ ì¤‘...', 'í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê³  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤');

      try {
        // 0. ì‹œíŠ¸ URL ë¨¼ì € í™•ì¸ (ì „ì²´ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
        const sheetUrl = getSheetUrl();
        if (!sheetUrl) {
          throw new Error('ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // 1. ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        completeBtn.disabled = true;
        completeBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        editBtn.disabled = true;

        // 2. ìºì‹œ ë¨¼ì € í™•ì¸ (ë¹ ë¥¸ ì‘ë‹µ)
        let rowNumber = null;
        let handTime = null;

        // ì „ì—­ ìºì‹œì—ì„œ í–‰ ë²ˆí˜¸ í™•ì¸
        if (window.handStatusCache && window.handStatusCache.has(handNumber)) {
          const cachedData = window.handStatusCache.get(handNumber);
          if (cachedData.rowNumber) {
            rowNumber = cachedData.rowNumber;
            console.log(`âœ… ìºì‹œì—ì„œ í–‰ ë²ˆí˜¸ ë°œê²¬: ${rowNumber}`);
          }
        }

        // 3. ìºì‹œì— ì—†ìœ¼ë©´ ì‹œíŠ¸ì—ì„œ ì°¾ê¸°
        if (!rowNumber) {
          // í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
          handTime = await getHandTimestamp(handNumber);
          if (!handTime) {
            throw new Error('í•¸ë“œ ì‹œê°„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ì‹œê°„ ë§¤ì¹­ ìˆ˜í–‰
          const matchResult = await findMatchingRowInVirtualSheet(sheetUrl, handTime);
          const matchedRowData = matchResult ? matchResult.matchedRow : null;
          if (!matchedRowData || !matchedRowData.row) {
            throw new Error('ì‹œê°„ ë§¤ì¹­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ëŒ€ìƒ ì‹œê°„ì—ì„œ Â±3ë¶„ ë²”ìœ„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ)');
          }
          rowNumber = matchedRowData.row; // í–‰ ë²ˆí˜¸ ì¶”ì¶œ (ìˆ«ì)

          // ì°¾ì€ í–‰ ë²ˆí˜¸ë¥¼ ìºì‹œì— ì €ì¥
          if (!window.handStatusCache) {
            window.handStatusCache = new Map();
          }
          const existing = window.handStatusCache.get(handNumber) || {};
          window.handStatusCache.set(handNumber, { ...existing, rowNumber });
        }

        // 5. AI ë¶„ì„ ì‹¤í–‰
        console.log(`ğŸ” [processEditButton] AI ë¶„ì„ í˜¸ì¶œ ì‹œì‘ - í•¸ë“œ #${handNumber}`);
        const aiAnalysis = await analyzeHandWithAI(handNumber);
        console.log(`ğŸ” [processEditButton] AI ë¶„ì„ ì™„ë£Œ: ${aiAnalysis?.substring?.(0, 50) || String(aiAnalysis).substring(0, 50) || 'N/A'}...`);

        // í¸ì§‘ ì‹œ ì €ì¥ëœ íŒŒì¼ëª… í™•ì¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        let filename = getFilenameForHand(handNumber);
        if (!filename) {
          // í¸ì§‘ ì—†ì´ ë°”ë¡œ ì™„ë£Œí•˜ëŠ” ê²½ìš° ìƒˆ íŒŒì¼ëª… ìƒì„±
          console.log(`ğŸ” [processEditButton] íŒŒì¼ëª… ìƒì„± í˜¸ì¶œ ì‹œì‘ - í•¸ë“œ #${handNumber}`);
          filename = await generateCustomFilename(handNumber);
          console.log(`ğŸ” [processEditButton] íŒŒì¼ëª… ìƒì„± ì™„ë£Œ: ${filename}`);
          // ğŸš€ ë§¤í•‘ ì €ì¥
          saveHandFilenameMapping(handNumber, filename);
        }
        // ì´ë¯¸ í¸ì§‘ëœ ê²½ìš° ê¸°ì¡´ íŒŒì¼ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš©

        // AI ë¶„ì„ í…ìŠ¤íŠ¸ë¥¼ CSV ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        let safeAiAnalysis = aiAnalysis;
        if (safeAiAnalysis && (safeAiAnalysis.includes('\n') || safeAiAnalysis.includes(',') || safeAiAnalysis.includes('"'))) {
          safeAiAnalysis = `"${safeAiAnalysis.replace(/"/g, '""')}"`;  // RFC 4180 CSV í‘œì¤€
        }

        // 6. ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (ë³µì‚¬ì™„ë£Œ ìƒíƒœë¡œ)
        const updateData = {
          action: 'updateSheet',
          sheetUrl: sheetUrl,
          rowNumber: rowNumber,
          handNumber: handNumber,
          filename: filename,
          aiAnalysis: safeAiAnalysis,  // CSV ì•ˆì „ ì²˜ë¦¬ëœ AI ë¶„ì„
          status: 'ë³µì‚¬ì™„ë£Œ',  // âœ… ì™„ë£Œ ë‹¨ê³„ì—ì„œ 'ë³µì‚¬ì™„ë£Œ' ì„¤ì •
          timestamp: handTime
        };

        console.log('ğŸ“¤ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë°ì´í„°:', updateData);

        const result = await updateSheetData(rowNumber, handNumber, filename, aiAnalysis, updateData);

        if (result && result.success) {
          // 7. ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
          completeBtn.textContent = 'ì™„ë£Œ';
          completeBtn.disabled = true;  // ì™„ë£Œ í›„ ë¹„í™œì„±í™”
          editBtn.disabled = true;      // í¸ì§‘ ë²„íŠ¼ë„ ë¹„í™œì„±í™”

          // ğŸš€ ì¦‰ì‹œ ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸ (ì‚¬ì „ ë¡œë”© ë°ì´í„° ì—…ë°ì´íŠ¸ ë°˜ì˜)
          setTimeout(() => {
            console.log('ğŸ”„ ì™„ë£Œ ì²˜ë¦¬ í›„ ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸...');
            updateButtonStatesFromStatus(handNumber, 'ë³µì‚¬ì™„ë£Œ');
            // ğŸ“Š ì™„ë£Œ ì‹œê°„ ê¸°ë¡
            recordCompleteTime(handNumber);
          }, 100);

          hideLoadingPopup();  // ë¡œë”© íŒì—… ë‹«ê¸°

          // ìƒì„¸í•œ ì •ë³´ë¥¼ í¬í•¨í•œ íŒì—… ë©”ì‹œì§€
          const detailMessage = `âœ… ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!

ğŸ“Š Google Sheets ì—…ë°ì´íŠ¸ ì •ë³´:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ì‹œíŠ¸ ìœ„ì¹˜: ${rowNumber}ë²ˆì§¸ í–‰
ğŸ“ Dì—´ (í•¸ë“œë²ˆí˜¸): ${handNumber}
ğŸ“ Eì—´ (ìƒíƒœ): ë³µì‚¬ì™„ë£Œ âœ…
ğŸ“‚ Fì—´ (íŒŒì¼ëª…): ${filename}
ğŸ¤– Hì—´ (AIë¶„ì„): ${String(aiAnalysis).substring(0, 50)}...

â° ì‹œê°„: ${new Date(handTime * 1000).toLocaleString('ko-KR')}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;

          alert(detailMessage);

          // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateHandEditStatus(handNumber, true, true);
        } else {
          throw new Error(result?.message || 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        hideLoadingPopup();  // ì˜¤ë¥˜ ì‹œì—ë„ íŒì—… ë‹«ê¸°
        console.error('âŒ ì™„ë£Œ ë²„íŠ¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);

        // ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ë³µì›
        completeBtn.disabled = false;
        completeBtn.textContent = 'ì™„ë£Œ';
        editBtn.disabled = false;

        alert(`âŒ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message}`);
      }
    }

    // ë¡œë”© íŒì—… í‘œì‹œ í•¨ìˆ˜
    function showLoadingPopup(title = 'ì‘ì—… ì¤‘...', message = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”', showProgress = false) {
      const popup = document.getElementById('loading-popup');
      const titleEl = document.getElementById('loading-title');
      const messageEl = document.getElementById('loading-message');
      const progressEl = document.getElementById('loading-progress');

      titleEl.textContent = title;
      messageEl.textContent = message;

      if (showProgress) {
        progressEl.classList.remove('hidden');
      } else {
        progressEl.classList.add('hidden');
      }

      popup.classList.remove('hidden');

      // ëª¨ë‹¬ ë¹„í™œì„±í™”
      const modal = document.getElementById('hand-detail-modal');
      if (modal) {
        modal.style.pointerEvents = 'none';
        modal.style.opacity = '0.7';
      }
    }

    // ë¡œë”© íŒì—… ë‹«ê¸° í•¨ìˆ˜
    function hideLoadingPopup() {
      const popup = document.getElementById('loading-popup');
      popup.classList.add('hidden');

      // ëª¨ë‹¬ ë‹¤ì‹œ í™œì„±í™”
      const modal = document.getElementById('hand-detail-modal');
      if (modal) {
        modal.style.pointerEvents = 'auto';
        modal.style.opacity = '1';
      }
    }

    // í¸ì§‘ ë²„íŠ¼ ì²˜ë¦¬ í•¨ìˆ˜ (ìºì‹œ ìš°ì„  ì‚¬ìš©)
    async function processEditButton(handNumber) {
      if (window.DEBUG_MODE) console.log(`\nğŸ”´ğŸ”´ğŸ”´ [í¸ì§‘ ë²„íŠ¼ í´ë¦­] í•¸ë“œ #${handNumber} ì²˜ë¦¬ ì‹œì‘ ğŸ”´ğŸ”´ğŸ”´`);
      const editBtn = document.getElementById('edit-btn');
      const completeBtn = document.getElementById('complete-btn');

      // ë¡œë”© íŒì—… í‘œì‹œ
      showLoadingPopup('í¸ì§‘ ì¤‘...', 'ì‹œíŠ¸ì—ì„œ ì‹œê°„ ë§¤ì¹­ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤');

      try {
        // 0. ì‹œíŠ¸ URL ë¨¼ì € í™•ì¸ (ì „ì²´ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
        const sheetUrl = getSheetUrl();
        if (!sheetUrl) {
          throw new Error('ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // 1. ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        editBtn.disabled = true;
        editBtn.textContent = 'í¸ì§‘ ì¤‘...';
        completeBtn.disabled = true;

        // 2. ìºì‹œ ë¨¼ì € í™•ì¸ (ë¹ ë¥¸ ì‘ë‹µ)
        let rowNumber = null;
        let handTime = null;

        // ì „ì—­ ìºì‹œì—ì„œ í–‰ ë²ˆí˜¸ í™•ì¸
        if (window.handStatusCache && window.handStatusCache.has(handNumber)) {
          const cachedData = window.handStatusCache.get(handNumber);
          if (cachedData.rowNumber) {
            rowNumber = cachedData.rowNumber;
            console.log(`âœ… ìºì‹œì—ì„œ í–‰ ë²ˆí˜¸ ë°œê²¬: ${rowNumber}`);
          }
        }

        // 3. ìºì‹œì— ì—†ìœ¼ë©´ ì‹œíŠ¸ì—ì„œ ì°¾ê¸°
        if (!rowNumber) {
          // í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
          handTime = await getHandTimestamp(handNumber);
          if (!handTime) {
            throw new Error('í•¸ë“œ ì‹œê°„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ì‹œê°„ ë§¤ì¹­ ìˆ˜í–‰
          const matchResult = await findMatchingRowInVirtualSheet(sheetUrl, handTime);
          const matchedRowData = matchResult ? matchResult.matchedRow : null;
          if (!matchedRowData || !matchedRowData.row) {
            throw new Error('ì‹œê°„ ë§¤ì¹­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ëŒ€ìƒ ì‹œê°„ì—ì„œ Â±3ë¶„ ë²”ìœ„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ)');
          }
          rowNumber = matchedRowData.row; // í–‰ ë²ˆí˜¸ ì¶”ì¶œ (ìˆ«ì)

          // ì°¾ì€ í–‰ ë²ˆí˜¸ë¥¼ ìºì‹œì— ì €ì¥
          if (!window.handStatusCache) {
            window.handStatusCache = new Map();
          }
          const existing = window.handStatusCache.get(handNumber) || {};
          window.handStatusCache.set(handNumber, { ...existing, rowNumber });
        }

        // ğŸ”´ ë””ë²„ê¹…: í¸ì§‘ ì‹œ ë§¤ì¹­ëœ í–‰ ë²ˆí˜¸
        console.log(`ğŸ”´ [í¸ì§‘ ë²„íŠ¼] í•¸ë“œ #${handNumber} ë§¤ì¹­ ê²°ê³¼:`);
        console.log(`   - í•¸ë“œ íƒ€ì„ìŠ¤íƒ¬í”„: ${handTime} (${new Date(handTime * 1000).toLocaleTimeString()})`);
        console.log(`   - ë§¤ì¹­ëœ í–‰ ë²ˆí˜¸: ${rowNumber}`);
        console.log(`ğŸ”´ğŸ”´ğŸ”´ í¸ì§‘ ë²„íŠ¼ ë§¤ì¹­ ì™„ë£Œ ğŸ”´ğŸ”´ğŸ”´\n`);

        // 5. AI ë¶„ì„ ë° ìë§‰ ìƒì„± ì‹¤í–‰
        const aiAnalysis = await analyzeHandWithAI(handNumber);
        const filename = await generateCustomFilename(handNumber);
        const subtitle = await generateSubtitle(handNumber);

        // ğŸš€ ë§¤í•‘ ì €ì¥
        saveHandFilenameMapping(handNumber, filename);

        // AI ë¶„ì„ í…ìŠ¤íŠ¸ë¥¼ CSV ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        let safeAiAnalysis = aiAnalysis;
        if (safeAiAnalysis && (safeAiAnalysis.includes('\n') || safeAiAnalysis.includes(',') || safeAiAnalysis.includes('"'))) {
          safeAiAnalysis = `"${safeAiAnalysis.replace(/"/g, '""')}"`;  // RFC 4180 CSV í‘œì¤€
        }

        // 6. ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (ë¯¸ì™„ë£Œ ìƒíƒœë¡œ)
        const updateData = {
          action: 'updateSheet',
          sheetUrl: sheetUrl,
          rowNumber: rowNumber,  // ìˆ«ì íƒ€ì… ì‚¬ìš©
          handNumber: handNumber,
          filename: filename,
          aiAnalysis: safeAiAnalysis,  // CSV ì•ˆì „ ì²˜ë¦¬ëœ AI ë¶„ì„
          subtitle: subtitle,  // ìë§‰ ì •ë³´ ì¶”ê°€
          status: 'ë¯¸ì™„ë£Œ',  // âœ… í¸ì§‘ ë‹¨ê³„ì—ì„œ 'ë¯¸ì™„ë£Œ' ì„¤ì •
          timestamp: handTime
        };

        console.log('ğŸ“¤ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ë°ì´í„°:', updateData);
        console.log('ğŸ¬ ìƒì„±ëœ ìë§‰:', subtitle);

        const result = await updateSheetData(rowNumber, handNumber, filename, aiAnalysis, updateData);

        if (result && result.success) {
          // 7. ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
          hideLoadingPopup();  // ë¡œë”© íŒì—… ë‹«ê¸°
          editBtn.textContent = 'í¸ì§‘';
          editBtn.disabled = true;      // í¸ì§‘ ì™„ë£Œ í›„ ë¹„í™œì„±í™”
          completeBtn.disabled = false;  // ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”

          // ğŸš€ ì¦‰ì‹œ ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸ (ì‚¬ì „ ë¡œë”© ë°ì´í„° ì—…ë°ì´íŠ¸ ë°˜ì˜)
          setTimeout(() => {
            console.log('ğŸ”„ í¸ì§‘ ì™„ë£Œ í›„ ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸...');
            updateButtonStatesFromStatus(handNumber, 'ë¯¸ì™„ë£Œ');
            // ğŸ“Š í¸ì§‘ ì‹œì‘ ì‹œê°„ ê¸°ë¡
            recordEditStartTime(handNumber);
          }, 100);

          // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateHandEditStatus(handNumber, false, true); // ë§ˆì§€ë§‰ ë§¤ê°œë³€ìˆ˜ëŠ” skipServerCall

          // ìƒì„¸í•œ ì •ë³´ë¥¼ í¬í•¨í•œ íŒì—… ë©”ì‹œì§€
          const detailMessage = `âœ… í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!

ğŸ“Š Google Sheets ì—…ë°ì´íŠ¸ ì •ë³´:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ì‹œíŠ¸ ìœ„ì¹˜: ${rowNumber}ë²ˆì§¸ í–‰
ğŸ“ Dì—´ (í•¸ë“œë²ˆí˜¸): ${handNumber}
ğŸ“ Eì—´ (ìƒíƒœ): ë¯¸ì™„ë£Œ
ğŸ“‚ Fì—´ (íŒŒì¼ëª…): ${filename}
ğŸ¤– Hì—´ (AIë¶„ì„): ${String(aiAnalysis).substring(0, 50)}...

â° ì‹œê°„: ${new Date(handTime * 1000).toLocaleString('ko-KR')}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„: "ì™„ë£Œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµœì¢… ì²˜ë¦¬í•˜ì„¸ìš”.`;

          alert(detailMessage);
        } else {
          throw new Error(result?.message || 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('âŒ í¸ì§‘ ë²„íŠ¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);

        // ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ë³µì›
        editBtn.textContent = 'í¸ì§‘';
        editBtn.disabled = false;
        completeBtn.disabled = true;

        alert('âŒ í¸ì§‘ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n' + error.message + '\n\në‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    async function updateHandEditStatus(handNumber, checked, skipServerCall = false) {
      const completeBtn = document.getElementById('complete-btn');
      const editBtn = document.getElementById('edit-btn');

      if (skipServerCall) {
        // ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ (ì„œë²„ í˜¸ì¶œ ì—†ì´)
        console.log('ğŸ”„ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸:', handNumber);
        return;
      }

      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      completeBtn.disabled = true;
      editBtn.disabled = true;
      completeBtn.textContent = checked ? 'ì™„ë£Œ ì¤‘...' : 'ì·¨ì†Œ ì¤‘...';

      try {
        const payload = {
          action: 'updateHandEdit',
          handNumber: handNumber,
          checked: checked
        };

        console.log('ğŸ”§ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ - ì „ì†¡í•  ë°ì´í„°:', payload);
        console.log('ğŸ”§ í˜„ì¬ CONFIG.APPS_SCRIPT_URL:', CONFIG.APPS_SCRIPT_URL);

        const formData = new FormData();
        formData.append('payload', JSON.stringify(payload));

        console.log('ğŸ“¤ Google Apps Script ìš”ì²­ ì „ì†¡ ì¤‘...');
        console.log('ğŸ“¤ ì‚¬ìš© ì¤‘ì¸ URL:', CONFIG.APPS_SCRIPT_URL);
        const response = await fetch(CONFIG.APPS_SCRIPT_URL + '?_t=' + Date.now(), {
          method: 'POST',
          body: formData,
          cache: 'no-cache'
        });
        
        console.log('ğŸ“¨ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        console.log('ğŸ“¨ ì‘ë‹µ í—¤ë”:', Object.fromEntries(response.headers.entries()));
        
        const responseText = await response.text();
        console.log('ğŸ“¨ ì‘ë‹µ ì›ë³¸ í…ìŠ¤íŠ¸:', responseText);
        
        let result;
        try {
          result = JSON.parse(responseText);
          console.log('ğŸ“¨ íŒŒì‹±ëœ ê²°ê³¼:', result);
        } catch (parseError) {
          console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
          console.error('âŒ ì‘ë‹µì´ JSONì´ ì•„ë‹˜:', responseText);
          throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + responseText);
        }
        
        if (result.success === true || result.status === 'success') {
          console.log('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
          
          // ì„±ê³µ ì•Œë¦¼
          showNotification(
            checked ? 'âœ… í•¸ë“œ í¸ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ğŸ“ í•¸ë“œê°€ í¸ì§‘ ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!',
            'success'
          );
          
          // ì„±ê³µ ì†Œë¦¬ ì¬ìƒ
          playSound('success');
          
          // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ì•Œë¦¼ ì–µì œ)
          await loadIndexData(true);
          
          // í˜„ì¬ ì„ íƒëœ í•¸ë“œ ì—…ë°ì´íŠ¸
          if (currentHand === handNumber) {
            updateHandStatus(checked);
          }
        } else if (result.status === 'error') {
          console.error('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', result);
          showNotification('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
        } else {
          console.error('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ:', result);
          showNotification('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜', 'error');
        }
      } catch (error) {
        console.error('API ì˜¤ë¥˜:', error);
        showNotification('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
        completeBtn.disabled = false;
        editBtn.disabled = false;
        completeBtn.textContent = 'ì™„ë£Œ';
      }
    }
    
    // í˜„ì¬ í•¸ë“œì˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateHandStatus(isCompleted) {
      const completeBtn = document.getElementById('complete-btn');
      const editBtn = document.getElementById('edit-btn');
      
      if (isCompleted) {
        completeBtn.classList.add('bg-gray-600');
        completeBtn.classList.remove('bg-green-600');
        completeBtn.textContent = 'ì™„ë£Œë¨';
        completeBtn.disabled = true;
        
        editBtn.classList.remove('bg-gray-600');
        editBtn.classList.add('bg-yellow-600');
        editBtn.disabled = false;
      } else {
        completeBtn.classList.remove('bg-gray-600');
        completeBtn.classList.add('bg-green-600');
        completeBtn.textContent = 'ì™„ë£Œ';
        completeBtn.disabled = false;
        
        editBtn.classList.add('bg-gray-600');
        editBtn.classList.remove('bg-yellow-600');
        editBtn.disabled = true;
      }
    }
    
    // ====================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // ====================================
    


    document.getElementById('refresh-btn').addEventListener('click', () => {
      console.log('ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨');
      loadIndexData(false); // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì€ ì•Œë¦¼ í—ˆìš©
    });
    
    document.getElementById('settings-btn').addEventListener('click', () => {
      // Gemini API í‚¤ ë¡œë“œ
      document.getElementById('gemini-api-key').value = CONFIG.GEMINI_API_KEY;

      // íŒŒì¼ëª… ì»¤ìŠ¤í„°ë§ˆì´ì§• ì„¤ì • ë¡œë“œ (null ì²´í¬ ì¶”ê°€)
      const filenamePrefix = document.getElementById('filename-prefix');
      const filenameSuffix = document.getElementById('filename-suffix');
      const aiSuggestions = document.getElementById('ai-filename-suggestions');

      if (filenamePrefix) {
        filenamePrefix.value = localStorage.getItem('filenamePrefix') || '';
      }
      if (filenameSuffix) {
        filenameSuffix.value = localStorage.getItem('filenameSuffix') || '';
      }
      // AI ê¸°ëŠ¥ ì„¤ì • ë¡œë“œ
      const aiFilename = document.getElementById('ai-filename-enable');
      const aiHColumn = document.getElementById('ai-hcolumn-enable');

      if (aiFilename) {
        aiFilename.checked = localStorage.getItem('useAIForFilename') === 'true';
      }
      if (aiHColumn) {
        aiHColumn.checked = localStorage.getItem('useAIForHColumn') === 'true';
      }

      // í…œí”Œë¦¿ ì„¤ì • ë¡œë“œ
      const filenameTemplate = document.getElementById('filename-template');
      const templatePreset = document.getElementById('template-preset');

      if (filenameTemplate) {
        filenameTemplate.value = localStorage.getItem('filenameTemplate') || '{prefix}{handNumber}';

        // í…œí”Œë¦¿ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        filenameTemplate.addEventListener('input', updateFilenamePreview);
      }

      if (templatePreset) {
        templatePreset.value = localStorage.getItem('templatePreset') || 'simple';

        // í”„ë¦¬ì…‹ ë³€ê²½ ì‹œ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
        templatePreset.addEventListener('change', handleTemplatePresetChange);
      }

      // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      updateFilenamePreview();

      document.getElementById('settings-modal').classList.remove('hidden');
    });

    // íŒŒì¼ëª… ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('preview-filename').addEventListener('click', async () => {
      const prefix = document.getElementById('filename-prefix').value;
      const suffix = document.getElementById('filename-suffix').value;

      // localStorageì— ì„ì‹œ ì €ì¥
      const originalPrefix = localStorage.getItem('filenamePrefix');
      const originalSuffix = localStorage.getItem('filenameSuffix');

      localStorage.setItem('filenamePrefix', prefix);
      localStorage.setItem('filenameSuffix', suffix);

      // í˜„ì¬ ì„ íƒëœ í•¸ë“œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
      let testHandNumber = '143';
      const selectedHand = document.querySelector('.hand-item.selected');
      if (selectedHand) {
        testHandNumber = selectedHand.dataset.handNumber || '143';
      }

      // ì˜ˆì‹œ íŒŒì¼ëª… ìƒì„±
      const exampleFilename = await generateCustomFilename(testHandNumber);

      // ì›ë˜ ì„¤ì • ë³µì›
      if (originalPrefix !== null) localStorage.setItem('filenamePrefix', originalPrefix);
      if (originalSuffix !== null) localStorage.setItem('filenameSuffix', originalSuffix);

      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      const previewDiv = document.getElementById('filename-preview');
      previewDiv.innerHTML = `
        <div>ğŸ“ ì˜ˆì‹œ: ${exampleFilename}.mp4</div>
        <div class="text-xs text-gray-400 mt-1">í˜•ì‹: ì ‘ë‘ì‚¬{í•¸ë“œë²ˆí˜¸}_í”Œë ˆì´ì–´A_í•¸ë“œ_í”Œë ˆì´ì–´B_í•¸ë“œ_ìš”ì•½</div>
        <div class="text-xs text-gray-400">ğŸ’¡ í¸ì§‘ê³¼ ì™„ë£Œ ì‹œ ë™ì¼í•œ íŒŒì¼ëª… ì‚¬ìš©</div>
      `;
      previewDiv.classList.remove('hidden');
    });

    document.getElementById('cancel-settings').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.add('hidden');
    });
    
    document.getElementById('save-settings').addEventListener('click', () => {
      // ìƒˆë¡œìš´ í†µí•© ì €ì¥ í•¨ìˆ˜ ì‚¬ìš©
      saveAllSettings();

      // API í‚¤ localStorage ì €ì¥ (ì¤‘ë³µì´ì§€ë§Œ í˜¸í™˜ì„± ìœ ì§€)
      saveAPIKeys();
      
      // âš ï¸ ê¸°ì¡´ íƒ€ì´ë¨¸ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” - Phase 3 ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ë§Œ ì‚¬ìš©
      // Phase 3ì—ì„œ ë” íš¨ìœ¨ì ì¸ ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ì„ ì œê³µí•˜ë¯€ë¡œ ê¸°ì¡´ íƒ€ì´ë¨¸ ì‚¬ìš© ì•ˆ í•¨
      if (refreshTimerInitial) {
        clearTimeout(refreshTimerInitial);
        refreshTimerInitial = null;
      }
      if (refreshTimerInterval) {
        clearInterval(refreshTimerInterval);
        refreshTimerInterval = null;
      }

      console.log('âš ï¸ ì„¤ì • ì €ì¥ - ê¸°ì¡´ íƒ€ì´ë¨¸ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” ìœ ì§€ (Phase 3 ì‚¬ìš©)');
      
      document.getElementById('settings-modal').classList.add('hidden');
    });
    
    // ë²„í¼ ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById('clear-notification-history').addEventListener('click', () => {
      if (confirm('ì •ë§ë¡œ ìµœê·¼ í•¸ë“œ ë²„í¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜:\n- ìµœê·¼ í•¸ë“œ ë²„í¼ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤\n- ë‹¤ìŒ ë¡œë“œì‹œ ê¸°ì¡´ í•¸ë“œë„ ìƒˆ í•¸ë“œë¡œ ì¸ì‹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤')) {
        // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        recentHandsBuffer.clear();
        masterHandList.clear();
        saveMasterHandList();
        
        // ê¸°ì¡´ ì•Œë¦¼ ê¸°ë¡ë„ ì´ˆê¸°í™”
        notifiedHands = {};
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(MASTER_LIST_KEY);
        
        showNotification('âœ… ìµœê·¼ í•¸ë“œ ë²„í¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        console.log('ğŸ”„ ë²„í¼ ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ì„¤ì • ì°½ ë‹«ê¸°
        document.getElementById('settings-modal').classList.add('hidden');
      }
    });
    
    // ===== ì„¤ì •ì°½ URL ìœ íš¨ì„± ê²€ì‚¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    
    // ì½ê¸°ìš© CSV ì‹œíŠ¸ URL ìœ íš¨ì„± ê²€ì‚¬
    document.getElementById('read-sheet-url').addEventListener('input', (e) => {
      const validation = validateCsvUrl(e.target.value);
      updateUrlFeedback('read-sheet-url', 'read-sheet-url-feedback', validation);
    });
    
    // ì“°ê¸°ìš© ì‹œíŠ¸ URL ìœ íš¨ì„± ê²€ì‚¬  
    document.getElementById('write-sheet-url').addEventListener('input', (e) => {
      const validation = validateSheetUrl(e.target.value);
      updateUrlFeedback('write-sheet-url', 'write-sheet-url-feedback', validation);
    });
    
    // Apps Script URL ìœ íš¨ì„± ê²€ì‚¬
    const appsScriptUrlElement = document.getElementById('apps-script-url');
    if (appsScriptUrlElement) {
      appsScriptUrlElement.addEventListener('input', (e) => {
        const validation = validateAppsScriptUrl(e.target.value);
        updateUrlFeedback('apps-script-url', 'apps-script-url-feedback', validation);
      });
    } else {
      console.error('âŒ apps-script-url ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ===== Apps Script ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    
    // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    const testAppsScriptElement = document.getElementById('test-apps-script');
    if (testAppsScriptElement) {
      testAppsScriptElement.addEventListener('click', async () => {
        await testAppsScriptConnection();
      });
    } else {
      console.error('âŒ test-apps-script ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // Gemini API í‚¤ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    const testGeminiApiElement = document.getElementById('test-gemini-api');
    if (testGeminiApiElement) {
      testGeminiApiElement.addEventListener('click', async () => {
        await testGeminiAPIConnection();
      });
    } else {
      console.error('âŒ test-gemini-api ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼
    const openSheetUpdateElement = document.getElementById('open-sheet-update');
    if (openSheetUpdateElement) {
      openSheetUpdateElement.addEventListener('click', () => {
        const filenameInput = document.getElementById('final-filename');
        const summaryTextarea = document.getElementById('ai-summary');
        const matchedRowInput = document.getElementById('matched-row');
        
        // ì™„ë£Œ ëª¨ë‹¬ì˜ ë°ì´í„°ë¥¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ë¡œ ë³µì‚¬
        document.getElementById('update-filename').value = filenameInput.value;
        document.getElementById('update-ai-analysis').value = summaryTextarea.value;
        document.getElementById('update-hand-number').textContent = currentHand || '-';
        
        // ë§¤ì¹­ëœ í–‰ ì •ë³´ í‘œì‹œ
        if (window.currentMatchedRowData) {
          const timeInfo = window.currentMatchedRowData.formattedTime ? 
            ` [ì‹œê°„: ${window.currentMatchedRowData.formattedTime}]` : '';
          document.getElementById('update-matched-row').textContent = 
            `Row ${window.currentMatchedRowData.row}${timeInfo} (${window.currentMatchedRowData.isExactMatch ? 'ì •í™•' : 'ê·¼ì‚¬'} ë§¤ì¹­)`;
        } else {
          document.getElementById('update-matched-row').textContent = matchedRowInput.value || '-';
        }
        const now = new Date();
        const nowTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        document.getElementById('update-matched-time').textContent = nowTimeStr;
        
        // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('sheet-update-modal').classList.remove('hidden');
    });
    } else {
      console.error('âŒ open-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ì·¨ì†Œ
    const cancelSheetUpdateElement = document.getElementById('cancel-sheet-update');
    if (cancelSheetUpdateElement) {
      cancelSheetUpdateElement.addEventListener('click', () => {
        document.getElementById('sheet-update-modal').classList.add('hidden');
      });
    } else {
      console.error('âŒ cancel-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    const confirmSheetUpdateElement = document.getElementById('confirm-sheet-update');
    if (confirmSheetUpdateElement) {
      confirmSheetUpdateElement.addEventListener('click', async () => {
      const filename = document.getElementById('update-filename').value.trim();
      const aiAnalysis = document.getElementById('update-ai-analysis').value.trim();
      const matchedRowText = document.getElementById('update-matched-row').textContent;
      
      if (!filename) {
        alert('âš ï¸ íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!currentHand) {
        alert('âš ï¸ í˜„ì¬ ì„ íƒëœ í•¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë§¤ì¹­ëœ í–‰ ë²ˆí˜¸ ì¶”ì¶œ
      let matchedRow = null;
      
      // ë¨¼ì € ì „ì—­ ë³€ìˆ˜ì—ì„œ í™•ì¸
      if (window.currentMatchedRowData && window.currentMatchedRowData.row) {
        matchedRow = window.currentMatchedRowData.row;
      } else {
        // í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œ ì‹œë„ (ì˜ˆ: "Row 5 ..." â†’ 5)
        const rowMatch = matchedRowText.match(/Row\s+(\d+)/);
        if (rowMatch) {
          matchedRow = parseInt(rowMatch[1]);
        }
      }
      
      if (!matchedRow) {
        alert('âš ï¸ ë§¤ì¹­ëœ í–‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € Virtual ì‹œíŠ¸ ë§¤ì¹­ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log('ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘...');
      console.log(`ğŸ“ í–‰: ${matchedRow}, í•¸ë“œ: ${currentHand}, íŒŒì¼ëª…: ${filename}`);
      
      try {
        // ì—…ë°ì´íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
        const updateBtn = document.getElementById('confirm-sheet-update');
        updateBtn.disabled = true;
        updateBtn.textContent = 'ğŸ“Š ì—…ë°ì´íŠ¸ ì¤‘...';
        
        const result = await updateSheetData(matchedRow, currentHand, filename, aiAnalysis);
        
        if (result.success) {
          alert(`âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nğŸ“ í–‰: ${matchedRow}\nğŸ“ íŒŒì¼ëª…: ${filename}\nğŸ¤– AI ë¶„ì„: ${String(aiAnalysis).substring(0, 30)}...`);
          document.getElementById('sheet-update-modal').classList.add('hidden');
          
          // ì™„ë£Œ ì²˜ë¦¬ë„ ê°™ì´ ì‹¤í–‰
          const handNumber = currentHand;
          masterHandList.get(handNumber).status = 'completed';
          saveMasterHandList();
          updateHandList();
          clearHandDetails();
          currentHand = null;
          
        } else {
          alert(`âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${result.message}`);
        }
        
      } catch (error) {
        console.error('ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert(`âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜\n\n${error.message}`);
        
      } finally {
        // ë²„íŠ¼ ë³µêµ¬
        const updateBtn = document.getElementById('confirm-sheet-update');
        updateBtn.disabled = false;
        updateBtn.textContent = 'ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸';
      }
      });
    } else {
      console.error('âŒ confirm-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    document.getElementById('table-filter').addEventListener('change', updateHandList);
    document.getElementById('status-filter').addEventListener('change', updateHandList);
    
    // Eì—´ ë°ì´í„° ë¶„ì„ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
    async function analyzeEColumnData() {
      console.log('\nğŸ”ğŸ”ğŸ” Eì—´ ë°ì´í„° ë¶„ì„ ì‹œì‘ ğŸ”ğŸ”ğŸ”');

      try {
        const sheetUrl = getSheetUrl();
        if (!sheetUrl) {
          console.error('âŒ ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
          return;
        }

        // CSV URL ìƒì„± (ì›¹ ê²Œì‹œ CSV)
        let csvUrl = sheetUrl;
        if (!csvUrl.includes('output=csv')) {
          // URL ë³€í™˜ í•„ìš”
          if (csvUrl.includes('/edit')) {
            const sheetId = csvUrl.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
            const gid = csvUrl.match(/gid=(\d+)/)?.[1] || '0';
            if (sheetId) {
              csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
            }
          }
        }

        console.log(`ğŸ“Š CSV URL: ${csvUrl}`);
        console.log('ğŸ“¥ CSV ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...');

        const response = await fetch(csvUrl + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);

        console.log(`âœ… ì´ ${rows.length}ê°œ í–‰ ë¡œë“œë¨`);

        // Eì—´ ë°ì´í„° ë¶„ì„
        let emptyCount = 0;
        let miCompleteCount = 0;
        let completeCount = 0;
        let otherCount = 0;
        const miCompleteRows = [];
        const completeRows = [];

        rows.forEach((row, index) => {
          const eValue = row[4]?.trim() || ''; // Eì—´ (0-based index)

          if (!eValue || eValue === '') {
            emptyCount++;
          } else if (eValue === 'ë¯¸ì™„ë£Œ' || eValue === '"ë¯¸ì™„ë£Œ"') {
            miCompleteCount++;
            miCompleteRows.push(index + 1); // 1-based í–‰ ë²ˆí˜¸
          } else if (eValue === 'ë³µì‚¬ì™„ë£Œ' || eValue === '"ë³µì‚¬ì™„ë£Œ"') {
            completeCount++;
            completeRows.push(index + 1);
          } else {
            otherCount++;
            console.log(`   ê¸°íƒ€ ê°’ (í–‰ ${index + 1}): "${eValue}"`);
          }
        });

        console.log('\nğŸ“Š === Eì—´ ë°ì´í„° ë¶„ì„ ê²°ê³¼ ===');
        console.log(`   ë¹ˆ ê°’: ${emptyCount}ê°œ`);
        console.log(`   "ë¯¸ì™„ë£Œ": ${miCompleteCount}ê°œ`);
        console.log(`   "ë³µì‚¬ì™„ë£Œ": ${completeCount}ê°œ`);
        console.log(`   ê¸°íƒ€: ${otherCount}ê°œ`);

        if (miCompleteCount > 0) {
          console.log('\nğŸ“Œ "ë¯¸ì™„ë£Œ" ìƒíƒœì¸ í–‰ë“¤:');
          console.log(`   ${miCompleteRows.slice(0, 10).join(', ')}${miCompleteRows.length > 10 ? '...' : ''}`);
        }

        if (completeCount > 0) {
          console.log('\nâœ… "ë³µì‚¬ì™„ë£Œ" ìƒíƒœì¸ í–‰ë“¤:');
          console.log(`   ${completeRows.slice(0, 10).join(', ')}${completeRows.length > 10 ? '...' : ''}`);
        }

        // íŠ¹ì • í–‰ í™•ì¸ (938í–‰, 694í–‰)
        console.log('\nğŸ¯ íŠ¹ì • í–‰ í™•ì¸:');
        [938, 694].forEach(rowNum => {
          if (rowNum <= rows.length) {
            const row = rows[rowNum - 1]; // 0-based index
            console.log(`   í–‰ ${rowNum}: Eì—´ = "${row[4]?.trim() || '(ë¹ˆ ê°’)'}"`);
          }
        });

        console.log('ğŸ”ğŸ”ğŸ” Eì—´ ë°ì´í„° ë¶„ì„ ì™„ë£Œ ğŸ”ğŸ”ğŸ”\n');

        return {
          total: rows.length,
          empty: emptyCount,
          miComplete: miCompleteCount,
          complete: completeCount,
          other: otherCount,
          miCompleteRows,
          completeRows
        };

      } catch (error) {
        console.error('âŒ Eì—´ ë°ì´í„° ë¶„ì„ ì˜¤ë¥˜:', error);
      }
    }

    // ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
    window.analyzeEColumnData = analyzeEColumnData;

    // ì‹œê°„ ë§¤ì¹­ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    window.testTimeMatching = async function(handNumber) {
      console.log('ğŸ§ª ============ ì‹œê°„ ë§¤ì¹­ ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ============');
      console.log(`ğŸ“Œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: í•¸ë“œ #${handNumber}`);

      // 1. Hand ì‹œíŠ¸ì—ì„œ íƒ€ì„ìŠ¤íƒ¬í”„ ê°€ì ¸ì˜¤ê¸°
      const handTimestamp = await getHandTimestamp(handNumber);
      if (!handTimestamp) {
        console.error('âŒ í•¸ë“œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
      }

      const handDate = new Date(handTimestamp * 1000);
      console.log('\nğŸ“Š [1] Hand ì‹œíŠ¸ ë°ì´í„°:');
      console.log(`   - íƒ€ì„ìŠ¤íƒ¬í”„: ${handTimestamp}`);
      console.log(`   - ë‚ ì§œ/ì‹œê°„: ${handDate.toLocaleString()}`);
      console.log(`   - ì‹œê°„ë§Œ: ${handDate.getHours()}:${handDate.getMinutes().toString().padStart(2,'0')}:${handDate.getSeconds().toString().padStart(2,'0')}`);

      // 2. ìºì‹œ ë°ì´í„° í™•ì¸
      console.log('\nğŸ“Š [2] ìºì‹œ ë°ì´í„° ë¶„ì„:');
      await sheetDataCache.ensureFresh();

      // ëª©í‘œ ì‹œê°„ ë¬¸ìì—´ë“¤
      const targetHour = handDate.getHours();
      const targetMin = handDate.getMinutes();
      const targetTimeStr = `${targetHour.toString().padStart(2,'0')}:${targetMin.toString().padStart(2,'0')}`;
      const targetTimeNoZero = `${targetHour}:${targetMin.toString().padStart(2,'0')}`;

      console.log(`   - ì°¾ëŠ” ì‹œê°„: "${targetTimeStr}" ë˜ëŠ” "${targetTimeNoZero}"`);

      // ìºì‹œì—ì„œ ì •í™•í•œ ë§¤ì¹­ ì°¾ê¸°
      let exactMatches = [];
      let nearMatches = [];

      for (const [rowNum, data] of sheetDataCache.cache) {
        // ì •í™•í•œ ë§¤ì¹­
        if (data.time === targetTimeStr || data.time === targetTimeNoZero) {
          exactMatches.push({row: rowNum, data: data});
        }

        // ê·¼ì ‘ ë§¤ì¹­ (Â±5ë¶„)
        const timeParts = data.time.match(/(\d+):(\d+)/);
        if (timeParts) {
          const cacheHour = parseInt(timeParts[1]);
          const cacheMin = parseInt(timeParts[2]);
          const cacheTotalMin = cacheHour * 60 + cacheMin;
          const targetTotalMin = targetHour * 60 + targetMin;
          const diff = Math.abs(cacheTotalMin - targetTotalMin);

          if (diff <= 5 && diff > 0) {
            nearMatches.push({
              row: rowNum,
              data: data,
              diff: diff,
              time: data.time
            });
          }
        }
      }

      console.log(`\n   ğŸ¯ ì •í™•í•œ ë§¤ì¹­ (${targetTimeStr}):`);
      if (exactMatches.length > 0) {
        exactMatches.forEach(m => {
          console.log(`      - í–‰ ${m.row}: ì‹œê°„="${m.data.time}", ìƒíƒœ="${m.data.status || '(ë¹ˆê°’)'}", íƒ€ì„ìŠ¤íƒ¬í”„=${m.data.timestamp}`);
        });
      } else {
        console.log('      âŒ ì—†ìŒ');
      }

      console.log(`\n   ğŸ“ ê·¼ì ‘ ë§¤ì¹­ (Â±5ë¶„):`);
      nearMatches.sort((a, b) => a.diff - b.diff);
      nearMatches.forEach(m => {
        console.log(`      - í–‰ ${m.row}: ì‹œê°„="${m.time}" (${m.diff}ë¶„ ì°¨ì´), ìƒíƒœ="${m.data.status || '(ë¹ˆê°’)'}"`);
      });

      // 3. parseTimeToTimestamp í…ŒìŠ¤íŠ¸
      console.log('\nğŸ“Š [3] parseTimeToTimestamp í•¨ìˆ˜ í…ŒìŠ¤íŠ¸:');
      const testTimes = [targetTimeStr, targetTimeNoZero, "10:14", "10:18"];
      testTimes.forEach(time => {
        const parsed = sheetDataCache.parseTimeToTimestamp(time);
        const parsedDate = parsed ? new Date(parsed * 1000) : null;
        console.log(`   - "${time}" â†’ ${parsed} ${parsedDate ? `(${parsedDate.toLocaleTimeString()})` : '(íŒŒì‹± ì‹¤íŒ¨)'}`);
      });

      // 4. í˜„ì¬ findClosestRow ë™ì‘ í…ŒìŠ¤íŠ¸
      console.log('\nğŸ“Š [4] findClosestRow í•¨ìˆ˜ ì‹¤í–‰:');
      const result = sheetDataCache.findClosestRow(handTimestamp);
      if (result) {
        console.log(`   âœ… ë§¤ì¹­ ê²°ê³¼:`);
        console.log(`      - í–‰: ${result.row}`);
        console.log(`      - ì‹œê°„: "${result.time}"`);
        console.log(`      - ìƒíƒœ: "${result.status || '(ë¹ˆê°’)'}"`);
        console.log(`      - íƒ€ì„ìŠ¤íƒ¬í”„: ${result.timestamp}`);
      } else {
        console.log('   âŒ ë§¤ì¹­ ì‹¤íŒ¨');
      }

      // 5. ìºì‹œ ì‹œê°„ ì¸ë±ìŠ¤ ë¶„ì„
      console.log('\nğŸ“Š [5] ì‹œê°„ ì¸ë±ìŠ¤ ë¶„ì„:');
      console.log(`   - ì´ íƒ€ì„ìŠ¤íƒ¬í”„ ê°œìˆ˜: ${sheetDataCache.timeIndex.size}`);

      // íƒ€ì„ìŠ¤íƒ¬í”„ ë²”ìœ„ í™•ì¸
      const timestamps = Array.from(sheetDataCache.timeIndex.keys()).sort((a, b) => a - b);
      if (timestamps.length > 0) {
        const minTime = new Date(timestamps[0] * 1000);
        const maxTime = new Date(timestamps[timestamps.length - 1] * 1000);
        console.log(`   - ìµœì†Œ: ${timestamps[0]} (${minTime.toLocaleString()})`);
        console.log(`   - ìµœëŒ€: ${timestamps[timestamps.length - 1]} (${maxTime.toLocaleString()})`);

        // Hand íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€
        if (handTimestamp < timestamps[0] || handTimestamp > timestamps[timestamps.length - 1]) {
          console.log(`   âš ï¸ Hand íƒ€ì„ìŠ¤íƒ¬í”„ ${handTimestamp}ê°€ ìºì‹œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨!`);
        }
      }

      // 6. 618-622í–‰ ê·¼ì²˜ ë°ì´í„° í™•ì¸
      console.log('\nğŸ“Š [6] 618-622í–‰ ë°ì´í„°:');
      for (let i = 618; i <= 622; i++) {
        const data = sheetDataCache.cache.get(i);
        if (data) {
          console.log(`   - í–‰ ${i}: ì‹œê°„="${data.time}", ìƒíƒœ="${data.status || '(ë¹ˆê°’)'}", íƒ€ì„ìŠ¤íƒ¬í”„=${data.timestamp}`);
        } else {
          console.log(`   - í–‰ ${i}: (ìºì‹œì— ì—†ìŒ)`);
        }
      }

      console.log('\nğŸ§ª ============ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ============');
    };

    document.getElementById('edit-btn').addEventListener('click', async () => {
      if (currentHand) {
        await processEditButton(currentHand);
      }
    });
    
    document.getElementById('complete-btn').addEventListener('click', async () => {
      if (currentHand) {
        await processCompleteButton(currentHand);
      }
    });
    
    // ====================================
    // ğŸ“Š í•¸ë“œ ìƒíƒœ ì •ë³´ ì„¹ì…˜ ê´€ë¦¬
    // ====================================

    // ì „ì—­ ìƒíƒœ ì €ì¥ì†Œ (í¸ì§‘ ì‹œì‘ ì‹œê°„, ì‘ì—… ì •ë³´ ë“±)
    window.handWorkSessions = window.handWorkSessions || new Map();


    // í•¸ë“œ ìƒíƒœ ì •ë³´ ì„¹ì…˜ ì—…ë°ì´íŠ¸ (ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ - Virtual ì‹œíŠ¸ ì •ë³´ë¡œ ëŒ€ì²´)
    function updateHandStatusSection(handNumber, status) {
      // Virtual ì‹œíŠ¸ ì •ë³´ í‘œì‹œë¡œ ëŒ€ì²´ë¨
      console.log(`ğŸ“Š í•¸ë“œ #${handNumber} ìƒíƒœ ì—…ë°ì´íŠ¸ (Virtual ì‹œíŠ¸ë¡œ ëŒ€ì²´): ${status}`);
    }

    // í¸ì§‘ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    function recordEditStartTime(handNumber) {
      const session = window.handWorkSessions.get(handNumber) || {};
      session.editStartTime = Date.now();
      window.handWorkSessions.set(handNumber, session);

      console.log(`ğŸ“ í•¸ë“œ #${handNumber} í¸ì§‘ ì‹œì‘ ì‹œê°„ ê¸°ë¡: ${new Date(session.editStartTime).toLocaleString()}`);
    }

    // ì™„ë£Œ ì‹œê°„ ê¸°ë¡
    function recordCompleteTime(handNumber) {
      const session = window.handWorkSessions.get(handNumber) || {};
      session.completeTime = Date.now();

      // ì´ ì†Œìš” ì‹œê°„ ê³„ì‚°
      if (session.editStartTime) {
        session.totalDuration = session.completeTime - session.editStartTime;
        console.log(`âœ… í•¸ë“œ #${handNumber} ì™„ë£Œ - ì´ ì†Œìš”ì‹œê°„: ${Math.round(session.totalDuration / 1000)}ì´ˆ`);
      }

      window.handWorkSessions.set(handNumber, session);

      console.log(`âœ… í•¸ë“œ #${handNumber} ì™„ë£Œ ì‹œê°„ ê¸°ë¡: ${new Date(session.completeTime).toLocaleString()}`);
    }

    // ì§„í–‰ ì‹œê°„ ì‹¤ì‹œê°„ ì¹´ìš´í„° ì‹œì‘
    function startDurationCounter(handNumber) {
      // ê¸°ì¡´ ì¹´ìš´í„° ì •ë¦¬
      stopDurationCounter(handNumber);

      const session = window.handWorkSessions.get(handNumber) || {};
      if (!session.editStartTime) return;

      const updateDuration = () => {
        const now = Date.now();
        const elapsed = now - session.editStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);

        const editDuration = document.getElementById('edit-duration');
        if (editDuration) {
          editDuration.classList.remove('hidden');
          document.querySelector('#edit-duration .time-value').textContent =
            `${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
      };

      // ì¦‰ì‹œ í•œë²ˆ ì‹¤í–‰
      updateDuration();

      // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
      session.durationInterval = setInterval(updateDuration, 1000);
      window.handWorkSessions.set(handNumber, session);
    }

    // ì§„í–‰ ì‹œê°„ ì¹´ìš´í„° ì¤‘ì§€
    function stopDurationCounter(handNumber) {
      const session = window.handWorkSessions.get(handNumber) || {};
      if (session.durationInterval) {
        clearInterval(session.durationInterval);
        delete session.durationInterval;
        window.handWorkSessions.set(handNumber, session);
      }
    }

    // ìƒì„¸ë³´ê¸° í† ê¸€ ê¸°ëŠ¥
    function toggleStatusDetails() {
      const detailedInfo = document.getElementById('detailed-status-info');
      const toggleButton = document.getElementById('status-toggle');

      if (detailedInfo.classList.contains('hidden')) {
        detailedInfo.classList.remove('hidden');
        toggleButton.textContent = 'ê°„ë‹¨ë³´ê¸° â–²';
      } else {
        detailedInfo.classList.add('hidden');
        toggleButton.textContent = 'ìƒì„¸ë³´ê¸° â–¼';
      }
    }

    // Virtual ì‹œíŠ¸ ì •ë³´ ìƒì„¸ë³´ê¸° í† ê¸€
    function toggleSheetInfoDetails() {
      const detailedInfo = document.getElementById('sheet-detailed-info');
      const toggleButton = document.getElementById('sheet-info-toggle');

      if (detailedInfo.classList.contains('hidden')) {
        detailedInfo.classList.remove('hidden');
        toggleButton.textContent = 'ê°„ë‹¨ë³´ê¸° â–²';
      } else {
        detailedInfo.classList.add('hidden');
        toggleButton.textContent = 'ìƒì„¸ë³´ê¸° â–¼';
      }
    }

    // í•¸ë“œ ì¹´ë“œë³„ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    async function updateHandCardSheetInfo(hands) {
      if (!hands || hands.length === 0) return;

      console.log(`ğŸ“Š í•¸ë“œ ì¹´ë“œë³„ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹œì‘: ${hands.length}ê°œ í•¸ë“œ`);

      for (const hand of hands) {
        const handNumber = hand.handNumber;

        // ì‚¬ì „ ë¡œë”©ëœ ë°ì´í„°ì—ì„œ ìƒíƒœ í™•ì¸
        let status = null;
        if (window.preloadedHandStatuses && window.preloadedHandStatuses.has(parseInt(handNumber))) {
          status = window.preloadedHandStatuses.get(parseInt(handNumber));
        }

        // í•¸ë“œ ì¹´ë“œ ë‚´ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
        updateHandCardVirtualInfo(handNumber, status);
      }

      console.log(`ğŸ“Š í•¸ë“œ ì¹´ë“œë³„ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    }

    // ê°œë³„ í•¸ë“œ ì¹´ë“œì˜ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateHandCardVirtualInfo(handNumber, status) {
      const statusIcon = document.getElementById(`sheet-status-${handNumber}`);
      const statusText = document.getElementById(`sheet-status-text-${handNumber}`);
      const rowNumber = document.getElementById(`sheet-row-${handNumber}`);
      const filename = document.getElementById(`sheet-filename-${handNumber}`);

      if (!statusIcon || !statusText) return;

      // ìƒíƒœì— ë”°ë¥¸ ì•„ì´ì½˜ ë° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      switch(status) {
        case null:
        case '':
          statusIcon.textContent = 'ğŸ”´';
          statusText.textContent = 'ë¯¸ì²˜ë¦¬';
          statusText.className = 'sheet-status-text text-red-400';
          break;
        case 'ë¯¸ì™„ë£Œ':
          statusIcon.textContent = 'ğŸŸ¡';
          statusText.textContent = 'í¸ì§‘ì¤‘';
          statusText.className = 'sheet-status-text text-yellow-400';
          break;
        case 'ë³µì‚¬ì™„ë£Œ':
          statusIcon.textContent = 'ğŸŸ¢';
          statusText.textContent = 'ì™„ë£Œë¨';
          statusText.className = 'sheet-status-text text-green-400';
          break;
        default:
          statusIcon.textContent = 'â“';
          statusText.textContent = 'ì•Œìˆ˜ì—†ìŒ';
          statusText.className = 'sheet-status-text text-gray-400';
      }

      // íŒŒì¼ëª… ì •ë³´ (ì‚¬ì „ ë¡œë”© ë°ì´í„°ì—ì„œ ì¶”ì¶œ ì‹œë„)
      updateHandCardFilename(handNumber);
    }

    // í•¸ë“œ ì¹´ë“œì˜ íŒŒì¼ëª… ì •ë³´ ì—…ë°ì´íŠ¸
    async function updateHandCardFilename(handNumber) {
      const filename = document.getElementById(`sheet-filename-${handNumber}`);
      const rowNumber = document.getElementById(`sheet-row-${handNumber}`);

      if (!filename) return;

      try {
        // ê°„ë‹¨í•œ íŒŒì¼ëª… ì¡°íšŒ (ì„±ëŠ¥ì„ ìœ„í•´ ìºì‹œëœ ì •ë³´ë§Œ ì‚¬ìš©)
        const indexHand = allHands.find(h => h.handNumber === handNumber);
        if (indexHand && indexHand.camFiles && indexHand.camFiles.length > 0) {
          // ì¹´ë©”ë¼ íŒŒì¼ëª…ì„ Virtual íŒŒì¼ëª…ìœ¼ë¡œ ì¶”ì •
          const estimatedFilename = `${handNumber}_edited`;
          filename.textContent = estimatedFilename;
          filename.title = `ì¶”ì • íŒŒì¼ëª…: ${estimatedFilename}`;
        } else {
          filename.textContent = 'íŒŒì¼ëª… ì—†ìŒ';
          filename.title = '';
        }

        // í–‰ ë²ˆí˜¸ëŠ” ìƒì„¸ ì¡°íšŒ ì—†ì´ëŠ” ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ '-'ë¡œ í‘œì‹œ
        if (rowNumber) {
          rowNumber.textContent = '-';
        }

      } catch (error) {
        console.error(`âŒ í•¸ë“œ #${handNumber} íŒŒì¼ëª… ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:`, error);
        filename.textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
      }
    }

    // Virtual ì‹œíŠ¸ ë“±ë¡ ì •ë³´ ë¡œë“œ
    async function loadVirtualSheetInfo(handNumber) {
      const sheetInfoSection = document.getElementById('virtual-sheet-info');
      const sheetStatusIcon = document.getElementById('sheet-status-icon');
      const sheetRowNumber = document.getElementById('sheet-row-number');
      const sheetStatus = document.getElementById('sheet-status');
      const sheetFilename = document.getElementById('sheet-filename');

      if (!sheetInfoSection) return;

      try {
        console.log(`ğŸ“‹ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ ì •ë³´ ë¡œë“œ ì‹œì‘`);

        // ì„¹ì…˜ í‘œì‹œ
        sheetInfoSection.classList.remove('hidden');

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        sheetStatusIcon.textContent = 'ğŸ”„';
        sheetRowNumber.textContent = 'ë¡œë”© ì¤‘...';
        sheetStatus.textContent = 'í™•ì¸ ì¤‘...';
        sheetFilename.textContent = 'ì¡°íšŒ ì¤‘...';

        // ì‚¬ì „ ë¡œë”©ëœ ë°ì´í„°ì—ì„œ ë¨¼ì € í™•ì¸
        let virtualSheetData = null;
        if (window.preloadedHandStatuses && window.preloadedHandStatuses.has(parseInt(handNumber))) {
          const status = window.preloadedHandStatuses.get(parseInt(handNumber));
          console.log(`ğŸ“‹ ì‚¬ì „ ë¡œë”© ë°ì´í„°ì—ì„œ í•¸ë“œ #${handNumber} ìƒíƒœ: ${status}`);

          // ì‚¬ì „ ë¡œë”© ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ ì •ë³´ ë¨¼ì € í‘œì‹œ
          updateBasicSheetInfo(handNumber, status, null);
        }

        // Virtual ì‹œíŠ¸ì—ì„œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
        const detailedInfo = await getVirtualSheetDetailedInfo(handNumber);
        if (detailedInfo) {
          updateDetailedSheetInfo(handNumber, detailedInfo);
        } else {
          // ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
          console.log(`ğŸ“‹ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ì—ì„œ ìƒì„¸ ì •ë³´ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          updateBasicSheetInfo(handNumber, null, "Virtual ì‹œíŠ¸ì— ë“±ë¡ë˜ì§€ ì•ŠìŒ");
        }

      } catch (error) {
        console.error(`âŒ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:`, error);
        sheetStatusIcon.textContent = 'âŒ';
        sheetRowNumber.textContent = 'ì˜¤ë¥˜';
        sheetStatus.textContent = 'ë¡œë“œ ì‹¤íŒ¨';
        sheetFilename.textContent = error.message;
      }
    }

    // ê¸°ë³¸ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateBasicSheetInfo(handNumber, status, errorMessage = null) {
      const sheetStatusIcon = document.getElementById('sheet-status-icon');
      const sheetRowNumber = document.getElementById('sheet-row-number');
      const sheetStatus = document.getElementById('sheet-status');
      const sheetFilename = document.getElementById('sheet-filename');

      if (errorMessage) {
        sheetStatusIcon.textContent = 'âŒ';
        sheetRowNumber.textContent = '-';
        sheetStatus.textContent = errorMessage;
        sheetStatus.className = 'font-semibold text-red-400';
        sheetFilename.textContent = '-';
        return;
      }

      // ìƒíƒœì— ë”°ë¥¸ ì•„ì´ì½˜ ë° ìƒ‰ìƒ ì„¤ì •
      switch(status) {
        case null:
        case '':
          sheetStatusIcon.textContent = 'ğŸ”´';
          sheetStatus.textContent = 'ë¯¸ì²˜ë¦¬';
          sheetStatus.className = 'font-semibold text-red-400';
          break;
        case 'ë¯¸ì™„ë£Œ':
          sheetStatusIcon.textContent = 'ğŸŸ¡';
          sheetStatus.textContent = 'í¸ì§‘ ì¤‘';
          sheetStatus.className = 'font-semibold text-yellow-400';
          break;
        case 'ë³µì‚¬ì™„ë£Œ':
          sheetStatusIcon.textContent = 'ğŸŸ¢';
          sheetStatus.textContent = 'ì™„ë£Œë¨';
          sheetStatus.className = 'font-semibold text-green-400';
          break;
        default:
          sheetStatusIcon.textContent = 'â“';
          sheetStatus.textContent = status || 'ì•Œ ìˆ˜ ì—†ìŒ';
          sheetStatus.className = 'font-semibold text-gray-400';
      }
    }

    // ìƒì„¸ Virtual ì‹œíŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateDetailedSheetInfo(handNumber, detailedInfo) {
      console.log(`ğŸ“‹ updateDetailedSheetInfo - Fì—´ íŒŒì¼ëª…: "${detailedInfo.filename}"`);
      // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('sheet-row-number').textContent = detailedInfo.rowNumber || '-';
      document.getElementById('sheet-filename').textContent = detailedInfo.filename || 'Virtual íŒŒì¼ëª… ì—†ìŒ';

      // ì¹´ë©”ë¼ íŒŒì¼ ì •ë³´ í‘œì‹œ (ì¸ë±ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
      const indexHand = allHands.find(h => h.handNumber === handNumber);
      const cameraFilenames = document.getElementById('camera-filenames');
      if (indexHand && indexHand.camFiles && indexHand.camFiles.length > 0) {
        cameraFilenames.textContent = indexHand.camFiles.join(', ');
        cameraFilenames.title = indexHand.camFiles.join('\n');
      } else {
        cameraFilenames.textContent = 'ì¹´ë©”ë¼ íŒŒì¼ ì—†ìŒ';
        cameraFilenames.title = '';
      }

      // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('sheet-hand-number').textContent = handNumber;
      document.getElementById('sheet-registered-time').textContent = detailedInfo.registeredTime || '-';
      document.getElementById('sheet-modified-time').textContent = detailedInfo.modifiedTime || '-';
      document.getElementById('sheet-match-method').textContent = detailedInfo.matchMethod || '-';
      document.getElementById('sheet-time-diff').textContent = detailedInfo.timeDiff || '-';
      document.getElementById('sheet-csv-row').textContent = detailedInfo.csvRow || '-';

      // AI ë¶„ì„ ì •ë³´ (ìˆëŠ” ê²½ìš°)
      const aiInfo = document.getElementById('sheet-ai-info');
      const aiContent = document.getElementById('sheet-ai-content');
      if (detailedInfo.aiAnalysis) {
        aiInfo.classList.remove('hidden');
        aiContent.textContent = detailedInfo.aiAnalysis;
      } else {
        aiInfo.classList.add('hidden');
      }

      // ì›ë³¸ ë°ì´í„°
      const rawData = document.getElementById('sheet-raw-data');
      if (detailedInfo.rawData) {
        rawData.textContent = JSON.stringify(detailedInfo.rawData, null, 2);
      } else {
        rawData.textContent = 'ì›ë³¸ ë°ì´í„° ì—†ìŒ';
      }

      console.log(`ğŸ“‹ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    }

    // Virtual ì‹œíŠ¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ
    async function getVirtualSheetDetailedInfo(handNumber) {
      try {
        // ê¸°ì¡´ ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ í™œìš©
        const sheetUrl = getSheetUrl();
        if (!sheetUrl) {
          throw new Error('Virtual ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
        }

        // í•¸ë“œ ì‹œê°„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const handTime = await getHandTimestamp(handNumber);
        if (!handTime) {
          throw new Error('í•¸ë“œ ì‹œê°„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ');
        }

        // Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ ì •ë³´ ì¡°íšŒ
        const matchResult = await findMatchingRowInVirtualSheet(sheetUrl, handTime);
        if (!matchResult || !matchResult.matchedRow) {
          return null;
        }

        const matchedRow = matchResult.matchedRow;
        const timeDiff = matchResult.timeDifference;

        // ìƒì„¸ ì •ë³´ êµ¬ì„±
        console.log(`ğŸ“‹ Virtual ì‹œíŠ¸ Fì—´ íŒŒì¼ëª… í™•ì¸: "${matchedRow.filename}" (í–‰ ${matchedRow.row})`);
        const detailedInfo = {
          rowNumber: matchedRow.row,
          filename: matchedRow.filename || '', // Fì—´ íŒŒì¼ëª… (ì´ë¯¸ íŒŒì‹±ë¨)
          status: matchedRow.status || '', // Eì—´ ìƒíƒœ (ì´ë¯¸ íŒŒì‹±ë¨)
          registeredTime: matchedRow.timestamp ? new Date(matchedRow.timestamp * 1000).toLocaleString('ko-KR') : '-',
          modifiedTime: '-', // ìˆ˜ì • ì‹œê°„ì€ í˜„ì¬ CSVì— ì—†ìŒ
          matchMethod: matchResult.matchMethod || 'ì‹œê°„ ë§¤ì¹­',
          timeDiff: timeDiff ? `${Math.abs(timeDiff)}ì´ˆ` : '-',
          csvRow: matchedRow.row,
          aiAnalysis: null, // Hì—´ì€ ë‚˜ì¤‘ì— ì¶”ê°€
          rawData: matchedRow
        };

        console.log(`ğŸ“‹ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì™„ë£Œ:`, detailedInfo);
        return detailedInfo;

      } catch (error) {
        console.error(`âŒ í•¸ë“œ #${handNumber} Virtual ì‹œíŠ¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:`, error);
        return null;
      }
    }

    // ì‘ì—… ì„¸ì…˜ ID ìƒì„±
    function generateWorkSessionId(handNumber) {
      const now = new Date();
      const timeStr = now.getHours().toString().padStart(2, '0') +
                     now.getMinutes().toString().padStart(2, '0');
      return `H${handNumber}_${timeStr}`;
    }

    // ====================================
    // ì´ˆê¸°í™”
    // ====================================
    
    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • í•¨ìˆ˜
    function initializeButtonStates() {
      const editBtn = document.getElementById('edit-btn');
      const completeBtn = document.getElementById('complete-btn');

      if (editBtn && completeBtn) {
        // ì´ˆê¸° ìƒíƒœ: ëª¨ë‘ ë¹„í™œì„±í™” (í•¸ë“œ ì„ íƒ ì „)
        editBtn.disabled = true;
        completeBtn.disabled = true;
        editBtn.textContent = 'í¸ì§‘';
        completeBtn.textContent = 'ì™„ë£Œ';

        console.log('âš™ï¸ ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • ì™„ë£Œ - ëª¨ë‘ ë¹„í™œì„±í™”');
      }
    }

    // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ
    function loadMasterHandList() {
      try {
        const stored = localStorage.getItem(MASTER_LIST_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          masterHandList.clear();
          for (const [handNumber, hand] of Object.entries(data)) {
            masterHandList.set(handNumber, hand);
          }
          console.log(`ğŸ“ ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ: ${masterHandList.size}ê°œ`);
        }
      } catch (e) {
        console.error('ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }
    
    // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥
    function saveMasterHandList() {
      try {
        const data = {};
        for (const [handNumber, hand] of masterHandList.entries()) {
          data[handNumber] = hand;
        }
        localStorage.setItem(MASTER_LIST_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }
    
    // Virtual ì‹œíŠ¸ URL ì €ì¥ ê¸°ëŠ¥ì€ ì„¤ì • ëª¨ë‹¬ì—ì„œ ì²˜ë¦¬ë¨
    
    // Gemini API í‚¤ ë¡œë“œ (localStorage > GitHub Secrets > ë¹ˆê°’)
    function loadAPIKeys() {
      // localStorageì—ì„œ ë¨¼ì € í™•ì¸
      let apiKey = localStorage.getItem('GEMINI_API_KEY');
      let apiKeySource = '';

      if (apiKey) {
        apiKeySource = 'localStorage';
        console.log('ğŸ“¦ Gemini API í‚¤: localStorageì—ì„œ ë¡œë“œ');
      } else if (window.ENV_CONFIG?.GEMINI_API_KEY) {
        // GitHub Secretsì—ì„œ ë¡œë“œ ë° localStorageì— ì €ì¥
        apiKey = window.ENV_CONFIG.GEMINI_API_KEY;
        apiKeySource = 'GitHub Secrets';
        localStorage.setItem('GEMINI_API_KEY', apiKey);
        console.log('ğŸ” Gemini API í‚¤: GitHub Secretsì—ì„œ ë¡œë“œ ë° ì €ì¥');
      } else {
        apiKeySource = 'ë¯¸ì„¤ì •';
        console.log('âš ï¸ Gemini API í‚¤: ë¯¸ì„¤ì • ìƒíƒœ');
      }

      if (apiKey) {
        CONFIG.GEMINI_API_KEY = apiKey;
        console.log(`âœ… Gemini API í‚¤ ì„¤ì • ì™„ë£Œ [ì¶œì²˜: ${apiKeySource}] (ê¸¸ì´: ${apiKey.length})`);
      } else {
        CONFIG.GEMINI_API_KEY = '';
        console.log('ğŸ”“ API í‚¤ ë¡œë“œ: ì—†ìŒ');
      }
    }

    // Gemini API í‚¤ ì €ì¥
    function saveAPIKeys() {
      localStorage.setItem('GEMINI_API_KEY', CONFIG.GEMINI_API_KEY);
    }

    // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
    function debugLog(...args) {
      if (CONFIG.DEBUG_MODE) {
        console.log(...args);
      }
    }

    async function init() {
      // ë²„ì „ ì²´í¬ ë¨¼ì € ì‹¤í–‰
      if (checkVersion()) {
        return; // ë¦¬ë¡œë“œ ì¤‘ì´ë©´ ì¤‘ë‹¨
      }
      
      console.log('='.repeat(60));
      console.log(`ğŸš€ í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ v${APP_VERSION} - Gemini AI ë¶„ì„ ì‹œìŠ¤í…œ`);
      
      // ë²„ì „ í‘œì‹œ ì—…ë°ì´íŠ¸
      const versionDisplay = document.getElementById('version-display');
      if (versionDisplay) {
        versionDisplay.textContent = `v${APP_VERSION}`;
      }
      
      // í˜ì´ì§€ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        pageTitle.textContent = `í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ v${APP_VERSION} - AI ë¶„ì„ ì‹œìŠ¤í…œ`;
      }
      
      // ì´ˆê¸°í™” ì‹œ AI í‚¤ ë¡œë“œ
      loadAPIKeys();

      // ğŸ’¾ ëª¨ë“  ì„¤ì • ë¡œë“œ
      await loadAllSettings();
      console.log('='.repeat(60));

      // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • (í•¸ë“œ ì„ íƒ ì „ì—ëŠ” ë¹„í™œì„±í™”)
      initializeButtonStates();

      // Phase 3: IndexedDB ì´ˆê¸°í™”
      await localStore.init();

      // Phase 3: ê¸°ì¡´ ìºì‹œ ë³µêµ¬
      const savedCache = await localStore.loadSheetCache();
      if (savedCache.size > 0) {
        sheetDataCache.cache = savedCache;
        sheetDataCache.lastUpdate = Date.now();
        console.log(`ğŸ“‚ [Phase 3] ë¡œì»¬ ìºì‹œ ë³µêµ¬: ${savedCache.size}í–‰`);
      }

      // ì™„ì „í•œ ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ: Virtual ì‹œíŠ¸ ì „ì²´ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë”©
      console.log('ğŸš€ ì™„ì „í•œ ì‚¬ì „ ë¡œë”© ì‹œìŠ¤í…œ ì‹œì‘...');
      const preloadSuccess = await preloadAllHandStatuses();

      if (preloadSuccess) {
        // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ì‹œì‘
        startBackgroundRefresh();
        console.log('âœ… ì‚¬ì „ ë¡œë”© ì™„ë£Œ - í•¸ë“œ í´ë¦­ ì‹œ ì¦‰ì‹œ ì‘ë‹µ ê°€ëŠ¥');
      } else {
        console.warn('âš ï¸ ì‚¬ì „ ë¡œë”© ì‹¤íŒ¨ - ê¸°ì¡´ ìºì‹œ ì‹œìŠ¤í…œìœ¼ë¡œ í´ë°±');
        await loadAllHandsStatusAtOnce();
      }

      // Phase 1: ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¡œ ë³´ì´ëŠ” í•¸ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
      let scrollDebounceTimer;
      const handListContainer = document.getElementById('hand-list-container');
      if (handListContainer) {
        handListContainer.addEventListener('scroll', () => {
          clearTimeout(scrollDebounceTimer);
          scrollDebounceTimer = setTimeout(() => {
            console.log('ğŸ“œ ìŠ¤í¬ë¡¤ ê°ì§€ - ë³´ì´ëŠ” í•¸ë“œ ìƒíƒœ í™•ì¸');
            updateVisibleHandsStatus();
          }, 500); // ìŠ¤í¬ë¡¤ í›„ 500ms ëŒ€ê¸°
        });
      }

      // Phase 3: ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (v12.0.0ì—ì„œ ë¹„í™œì„±í™”)
      // smartRefreshê°€ nullì´ë¯€ë¡œ start() í˜¸ì¶œ ì œê±°
      // if (smartRefresh) {
      //   smartRefresh.start();
      // }

      // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ
      loadMasterHandList();
      console.log(`ğŸ“ ê¸°ì¡´ ë§ˆìŠ¤í„° í•¸ë“œ: ${masterHandList.size}ê°œ`);
      
      // Virtual ì‹œíŠ¸ URLì€ CONFIGì—ì„œ ê´€ë¦¬ë¨
      // console.log(`ğŸ“Š Virtual ì‹œíŠ¸ ì„¤ì •: ${CONFIG.READ_SHEET_URL ? CONFIG.READ_SHEET_URL.substring(0, 50) + '...' : 'ë¯¸ì„¤ì •'}`); // âš ï¸ ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
      
      
      // ì´ˆê¸° ë¡œë“œ ë™ê¸°í™” íŒì—… í‘œì‹œ
      initSyncManager.show();

      // ğŸš€ í•¸ë“œ-íŒŒì¼ëª… ë§¤í•‘ ë°ì´í„° ë¡œë“œ
      initSyncManager.addLog('ğŸ’¾ ì €ì¥ëœ ë§¤í•‘ ë°ì´í„° ë¡œë“œ ì¤‘...');
      loadHandFilenameMappings();

      // Apps Script ì„¤ì • ë¡œë“œ (í†µí•© ì‹œíŠ¸ ê´€ë¦¬)
      initSyncManager.updateStep('settings', 'running', 'ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      initSyncManager.addLog('ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì„¤ì • ì½ê¸°...');

      const savedMainSheetUrl = localStorage.getItem('main_sheet_url');
      const savedReadSheetUrl = localStorage.getItem('read_sheet_url'); // í˜¸í™˜ì„±
      const savedWriteSheetUrl = localStorage.getItem('write_sheet_url'); // í˜¸í™˜ì„±
      const savedScriptUrl = localStorage.getItem('sheet_update_script_url');
      
      // ë©”ì¸ ì‹œíŠ¸ URL ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ì¡´ URL ì‚¬ìš© (í˜¸í™˜ì„±)
      const sheetUrl = savedMainSheetUrl || savedWriteSheetUrl || savedReadSheetUrl || CONFIG.MAIN_SHEET_URL;
      
      if (sheetUrl) {
        CONFIG.MAIN_SHEET_URL = sheetUrl;
        CONFIG.READ_SHEET_URL = sheetUrl; // í˜¸í™˜ì„±
        CONFIG.WRITE_SHEET_URL = sheetUrl; // í˜¸í™˜ì„±
        
        // UIì— í‘œì‹œ
        document.getElementById('main-sheet-url').value = sheetUrl;
        // ìˆ¨ê²¨ì§„ í•„ë“œë„ ì—…ë°ì´íŠ¸ (í˜¸í™˜ì„±)
        document.getElementById('read-sheet-url').value = sheetUrl;
        document.getElementById('write-sheet-url').value = sheetUrl;
        
        console.log(`ğŸ“‹ ë©”ì¸ ì‹œíŠ¸ URL ë¡œë“œë¨: ${sheetUrl.substring(0, 50)}...`);
      }
      if (savedScriptUrl) {
        // ì´ì „ URLì´ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ìƒˆ URLë¡œ ìë™ êµì²´
        const oldUrl = 'AKfycbyiop6JQBJyRk2pNsPvrCo8Q2HJ2CB-tqwBeb17SYqrmz1C_xZWVi0wzXio2v3mzC76mQ';
        const newUrl = 'https://script.google.com/macros/s/AKfycbxz6Vg7Hzb87PBDD2DcKwsRoN_MvzVa2BQpthLn6TTsdku-BSZcDdubXlD0h1KP9wEIEA/exec';
        
        if (savedScriptUrl.includes(oldUrl)) {
          console.log('âš ï¸ ì´ì „ URL ê°ì§€! ìƒˆ URLë¡œ ìë™ êµì²´');
          CONFIG.SHEET_UPDATE_SCRIPT_URL = newUrl;
          document.getElementById('apps-script-url').value = newUrl;
          localStorage.setItem('sheet_update_script_url', newUrl);
          console.log(`âœ… Apps Script URL ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
        } else {
          CONFIG.SHEET_UPDATE_SCRIPT_URL = savedScriptUrl;
          document.getElementById('apps-script-url').value = savedScriptUrl;
          console.log(`ğŸ”— Apps Script URL ë¡œë“œë¨`);
        }
      } else if (CONFIG.SHEET_UPDATE_SCRIPT_URL) {
        // í•˜ë“œì½”ë”©ëœ URLë„ ì²´í¬
        const oldUrl = 'AKfycbyiop6JQBJyRk2pNsPvrCo8Q2HJ2CB-tqwBeb17SYqrmz1C_xZWVi0wzXio2v3mzC76mQ';
        if (CONFIG.SHEET_UPDATE_SCRIPT_URL.includes(oldUrl)) {
          console.log('âš ï¸ CONFIGì— ì´ì „ URL ë°œê²¬! ìƒˆ URLë¡œ êµì²´');
          const newUrl = 'https://script.google.com/macros/s/AKfycbxz6Vg7Hzb87PBDD2DcKwsRoN_MvzVa2BQpthLn6TTsdku-BSZcDdubXlD0h1KP9wEIEA/exec';
          CONFIG.SHEET_UPDATE_SCRIPT_URL = newUrl;
          document.getElementById('apps-script-url').value = newUrl;
          localStorage.setItem('sheet_update_script_url', newUrl);
        } else {
          // CONFIGì—ì„œ ê°€ì ¸ì˜¨ ê°’ì„ ì…ë ¥ í•„ë“œì— ì„¤ì •
          document.getElementById('apps-script-url').value = CONFIG.SHEET_UPDATE_SCRIPT_URL;
          console.log(`ğŸ”— Apps Script URL CONFIGì—ì„œ ë¡œë“œ: ${CONFIG.SHEET_UPDATE_SCRIPT_URL}`);
        }
      } else {
        // Apps Script URLì´ ì „í˜€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°
        console.warn('âš ï¸ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì • ë©”ë‰´ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      
      // ìµœê·¼ í•¸ë“œ ë²„í¼ ìƒíƒœ í™•ì¸
      const bufferStatus = recentHandsBuffer.getStatus();
      console.log(`ğŸ’¾ ìµœê·¼ í•¸ë“œ ë²„í¼: ${bufferStatus.size}/${bufferStatus.maxSize}ê°œ (ìµœëŒ€ 100ê°œ ì €ì¥)`);
      if (bufferStatus.size > 0) {
        console.log(`ğŸ’¾ ë²„í¼ ë‚´ìš©:`, bufferStatus.buffer);
      }

      // ì„¤ì • ë¡œë“œ ì™„ë£Œ
      initSyncManager.updateStep('settings', 'complete', 'ì„¤ì • ë¡œë“œ ì™„ë£Œ');
      initSyncManager.addLog('âœ… ì„¤ì • ë¡œë“œ ì™„ë£Œ', 'success');

      // Google Sheets ì—°ê²°
      initSyncManager.updateStep('sheets', 'running', 'Google Sheets ì—°ê²° ì¤‘...');
      initSyncManager.addLog('Google Sheets API ì´ˆê¸°í™”...');

      console.log('ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }

      // Google Sheets ì—°ê²° ì™„ë£Œ
      initSyncManager.updateStep('sheets', 'complete', 'Google Sheets ì—°ê²° ì™„ë£Œ');
      initSyncManager.addLog('âœ… Google Sheets ì—°ê²° ì„±ê³µ', 'success');

      console.log('ğŸ“„ ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹œì‘...');
      // ì´ˆê¸° ë¡œë”© í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •í•˜ì—¬ ì•Œë¦¼ ë°©ì§€
      isInitialLoad = true;
      await loadIndexData();

      // ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ
      initSyncManager.updateStep('data', 'complete', 'ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
      initSyncManager.addLog(`âœ… ${allHands.length}ê°œ í•¸ë“œ ë¡œë“œ ì™„ë£Œ`, 'success');

      // ìºì‹œ êµ¬ì¶•
      initSyncManager.updateStep('cache', 'running', 'ìºì‹œ êµ¬ì¶• ì¤‘...');
      initSyncManager.addLog('ë©”ëª¨ë¦¬ ìºì‹œ ë° ì¸ë±ìŠ¤ ìƒì„±...');

      // SheetDataCache ê°±ì‹  (ìºì‹œ êµ¬ì¶•)
      if (typeof sheetDataCache !== 'undefined') {
        await sheetDataCache.refreshCache();

        // ìŠ¤ë§ˆíŠ¸ ê°±ì‹  ì‹œì‘
        sheetDataCache.startSmartUpdate();

        initSyncManager.updateStep('cache', 'complete', 'ìºì‹œ êµ¬ì¶• ì™„ë£Œ');
        initSyncManager.addLog('âœ… ìºì‹œ ë° ì¸ë±ìŠ¤ êµ¬ì¶• ì™„ë£Œ', 'success');
        initSyncManager.addLog('ğŸ”„ ìŠ¤ë§ˆíŠ¸ ìºì‹œ ê°±ì‹  ì‹œì‘ (30ì´ˆ ê°„ê²©)', 'info');
      } else {
        initSyncManager.updateStep('cache', 'complete', 'ìºì‹œ ì¤€ë¹„ ì™„ë£Œ');
      }

      // ì™„ë£Œ
      initSyncManager.updateStep('complete', 'complete', 'ì´ˆê¸°í™” ì™„ë£Œ!');
      initSyncManager.addLog('ğŸ‰ ëª¨ë“  ì´ˆê¸°í™” ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

      if (allHands.length > 0) {
        selectHand(allHands[0].handNumber);
        initSyncManager.addLog(`ì²« ë²ˆì§¸ í•¸ë“œ #${allHands[0].handNumber} ì„ íƒ`);
      }

      // íŒì—… ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        initSyncManager.hide();
      }, 1000);
      
      // âš ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì™„ì „ ë¹„í™œì„±í™” (v12.0.0)
      // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°ì´í„° ì—…ë°ì´íŠ¸
      console.log('â„¹ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™” - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ ì‚¬ìš©');
      console.log('ğŸ’¡ íŒ: ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”');

      // ëª¨ë“  ìë™ íƒ€ì´ë¨¸ ì •ë¦¬
      if (refreshTimerInitial) {
        clearTimeout(refreshTimerInitial);
        refreshTimerInitial = null;
      }
      if (refreshTimerInterval) {
        clearInterval(refreshTimerInterval);
        refreshTimerInterval = null;
      }
      
      console.log('ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ì•± ì‹œì‘
    init();
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
    // ë””ë²„ê·¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('debug-sheet-btn').addEventListener('click', async () => {
      console.log('ğŸ” === ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ë””ë²„ê·¸ ì‹œì‘ ===');
      
      const debugInfo = {
        sheetUrl: getSheetUrl(), // í†µí•©ëœ ì‹œíŠ¸ URL ì‚¬ìš©
        appsScriptUrl: CONFIG.SHEET_UPDATE_SCRIPT_URL,
        timestamp: new Date().toISOString()
      };
      
      // 1. Google Sheets URL ê²€ì¦
      console.log('\n1ï¸âƒ£ Google Sheets URL ê²€ì¦');
      console.log('   URL:', debugInfo.sheetUrl);
      
      if (!debugInfo.sheetUrl) {
        alert('âŒ ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      // URL í˜•ì‹ ê²€ì¦
      const urlMatch = debugInfo.sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!urlMatch) {
        alert('âŒ ì˜ëª»ëœ Google Sheets URL í˜•ì‹\n\nì˜¬ë°”ë¥¸ í˜•ì‹:\nhttps://docs.google.com/spreadsheets/d/[ID]/edit');
        return;
      }
      
      const spreadsheetId = urlMatch[1];
      const gidMatch = debugInfo.sheetUrl.match(/[#&]gid=([0-9]+)/);
      const gid = gidMatch ? gidMatch[1] : null;
      
      console.log('   ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID:', spreadsheetId);
      console.log('   ì‹œíŠ¸ GID:', gid || '(ê¸°ë³¸ ì‹œíŠ¸)');
      
      // 2. Apps Script URL ê²€ì¦
      console.log('\n2ï¸âƒ£ Apps Script URL ê²€ì¦');
      console.log('   URL:', debugInfo.appsScriptUrl);
      
      if (!debugInfo.appsScriptUrl) {
        alert('âŒ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!debugInfo.appsScriptUrl.includes('script.google.com') || !debugInfo.appsScriptUrl.includes('/exec')) {
        alert('âŒ ì˜ëª»ëœ Apps Script URL\n\nì˜¬ë°”ë¥¸ í˜•ì‹:\nhttps://script.google.com/macros/s/[SCRIPT_ID]/exec');
        return;
      }
      
      // 3. Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
      console.log('\n3ï¸âƒ£ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸');
      
      try {
        const testData = {
          action: 'test',
          timestamp: new Date().toISOString()
        };
        
        const response = await fetch(debugInfo.appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(testData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('   ì—°ê²° ê²°ê³¼:', result);
        
        if (result.status !== 'success') {
          throw new Error(result.message || 'ì—°ê²° ì‹¤íŒ¨');
        }
        
        console.log('   âœ… Apps Script ì—°ê²° ì„±ê³µ');
        
      } catch (error) {
        console.error('   âŒ Apps Script ì—°ê²° ì‹¤íŒ¨:', error);
        alert(`âŒ Apps Script ì—°ê²° ì‹¤íŒ¨\n\n${error.message}\n\ní•´ê²°ì±…:\n1. Apps Scriptê°€ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸\n2. "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ ì„¤ì • í™•ì¸`);
        return;
      }
      
      // 4. Apps Script ê¶Œí•œ ì§„ë‹¨
      console.log('\n4ï¸âƒ£ Apps Script ê¶Œí•œ ì§„ë‹¨');
      
      try {
        const permissionData = {
          action: 'testPermissions',
          sheetUrl: debugInfo.sheetUrl,
          timestamp: new Date().toISOString()
        };
        
        const permResponse = await fetch(debugInfo.appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(permissionData)
        });
        
        const permResult = await permResponse.json();
        console.log('   ê¶Œí•œ ì§„ë‹¨ ê²°ê³¼:', permResult);
        
        if (permResult.status !== 'success') {
          console.warn('   âš ï¸ ê¶Œí•œ ë¬¸ì œ ê°ì§€:', permResult.message);
        } else {
          console.log('   âœ… ê¶Œí•œ í™•ì¸ ì™„ë£Œ');
        }
        
      } catch (permError) {
        console.warn('   âš ï¸ ê¶Œí•œ í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€:', permError.message);
      }
      
      // 5. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      console.log('\n5ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸');
      
      const testRow = prompt('í…ŒìŠ¤íŠ¸í•  í–‰ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2)', '2');
      if (!testRow) return;
      
      const testUpdateData = {
        action: 'updateSheet',
        sheetUrl: debugInfo.sheetUrl,
        rowNumber: parseInt(testRow),
        filename: 'debug_test_' + Date.now() + '.mp4',  // Fì—´
        aiAnalysis: 'ğŸ”§ ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ - ' + new Date().toLocaleString('ko-KR')  // Hì—´
      };
      
      console.log('   í…ŒìŠ¤íŠ¸ ë°ì´í„°:', testUpdateData);
      
      try {
        const response = await fetch(debugInfo.appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(testUpdateData)
        });
        
        const result = await response.json();
        console.log('   ì—…ë°ì´íŠ¸ ê²°ê³¼:', result);
        
        if (result.status === 'success') {
          console.log('   âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!');
          
          const details = result.data || {};
          
          // 6. ì‹¤ì œ ì—…ë°ì´íŠ¸ ê²€ì¦ (ì˜µì…˜)
          console.log('\n6ï¸âƒ£ ì‹¤ì œ ì—…ë°ì´íŠ¸ ê²€ì¦ (ì„ íƒì‚¬í•­)');
          
          // verifyUpdate ì•¡ì…˜ ì§€ì› ì—¬ë¶€ í™•ì¸
          try {
            const checkData = {
              action: 'test',
              timestamp: new Date().toISOString()
            };
            
            const checkResponse = await fetch(debugInfo.appsScriptUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'text/plain',
              },
              body: JSON.stringify(checkData)
            });
            
            const checkResult = await checkResponse.json();
            
            // verifyUpdate ì§€ì› í™•ì¸
            if (checkResult.availableActions && !checkResult.availableActions.includes('verifyUpdate')) {
              console.log('   âš ï¸ í˜„ì¬ Apps Script ë²„ì „ì€ verifyUpdateë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log('   ğŸ“‹ ì§€ì›ë˜ëŠ” ì•¡ì…˜:', checkResult.availableActions);
              alert(`âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nğŸ“ í–‰ ë²ˆí˜¸: ${testRow}\nğŸ“ Fì—´(íŒŒì¼ëª…): ${testUpdateData.filename}\nğŸ¤– Hì—´(AIë¶„ì„): ${testUpdateData.aiAnalysis}\nğŸ•’ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}\n\nì—…ë°ì´íŠ¸ëœ ì—´: ${details.updatedFields ? details.updatedFields.join(', ') : 'F, H'}\n\nâš ï¸ ê²€ì¦ ê¸°ëŠ¥ì€ Apps Script v3.3 ì´ìƒì—ì„œ ì§€ì›ë©ë‹ˆë‹¤.\nGoogle Sheetsì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.`);
            } else {
              // verifyUpdate ì‹¤í–‰
              await new Promise(resolve => setTimeout(resolve, 2000)); // 2ì´ˆ ëŒ€ê¸°
              
              const verifyData = {
                action: 'verifyUpdate',
                sheetUrl: debugInfo.sheetUrl,
                rowNumber: parseInt(testRow),
                expectedFilename: testUpdateData.filename,
                expectedAnalysis: testUpdateData.aiAnalysis
              };
              
              const verifyResponse = await fetch(debugInfo.appsScriptUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'text/plain',
                },
                body: JSON.stringify(verifyData)
              });
              
              const verifyResult = await verifyResponse.json();
              console.log('   ê²€ì¦ ê²°ê³¼:', verifyResult);
              
              if (verifyResult.status === 'success' && verifyResult.verified) {
                alert(`âœ… ì™„ë²½! ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ë° ê²€ì¦ ì„±ê³µ!\n\nğŸ“ í–‰ ë²ˆí˜¸: ${testRow}\nğŸ“ Fì—´(íŒŒì¼ëª…): ${testUpdateData.filename}\nğŸ¤– Hì—´(AIë¶„ì„): ${testUpdateData.aiAnalysis}\nğŸ•’ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}\n\nâœ… ì‹¤ì œ ì‹œíŠ¸ì—ì„œ ë°ì´í„° í™•ì¸ë¨\nì—…ë°ì´íŠ¸ëœ ì—´: ${details.updatedFields ? details.updatedFields.join(', ') : 'F, H'}\n\nGoogle Sheetsì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.`);
              } else if (verifyResult.status === 'error' && verifyResult.message.includes('ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜')) {
                console.warn('   âš ï¸ verifyUpdate ì•¡ì…˜ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                alert(`âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nğŸ“ í–‰ ë²ˆí˜¸: ${testRow}\nğŸ“ Fì—´(íŒŒì¼ëª…): ${testUpdateData.filename}\nğŸ¤– Hì—´(AIë¶„ì„): ${testUpdateData.aiAnalysis}\n\nâš ï¸ ê²€ì¦ ê¸°ëŠ¥ ë¯¸ì§€ì› (Apps Script ì—…ë°ì´íŠ¸ í•„ìš”)\nGoogle Sheetsì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.`);
              } else {
                alert(`âš ï¸ ì—…ë°ì´íŠ¸ ì„±ê³µ ë³´ê³ ë˜ì—ˆìœ¼ë‚˜ ê²€ì¦ ì‹¤íŒ¨\n\n${verifyResult.message || 'ì‹¤ì œ ì‹œíŠ¸ ë°ì´í„° ë¶ˆì¼ì¹˜'}\n\nê°€ëŠ¥í•œ ì›ì¸:\n1. ê¶Œí•œ ë¬¸ì œë¡œ ì½ê¸° ì‹¤íŒ¨\n2. ì‹œíŠ¸ ID ë˜ëŠ” GID ë¶ˆì¼ì¹˜\n3. ìºì‹œ ì§€ì—°\n\nGoogle Sheetsë¥¼ ì§ì ‘ í™•ì¸í•˜ê³ \nëª‡ ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.`);
              }
            }
            
          } catch (verifyError) {
            console.warn('   ê²€ì¦ ê³¼ì • ê±´ë„ˆëœ€:', verifyError.message);
            alert(`âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nğŸ“ í–‰ ë²ˆí˜¸: ${testRow}\nğŸ“ Fì—´(íŒŒì¼ëª…): ${testUpdateData.filename}\nğŸ¤– Hì—´(AIë¶„ì„): ${testUpdateData.aiAnalysis}\n\nGoogle Sheetsì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.`);
          }
          
        } else {
          throw new Error(result.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
      } catch (error) {
        console.error('   âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        
        // ìƒì„¸í•œ ì˜¤ë¥˜ ë¶„ì„
        let troubleshootMsg = '';
        if (error.message.includes('CORS')) {
          troubleshootMsg = '\nğŸ”§ í•´ê²°ì±…: Apps Script "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ ì„¤ì • í™•ì¸';
        } else if (error.message.includes('ê¶Œí•œ')) {
          troubleshootMsg = '\nğŸ”§ í•´ê²°ì±…: ì‹œíŠ¸ í¸ì§‘ ê¶Œí•œ ë˜ëŠ” Apps Script ê¶Œí•œ í™•ì¸';
        } else if (error.message.includes('ì°¾ì„ ìˆ˜ ì—†ìŒ')) {
          troubleshootMsg = '\nğŸ”§ í•´ê²°ì±…: ì‹œíŠ¸ URL ë˜ëŠ” Apps Script URL í™•ì¸';
        } else {
          troubleshootMsg = '\nğŸ”§ í•´ê²°ì±…: Apps Script ë¡œê·¸ì™€ ë¬¸ì„œ í™•ì¸';
        }
        
        alert(`âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${error.message}${troubleshootMsg}\n\nì¶”ê°€ ì§„ë‹¨:\n1. F12 > Console ë¡œê·¸ í™•ì¸\n2. Apps Script ì‹¤í–‰ ë¡œê·¸ í™•ì¸\n3. ë¬¸ì œí•´ê²° ê°€ì´ë“œ ì°¸ì¡°`);
      }
      
      console.log('\nğŸ” === ë””ë²„ê·µ ì¢…ë£Œ ===');
    });
    
    // ====================================
    // Phase 2: ìºì‹œ í†µê³„ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    // ====================================

    function updateCacheStatsUI() {
      const stats = sheetDataCache.getStats();

      // ì•ˆì „í•œ ìš”ì†Œ ì—…ë°ì´íŠ¸ (ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ)
      const safeUpdate = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      safeUpdate('cache-size', stats.size);
      safeUpdate('cache-hit-rate', stats.hitRate);
      safeUpdate('cache-hits', stats.hitCount);
      safeUpdate('cache-misses', stats.missCount);
      safeUpdate('cache-last-update', stats.lastUpdate);
      safeUpdate('cache-ttl', stats.ttl);

      const statusEl = document.getElementById('cache-status');
      if (statusEl) {
        if (sheetDataCache.isLoading) {
          statusEl.textContent = 'ê°±ì‹  ì¤‘...';
          statusEl.className = 'text-yellow-400';
        } else if (stats.isExpired) {
          statusEl.textContent = 'ë§Œë£Œë¨';
          statusEl.className = 'text-red-400';
        } else {
          statusEl.textContent = 'í™œì„±';
          statusEl.className = 'text-green-400';
        }
      }
    }

    function toggleCacheStats() {
      const panel = document.getElementById('cache-stats-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function refreshCacheManually() {
      await sheetDataCache.refreshCache();
      updateCacheStatsUI();
      // í™”ë©´ ì—…ë°ì´íŠ¸ë„ íŠ¸ë¦¬ê±°
      updateVisibleHandsStatus();
    }

    function clearCacheManually() {
      sheetDataCache.clear();
      updateCacheStatsUI();
    }

    // Phase 3 ì œì–´ í•¨ìˆ˜ë“¤
    function toggleSmartRefresh() {
      if (!smartRefresh) {
        console.warn('âš ï¸ SmartRefreshManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
        return;
      }

      smartRefresh.isEnabled = !smartRefresh.isEnabled;
      const btn = document.getElementById('smart-refresh-btn');
      if (btn) {
        btn.textContent = `ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨: ${smartRefresh.isEnabled ? 'ON' : 'OFF'}`;
      }

      if (smartRefresh.isEnabled) {
        smartRefresh.start();
        console.log('âœ… ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ í™œì„±í™”');
      } else {
        smartRefresh.stop();
        console.log('â¹ï¸ ìŠ¤ë§ˆíŠ¸ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”');
      }

      updateAllStatsUI();
    }

    async function clearAllData() {
      if (!confirm('âš ï¸ ëª¨ë“  ìºì‹œ ë° ë¡œì»¬ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        // ìºì‹œ ì´ˆê¸°í™”
        if (sheetDataCache) {
          sheetDataCache.clear();
        }

        // IndexedDB ì´ˆê¸°í™”
        if (localStore) {
          await localStore.clearAll();
        }

        // localStorage ì´ˆê¸°í™” (ì„¤ì • ì œì™¸)
        const settings = {
          main_sheet_url: localStorage.getItem('main_sheet_url'),
          sheet_update_script_url: localStorage.getItem('sheet_update_script_url'),
          GEMINI_API_KEY: localStorage.getItem('GEMINI_API_KEY')
        };

        localStorage.clear();

        // ì„¤ì • ë³µì›
        Object.entries(settings).forEach(([key, value]) => {
          if (value) localStorage.setItem(key, value);
        });

        console.log('âœ… ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
        alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. Ctrl+Shift+Rë¡œ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜í•˜ì„¸ìš”.');
        // location.reload(); // âš ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™” - ê³¼ë„í•œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
      } catch (error) {
        console.error('âŒ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        alert('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function clearCache() {
      clearCacheManually();
    }

    function refreshStats() {
      updateAllStatsUI();
    }

    function updateAllStatsUI() {
      // Phase 1-2 í†µê³„
      updateCacheStatsUI();

      // Phase 3 í†µê³„
      if (smartRefresh) {
        const intervalEl = document.getElementById('refresh-interval');
        if (intervalEl) {
          const seconds = Math.round(smartRefresh.refreshInterval / 1000);
          intervalEl.textContent = `${seconds}ì´ˆ`;
        }
      }

      if (localStore) {
        localStore.getStorageSize().then(size => {
          const sizeEl = document.getElementById('storage-size');
          if (sizeEl) {
            const kb = Math.round(size / 1024);
            sizeEl.textContent = `${kb} KB`;
          }
        });
      }
    }

    /**
     * ì´ˆê¸° ë¡œë“œ ì‹œ ëª¨ë“  í•¸ë“œ ìƒíƒœë¥¼ í•œë²ˆì— ê°€ì ¸ì™€ì„œ ìºì‹œ
     * ê°œì„ : ê°œë³„ API í˜¸ì¶œ ëŒ€ì‹  ì¼ê´„ ë¡œë”©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
     */
    async function loadAllHandsStatusAtOnce() {
      try {
        console.log('ğŸš€ === ì „ì²´ í•¸ë“œ ìƒíƒœ ì¼ê´„ ë¡œë”© ì‹œì‘ ===');
        const startTime = performance.now();

        // 1. ëª¨ë“  í•¸ë“œì˜ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í–‰ ë²ˆí˜¸ ìˆ˜ì§‘
        const handDataArray = [];
        const handElements = document.querySelectorAll('.hand-item');

        for (const el of handElements) {
          const handNumber = el.dataset.handNumber;
          if (handNumber) {
            const timestamp = await getHandTimestamp(handNumber);
            if (timestamp) {
              handDataArray.push({
                handNumber,
                timestamp,
                element: el
              });
            }
          }
        }

        console.log(`ğŸ“Š ì¼ê´„ ë¡œë”© ëŒ€ìƒ: ${handDataArray.length}ê°œ í•¸ë“œ`);

        if (handDataArray.length === 0) {
          console.log('â„¹ï¸ ë¡œë“œí•  í•¸ë“œê°€ ì—†ìŒ');
          return;
        }

        // 2. Apps Scriptë¡œ ì¼ê´„ ìƒíƒœ ìš”ì²­ (í•œ ë²ˆì˜ API í˜¸ì¶œë¡œ ëª¨ë“  ìƒíƒœ ê°€ì ¸ì˜¤ê¸°)
        const batchRequest = {
          action: 'batchGetAllStatus',  // ëª¨ë“  í•¸ë“œ ìƒíƒœë¥¼ í•œë²ˆì— ê°€ì ¸ì˜¤ëŠ” ì•¡ì…˜
          sheetUrl: getSheetUrl(),
          timestamps: handDataArray.map(data => data.timestamp)
        };

        console.log('ğŸ“¡ Apps Scriptì— ì¼ê´„ ìƒíƒœ ìš”ì²­...');

        try {
          const response = await fetch(getAppsScriptUrl(), {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(batchRequest)
          });

          if (response.ok) {
            const result = await response.json();

            if (result.status === 'success' && result.data) {
              // 3. ë°›ì€ ìƒíƒœ ë°ì´í„°ë¥¼ ì „ì—­ ìºì‹œì— ì €ì¥
              const statusCache = new Map();

              result.data.forEach(item => {
                if (item.timestamp && item.status) {
                  statusCache.set(item.timestamp, {
                    status: item.status,
                    fileName: item.fileName || '',
                    aiAnalysis: item.aiAnalysis || ''
                  });
                }
              });

              console.log(`âœ… ${statusCache.size}ê°œ í•¸ë“œ ìƒíƒœ ìºì‹œ ì™„ë£Œ`);

              // 4. ìºì‹œëœ ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
              let updatedCount = 0;
              handDataArray.forEach(({ handNumber, timestamp, element }) => {
                const cachedStatus = statusCache.get(timestamp);
                if (cachedStatus) {
                  updateHandStatusUI(element, cachedStatus.status);

                  // ì „ì—­ ìƒíƒœ ì €ì¥
                  if (!window.handStatusCache) {
                    window.handStatusCache = new Map();
                  }
                  window.handStatusCache.set(handNumber, cachedStatus);
                  updatedCount++;
                }
              });

              const endTime = performance.now();
              const totalTime = ((endTime - startTime) / 1000).toFixed(2);

              console.log(`ğŸ‰ ì¼ê´„ ë¡œë”© ì™„ë£Œ: ${updatedCount}/${handDataArray.length}ê°œ ì—…ë°ì´íŠ¸ (${totalTime}ì´ˆ)`);

              // ì„±ê³µ ì•Œë¦¼
              if (updatedCount > 0) {
                showNotification(`${updatedCount}ê°œ í•¸ë“œ ìƒíƒœê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
              }
            }
          }
        } catch (error) {
          console.error('âŒ ì¼ê´„ ìƒíƒœ ìš”ì²­ ì‹¤íŒ¨:', error);

          // í´ë°±: ìºì‹œëœ CSV ë°ì´í„° ì‚¬ìš©
          console.log('ğŸ“¦ í´ë°±: ë¡œì»¬ ìºì‹œ ë°ì´í„° ì‚¬ìš©...');
          await fallbackToCachedData(handDataArray);
        }

      } catch (error) {
        console.error('âŒ ì¼ê´„ ë¡œë”© ì‹¤íŒ¨:', error);
      }
    }

    /**
     * ìºì‹œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•œ í´ë°± ì²˜ë¦¬
     */
    async function fallbackToCachedData(handDataArray) {
      if (!sheetDataCache) {
        console.warn('âš ï¸ ìºì‹œê°€ ì—†ì–´ í´ë°± ë¶ˆê°€');
        return;
      }

      let updatedCount = 0;
      for (const { handNumber, timestamp, element } of handDataArray) {
        const cachedRow = sheetDataCache.findClosestRow(timestamp);
        if (cachedRow && cachedRow.status) {
          updateHandStatusUI(element, cachedRow.status);

          // ì „ì—­ ìƒíƒœ ì €ì¥
          if (!window.handStatusCache) {
            window.handStatusCache = new Map();
          }
          window.handStatusCache.set(handNumber, {
            status: cachedRow.status,
            fileName: cachedRow.fileName || '',
            aiAnalysis: cachedRow.aiAnalysis || ''
          });
          updatedCount++;
        }
      }

      console.log(`ğŸ“¦ í´ë°± ì™„ë£Œ: ${updatedCount}ê°œ í•¸ë“œ ìƒíƒœ ë³µêµ¬`);
    }

    /**
     * í•¸ë“œ ìƒíƒœ UI ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
     */
    function updateHandStatusUI(element, status) {
      const statusIndicator = element.querySelector('.status-indicator');
      if (statusIndicator) {
        // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
        statusIndicator.classList.remove('status-empty', 'status-pending', 'status-completed');

        // ìƒˆ ìƒíƒœ ì ìš©
        if (status === 'ë³µì‚¬ì™„ë£Œ' || status === 'completed') {
          statusIndicator.classList.add('status-completed');
          statusIndicator.textContent = 'âœ…';
          statusIndicator.title = 'ì™„ë£Œë¨';
        } else if (status === 'ë¯¸ì™„ë£Œ' || status === 'pending') {
          statusIndicator.classList.add('status-pending');
          statusIndicator.textContent = 'â³';
          statusIndicator.title = 'ì§„í–‰ ì¤‘';
        } else {
          statusIndicator.classList.add('status-empty');
          statusIndicator.textContent = 'â—‹';
          statusIndicator.title = 'ë¯¸ì²˜ë¦¬';
        }
      }
    }

    /**
     * í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ í•¸ë“œ ìƒíƒœ ì´ˆê¸°í™” ë° ë™ê¸°í™” (ë ˆê±°ì‹œ - ë³´ì¡´)
     * ëª©ì : ìƒˆë¡œê³ ì¹¨ í›„ ê° í•¸ë“œì˜ ì‹¤ì œ ì‹œíŠ¸ ìƒíƒœì™€ UI ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
     */
    async function initializeAllHandsStatus() {
      try {
        console.log('ğŸ”„ === ì „ì²´ í•¸ë“œ ìƒíƒœ ë™ê¸°í™” ì‹œì‘ ===');

        // 1. ìºì‹œ ì¤€ë¹„ í™•ì¸
        if (!sheetDataCache) {
          console.warn('âš ï¸ ìºì‹œê°€ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ - ë™ê¸°í™” ì—°ê¸°');
          return;
        }

        await sheetDataCache.ensureFresh();

        // 2. í˜„ì¬ í‘œì‹œëœ ëª¨ë“  í•¸ë“œ ìš”ì†Œ ì°¾ê¸°
        const handElements = document.querySelectorAll('.hand-item');
        console.log(`ğŸ“Š í‘œì‹œëœ í•¸ë“œ ìˆ˜: ${handElements.length}ê°œ`);

        if (handElements.length === 0) {
          console.log('â„¹ï¸ í‘œì‹œëœ í•¸ë“œê°€ ì—†ìŒ - ë™ê¸°í™” ì™„ë£Œ');
          return;
        }

        // 3. ì¼ê´„ ìƒíƒœ í™•ì¸ì„ ìœ„í•œ í•¸ë“œ ë²ˆí˜¸ ìˆ˜ì§‘
        const handNumbers = [];
        handElements.forEach(el => {
          const handNumber = el.dataset.handNumber;
          if (handNumber) {
            handNumbers.push(handNumber);
          }
        });

        console.log(`ğŸ” ìƒíƒœ í™•ì¸ ëŒ€ìƒ: ${handNumbers.length}ê°œ í•¸ë“œ`);

        // 4. Phase 2 ìºì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´„ ìƒíƒœ í™•ì¸
        const statusResults = {};
        let cacheHits = 0;
        let cacheMisses = 0;

        for (const handNumber of handNumbers) {
          try {
            const handTime = await getHandTimestamp(handNumber);
            if (handTime) {
              const cachedRow = sheetDataCache.findClosestRow(handTime);
              if (cachedRow) {
                statusResults[handNumber] = cachedRow.status || '';
                cacheHits++;
              } else {
                statusResults[handNumber] = '';
                cacheMisses++;
              }
            }
          } catch (error) {
            console.error(`âŒ í•¸ë“œ ${handNumber} ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:`, error);
            statusResults[handNumber] = '';
            cacheMisses++;
          }
        }

        console.log(`ğŸ“Š ìºì‹œ ì„±ëŠ¥: ${cacheHits}ê°œ ì ì¤‘, ${cacheMisses}ê°œ ë¯¸ìŠ¤`);

        // 5. UI ì—…ë°ì´íŠ¸
        let updatedCount = 0;
        handElements.forEach(el => {
          const handNumber = el.dataset.handNumber;
          const status = statusResults[handNumber];

          if (status) {
            // ìƒíƒœì— ë”°ë¥¸ ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
            const statusIndicator = el.querySelector('.status-indicator');
            if (statusIndicator) {
              // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
              statusIndicator.classList.remove('status-empty', 'status-pending', 'status-completed');

              // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
              switch (status) {
                case 'ë¯¸ì™„ë£Œ':
                  statusIndicator.classList.add('status-pending');
                  statusIndicator.textContent = 'ğŸ“';
                  statusIndicator.title = 'í¸ì§‘ë¨ - ì™„ë£Œ ëŒ€ê¸°';
                  break;
                case 'ë³µì‚¬ì™„ë£Œ':
                  statusIndicator.classList.add('status-completed');
                  statusIndicator.textContent = 'âœ…';
                  statusIndicator.title = 'ì²˜ë¦¬ ì™„ë£Œ';
                  break;
                default:
                  statusIndicator.classList.add('status-empty');
                  statusIndicator.textContent = 'âšª';
                  statusIndicator.title = 'ë¯¸ì²˜ë¦¬';
              }
              updatedCount++;
            }
          }
        });

        console.log(`âœ… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${updatedCount}ê°œ í•¸ë“œ`);

        // 6. í˜„ì¬ ì„ íƒëœ í•¸ë“œì˜ ë²„íŠ¼ ìƒíƒœë„ ì—…ë°ì´íŠ¸
        if (currentHand) {
          const currentStatus = statusResults[currentHand];
          if (currentStatus) {
            console.log(`ğŸ”„ í˜„ì¬ í•¸ë“œ #${currentHand} ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸: ${currentStatus}`);
            await updateButtonStatesFromStatus(currentHand, currentStatus);
          }
        }

        console.log('âœ… === ì „ì²´ í•¸ë“œ ìƒíƒœ ë™ê¸°í™” ì™„ë£Œ ===');

      } catch (error) {
        console.error('âŒ ì „ì²´ í•¸ë“œ ìƒíƒœ ë™ê¸°í™” ì‹¤íŒ¨:', error);
      }
    }

    /**
     * ìƒíƒœ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë²„íŠ¼ ìƒíƒœë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸ (API í˜¸ì¶œ ì—†ì´)
     */
    async function updateButtonStatesFromStatus(handNumber, status) {
      const editBtn = document.getElementById('edit-btn');
      const completeBtn = document.getElementById('complete-btn');

      if (!editBtn || !completeBtn) return;

      switch(status) {
        case null:
        case '':
          editBtn.disabled = false;
          editBtn.textContent = 'í¸ì§‘';
          completeBtn.disabled = true;
          completeBtn.textContent = 'ì™„ë£Œ';
          break;

        case 'ë¯¸ì™„ë£Œ':
          editBtn.disabled = true;
          editBtn.textContent = 'í¸ì§‘';
          completeBtn.disabled = false;
          completeBtn.textContent = 'ì™„ë£Œ';
          break;

        case 'ë³µì‚¬ì™„ë£Œ':
          editBtn.disabled = true;
          editBtn.textContent = 'í¸ì§‘';
          completeBtn.disabled = true;
          completeBtn.textContent = 'ì™„ë£Œ';
          break;

        default:
          editBtn.disabled = false;
          editBtn.textContent = 'í¸ì§‘';
          completeBtn.disabled = true;
          completeBtn.textContent = 'ì™„ë£Œ';
      }

      console.log(`ğŸ”„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸: í•¸ë“œ #${handNumber} â†’ ${status}`);
    }

    // âš ï¸ ì£¼ê¸°ì  í†µê³„ ì—…ë°ì´íŠ¸ ë¹„í™œì„±í™” - ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€
    // setInterval(updateAllStatsUI, 1000); // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ì–´ ê³¼ë„í•œ ë¡œê·¸ ë°œìƒ

    window.addEventListener('beforeunload', () => {
      if (refreshTimerInitial) {
        clearTimeout(refreshTimerInitial);
      }
      if (refreshTimerInterval) {
        clearInterval(refreshTimerInterval);
      }
    });

    // í…ŒìŠ¤íŠ¸ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜ë“¤
    function togglePerformanceDashboard() {
      const dashboard = document.getElementById('performance-dashboard');
      dashboard.style.display = dashboard.style.display === 'none' ? 'block' : 'none';
    }

    function toggleTestPanel() {
      const panel = document.getElementById('test-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function runDay1Tests() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '<div class="text-yellow-400">ğŸ”„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</div>';

      try {
        const automation = new TestAutomation();
        const results = await automation.testDay1_PerformanceMonitoring();

        let html = '<div class="space-y-2">';
        html += `<div class="text-white font-bold">Day 1 í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>`;
        html += `<div>ì´ í…ŒìŠ¤íŠ¸: ${results.total}</div>`;
        html += `<div class="text-green-400">âœ… í†µê³¼: ${results.passed}</div>`;
        html += `<div class="text-red-400">âŒ ì‹¤íŒ¨: ${results.failed}</div>`;

        if (results.failed > 0) {
          html += '<div class="mt-2 text-yellow-400">ì¬ì‘ì—… í•„ìš”:</div>';
          results.details
            .filter(d => d.status === 'FAIL')
            .forEach(d => {
              html += `<div class="ml-2 text-xs">â€¢ ${d.name}: ${d.action}</div>`;
            });
        }

        html += '</div>';
        resultsDiv.innerHTML = html;

        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ë”°ë¥¸ Todo ì—…ë°ì´íŠ¸
        if (results.failed === 0) {
          console.log('âœ… Day 1 í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼');
        } else {
          console.log('âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ì¬ì‘ì—… í•„ìš”');
        }

      } catch (error) {
        resultsDiv.innerHTML = `<div class="text-red-400">âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜: ${error.message}</div>`;
      }
    }

    // íƒ€ì„ìŠ¤íƒ¬í”„ ë””ë²„ê¹… í•¨ìˆ˜
    window.debugTimestamps = function() {
        console.log('ğŸ” íƒ€ì„ìŠ¤íƒ¬í”„ ë””ë²„ê¹… ì‹œì‘\n');

        // ì‹¤íŒ¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ë“¤
        const failedTimestamps = [
            1758018149, // 19:22
            1758012781, // 17:53
            1758011238, // 17:27
            1757946013, // 23:20
            1757945477, // 23:11
            1757942926, // 22:28
            1757940640  // 21:50
        ];

        console.log('ì‹¤íŒ¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ë¶„ì„:');
        failedTimestamps.forEach(ts => {
            const date = new Date(ts * 1000);
            console.log(`${ts} â†’ ${date.toLocaleString('ko-KR')} (${date.toDateString()})`);
        });

        console.log('\nì„±ê³µí•œ íƒ€ì„ìŠ¤íƒ¬í”„ ë¶„ì„:');
        const successTimestamps = [
            1758075882, // 11:24
            1758090528  // 15:28
        ];

        successTimestamps.forEach(ts => {
            const date = new Date(ts * 1000);
            console.log(`${ts} â†’ ${date.toLocaleString('ko-KR')} (${date.toDateString()})`);
        });

        // ë‚ ì§œ ì°¨ì´ ê³„ì‚°
        const successDate = new Date(successTimestamps[0] * 1000);
        const failedDate = new Date(failedTimestamps[0] * 1000);
        const dayDiff = Math.floor((failedDate - successDate) / (1000 * 60 * 60 * 24));
        console.log(`\në‚ ì§œ ì°¨ì´: ${dayDiff}ì¼`);

        // Virtual ì‹œíŠ¸ ìºì‹œ ë¶„ì„
        if (typeof sheetDataCache !== 'undefined' && sheetDataCache.cache.size > 0) {
            console.log('\nğŸ“Š Virtual ì‹œíŠ¸ ìºì‹œ ë¶„ì„:');
            sheetDataCache.analyzeCache();
        }
    };

    // ê³ ìœ  ID ë§¤ì¹­ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    window.testHandNumberMatching = async function() {
        console.log('ğŸ§ª í•¸ë“œ ë²ˆí˜¸ ë§¤ì¹­ í…ŒìŠ¤íŠ¸ ì‹œì‘\n');

        // 1. ìºì‹œ ê°±ì‹ 
        console.log('ğŸ“¥ ìºì‹œ ê°±ì‹  ì¤‘...');
        await sheetDataCache.refreshCache();

        // 2. í…ŒìŠ¤íŠ¸í•  í•¸ë“œ ë²ˆí˜¸ë“¤
        const testHandNumbers = [138, 139, 140];

        console.log('\nğŸ” í•¸ë“œ ë²ˆí˜¸ë¡œ ì§ì ‘ ê²€ìƒ‰:');
        for (const handNum of testHandNumbers) {
            const row = sheetDataCache.findRowByHandNumber(handNum);
            if (row) {
                console.log(`âœ… í•¸ë“œ #${handNum}:`);
                console.log(`   - í–‰: ${row.row}`);
                console.log(`   - ì‹œê°„: ${row.time}`);
                console.log(`   - ìƒíƒœ: "${row.status || ''}"`);
            } else {
                console.log(`âŒ í•¸ë“œ #${handNum}: ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            }
        }

        // 3. íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤ì¹­ê³¼ ë¹„êµ
        console.log('\nğŸ”„ íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤ì¹­ê³¼ ë¹„êµ:');
        for (const handNum of testHandNumbers) {
            try {
                const timestamp = await getHandTimestamp(handNum);
                if (timestamp) {
                    const date = new Date(timestamp * 1000);
                    const timeStr = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    console.log(`í•¸ë“œ #${handNum}: íƒ€ì„ìŠ¤íƒ¬í”„=${timestamp} â†’ ì‹œê°„=${timeStr}`);

                    const timestampRow = sheetDataCache.findClosestRow(timestamp);
                    if (timestampRow) {
                        console.log(`   íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤ì¹­: í–‰ ${timestampRow.row}, ìƒíƒœ="${timestampRow.status || ''}"`);
                    } else {
                        console.log(`   íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤ì¹­: ì‹¤íŒ¨`);
                    }
                }
            } catch (error) {
                console.log(`   í•¸ë“œ #${handNum} íƒ€ì„ìŠ¤íƒ¬í”„ ì¡°íšŒ ì˜¤ë¥˜:`, error);
            }
        }

        console.log('\nâœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    };

    // ğŸ”§ í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    function loadSavedSettings() {
        console.log('ğŸ“¦ ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...');

        // GitHub Secrets í™•ì¸ ë¡œê¹…
        console.log('ğŸ” === GitHub Secrets í™•ì¸ ===');
        if (window.ENV_CONFIG) {
            console.log('âœ… ENV_CONFIG ê°ì²´ ë°œê²¬');
            console.log('ğŸ“Œ GEMINI_API_KEY:', window.ENV_CONFIG.GEMINI_API_KEY ?
                `ì„¤ì •ë¨ (${window.ENV_CONFIG.GEMINI_API_KEY.substring(0, 10)}...)` : 'âŒ ë¯¸ì„¤ì •');
            console.log('ğŸ“Œ GOOGLE_APP_SCRIPT:', window.ENV_CONFIG.GOOGLE_APP_SCRIPT ?
                `ì„¤ì •ë¨ (${window.ENV_CONFIG.GOOGLE_APP_SCRIPT.substring(0, 30)}...)` : 'âŒ ë¯¸ì„¤ì •');
        } else {
            console.log('âš ï¸ ENV_CONFIG ì—†ìŒ - GitHub Secretsê°€ ì£¼ì…ë˜ì§€ ì•ŠìŒ');
            console.log('ğŸ’¡ ë¡œì»¬ í™˜ê²½ì´ê±°ë‚˜ GitHub Actionsê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
        console.log('ğŸ” ======================');

        // GitHub Secrets ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
        const DEFAULT_CONFIG = {
            GEMINI_API_KEY: window.ENV_CONFIG?.GEMINI_API_KEY || '',
            GOOGLE_APP_SCRIPT: window.ENV_CONFIG?.GOOGLE_APP_SCRIPT || '',
            FILENAME_PREFIX: 'VT',
            TEMPLATE_PRESET: 'ai-analysis'
        };

        // 1. CSV URL ì„¤ì •
        const savedCsvUrl = localStorage.getItem('csvUrl');
        if (savedCsvUrl) {
            const csvInput = document.getElementById('csv-url');
            if (csvInput) {
                csvInput.value = savedCsvUrl;
                console.log('âœ… CSV URL ë¡œë“œë¨');
            }
        }

        // 2. ì‹œíŠ¸ ì´ë¦„ ì„¤ì •
        const savedSheetName = localStorage.getItem('sheetName');
        if (savedSheetName) {
            const sheetInput = document.getElementById('sheet-name');
            if (sheetInput) {
                sheetInput.value = savedSheetName;
                console.log('âœ… ì‹œíŠ¸ ì´ë¦„ ë¡œë“œë¨');
            }
        }

        // 3. Gemini API í‚¤ ì„¤ì • (loadAPIKeys í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
        // loadAPIKeys() í•¨ìˆ˜ê°€ ì´ë¯¸ localStorage > GitHub Secrets ìˆœì„œë¡œ ì²˜ë¦¬í•¨
        console.log('ğŸ”‘ API í‚¤ ë¡œë”©ì€ loadAPIKeys() í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë¨');

        // 4. Apps Script URL ì„¤ì • (localStorage > GitHub Secrets > ë¹ˆê°’)
        let appsScriptUrl = localStorage.getItem('appsScriptUrl');
        let scriptSource = '';

        if (appsScriptUrl) {
            scriptSource = 'localStorage';
            console.log('ğŸ“¦ Apps Script URL: localStorageì—ì„œ ë¡œë“œ');
        } else if (DEFAULT_CONFIG.GOOGLE_APP_SCRIPT) {
            appsScriptUrl = DEFAULT_CONFIG.GOOGLE_APP_SCRIPT;
            scriptSource = 'GitHub Secrets';
            localStorage.setItem('appsScriptUrl', appsScriptUrl);
            console.log('ğŸ” Apps Script URL: GitHub Secretsì—ì„œ ë¡œë“œ ë° ì €ì¥');
        } else {
            scriptSource = 'ë¯¸ì„¤ì •';
            console.log('âš ï¸ Apps Script URL: ë¯¸ì„¤ì • ìƒíƒœ');
        }

        if (appsScriptUrl) {
            console.log(`âœ… Apps Script URL ì„¤ì • ì™„ë£Œ [ì¶œì²˜: ${scriptSource}]`);
        }

        // 5. íŒŒì¼ëª… ì»¤ìŠ¤í„°ë§ˆì´ì§• ì„¤ì • (ê¸°ë³¸ê°’: 'VT')
        let filenamePrefix = localStorage.getItem('filenamePrefix');
        if (filenamePrefix === null) {
            filenamePrefix = DEFAULT_CONFIG.FILENAME_PREFIX;
            localStorage.setItem('filenamePrefix', filenamePrefix);
            console.log(`âœ… íŒŒì¼ëª… ì ‘ë‘ì‚¬ ê¸°ë³¸ê°’ ì„¤ì •: ${filenamePrefix}`);
        } else {
            console.log(`âœ… íŒŒì¼ëª… ì ‘ë‘ì‚¬ ë¡œë“œ: ${filenamePrefix}`);
        }

        const filenameSuffix = localStorage.getItem('filenameSuffix');
        if (filenameSuffix !== null) {
            console.log(`âœ… íŒŒì¼ëª… ì ‘ë¯¸ì‚¬ ë¡œë“œ: ${filenameSuffix}`);
        }

        // 6. í…œí”Œë¦¿ í”„ë¦¬ì…‹ ì„¤ì • (ê¸°ë³¸ê°’: 'ai-analysis')
        let templatePreset = localStorage.getItem('templatePreset');
        if (!templatePreset) {
            templatePreset = DEFAULT_CONFIG.TEMPLATE_PRESET;
            localStorage.setItem('templatePreset', templatePreset);
            console.log(`âœ… í…œí”Œë¦¿ í”„ë¦¬ì…‹ ê¸°ë³¸ê°’ ì„¤ì •: ${templatePreset}`);
        } else {
            console.log(`âœ… í…œí”Œë¦¿ í”„ë¦¬ì…‹ ë¡œë“œ: ${templatePreset}`);
        }

        // 7. AI ê¸°ëŠ¥ ì„¤ì • (ê¸°ë³¸ê°’: true)
        let useAI = localStorage.getItem('useAIForFilename');
        if (useAI === null) {
            useAI = 'true'; // AI ë¶„ì„ í…œí”Œë¦¿ì´ë¯€ë¡œ ê¸°ë³¸ í™œì„±í™”
            localStorage.setItem('useAIForFilename', useAI);
            console.log('âœ… AI íŒŒì¼ëª… ê¸°ë³¸ê°’ í™œì„±í™”');
        } else {
            console.log(`âœ… AI íŒŒì¼ëª… ì‚¬ìš©: ${useAI}`);
        }

        // ìµœì¢… ì„¤ì • ìƒíƒœ ìš”ì•½
        console.log('ğŸ“Š === ìµœì¢… ì„¤ì • ìƒíƒœ ===');
        console.log('ğŸ”‘ API í‚¤:', CONFIG.GEMINI_API_KEY ? 'âœ… ì„¤ì •ë¨' : 'âŒ ë¯¸ì„¤ì •');
        console.log('ğŸ“œ Apps Script:', appsScriptUrl ? 'âœ… ì„¤ì •ë¨' : 'âŒ ë¯¸ì„¤ì •');
        console.log('ğŸ·ï¸ íŒŒì¼ëª… ì ‘ë‘ì‚¬:', filenamePrefix || 'ë¯¸ì„¤ì •');
        console.log('ğŸ¨ í…œí”Œë¦¿ í”„ë¦¬ì…‹:', templatePreset || 'ë¯¸ì„¤ì •');
        console.log('ğŸ¤– AI ê¸°ëŠ¥:', useAI === 'true' ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”');
        console.log('ğŸ“Š ======================');

        console.log('âœ… ëª¨ë“  ì„¤ì • ë¡œë“œ ì™„ë£Œ!');

        // ìë™ìœ¼ë¡œ loadServerSettings ì‹¤í–‰ (ì„¤ì •ì´ ì´ë¯¸ ìˆëŠ” ê²½ìš°)
        if (savedCsvUrl || savedSheetName) {
            console.log('ğŸš€ ì €ì¥ëœ ì„¤ì •ìœ¼ë¡œ ìë™ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            // loadServerSettings í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ì‹¤í–‰
            if (typeof loadServerSettings === 'function') {
                loadServerSettings();
            }
        }
    }

    // ====================================
    // SSE ì‹¤ì‹œê°„ í•¸ë“œ ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    // ====================================
    let sseDetector = null;
    let sseUI = null;

    /**
     * SSE ì‹œìŠ¤í…œ ì´ˆê¸°í™”
     */
    function initializeSSE() {
        console.log('ğŸš€ SSE ì‹¤ì‹œê°„ ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');

        // Apps Script URL ê°€ì ¸ì˜¤ê¸°
        const appsScriptUrl = localStorage.getItem('appsScriptUrl') ||
                            DEFAULT_CONFIG.GOOGLE_APP_SCRIPT;

        if (!appsScriptUrl) {
            console.warn('âš ï¸ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ - SSE ë¹„í™œì„±í™”');
            return;
        }

        // SSE ìŠ¤íƒ€ì¼ ì£¼ì…
        if (typeof injectSSEStyles === 'function') {
            injectSSEStyles();
        }

        // SSE ê°ì§€ê¸° ìƒì„±
        sseDetector = new SSEHandDetector({
            sseUrl: appsScriptUrl,
            reconnectDelay: 2000,
            maxReconnectDelay: 60000,
            heartbeatTimeout: 90000,
            debug: true
        });

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        sseDetector.on('onNewHand', (handData) => {
            console.log('ğŸ¯ SSE ìƒˆ í•¸ë“œ ê°ì§€:', handData);

            // masterHandListì— ì¶”ê°€
            if (!masterHandList.has(handData.handNumber)) {
                masterHandList.set(handData.handNumber, {
                    ...handData,
                    source: 'SSE',
                    receivedAt: new Date().toISOString()
                });

                // DOMì— ì¶”ê°€ (renderHands í•¨ìˆ˜ í˜¸ì¶œ)
                if (typeof renderHands === 'function') {
                    renderHands();
                }

                // ì•Œë¦¼ í‘œì‹œ
                showNotification(`ìƒˆ í•¸ë“œ #${handData.handNumber} ì¶”ê°€ë¨!`);

                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
            }
        });

        sseDetector.on('onConnect', () => {
            console.log('âœ… SSE ì—°ê²° ì„±ê³µ');
            updateSSEStatus('connected');
        });

        sseDetector.on('onDisconnect', () => {
            console.log('âŒ SSE ì—°ê²° ëŠê¹€');
            updateSSEStatus('disconnected');
        });

        sseDetector.on('onStatusChange', (newStatus, oldStatus) => {
            console.log(`SSE ìƒíƒœ ë³€ê²½: ${oldStatus} â†’ ${newStatus}`);
            updateSSEStatus(newStatus);
        });

        // UI í—¬í¼ ì´ˆê¸°í™”
        sseUI = new SSEHandUI(sseDetector);

        // ì—°ê²° ì‹œì‘
        sseDetector.connect();
        console.log('âœ… SSE ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    /**
     * SSE ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
     */
    function updateSSEStatus(status) {
        // í—¤ë”ì— SSE ìƒíƒœ í‘œì‹œ ì¶”ê°€
        const headerElement = document.querySelector('.flex.justify-between.items-center.mb-6');
        if (!headerElement) return;

        let statusElement = document.getElementById('sse-status');
        if (!statusElement) {
            statusElement = document.createElement('div');
            statusElement.id = 'sse-status';
            headerElement.appendChild(statusElement);
        }

        const statusMap = {
            'connected': { text: 'SSE ì—°ê²°ë¨', color: 'text-green-500', icon: 'ğŸŸ¢' },
            'connecting': { text: 'SSE ì—°ê²° ì¤‘...', color: 'text-yellow-500', icon: 'ğŸŸ¡' },
            'disconnected': { text: 'SSE ì—°ê²° ëŠê¹€', color: 'text-red-500', icon: 'ğŸ”´' },
            'reconnecting': { text: 'SSE ì¬ì—°ê²° ì¤‘...', color: 'text-orange-500', icon: 'ğŸŸ ' }
        };

        const info = statusMap[status] || statusMap['disconnected'];
        statusElement.className = `flex items-center gap-2 ${info.color}`;
        statusElement.innerHTML = `
            <span>${info.icon}</span>
            <span class="text-sm font-medium">${info.text}</span>
        `;
    }

    /**
     * ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
     */
    function showNotification(message) {
        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í™•ì¸
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Virtual Table', {
                body: message,
                icon: '/favicon.ico',
                tag: 'new-hand',
                requireInteraction: false
            });
        }

        // í™”ë©´ í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-x-full';
        toast.textContent = message;
        document.body.appendChild(toast);

        // ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ìë™ ì‹¤í–‰
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedSettings();
            console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì„¤ì • ìë™ ì ìš©');

            // SSE ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            setTimeout(() => {
                initializeSSE();
            }, 1000); // ë‹¤ë¥¸ ì´ˆê¸°í™” ì™„ë£Œ í›„ ì‹¤í–‰
        });
    } else {
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
        setTimeout(() => {
            loadSavedSettings();

            // SSE ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            setTimeout(() => {
                initializeSSE();
            }, 1000);
        }, 100); // ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ë‹¤ë¥¸ ì´ˆê¸°í™” í›„ ì‹¤í–‰
    }
  </script>
</body>
</html>
Tue, Sep 23, 2025 12:15:18 AM
<!-- Cache Bust: Tue, Sep 23, 2025 12:15:18 AM -->
