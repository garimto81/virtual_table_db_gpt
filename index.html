<!DOCTYPE html>
<!--
  í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - AI ë¶„ì„ ë° ì‹œíŠ¸ ì—°ë™
  Version: 9.4.1
  Last Updated: 2025-01-09
  Description: BB ë° íŒŸ ê³„ì‚° ë¡œì§ ê°œì„  - ì´ˆê¸° ë¸”ë¼ì¸ë“œ í¬í•¨
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ v9.4.1 - AI ë¶„ì„ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .mono {
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* ì»´íŒ©íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card-mini {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 48px;
      background-color: #FFFFFF !important;
      color-scheme: light;
      border: 1px solid #6b7280;
      border-radius: 4px;
      font-weight: 800;
      font-size: 16px;
      margin: 0 1px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      position: relative;
    }
    
    /* ìŠ¤í˜ì´ë“œ, í´ëŸ½ - ì§„í•œ ê²€ì€ìƒ‰ */
    .card-mini.spade, .card-mini.club { 
      color: #000000 !important;
    }
    
    /* í•˜íŠ¸, ë‹¤ì´ì•„ëª¬ë“œ - ì§„í•œ ë¹¨ê°„ìƒ‰ */
    .card-mini.heart, .card-mini.diamond { 
      color: #dc2626 !important;
    }
    
    /* ë³´ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .board-card {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 60px;
      background-color: #FFFFFF !important;
      color-scheme: light;
      border: 2px solid #f59e0b;
      border-radius: 6px;
      font-weight: 900;
      font-size: 20px;
      margin: 0 2px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative;
    }
    
    /* ìŠ¤í˜ì´ë“œ, í´ëŸ½ - ì§„í•œ ê²€ì€ìƒ‰ */
    .board-card.spade, .board-card.club { 
      color: #000000 !important;
    }
    
    /* í•˜íŠ¸, ë‹¤ì´ì•„ëª¬ë“œ - ì§„í•œ ë¹¨ê°„ìƒ‰ */
    .board-card.heart, .board-card.diamond { 
      color: #dc2626 !important;
    }
    
    /* ì•¡ì…˜ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .action-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .action-badge.fold { background: #64748b; color: white; }
    .action-badge.check { background: #0ea5e9; color: white; }
    .action-badge.call { background: #22c55e; color: white; }
    .action-badge.bet { background: #f97316; color: white; }
    .action-badge.raise { background: #ef4444; color: white; }
    .action-badge.allin { background: #fbbf24; color: #000; }
    
    /* í¬ì§€ì…˜ ë°°ì§€ */
    .pos-badge {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .pos-badge.btn { background: #fbbf24; color: #000; }
    .pos-badge.sb { background: #10b981; color: white; }
    .pos-badge.bb { background: #3b82f6; color: white; }
    .pos-badge.utg { background: #8b5cf6; color: white; }
    .pos-badge.mp { background: #ec4899; color: white; }
    .pos-badge.co { background: #f97316; color: white; }
    
    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1e293b;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    
    /* ì»´íŒ©íŠ¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .compact-grid {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 12px;
      padding: 12px;
      height: 100vh;
      max-width: 1920px;
      margin: 0 auto;
    }
    
    @media (max-width: 1440px) {
      .compact-grid {
        grid-template-columns: 260px 1fr 300px;
      }
    }
    
    /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .section {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
    }
    
    .section-header {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #334155;
    }
    
    /* í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ */
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .player-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid #334155;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .player-item:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
    }
    
    .player-item.folded {
      opacity: 0.5;
    }
    
    /* ì•¡ì…˜ íƒ€ì„ë¼ì¸ ì»´íŒ©íŠ¸ */
    .action-line {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      font-size: 12px;
      border-left: 2px solid transparent;
    }
    
    .action-line.preflop { border-left-color: #8b5cf6; }
    .action-line.flop { border-left-color: #3b82f6; }
    .action-line.turn { border-left-color: #10b981; }
    .action-line.river { border-left-color: #f97316; }
    .action-line.showdown { border-left-color: #fbbf24; }
    
    /* íŒŸ ë””ìŠ¤í”Œë ˆì´ */
    .pot-display {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      border-radius: 6px;
      font-weight: 700;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <div class="app-header" style="background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #334155; padding: 10px 16px; position: sticky; top: 0; z-index: 100;">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-bold">í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§</h1>
        <span class="text-xs text-gray-500">v9.4.1</span>
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          <span class="text-xs text-gray-400">ì—°ê²°ë¨</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refresh-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
          ìƒˆë¡œê³ ì¹¨
        </button>
        <button id="settings-btn" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">
          ì„¤ì •
        </button>
      </div>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="compact-grid">
    
    <!-- ì™¼ìª½: í•¸ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="section overflow-hidden">
      <div class="section-header flex items-center justify-between">
        <span>í•¸ë“œ ëª©ë¡</span>
        <span id="hand-count" class="text-xs">0</span>
      </div>
      <div class="flex gap-2 mb-2">
        <select id="table-filter" class="bg-gray-700 text-xs px-2 py-1 rounded flex-1">
          <option value="">ëª¨ë“  í…Œì´ë¸”</option>
        </select>
        <select id="status-filter" class="bg-gray-700 text-xs px-2 py-1 rounded">
          <option value="">ì „ì²´</option>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="completed">ì™„ë£Œ</option>
        </select>
      </div>
      <div id="hand-list" class="flex-1 overflow-y-auto" style="max-height: calc(100vh - 180px);">
        <!-- í•¸ë“œ ë¦¬ìŠ¤íŠ¸ ë™ì  ìƒì„± -->
      </div>
    </div>

    <!-- ì¤‘ì•™: í•¸ë“œ ìƒì„¸ ì •ë³´ -->
    <div class="section overflow-hidden">
      <!-- í•¸ë“œ í—¤ë” ì •ë³´ -->
      <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-700">
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-3">
            <span class="text-sm font-bold">Hand #<span id="hand-number">-</span></span>
            <span class="text-xs text-gray-400">Table: <span id="table-name">-</span></span>
            <span class="text-xs text-gray-400">Blinds: <span id="blinds">-</span></span>
          </div>
          <div class="text-xs text-blue-300">
            ğŸ“¹ <span id="camera-files">-</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="edit-btn" class="px-2 py-1 bg-yellow-600 text-xs rounded">í¸ì§‘</button>
          <button id="complete-btn" class="px-2 py-1 bg-green-600 text-xs rounded">ì™„ë£Œ</button>
        </div>
      </div>

      <!-- íŒŸ ì •ë³´ -->
      <div class="pot-display mb-3">
        POT: <span id="pot-amount">0</span>
      </div>

      <!-- ë³´ë“œ ì¹´ë“œ -->
      <div class="mb-3">
        <div class="section-header">Board</div>
        <div id="board-cards" class="flex justify-center gap-1">
          <!-- ë³´ë“œ ì¹´ë“œ ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- í”Œë ˆì´ì–´ ì¹´ë“œ ì„¹ì…˜ -->
      <div class="mb-3">
        <div class="section-header">Players</div>
        <div id="players-section" class="player-list" style="max-height: 180px; overflow-y: auto;">
          <!-- í”Œë ˆì´ì–´ ì •ë³´ ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- ì•¡ì…˜ íˆìŠ¤í† ë¦¬ -->
      <div class="flex-1">
        <div class="section-header">Actions</div>
        <div id="action-history" style="max-height: calc(100vh - 520px); overflow-y: auto;">
          <!-- ì•¡ì…˜ íˆìŠ¤í† ë¦¬ ë™ì  ìƒì„± -->
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ìš”ì•½ ì •ë³´ -->
    <div class="section">
      <!-- í†µê³„ -->
      <div class="mb-3">
        <div class="section-header">í†µê³„</div>
        <div class="grid grid-cols-2 gap-2">
          <div class="bg-gray-800 rounded p-2">
            <div class="text-xs text-gray-400">ì´ í•¸ë“œ</div>
            <div class="text-lg font-bold" id="total-hands">0</div>
          </div>
          <div class="bg-gray-800 rounded p-2">
            <div class="text-xs text-gray-400">ì™„ë£Œ</div>
            <div class="text-lg font-bold text-green-400" id="completed-hands">0</div>
          </div>
        </div>
      </div>

      <!-- í•¸ë“œ ê²°ê³¼ -->
      <div class="mb-3">
        <div class="section-header">ê²°ê³¼</div>
        <div id="hand-result" class="bg-gray-800 rounded p-3">
          <div class="text-xs text-gray-400">ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>

      <!-- í¸ì§‘ ë…¸íŠ¸ -->
      <div class="flex-1">
        <div class="section-header">ë…¸íŠ¸</div>
        <textarea id="hand-notes" 
          class="w-full flex-1 bg-gray-800 rounded p-2 text-xs resize-none" 
          style="min-height: 100px;"
          placeholder="í•¸ë“œ ë¶„ì„ ë…¸íŠ¸..."></textarea>
        <button id="save-notes" class="mt-2 w-full px-3 py-1 bg-blue-600 text-white rounded text-xs">
          ë…¸íŠ¸ ì €ì¥
        </button>
      </div>
    </div>
  </div>

  <!-- ì™„ë£Œ íŒŒì¼ëª… ì…ë ¥ ëª¨ë‹¬ -->
  <div id="completion-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ“ í•¸ë“œ í¸ì§‘ ì™„ë£Œ</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">ìµœì¢… íŒŒì¼ëª…</label>
          <input type="text" id="final-filename" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 placeholder="ì˜ˆ: 2025-09-05_Hand91_Final.mp4">
        </div>
        <div>
          <label class="block text-sm mb-2">í•¸ë“œ ì‹œê°„ (ì‹œ:ë¶„:ì´ˆ)</label>
          <input type="text" id="hand-timestamp" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm mono" 
                 readonly>
        </div>
        <div>
          <label class="block text-sm mb-2">ë§¤ì¹­ëœ Virtual ì‹œíŠ¸ í–‰ (ì‹œê°„ ì •ë³´)</label>
          <input type="text" id="matched-row" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 readonly>
        </div>
        <div>
          <label class="block text-sm mb-2">AI ë¶„ì„ ìš”ì•½ (3ì¤„)</label>
          <textarea id="ai-summary" 
                    class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                    rows="3"
                    placeholder="AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ìš”ì•½í•©ë‹ˆë‹¤..."
                    readonly></textarea>
        </div>
        <div class="text-xs text-gray-400">
          <p>âœ… Virtual ì‹œíŠ¸ì˜ ê°€ì¥ ë¹„ìŠ·í•œ ì‹œê°„ í–‰ì„ ì°¾ì•„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤</p>
          <p>âœ… Fì—´: íŒŒì¼ëª…, Hì—´: AI ìš”ì•½ì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤</p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-completion" class="px-4 py-2 bg-gray-600 rounded text-sm">ì·¨ì†Œ</button>
        <button id="open-sheet-update" class="px-4 py-2 bg-blue-600 rounded text-sm">ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸</button>
        <button id="confirm-completion" class="px-4 py-2 bg-green-600 rounded text-sm">ì™„ë£Œ ì²˜ë¦¬</button>
      </div>
    </div>
  </div>

  <!-- ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ -->
  <div id="sheet-update-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ“Š Virtual ì‹œíŠ¸ ì—…ë°ì´íŠ¸</h2>
      <div class="space-y-4">
        <div class="bg-gray-700 rounded p-3 mb-4">
          <h3 class="text-sm font-bold mb-2">ğŸ¯ ë§¤ì¹­ ì •ë³´</h3>
          <div class="text-sm space-y-1">
            <div>ğŸ“ ë§¤ì¹­ëœ í–‰: <span id="update-matched-row" class="font-mono">-</span></div>
            <div>ğŸ”¢ í•¸ë“œ ë²ˆí˜¸: <span id="update-hand-number" class="font-mono">-</span></div>
            <div>â° ë§¤ì¹­ ì‹œê°„: <span id="update-matched-time" class="font-mono">-</span></div>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2">ğŸ“ Fì—´ - íŒŒì¼ëª…</label>
          <input type="text" id="update-filename" 
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm" 
                 placeholder="íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">
          <p class="text-xs text-gray-400 mt-1">
            ğŸ“ ì˜ˆ: "hand_001_river_bluff.mp4"
          </p>
        </div>
        <div>
          <label class="block text-sm mb-2">ğŸ¤– Hì—´ - AI ë¶„ì„ ë‚´ìš©</label>
          <textarea id="update-ai-analysis" 
                    class="w-full bg-gray-700 rounded px-3 py-2 text-sm h-24 resize-none"
                    placeholder="AI ë¶„ì„ ê²°ê³¼ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥..."
                    readonly>ë¶„ì„ ì‹¤íŒ¨</textarea>
          <p class="text-xs text-gray-400 mt-1">
            ğŸ“Š í˜„ì¬ëŠ” "ë¶„ì„ ì‹¤íŒ¨"ë¡œ ê³ ì • (ì¶”í›„ AI ë¶„ì„ ì—°ë™ ì˜ˆì •)
          </p>
        </div>
        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-yellow-400">âš ï¸</span>
            <span class="text-sm font-semibold">ì—…ë°ì´íŠ¸ í™•ì¸</span>
          </div>
          <div class="text-xs text-gray-300 space-y-1">
            <div>â€¢ <strong>ì½ê¸° ì‹œíŠ¸:</strong> Bì—´ ê¸°ì¤€ ì‹œê°„ ë§¤ì¹­</div>
            <div>â€¢ <strong>ì“°ê¸° ì‹œíŠ¸:</strong> Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„) ì—…ë°ì´íŠ¸</div>
            <div>â€¢ <strong>Apps Script:</strong> ìë™ ì—…ë°ì´íŠ¸ ì‹¤í–‰</div>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-sheet-update" class="px-4 py-2 bg-gray-600 rounded text-sm hover:bg-gray-700">ì·¨ì†Œ</button>
        <button id="confirm-sheet-update" class="px-4 py-2 bg-blue-600 rounded text-sm hover:bg-blue-700">
          ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        </button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-lg font-bold mb-4">ì„¤ì •</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">ìƒˆë¡œê³ ì¹¨ ê°„ê²©</label>
          <select id="refresh-interval" class="w-full bg-gray-700 rounded px-3 py-2">
            <option value="5000">5ì´ˆ</option>
            <option value="10000" selected>10ì´ˆ</option>
            <option value="30000">30ì´ˆ</option>
            <option value="60000">1ë¶„</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="enable-notifications" checked>
          <label for="enable-notifications" class="text-sm">ìƒˆ í•¸ë“œ ì•Œë¦¼ í™œì„±í™”</label>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="enable-sound" checked>
          <label for="enable-sound" class="text-sm">ì†Œë¦¬ ì•Œë¦¼ í™œì„±í™”</label>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-bold mb-2">ğŸ“Š Apps Script ì‹œíŠ¸ ì—°ë™</h3>
          <div class="mb-2">
            <label class="block text-xs mb-1">ğŸ“– ì½ê¸°ìš© CSV ì‹œíŠ¸ URL</label>
            <input type="text" id="read-sheet-url" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm border-2 border-gray-600" 
                   placeholder="Virtual ì‹œíŠ¸ CSV URL (Bì—´ ê¸°ì¤€)..."
                   title="ë§¤ì¹­ì— ì‚¬ìš©ë˜ëŠ” Virtual ì‹œíŠ¸ CSV URL">
            <div id="read-sheet-url-feedback" class="text-xs mt-1 text-gray-400">
              âœ… Bì—´ ê¸°ì¤€ ì‹œê°„ ë§¤ì¹­ì— ì‚¬ìš©
            </div>
          </div>
          <div class="mb-2">
            <label class="block text-xs mb-1">âœï¸ ì“°ê¸°ìš© ì‹œíŠ¸ URL</label>
            <input type="text" id="write-sheet-url" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm border-2 border-gray-600" 
                   placeholder="ì—…ë°ì´íŠ¸í•  ì‹œíŠ¸ URL..."
                   value="https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/edit?gid=561799849#gid=561799849"
                   title="Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„) ì—…ë°ì´íŠ¸í•  ì‹œíŠ¸">
            <div id="write-sheet-url-feedback" class="text-xs mt-1 text-gray-400">
              âœ… Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„) ì—…ë°ì´íŠ¸
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-xs mb-1">ğŸ”— Apps Script Web App URL</label>
            <input type="text" id="apps-script-url" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm border-2 border-gray-600" 
                   placeholder="Apps Script ì›¹ì•± URL..."
                   title="ì‹œíŠ¸ ì—…ë°ì´íŠ¸ìš© Apps Script URL">
            <div id="apps-script-url-feedback" class="text-xs mt-1 text-gray-400">
              ğŸ“ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì „ìš© Apps Script
            </div>
          </div>
          <button id="test-apps-script" class="w-full px-4 py-2 bg-green-600 rounded text-sm hover:bg-green-700 transition mb-2">
            ğŸ§ª Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
        
        <!-- AI API ì„¤ì • ì„¹ì…˜ (Gemini ì „ìš©) -->
        <div class="mt-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-bold mb-2">ğŸ¤– AI ë¶„ì„ ì„¤ì •</h3>
          <div class="mb-2">
            <label class="block text-xs mb-1">ğŸ”‘ Gemini API Key</label>
            <input type="password" id="gemini-api-key" 
                   class="w-full bg-gray-700 rounded px-3 py-1 text-sm" 
                   placeholder="AIzaSy...">
            <div class="text-xs mt-1 text-gray-400">
              <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">
                API í‚¤ ë°œê¸‰í•˜ê¸° â†’
              </a>
            </div>
          </div>
          <div class="text-xs text-gray-500 bg-gray-700 rounded p-2">
            ğŸ’¡ <strong>Gemini API ì‚¬ìš©</strong><br>
            â€¢ Googleì˜ ìµœì‹  AI ëª¨ë¸ë¡œ í•¸ë“œ ë¶„ì„ ìˆ˜í–‰<br>
            â€¢ ë¬´ë£Œ í• ë‹¹ëŸ‰: ì›” 100ë§Œ í† í° (ì¶©ë¶„í•œ ì‚¬ìš©ëŸ‰)
          </div>
          <button id="test-gemini-api" class="w-full mt-2 px-3 py-1 bg-blue-600 rounded text-xs hover:bg-blue-700 transition">
            ğŸ§ª API í‚¤ ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-700">
          <button id="clear-notification-history" class="w-full px-4 py-2 bg-red-600 rounded text-sm hover:bg-red-700 transition">
            ğŸ”„ ë²„í¼ ì´ˆê¸°í™”
          </button>
          <p class="text-xs text-gray-400 mt-2">
            ìµœê·¼ í•¸ë“œ ë²„í¼(ìµœëŒ€ 100ê°œ)ê°€ ì´ˆê¸°í™”ë˜ë©°, ë‹¤ìŒ ë¡œë“œì‹œ ê¸°ì¡´ í•¸ë“œë„ ìƒˆ í•¸ë“œë¡œ ì¸ì‹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="cancel-settings" class="px-4 py-2 bg-gray-600 rounded text-sm">ì·¨ì†Œ</button>
        <button id="save-settings" class="px-4 py-2 bg-blue-600 rounded text-sm">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Virtual ì‹œíŠ¸ ë§¤ì¹­ ì§„í–‰ë¥  ëª¨ë‹¬ -->
  <div id="progress-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-bold mb-4">ğŸ” Virtual ì‹œíŠ¸ ë§¤ì¹­ ì¤‘...</h2>
      <div class="space-y-4">
        <div class="bg-gray-700 rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm">ì§„í–‰ë¥ </span>
            <span id="progress-percentage" class="text-sm font-bold">0%</span>
          </div>
          <div class="w-full bg-gray-600 rounded-full h-2.5">
            <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="text-sm space-y-1">
          <div>ğŸ“ í˜„ì¬ í–‰: <span id="current-row" class="font-mono">-</span></div>
          <div>ğŸ“Š ì´ í–‰ ìˆ˜: <span id="total-rows" class="font-mono">-</span></div>
          <div>â±ï¸ ë‚¨ì€ ì‹œê°„: <span id="remaining-time" class="font-mono">ê³„ì‚° ì¤‘...</span></div>
          <div>ğŸ¯ í˜„ì¬ ìƒíƒœ: <span id="current-status">ì‹œì‘ ì¤‘...</span></div>
        </div>
        
        <div class="text-xs text-gray-400 space-y-1">
          <div>â€¢ Bì—´ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì—¬ ê°€ì¥ ìœ ì‚¬í•œ í–‰ì„ ì°¾ìŠµë‹ˆë‹¤</div>
          <div>â€¢ 30ì´ˆ íƒ€ì„ì•„ì›ƒì´ ì ìš©ë©ë‹ˆë‹¤</div>
        </div>
      </div>
      
      <div class="flex justify-center mt-6">
        <button id="cancel-progress" class="px-4 py-2 bg-red-600 rounded text-sm hover:bg-red-700">ì‘ì—… ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ====================================
    // í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ v9.2.0 - Gemini AI ë¶„ì„ ì‹œìŠ¤í…œ
    // ====================================
    
    const CONFIG = {
      // Google Sheets CSV URLs
      CSV_HAND_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1906746276&single=true&output=csv',
      CSV_INDEX_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1354012271&single=true&output=csv',
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzbya-VriY5oEDOEO4W80VJz4GaY6QhBb38-3JvSrwl5Qo-7K8D0jqbjTO06bO6VAYj/exec',
      
      // ì„¤ì •
      REFRESH_INTERVAL: 10000,
      ENABLE_NOTIFICATIONS: true,
      ENABLE_SOUND: true,
      DEBUG_MODE: false, // ìš´ì˜ í™˜ê²½ìš©
      
      // AI API ì„¤ì • (Gemini ì „ìš©)
      AI_PROVIDER: 'gemini',
      GEMINI_API_KEY: '',
      
      // Apps Script ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„¤ì •
      READ_SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=0&single=true&output=csv', // Bì—´ ê¸°ì¤€ ì‹œê°„ ë§¤ì¹­ìš© ê¸°ë³¸ Virtual ì‹œíŠ¸ CSV URL
      WRITE_SHEET_URL: 'https://docs.google.com/spreadsheets/d/1M-LM2KkwLNOTygtrPVdnYLqqBoz4MmZvbglUaptSYqE/edit?gid=561799849#gid=561799849', // Fì—´(íŒŒì¼ëª…), Hì—´(AIë¶„ì„) ì—…ë°ì´íŠ¸ìš© ì‹œíŠ¸ URL
      SHEET_UPDATE_SCRIPT_URL: '' // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì „ìš© Apps Script URL
    };
    
    // ì „ì—­ ìƒíƒœ
    let currentHand = null;
    let allHands = [];
    let masterHandList = new Map(); // ì˜êµ¬ ì €ì¥ìš© ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡
    const MASTER_LIST_KEY = 'poker_master_hand_list_v1';
    let handData = {};
    let refreshTimerInitial = null;  // ì´ˆê¸° setTimeoutìš©
    let refreshTimerInterval = null;  // ë°˜ë³µ setIntervalìš©
    let lastHandCount = 0;
    let isInitialLoad = true; // ì²« ë¡œë”©ì¸ì§€ í™•ì¸
    
    // ìµœê·¼ 5ê°œ í•¸ë“œë§Œ ì¶”ì í•˜ëŠ” ê°„ë‹¨í•œ ë²„í¼
    class RecentHandsBuffer {
      constructor() {
        this.buffer = [];
        this.maxSize = 100; // 5ê°œëŠ” ë„ˆë¬´ ì ìŒ, 100ê°œë¡œ ì¦ê°€
        this.storageKey = 'poker_recent_hands_buffer_v2'; // ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
        this.loadFromStorage();
      }
      
      // ìƒˆ í•¸ë“œ ì¶”ê°€ (ì¤‘ë³µ ì²´í¬ í¬í•¨)
      addHand(handNumber) {
        const handStr = String(handNumber);
        
        // ì´ë¯¸ ë²„í¼ì— ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        if (this.buffer.includes(handStr)) {
          return false; // ì¤‘ë³µ
        }
        
        // ë²„í¼ì— ì¶”ê°€
        this.buffer.push(handStr);
        
        // ìµœëŒ€ í¬ê¸° ì´ˆê³¼ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°
        while (this.buffer.length > this.maxSize) {
          this.buffer.shift();
        }
        
        this.saveToStorage();
        return true; // ìƒˆ í•¸ë“œ
      }
      
      // í•¸ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      hasHand(handNumber) {
        return this.buffer.includes(String(handNumber));
      }
      
      // ë²„í¼ ìƒíƒœ í™•ì¸
      getStatus() {
        return {
          buffer: [...this.buffer],
          size: this.buffer.length,
          maxSize: this.maxSize
        };
      }
      
      // localStorageì—ì„œ ë¡œë“œ
      loadFromStorage() {
        try {
          const stored = localStorage.getItem(this.storageKey);
          if (stored) {
            this.buffer = JSON.parse(stored) || [];
            console.log(`ğŸ’¾ ìµœê·¼ í•¸ë“œ ë²„í¼ ë¡œë“œ: ${this.buffer.length}ê°œ`);
          }
        } catch (e) {
          console.error('ë²„í¼ ë¡œë“œ ì‹¤íŒ¨:', e);
          this.buffer = [];
        }
      }
      
      // localStorageì— ì €ì¥
      saveToStorage() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.buffer));
        } catch (e) {
          console.error('ë²„í¼ ì €ì¥ ì‹¤íŒ¨:', e);
        }
      }
      
      // ë²„í¼ ì´ˆê¸°í™”
      clear() {
        this.buffer = [];
        this.saveToStorage();
        console.log('ğŸ”„ ìµœê·¼ í•¸ë“œ ë²„í¼ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    }
    
    // ì „ì—­ ë²„í¼ ì¸ìŠ¤í„´ìŠ¤
    const recentHandsBuffer = new RecentHandsBuffer();
    
    // ê¸°ì¡´ ì•Œë¦¼ ê´€ë ¨ ì„¤ì •
    const STORAGE_KEY = 'poker_notified_hands_v3';
    const MAX_STORED_HANDS = 500;
    const NOTIFICATION_COOLDOWN = 30000; // 30ì´ˆ ì¿¨ë‹¤ìš´
    
    // ë””ë²„ê·¸ ëª¨ë“œ
    const DEBUG_MODE = true; // ì½˜ì†”ì— ìƒì„¸ ë¡œê·¸ ì¶œë ¥
    
    
    // ì•Œë¦¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹œê°„ ì •ë³´ í¬í•¨)
    function getNotifiedHands() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          // ê°ì²´ í˜•íƒœë¡œ ì €ì¥ (handNumber: timestamp)
          return data.hands || {};
        }
      } catch (e) {
        console.error('ì•Œë¦¼ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
      }
      return {};
    }
    
    // ì•Œë¦¼ ê¸°ë¡ ì €ì¥ (ì‹œê°„ ì •ë³´ í¬í•¨)
    // ì¤‘ìš”: í•œ ë²ˆ ì•Œë¦¼ì„ í‘œì‹œí•œ í•¸ë“œëŠ” CSVì—ì„œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ë¼ì ¸ë„ 
    // ìµœì†Œ 24ì‹œê°„ ë™ì•ˆì€ ê¸°ë¡ì„ ìœ ì§€í•˜ì—¬ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€
    function saveNotifiedHands(handsMap) {
      try {
        // ë„ˆë¬´ ì˜¤ë˜ëœ ê¸°ë¡ë§Œ ì œê±° (24ì‹œê°„ ì´ìƒ)
        // CSV ì§€ì—°ìœ¼ë¡œ ì¸í•´ í•¸ë“œê°€ ì ì‹œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
        // 7ì¼ì´ ì•„ë‹Œ 24ì‹œê°„ìœ¼ë¡œ ë‹¨ì¶•í•˜ì—¬ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ
        const now = Date.now();
        const oneDayAgo = now - (24 * 60 * 60 * 1000);
        const cleanedHands = {};
        
        // ê¸°ì¡´ ì €ì¥ëœ ëª¨ë“  í•¸ë“œ ìœ ì§€ (24ì‹œê°„ ë‚´)
        const existingData = getNotifiedHands();
        for (const [handNumber, timestamp] of Object.entries(existingData)) {
          if (timestamp > oneDayAgo) {
            cleanedHands[handNumber] = timestamp;
          }
        }
        
        // ìƒˆë¡œìš´ í•¸ë“œ ì¶”ê°€/ì—…ë°ì´íŠ¸
        for (const [handNumber, timestamp] of Object.entries(handsMap)) {
          cleanedHands[handNumber] = timestamp;
        }
        
        // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
        const entries = Object.entries(cleanedHands);
        if (entries.length > MAX_STORED_HANDS) {
          // ê°€ì¥ ì˜¤ë˜ëœ ê²ƒë“¤ ì œê±°
          entries.sort((a, b) => a[1] - b[1]);
          const toKeep = entries.slice(-MAX_STORED_HANDS);
          const finalHands = {};
          toKeep.forEach(([handNumber, timestamp]) => {
            finalHands[handNumber] = timestamp;
          });
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            hands: finalHands,
            lastUpdated: new Date().toISOString()
          }));
        } else {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            hands: cleanedHands,
            lastUpdated: new Date().toISOString()
          }));
        }
        
        if (DEBUG_MODE) {
          console.log(`ğŸ’¾ ì•Œë¦¼ ê¸°ë¡ ì €ì¥: ì´ ${Object.keys(cleanedHands).length}ê°œ í•¸ë“œ ê¸°ë¡ ìœ ì§€`);
        }
      } catch (e) {
        console.error('ì•Œë¦¼ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }
    
    // ì•Œë¦¼ ê¸°ë¡ ì´ˆê¸°í™” (ê°ì²´ í˜•íƒœ: {handNumber: timestamp})
    let notifiedHands = getNotifiedHands();
    let lastDataSnapshot = ''; // ë§ˆì§€ë§‰ ë°ì´í„° ìŠ¤ëƒ…ìƒ· (ë°ì´í„° ë³€ê²½ ê°ì§€ìš©)
    
    // ====================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ====================================
    
    // Google Sheets CSV Fetch í•¨ìˆ˜ (GitHub ì €ì¥ì†Œ ë°©ì‹ + í”„ë¡ì‹œ fallback)
    async function fetchCsvWithFallback(url) {
      console.log(`ğŸ”„ CSV ê°€ì ¸ì˜¤ê¸° ì‹œë„: ${url}`);
      
      try {
        // ë°©ë²• 1: GitHub ì €ì¥ì†Œì™€ ë™ì¼í•œ ì§ì ‘ fetch
        console.log('ğŸ”„ ë°©ë²• 1: ì§ì ‘ fetch ì‹œë„ (GitHub ë°©ì‹)');
        const res = await fetch(url);
        
        console.log(`ğŸ“Š HTTP ì‘ë‹µ: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
          throw new Error(`CSV fetch failed: ${res.status}`);
        }
        
        const txt = await res.text();
        console.log(`âœ… ì§ì ‘ ë°©ë²• ì„±ê³µ: ${txt.length}ê¸€ì`);
        
        return { 
          response: {
            ok: true,
            status: res.status,
            statusText: res.statusText,
            headers: { get: (key) => res.headers.get(key) }
          },
          fetchMethod: 'ì§ì ‘ fetch (GitHub ë°©ì‹)',
          csvText: txt
        };
        
      } catch (error) {
        console.log(`âŒ ì§ì ‘ ë°©ë²• ì‹¤íŒ¨: ${error.message}`);
        console.log('ğŸ’¡ CORS ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í”„ë¡ì‹œ ë°©ë²•ì„ ì‹œë„í•©ë‹ˆë‹¤.');
        
        // ë°©ë²• 2: í”„ë¡ì‹œ (CORS ìš°íšŒ)
        try {
          console.log('ğŸ”„ ë°©ë²• 2: AllOrigins í”„ë¡ì‹œ ì‹œë„');
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
          const proxyResponse = await fetch(proxyUrl);
          
          if (!proxyResponse.ok) {
            throw new Error(`í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: ${proxyResponse.status}`);
          }
          
          const proxyData = await proxyResponse.json();
          
          if (!proxyData.contents) {
            throw new Error('í”„ë¡ì‹œì—ì„œ ë¹ˆ ë°ì´í„° ë°˜í™˜');
          }
          
          let csvText = proxyData.contents;
          
          // Base64ë¡œ ì¸ì½”ë”©ëœ ë°ì´í„°ì¸ì§€ í™•ì¸ ë° ë””ì½”ë”©
          if (csvText.startsWith('data:text/csv;base64,')) {
            console.log('ğŸ”„ Base64 ì¸ì½”ë”© ë°ì´í„° ê°ì§€ - ë””ì½”ë”© ì¤‘...');
            const base64Data = csvText.replace('data:text/csv;base64,', '');
            try {
              csvText = atob(base64Data);
              console.log(`âœ… Base64 ë””ì½”ë”© ì„±ê³µ: ${csvText.length}ê¸€ì`);
            } catch (decodeError) {
              console.error(`âŒ Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`);
              throw new Error(`Base64 ë””ì½”ë”© ì‹¤íŒ¨: ${decodeError.message}`);
            }
          }
          
          console.log(`âœ… í”„ë¡ì‹œ ë°©ë²• ì„±ê³µ: ${csvText.length}ê¸€ì`);
          
          return {
            response: {
              ok: true,
              status: 200,
              statusText: 'OK (via Proxy)'
            },
            fetchMethod: 'AllOrigins í”„ë¡ì‹œ',
            csvText: csvText
          };
          
        } catch (error2) {
          console.log(`âŒ í”„ë¡ì‹œ ë°©ë²• ì‹¤íŒ¨: ${error2.message}`);
          
          // ë°©ë²• 3: cors-anywhere ë°±ì—… í”„ë¡ì‹œ
          try {
            console.log('ğŸ”„ ë°©ë²• 3: cors-anywhere í”„ë¡ì‹œ ì‹œë„');
            const corsUrl = `https://cors-anywhere.herokuapp.com/${url}`;
            const corsResponse = await fetch(corsUrl);
            
            if (!corsResponse.ok) {
              throw new Error(`CORS í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: ${corsResponse.status}`);
            }
            
            const corsTxt = await corsResponse.text();
            console.log(`âœ… CORS í”„ë¡ì‹œ ë°©ë²• ì„±ê³µ: ${corsTxt.length}ê¸€ì`);
            
            return {
              response: {
                ok: true,
                status: 200,
                statusText: 'OK (via CORS Proxy)'
              },
              fetchMethod: 'CORS Anywhere í”„ë¡ì‹œ',
              csvText: corsTxt
            };
            
          } catch (error3) {
            console.log(`âŒ CORS í”„ë¡ì‹œ ë°©ë²• ì‹¤íŒ¨: ${error3.message}`);
            throw new Error(`ëª¨ë“  CSV fetch ë°©ë²• ì‹¤íŒ¨. ì§ì ‘: ${error.message}, AllOrigins: ${error2.message}, CORS-Anywhere: ${error3.message}`);
          }
        }
      }
    }
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const rows = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const row = [];
        let inQuotes = false;
        let currentField = '';
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(currentField.trim());
            currentField = '';
          } else {
            currentField += char;
          }
        }
        row.push(currentField.trim());
        rows.push(row);
      }
      
      return rows;
    }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(num);
    }
    
    function getSuitSymbol(suit) {
      const symbols = {
        's': 'â™ ', 'h': 'â™¥', 'd': 'â™¦', 'c': 'â™£'
      };
      return symbols[suit.toLowerCase()] || '';
    }
    
    function getSuitClass(suit) {
      const classes = {
        's': 'spade', 'h': 'heart', 'd': 'diamond', 'c': 'club'
      };
      return classes[suit.toLowerCase()] || '';
    }
    
    function createCardElement(card, type = 'mini') {
      if (!card || card === '?' || card.length < 2) {
        // ì•Œ ìˆ˜ ì—†ëŠ” ì¹´ë“œë„ í°ìƒ‰ ë°”íƒ•ìœ¼ë¡œ í‘œì‹œ (ë‹¤í¬ëª¨ë“œ ë¬´ì‹œ)
        return `<div class="${type === 'board' ? 'board-card' : 'card-mini'}" style="background-color: #FFFFFF !important; color: #6b7280; border-style: dashed; color-scheme: light;">?</div>`;
      }
      
      const rank = card.slice(0, -1);
      const suit = card.slice(-1);
      const suitClass = getSuitClass(suit);
      const suitSymbol = getSuitSymbol(suit);
      
      // ìŠ¤í˜ì´ë“œ/í´ë¡œë²„ëŠ” ê²€ì€ìƒ‰, í•˜íŠ¸/ë‹¤ì´ì•„ëŠ” ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ê°•ì œ ì„¤ì •
      const textColor = (suit === 's' || suit === 'c') ? '#000000' : '#dc2626';
      
      // ì¹´ë“œì— ë­í¬ì™€ ë¬¸ì–‘ í‘œì‹œ
      return `<div class="${type === 'board' ? 'board-card' : 'card-mini'} ${suitClass}" style="background-color: #FFFFFF !important; color: ${textColor} !important; color-scheme: light;">
        <div style="display: flex; align-items: center; gap: 2px; color: ${textColor} !important;">
          <span style="font-weight: 900; color: ${textColor} !important;">${rank}</span>
          <span style="font-size: ${type === 'board' ? '16px' : '12px'}; color: ${textColor} !important;">${suitSymbol}</span>
        </div>
      </div>`;
    }
    
    function getActionBadgeClass(action) {
      const actionMap = {
        'FOLD': 'fold',
        'CHECK': 'check',
        'CALL': 'call',
        'CHECK/CALL': 'call',  // CHECK/CALL í†µí•© ì²˜ë¦¬
        'BET': 'bet',
        'RAISE': 'raise',
        'RAISE TO': 'raise',
        'ALL-IN': 'allin',
        'ALLIN': 'allin'
      };
      return actionMap[action.toUpperCase()] || 'check';
    }
    
    // ì•¡ì…˜ í‘œì‹œ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜ (ì´ë¯¸ ë³€í™˜ëœ ë°ì´í„°ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜)
    function getActionDisplayText(action) {
      if (!action) return '-';
      // ì´ë¯¸ íŒŒì‹± ë‹¨ê³„ì—ì„œ CHECK/CALLë¡œ ë³€í™˜ë˜ì—ˆìŒ
      return action.toUpperCase();
    }
    
    function getPositionBadgeClass(position) {
      const posMap = {
        'BTN': 'btn',
        'SB': 'sb',
        'BB': 'bb',
        'UTG': 'utg',
        'MP': 'mp',
        'CO': 'co'
      };
      return posMap[position] || '';
    }
    
    // ì¹´ë©”ë¼ íŒŒì¼ëª… ë³€í™˜ í•¨ìˆ˜
    function formatCameraFileName(camFiles) {
      if (!camFiles || camFiles.length === 0) return [];
      
      const formattedFiles = [];
      
      // ì¹´ë©”ë¼ ì´ë¦„ê³¼ ë²ˆí˜¸ë¥¼ í˜ì–´ë¡œ ì²˜ë¦¬
      for (let i = 0; i < camFiles.length; i += 2) {
        const camName = camFiles[i];
        const camNumber = camFiles[i + 1];
        
        if (camName && camNumber) {
          // ìˆ«ìë¥¼ 4ìë¦¬ë¡œ íŒ¨ë”© (ì˜ˆ: 115 -> 0115)
          const paddedNumber = String(camNumber).padStart(4, '0');
          formattedFiles.push(camName + paddedNumber);
        } else if (camName && !camNumber) {
          // ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì¶”ê°€
          formattedFiles.push(camName);
        }
      }
      
      return formattedFiles;
    }
    
    // ====================================
    // ê°„ë‹¨í•œ ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
    // ====================================
    
    function isCSVDataValid(newData) {
      // ê¸°ë³¸ì ì¸ ë°ì´í„° ìœ íš¨ì„±ë§Œ ì²´í¬
      if (!newData || newData.length === 0) {
        console.warn('âš ï¸ CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');
        return false;
      }
      
      // í•¸ë“œ ë²ˆí˜¸ê°€ ìˆëŠ” ë°ì´í„° í™•ì¸
      const validHands = newData.filter(h => h.handNumber && !isNaN(parseInt(h.handNumber)));
      if (validHands.length === 0) {
        console.warn('âš ï¸ ìœ íš¨í•œ í•¸ë“œê°€ ì—†ìŒ');
        return false;
      }
      
      return true;
    }
    
    // ====================================
    // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    // ====================================
    
    async function loadIndexData(suppressNotification = false) {
      console.log(`ğŸ”„ loadIndexData í˜¸ì¶œ - ì•Œë¦¼ ì–µì œ: ${suppressNotification}, ì´ˆê¸°ë¡œë“œ: ${isInitialLoad}`);
      console.log(`ğŸ“Š CONFIG.CSV_INDEX_URL: ${CONFIG.CSV_INDEX_URL}`);
      try {
        // ëœë¤ íŒŒë¼ë¯¸í„° ì¶”ê°€ë¡œ ìºì‹œ ë°©ì§€ ê°•í™”
        const randomParam = Math.random().toString(36).substring(7);
        const csvUrl = CONFIG.CSV_INDEX_URL + '&t=' + Date.now() + '&r=' + randomParam;
        console.log(`ğŸŒ CSV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°: ${csvUrl.substring(0, 100)}...`);
        
        // CORS ë¬¸ì œë¥¼ ìœ„í•œ ëŒ€ì•ˆ ì‹œë„
        let text;
        try {
          const response = await fetch(csvUrl);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          text = await response.text();
        } catch (error) {
          if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
            console.log('ğŸ”„ CORS ì˜¤ë¥˜ ê°ì§€, í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•œ ì¬ì‹œë„...');
            // ê°„ë‹¨í•œ CORS í”„ë¡ì‹œ ì‹œë„
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl);
            const proxyResponse = await fetch(proxyUrl);
            if (!proxyResponse.ok) {
              throw new Error(`í”„ë¡ì‹œ ì„œë²„ ì˜¤ë¥˜: ${proxyResponse.status}`);
            }
            text = await proxyResponse.text();
            console.log('âœ… í”„ë¡ì‹œë¥¼ í†µí•œ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
          } else {
            throw error;
          }
        }
        console.log(`ğŸ“„ CSV ì›ë³¸ ë°ì´í„° í¬ê¸°: ${text.length}ë¬¸ì`);
        
        const rows = parseCSV(text);
        console.log(`ğŸ“„ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}ê°œ`);
        
        const dataRows = rows.slice(1);
        
        // CSVì—ì„œ ì½ì€ ìƒˆë¡œìš´ í•¸ë“œ ë°ì´í„°
        const newHandsFromCSV = dataRows.map(row => {
          // lastActionì—ì„œë„ CHECK/CALL í†µí•©
          let lastAction = row[15];
          if (lastAction === 'CHECK' || lastAction === 'CALL') {
            lastAction = 'CHECK/CALL';
          }
          
          return {
            handNumber: row[0],
            startRow: parseInt(row[1]),
            endRow: parseInt(row[2]),
            handUpdatedAt: row[3],
            handEdit: row[4] === 'TRUE',
            handEditTime: row[5],
            table: row[7],
            cam: row[9], // Jì—´ - Cam ì •ë³´
            camFiles: formatCameraFileName([row[10], row[11], row[12], row[13]].filter(file => file && file.trim())), // K-Nì—´ - CamFile ì •ë³´ë¥¼ ë³€í™˜
            lastStreet: row[14],
            lastAction: lastAction,
            workStatus: row[16] || 'ëŒ€ê¸°ì¤‘'
          };
        });
        
        // ê¸°ë³¸ì ì¸ ë°ì´í„° ìœ íš¨ì„± ì²´í¬
        if (!isCSVDataValid(newHandsFromCSV)) {
          console.warn('ğŸš« ë¹„ì–´ìˆëŠ” CSV ë°ì´í„°, ëŒ€ê¸°ì¤‘...');
          return;
        }
        
        console.log(`ğŸ“„ CSVì—ì„œ ${newHandsFromCSV.length}ê°œ í•¸ë“œ ë¡œë“œ ì™„ë£Œ`);
        if (DEBUG_MODE && newHandsFromCSV.length > 0) {
          console.log('ğŸ” ë¡œë“œëœ í•¸ë“œ ë²ˆí˜¸:', newHandsFromCSV.map(h => h.handNumber).slice(0, 5));
        }
        
        // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ì— ë³‘í•© (ì‚­ì œí•˜ì§€ ì•Šê³  ì¶”ê°€ë§Œ)
        for (const hand of newHandsFromCSV) {
          masterHandList.set(hand.handNumber, hand);
        }
        
        // í‘œì‹œìš© ë°°ì—´ ìƒì„± (ë§ˆìŠ¤í„° ëª©ë¡ì—ì„œ)
        allHands = Array.from(masterHandList.values());
        allHands.sort((a, b) => parseInt(b.handNumber) - parseInt(a.handNumber));
        
        console.log(`ğŸ“ ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡: ì´ ${masterHandList.size}ê°œ í•¸ë“œ`);
        
        // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥
        saveMasterHandList();
        
        // ìƒˆ í•¸ë“œ ê°ì§€ ë° ì•Œë¦¼ ì²˜ë¦¬
        if (!isInitialLoad && !suppressNotification) {
          const handsToNotify = [];
          
          for (const hand of newHandsFromCSV) {
            const handNumber = hand.handNumber;
            
            // RecentHandsBufferì— ì¶”ê°€ - ìƒˆ í•¸ë“œì´ë©´ true ë°˜í™˜
            if (recentHandsBuffer.addHand(handNumber)) {
              handsToNotify.push(handNumber);
            }
          }
          
          // ì•Œë¦¼ ë°œì†¡
          if (handsToNotify.length > 0 && CONFIG.ENABLE_NOTIFICATIONS) {
            console.log(`ğŸ”” ìƒˆë¡œìš´ í•¸ë“œ ì•Œë¦¼: ${handsToNotify.join(', ')}`);
            showNotification(`${handsToNotify.length}ê°œì˜ ìƒˆë¡œìš´ í•¸ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (${handsToNotify.join(', ')})`);
            playSound('notification');
            
            // ê¸°ì¡´ ì•Œë¦¼ ì‹œìŠ¤í…œì—ë„ ê¸°ë¡ (í˜¸í™˜ì„±)
            const now = Date.now();
            for (const handNumber of handsToNotify) {
              notifiedHands[handNumber] = now;
            }
            saveNotifiedHands(notifiedHands);
          }
        } else if (isInitialLoad) {
          // ì´ˆê¸° ë¡œë”©ì‹œ ëª¨ë“  í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€ (ì•Œë¦¼ ì—†ì´)
          console.log(`ğŸ” ì´ˆê¸° ë¡œë”©: ${newHandsFromCSV.length}ê°œ í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€`);
          
          // ëª¨ë“  í•¸ë“œë¥¼ ë²„í¼ì— ì¶”ê°€ (ìµœëŒ€ 100ê°œê¹Œì§€ ì €ì¥)
          for (const hand of newHandsFromCSV) {
            recentHandsBuffer.addHand(hand.handNumber);
          }
          
          // ì´ˆê¸° ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
          isInitialLoad = false;
          const bufferStatus = recentHandsBuffer.getStatus();
          console.log(`ğŸš€ ì´ˆê¸° ë¡œë”© ì™„ë£Œ. í•¸ë“œ ìˆ˜: ${newHandsFromCSV.length}ê°œ, ë²„í¼: ${bufferStatus.size}ê°œ`);
        }
        
        updateHandList();
        updateStats();
        
      } catch (error) {
        console.error('Index ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }
    
    async function loadHandData(handNumber) {
      try {
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        const hand = allHands.find(h => h.handNumber === handNumber);
        if (!hand) return null;
        
        const handRows = rows.slice(hand.startRow - 1, hand.endRow);
        return parseHandDetails(handRows);
        
      } catch (error) {
        console.error('Hand ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        return null;
      }
    }
    
    function parseHandDetails(rows) {
      const hand = {
        number: '',
        table: '',
        blinds: { sb: 0, bb: 0 },
        players: [],
        actions: [],
        communityCards: [],
        pot: 0,
        winner: null,
        streets: {
          preflop: [],
          flop: [],
          turn: [],
          river: [],
          showdown: []
        },
        potContributions: {} // ê° í”Œë ˆì´ì–´ë³„ íŒŸ ê¸°ì—¬ë„ ì¶”ì 
      };
      
      let currentStreet = 'preflop';
      let streetBetAmount = {}; // ê° ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ í˜„ì¬ ë² íŒ… ê¸ˆì•¡ ì¶”ì 
      streetBetAmount['preflop'] = 0;
      streetBetAmount['flop'] = 0;
      streetBetAmount['turn'] = 0;
      streetBetAmount['river'] = 0;
      
      for (const row of rows) {
        const rowType = row[1];
        
        switch (rowType) {
          case 'HAND':
            hand.number = row[2];
            hand.timestamp = row[3];
            if (row[11] && row[12]) {
              hand.blinds.sb = parseInt(row[11]) || 0;
              hand.blinds.bb = parseInt(row[12]) || 0;
              // ì´ˆê¸° íŒŸì— SBì™€ BB ì¶”ê°€
              hand.pot = hand.blinds.sb + hand.blinds.bb;
              if (DEBUG_MODE) {
                console.log(`ğŸ’° ì´ˆê¸° íŒŸ ì„¤ì •: SB(${hand.blinds.sb}) + BB(${hand.blinds.bb}) = ${hand.pot}`);
              }
            }
            hand.table = row[16] || '';
            break;
          
          case 'PLAYER':
            const playerName = row[2];
            const seat = parseInt(row[3]) || 0;
            const chips = parseInt(row[5]) || parseInt(row[6]) || 0;
            const cards = row[7] ? row[7].split(' ') : ['?', '?'];
            
            hand.players.push({
              seat: seat,
              name: playerName,
              chips: chips,
              cards: cards.length >= 2 ? cards : [cards[0] || '?', cards[1] || '?'],
              position: '',
              status: 'active'
            });
            break;
          
          case 'EVENT':
            const eventType = row[2];
            
            if (eventType === 'BOARD') {
              const boardNum = parseInt(row[3]) || 0;
              const card = row[4];
              
              if (boardNum === 1) {
                currentStreet = 'flop';
                streetBetAmount['flop'] = 0; // í”Œë¡­ ì‹œì‘ì‹œ ë² íŒ… ê¸ˆì•¡ ì´ˆê¸°í™”
                // ì²« ë²ˆì§¸ í”Œë¡­ ì¹´ë“œ ì¶”ê°€ (ë°°ì—´ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ)
                hand.communityCards.push(card);
              } else if (boardNum === 2 || boardNum === 3) {
                // ë‘ ë²ˆì§¸, ì„¸ ë²ˆì§¸ í”Œë¡­ ì¹´ë“œ ì¶”ê°€
                hand.communityCards.push(card);
              } else if (boardNum === 4) {
                currentStreet = 'turn';
                streetBetAmount['turn'] = 0; // í„´ ì‹œì‘ì‹œ ë² íŒ… ê¸ˆì•¡ ì´ˆê¸°í™”
                hand.communityCards.push(card);
              } else if (boardNum === 5) {
                currentStreet = 'river';
                streetBetAmount['river'] = 0; // ë¦¬ë²„ ì‹œì‘ì‹œ ë² íŒ… ê¸ˆì•¡ ì´ˆê¸°í™”
                hand.communityCards.push(card);
              }
            } else {
              const playerNum = row[3];
              const amount = parseInt(row[4]) || 0;
              
              const playerObj = hand.players.find(p => p.seat === parseInt(playerNum));
              const playerName = playerObj ? playerObj.name : `Player ${playerNum}`;
              
              // CHECKì™€ CALLì„ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ êµ¬ë¶„
              let displayAction = eventType;
              const currentBet = streetBetAmount[currentStreet] || 0;
              
              // CALL ì•¡ì…˜ ì²˜ë¦¬
              if (eventType === 'CALL') {
                // í˜„ì¬ ìŠ¤íŠ¸ë¦¬íŠ¸ì— ë² íŒ…ì´ ì—†ê³  amountê°€ 0ì´ê±°ë‚˜ ì‘ìœ¼ë©´ CHECK
                // ë˜ëŠ” CALLí•˜ë ¤ëŠ” ê¸ˆì•¡ì´ í˜„ì¬ ë² íŒ…ê³¼ ê°™ìœ¼ë©´ CHECK
                if ((currentBet === 0 && amount <= hand.blinds.bb) || amount === currentBet) {
                  displayAction = 'CHECK/CALL';
                  if (DEBUG_MODE) {
                    console.log(`âœ… CHECK ê°ì§€: ${playerName} (${currentStreet}, bet=${currentBet}, amount=${amount})`);
                  }
                } else {
                  // ì§„ì§œ CALL
                  displayAction = 'CHECK/CALL';
                  if (DEBUG_MODE) {
                    console.log(`ğŸ“ CALL ê°ì§€: ${playerName} ${amount} (${currentStreet}, bet=${currentBet})`);
                  }
                }
              } else if (eventType === 'CHECK') {
                displayAction = 'CHECK/CALL';
              }
              
              // BETì´ë‚˜ RAISEê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ ìŠ¤íŠ¸ë¦¬íŠ¸ì˜ ë² íŒ… ê¸ˆì•¡ ì—…ë°ì´íŠ¸
              if (eventType === 'BET' || eventType === 'RAISE' || eventType === 'RAISE TO') {
                streetBetAmount[currentStreet] = amount;
                if (DEBUG_MODE) {
                  console.log(`ğŸ“Š ${currentStreet} ë² íŒ… ì—…ë°ì´íŠ¸: ${amount}`);
                }
              }
              
              const action = {
                player: playerName,
                action: displayAction,
                amount: amount,
                street: currentStreet
              };
              
              hand.actions.push(action);
              hand.streets[currentStreet].push(action);
              
              // ê°œì„ ëœ pot ê³„ì‚° ë¡œì§
              if (amount > 0) {
                // í”Œë ˆì´ì–´ë³„ ê¸°ì—¬ë„ ì¶”ì 
                if (!hand.potContributions[playerName]) {
                  hand.potContributions[playerName] = 0;
                }
                
                // ëª¨ë“  ë² íŒ… ì•¡ì…˜ì€ ê¸°ë¡ëœ amountë¥¼ ê·¸ëŒ€ë¡œ íŒŸì— ì¶”ê°€
                // CSV ë°ì´í„°ê°€ ì´ë¯¸ ì •í™•í•œ ê¸ˆì•¡ì„ ê¸°ë¡í•˜ê³  ìˆë‹¤ê³  ê°€ì •
                if (eventType === 'BET' || eventType === 'CALL' || eventType === 'RAISE' || 
                    eventType === 'RAISE TO' || eventType === 'ALL-IN' || eventType === 'ALLIN') {
                  hand.pot += amount;
                  hand.potContributions[playerName] += amount;
                  
                  if (DEBUG_MODE) {
                    console.log(`ğŸ’° POT ì¶”ê°€: ${playerName} ${displayAction} ${amount} (í˜„ì¬ POT: ${hand.pot}, ${playerName} ì´ ê¸°ì—¬: ${hand.potContributions[playerName]})`);
                  }
                }
              }
              
              if (eventType === 'FOLD' && playerObj) {
                playerObj.status = 'folded';
              }
            }
            break;
          
          case 'WIN':
            const winnerNum = row[2];
            const winAmount = parseInt(row[3]) || 0;
            const winnerObj = hand.players.find(p => p.seat === parseInt(winnerNum));
            
            hand.winner = {
              player: winnerObj ? winnerObj.name : `Player ${winnerNum}`,
              amount: winAmount,
              hand: row[4] || ''
            };
            break;
        }
      }
      
      calculatePositions(hand);
      return hand;
    }
    
    function calculatePositions(hand) {
      const playerCount = hand.players.length;
      if (playerCount < 2) return;
      
      const positions = getPositionNames(playerCount);
      hand.players.forEach((player, index) => {
        player.position = positions[index];
      });
    }
    
    function getPositionNames(playerCount) {
      const positions = {
        2: ['BTN', 'BB'],
        3: ['BTN', 'SB', 'BB'],
        4: ['BTN', 'SB', 'BB', 'CO'],
        5: ['BTN', 'SB', 'BB', 'UTG', 'CO'],
        6: ['BTN', 'SB', 'BB', 'UTG', 'MP', 'CO'],
        7: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'MP', 'CO'],
        8: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'MP', 'MP+1', 'CO'],
        9: ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'UTG+2', 'MP', 'MP+1', 'CO']
      };
      
      return positions[playerCount] || Array(playerCount).fill('').map((_, i) => `Seat ${i + 1}`);
    }
    
    // ====================================
    // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    // ====================================
    
    function updateHandList() {
      console.log(`ğŸ“‹ updateHandList í˜¸ì¶œ - ì´ í•¸ë“œ ìˆ˜: ${allHands.length}`);
      const listEl = document.getElementById('hand-list');
      const tableFilter = document.getElementById('table-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      
      let filteredHands = allHands;
      
      if (tableFilter) {
        filteredHands = filteredHands.filter(h => h.table === tableFilter);
      }
      
      if (statusFilter) {
        filteredHands = filteredHands.filter(h => {
          if (statusFilter === 'completed') return h.handEdit;
          if (statusFilter === 'pending') return !h.handEdit;
          return true;
        });
      }
      
      listEl.innerHTML = filteredHands.map(hand => {
        // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
        const statusColor = hand.handEdit ? 'border-green-500 bg-green-900/20' : 
                          hand.workStatus === 'ì§„í–‰ì¤‘' ? 'border-yellow-500 bg-yellow-900/20' : 
                          'border-gray-600 bg-gray-800';
        
        // ìŠ¤íŠ¸ë¦¬íŠ¸ë³„ ìƒ‰ìƒ
        const streetColors = {
          'preflop': 'text-purple-400',
          'flop': 'text-blue-400', 
          'turn': 'text-green-400',
          'river': 'text-orange-400',
          'showdown': 'text-yellow-400'
        };
        const streetColor = streetColors[hand.lastStreet?.toLowerCase()] || 'text-gray-400';
        
        // ì‹œê°„ í‘œì‹œ í¬ë§· (ì‹œ:ë¶„:ì´ˆ)
        let time = '-';
        if (hand.handUpdatedAt) {
          // timestampì¸ ê²½ìš° ë³€í™˜
          const timestamp = typeof hand.handUpdatedAt === 'string' ? 
            Date.parse(hand.handUpdatedAt) : hand.handUpdatedAt;
          const handDate = new Date(timestamp);
          if (!isNaN(handDate.getTime())) {
            const h = String(handDate.getHours()).padStart(2, '0');
            const m = String(handDate.getMinutes()).padStart(2, '0');
            const s = String(handDate.getSeconds()).padStart(2, '0');
            time = `${h}:${m}:${s}`;
          }
        }
        
        // ì¹´ë©”ë¼ íŒŒì¼ëª… ì •ë³´ (ì´ë¯¸ ë³€í™˜ëœ í˜•íƒœ)
        const camFilesText = hand.camFiles && hand.camFiles.length > 0 ? 
          hand.camFiles.slice(0, 2).join(', ') + 
          (hand.camFiles.length > 2 ? ` (+${hand.camFiles.length - 2})` : '') : 
          'íŒŒì¼ ì—†ìŒ';

        return `
        <div class="rounded-lg p-3 cursor-pointer hover:scale-105 transition-all border ${statusColor}" 
             onclick="selectHand('${hand.handNumber}')">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-bold text-white">Hand #${hand.handNumber}</span>
            ${hand.handEdit ? '<span class="text-green-400">âœ“</span>' : 
              hand.workStatus === 'ì§„í–‰ì¤‘' ? '<span class="text-yellow-400">âš¡</span>' : ''}
          </div>
          <div class="flex items-center justify-between text-xs">
            <span class="text-gray-300">${hand.table || 'í…Œì´ë¸” -'}</span>
            <span class="${streetColor} font-semibold">${hand.lastStreet || 'Preflop'}</span>
          </div>
          <div class="flex items-center justify-between text-xs mt-1">
            <span class="text-gray-500">${hand.lastAction || '-'}</span>
            <span class="text-gray-500 font-mono">${time}</span>
          </div>
          <div class="text-xs text-blue-300 mt-1 truncate" title="${hand.camFiles?.join(', ') || ''}">
            ğŸ“¹ ${camFilesText}
          </div>
        </div>
      `;
      }).join('');
      
      document.getElementById('hand-count').textContent = filteredHands.length;
      
      // í…Œì´ë¸” í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì„ íƒëœ ê°’ ìœ ì§€)
      const tables = [...new Set(allHands.map(h => h.table).filter(t => t))];
      const tableFilterEl = document.getElementById('table-filter');
      const currentTable = tableFilterEl.value;
      
      // í…Œì´ë¸” ëª©ë¡ì´ ë‹¬ë¼ì¡Œì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
      const currentOptions = Array.from(tableFilterEl.options).slice(1).map(opt => opt.value);
      const hasChanged = tables.length !== currentOptions.length || 
                        tables.some(t => !currentOptions.includes(t));
      
      if (hasChanged) {
        tableFilterEl.innerHTML = '<option value="">ëª¨ë“  í…Œì´ë¸”</option>' +
          tables.map(table => `<option value="${table}">${table}</option>`).join('');
      }
      
      // í˜„ì¬ ì„ íƒëœ ê°’ ë³µì›
      if (currentTable && tables.includes(currentTable)) {
        tableFilterEl.value = currentTable;
      }
    }
    
    function updateStats() {
      document.getElementById('total-hands').textContent = allHands.length;
      document.getElementById('completed-hands').textContent = allHands.filter(h => h.handEdit).length;
    }
    
    async function selectHand(handNumber) {
      currentHand = handNumber;
      
      const hand = await loadHandData(handNumber);
      if (!hand) return;
      
      // ì¸ë±ìŠ¤ì—ì„œ ì¹´ë©”ë¼ íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const indexHand = allHands.find(h => h.handNumber === handNumber);
      
      // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('hand-number').textContent = hand.number;
      document.getElementById('table-name').textContent = hand.table || '-';
      document.getElementById('blinds').textContent = `${hand.blinds.sb}/${hand.blinds.bb}`;
      document.getElementById('pot-amount').textContent = formatNumber(hand.pot);
      
      // ì¹´ë©”ë¼ íŒŒì¼ëª… ì—…ë°ì´íŠ¸ (ì´ë¯¸ ë³€í™˜ëœ í˜•íƒœ)
      const cameraFilesEl = document.getElementById('camera-files');
      if (indexHand && indexHand.camFiles && indexHand.camFiles.length > 0) {
        cameraFilesEl.textContent = indexHand.camFiles.join(', ');
        cameraFilesEl.title = indexHand.camFiles.join('\n');
      } else {
        cameraFilesEl.textContent = 'íŒŒì¼ ì—†ìŒ';
        cameraFilesEl.title = '';
      }
      
      // ë³´ë“œ ì¹´ë“œ í‘œì‹œ
      updateBoardCards(hand.communityCards);
      
      // í”Œë ˆì´ì–´ ì¹´ë“œ í‘œì‹œ
      updatePlayersSection(hand.players);
      
      // ì•¡ì…˜ íˆìŠ¤í† ë¦¬ í‘œì‹œ
      updateActionHistory(hand);
      
      // í•¸ë“œ ê²°ê³¼ í‘œì‹œ
      updateHandResult(hand);
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì™„ë£Œ ìƒíƒœì— ë”°ë¼)
      updateHandStatus(indexHand ? indexHand.handEdit : false);
    }
    
    function updateBoardCards(cards) {
      const container = document.getElementById('board-cards');
      
      // 5ì¥ì˜ ì¹´ë“œ ìŠ¬ë¡¯ í‘œì‹œ (ë¹„ì–´ìˆëŠ” ê²ƒì€ í°ìƒ‰ ì ì„ )
      let html = '';
      for (let i = 0; i < 5; i++) {
        if (cards && cards[i]) {
          html += createCardElement(cards[i], 'board');
        } else {
          html += '<div class="board-card" style="background-color: #FFFFFF !important; color: #9ca3af; border: 2px dashed #d1d5db; color-scheme: light;">?</div>';
        }
      }
      
      container.innerHTML = html;
    }
    
    function updatePlayersSection(players) {
      const container = document.getElementById('players-section');
      
      container.innerHTML = players.map(player => `
        <div class="player-item ${player.status === 'folded' ? 'folded' : ''}">
          <div class="flex items-center gap-2">
            <span class="pos-badge ${getPositionBadgeClass(player.position)}">${player.position}</span>
            <span class="text-xs font-semibold">${player.name}</span>
          </div>
          <div class="flex items-center gap-2">
            ${player.cards.map(card => createCardElement(card)).join('')}
            <span class="text-xs text-gray-400">${formatNumber(player.chips)}</span>
          </div>
        </div>
      `).join('');
    }
    
    function updateActionHistory(hand) {
      const container = document.getElementById('action-history');
      const streets = ['preflop', 'flop', 'turn', 'river', 'showdown'];
      
      let html = '';
      
      streets.forEach(street => {
        if (hand.streets[street] && hand.streets[street].length > 0) {
          html += `<div class="mb-2">`;
          html += `<div class="text-xs font-semibold text-gray-400 uppercase mb-1">${street}</div>`;
          hand.streets[street].forEach(action => {
            html += `
              <div class="action-line ${street}">
                <span class="text-xs">${action.player}</span>
                <span class="action-badge ${getActionBadgeClass(action.action)}">${action.action}</span>
                ${action.amount > 0 ? `<span class="text-xs text-gray-400">${formatNumber(action.amount)}</span>` : ''}
              </div>
            `;
          });
          html += `</div>`;
        }
      });
      
      container.innerHTML = html || '<div class="text-xs text-gray-500">ì•¡ì…˜ ê¸°ë¡ ì—†ìŒ</div>';
    }
    
    function updateHandResult(hand) {
      const container = document.getElementById('hand-result');
      
      if (!hand.winner) {
        container.innerHTML = '<div class="text-xs text-gray-400">ê²°ê³¼ ì—†ìŒ</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="text-sm font-bold text-green-400">${hand.winner.player}</div>
        <div class="text-xs text-gray-300">Win: ${formatNumber(hand.winner.amount)}</div>
        ${hand.winner.hand ? `<div class="text-xs text-gray-400">${hand.winner.hand}</div>` : ''}
      `;
    }
    
    // ====================================
    // ì•Œë¦¼ í•¨ìˆ˜
    // ====================================
    
    function showNotification(message) {
      if (!CONFIG.ENABLE_NOTIFICATIONS) return;
      
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§', {
          body: message,
          icon: '/favicon.ico'
        });
      }
    }
    
    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í˜¸ì¶œ ê°ì§€
    let userInteracted = false;
    document.addEventListener('click', () => { userInteracted = true; }, { once: true });
    document.addEventListener('keydown', () => { userInteracted = true; }, { once: true });
    
    function playSound(type = 'notification') {
      if (!CONFIG.ENABLE_SOUND) {
        console.log('ğŸ”‡ ì†Œë¦¬ ë¹„í™œì„±í™” ìƒíƒœ');
        return;
      }
      
      if (!userInteracted) {
        console.log('ğŸ”‡ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ëŒ€ê¸° ì¤‘ - ì†Œë¦¬ ì¬ìƒ ê±´ë„ˆë›°ê¸°');
        return;
      }
      
      console.log(`ğŸ”” ì†Œë¦¬ ì¬ìƒ ì‹œë„: ${type}`);
      
      const soundMap = {
        // ë¶€ë“œëŸ¬ìš´ ë²¨ ì†Œë¦¬ (ìƒˆ í•¸ë“œ ì•Œë¦¼ìš©)
        notification: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE',
        
        // ì„±ê³µ ì†Œë¦¬ (ì™„ë£Œ/ì—…ë°ì´íŠ¸ ì„±ê³µì‹œ)
        success: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE',
        
        // ì°¨ì„ë²¨ ì†Œë¦¬ (ë” ë¶€ë“œëŸ¬ìš´ ì•Œë¦¼)
        chime: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTgjMGHm7A7+OZURE'
      };
      
      // Web Audio APIë¥¼ ì‚¬ìš©í•œ ë” ì˜ˆìœ ì†Œë¦¬ ìƒì„±
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (type === 'chime') {
          // ë¶€ë“œëŸ¬ìš´ ì°¨ì„ë²¨ ì†Œë¦¬
          playChimeSound(audioContext);
        } else if (type === 'success') {
          // ì„±ê³µ ì†Œë¦¬ (ìƒìŠ¹í•˜ëŠ” í†¤)
          playSuccessSound(audioContext);
        } else {
          // ê¸°ë³¸ ì•Œë¦¼ ì†Œë¦¬ (ë¶€ë“œëŸ¬ìš´ ë²¨)
          playBellSound(audioContext);
        }
        console.log('âœ… ì†Œë¦¬ ì¬ìƒ ì„±ê³µ');
      } catch (error) {
        console.log('âš ï¸ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', error.message);
        // Web Audio API ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ì˜¤ë””ì˜¤ ì‚¬ìš©
        const audio = new Audio(soundMap[type] || soundMap.notification);
        audio.volume = 0.5;
        audio.play().catch(e => console.log('ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', e));
      }
    }
    
    // ë¶€ë“œëŸ¬ìš´ ë²¨ ì†Œë¦¬ ìƒì„±
    function playBellSound(audioContext) {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.3);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
      
      oscillator.type = 'sine';
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.8);
    }
    
    // ì„±ê³µ ì†Œë¦¬ ìƒì„± (ìƒìŠ¹í•˜ëŠ” 3ìŒê³„)
    function playSuccessSound(audioContext) {
      const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
      const duration = 0.15;
      
      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + (index * duration));
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime + (index * duration));
        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + (index * duration) + 0.02);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (index * duration) + duration);
        
        oscillator.start(audioContext.currentTime + (index * duration));
        oscillator.stop(audioContext.currentTime + (index * duration) + duration);
      });
    }
    
    // ì°¨ì„ë²¨ ì†Œë¦¬ ìƒì„± (í™”ìŒ)
    function playChimeSound(audioContext) {
      const frequencies = [523.25, 659.25, 783.99, 1046.5]; // C5, E5, G5, C6 í™”ìŒ
      
      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        oscillator.type = 'sine';
        
        const volume = 0.15 / (index + 1); // ë†’ì€ ìŒì¼ìˆ˜ë¡ ì‘ê²Œ
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 1.2);
      });
    }
    
    // ====================================
    // í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
    // ====================================
    
    // í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function getHandTimestamp(handNumber) {
      try {
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        for (const row of rows) {
          if (row[1] === 'HAND' && row[2] === String(handNumber)) {
            const timestamp = parseInt(row[3]);
            if (!isNaN(timestamp) && timestamp > 0) {
              return timestamp;
            }
          }
        }
      } catch (error) {
        console.error('í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
      return null;
    }
    


    // Virtual ì‹œíŠ¸ì—ì„œ ê°€ì¥ ë¹„ìŠ·í•œ ì‹œê°„ ì°¾ê¸° (ë‚ ì§œ ì œì™¸, ì‹œê°„ë§Œ ë¹„êµ)
    async function findClosestVirtualRow(targetTime, virtualSheetUrl) {
      console.log('ğŸ” === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹œì‘ ===');
      console.log(`ğŸ“‹ ì…ë ¥ URL: ${virtualSheetUrl}`);
      console.log(`â° íƒ€ê²Ÿ íƒ€ì„ìŠ¤íƒ¬í”„: ${targetTime} (${new Date(targetTime * 1000)})`);
      
      // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ
      showProgressModal();
      let isAborted = false;
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
      const timeoutId = setTimeout(() => {
        isAborted = true;
        hideProgressModal();
        console.error('âŒ Virtual ì‹œíŠ¸ ë§¤ì¹­ íƒ€ì„ì•„ì›ƒ (30ì´ˆ ì´ˆê³¼)');
      }, 30000);
      
      try {
        let csvUrl = '';
        
        // URL í˜•ì‹ ê°ì§€ ë° ì ì ˆí•œ CSV URL ìƒì„±
        console.log('\nğŸ“„ === Virtual Sheet CSV ë°ì´í„° ìš”ì²­ ===');
        console.log(`ğŸ”— ì…ë ¥ URL: ${virtualSheetUrl}`);
        console.log('ğŸ” URL í˜•ì‹ ë¶„ì„ ì¤‘...');
        
        let urlType = '';
        
        // 1. ì´ë¯¸ ì›¹ ê²Œì‹œëœ CSV URLì¸ì§€ í™•ì¸ (ê°€ì¥ ê¶Œì¥í•˜ëŠ” í˜•ì‹)
        if (virtualSheetUrl.includes('/pub?') && virtualSheetUrl.includes('output=csv')) {
          console.log('âœ… ì›¹ ê²Œì‹œ CSV URL ê°ì§€ (ê¶Œì¥ í˜•ì‹!)');
          csvUrl = virtualSheetUrl;
          urlType = 'published-csv';
        }
        // 2. ì›¹ ê²Œì‹œëœ ì¼ë°˜ URLì¸ì§€ í™•ì¸ (2PACX í˜•ì‹)
        else if (virtualSheetUrl.includes('/spreadsheets/d/e/2PACX-')) {
          console.log('ğŸ”„ ì›¹ ê²Œì‹œ ì¼ë°˜ URL ê°ì§€ - CSV ë³€í™˜ ì¤‘');
          // gid ì¶”ì¶œ
          const gidMatch = virtualSheetUrl.match(/gid=(\d+)/);
          const gid = gidMatch ? gidMatch[1] : '0';
          const publishedIdMatch = virtualSheetUrl.match(/\/spreadsheets\/d\/e\/(2PACX-[a-zA-Z0-9-_]+)/);
          if (publishedIdMatch) {
            csvUrl = `https://docs.google.com/spreadsheets/d/e/${publishedIdMatch[1]}/pub?gid=${gid}&single=true&output=csv`;
            console.log('âœ… ì›¹ ê²Œì‹œ CSV URLë¡œ ìë™ ë³€í™˜ë¨');
            urlType = 'published-converted';
          } else {
            throw new Error('ì›¹ ê²Œì‹œ URLì—ì„œ IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        }
        // 3. ì¼ë°˜ ì‹œíŠ¸ í¸ì§‘ URLì¸ì§€ í™•ì¸ (ë¹„ì¶”ì²œ - CORS ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)
        else if (virtualSheetUrl.includes('/spreadsheets/d/') && !virtualSheetUrl.includes('/pub?')) {
          console.log('âš ï¸ ì¼ë°˜ í¸ì§‘ URL ê°ì§€ - Export URLë¡œ ë³€í™˜ ì‹œë„');
          console.log('â— ì£¼ì˜: ì´ ë°©ì‹ì€ CORS ë° ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
          const sheetIdMatch = virtualSheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
          if (sheetIdMatch) {
            const sheetId = sheetIdMatch[1];
            // gid ì¶”ì¶œ ì‹œë„
            const gidMatch = virtualSheetUrl.match(/gid=(\d+)/);
            const gid = gidMatch ? gidMatch[1] : '0';
            csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
            console.log('ğŸ”„ Export CSV URLë¡œ ë³€í™˜ë¨');
            console.log('\nğŸ’¡ ê¶Œì¥ í•´ê²°ì±…:');
            console.log('1. Google Sheets ì—´ê¸°');
            console.log('2. íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ');
            console.log('3. "ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê°’(.csv)" ì„ íƒ');
            console.log('4. ê²Œì‹œ í›„ ìƒì„±ëœ CSV ë§í¬ ì‚¬ìš©');
            urlType = 'export-url';
          } else {
            throw new Error('ì‹œíŠ¸ IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        }
        else {
          throw new Error('ì§€ì›ë˜ì§€ ì•ŠëŠ” Google Sheets URL í˜•ì‹ì…ë‹ˆë‹¤.\n\nğŸ“ ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•:\n1. Google Sheets â†’ íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ\n2. "ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê°’(.csv)" ì„ íƒ\n3. ê²Œì‹œ í›„ ìƒì„±ëœ CSV ë§í¬ ì‚¬ìš©\n\nâœ… ì˜¬ë°”ë¥¸ í˜•ì‹ ì˜ˆì‹œ:\nhttps://docs.google.com/spreadsheets/d/e/2PACX-.../pub?gid=0&single=true&output=csv');
        }
        
        console.log(`ğŸ“¡ ìµœì¢… ìš”ì²­ URL: ${csvUrl}`);
        console.log(`ğŸ“‹ URL í˜•ì‹: ${urlType}`);
        
        console.log('ğŸ“¥ Google Sheets CSV ìš”ì²­ ì¤‘... (ë‹¤ì¤‘ ë°©ë²• ì‹œë„)');
        const csvData = await fetchCsvWithFallback(csvUrl);
        const text = csvData.csvText;
        
        console.log(`ğŸ“Š ì‚¬ìš©ëœ ë°©ë²•: ${csvData.fetchMethod}`);
        console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${csvData.response.status} ${csvData.response.statusText}`);
        console.log(`ğŸ“„ CSV ë°ì´í„° í¬ê¸°: ${text.length} characters`);
        console.log(`ğŸ“„ CSV ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²« 500ì):`);
        console.log(text.substring(0, 500) + (text.length > 500 ? '...' : ''));
        
        const rows = parseCSV(text);
        console.log(`ğŸ“‹ íŒŒì‹±ëœ í–‰ ìˆ˜: ${rows.length}`);
        
        if (rows.length === 0) {
          throw new Error('CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ì²« 5í–‰ ë°ì´í„° ìƒ˜í”Œ ë¡œê·¸
        console.log('ğŸ“‹ CSV ë°ì´í„° ìƒ˜í”Œ (ì²« 5í–‰):');
        for (let i = 0; i < Math.min(5, rows.length); i++) {
          console.log(`   í–‰ ${i+1}: A="${rows[i][0] || ''}", B="${rows[i][1] || ''}", C="${rows[i][2] || ''}", D="${rows[i][3] || ''}"`);
        }
        
        // Seoul ì‹œê°„ëŒ€ë¡œ ë³€í™˜ (UTC+9)
        console.log('â° === ì‹œê°„ëŒ€ ë³€í™˜ ì‹œì‘ ===');
        const targetDate = new Date(targetTime * 1000);
        console.log(`ğŸ“… ì›ë³¸ ì‹œê°„ (ë¡œì»¬): ${targetDate.toLocaleString()}`);
        
        const seoulOffset = 9 * 60; // Seoul UTC+9 (ë¶„ ë‹¨ìœ„)
        const localOffset = targetDate.getTimezoneOffset(); // ë¡œì»¬ ì‹œê°„ëŒ€ offset (ë¶„ ë‹¨ìœ„, UTC ê¸°ì¤€)
        console.log(`ğŸŒ Seoul ì˜¤í”„ì…‹: +${seoulOffset/60}ì‹œê°„ (${seoulOffset}ë¶„)`);
        console.log(`ğŸŒ ë¡œì»¬ ì˜¤í”„ì…‹: ${localOffset > 0 ? '-' : '+'}${Math.abs(localOffset/60)}ì‹œê°„ (${localOffset}ë¶„)`);
        
        const seoulTime = new Date(targetTime * 1000 + (seoulOffset + localOffset) * 60 * 1000);
        console.log(`ğŸ‡°ğŸ‡· ë³€í™˜ëœ Seoul ì‹œê°„: ${seoulTime.toLocaleString()}`);
        
        const targetHours = seoulTime.getHours();
        const targetMinutes = seoulTime.getMinutes();
        const targetSeconds = seoulTime.getSeconds();
        
        // ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì •í™•í•œ íƒ€ê²Ÿ ì‹œê°„ ê³„ì‚°
        const targetTotalSeconds = targetHours * 3600 + targetMinutes * 60 + targetSeconds;
        
        console.log(`ğŸ¯ íƒ€ê²Ÿ ì‹œê°„ (Seoul): ${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}:${targetSeconds.toString().padStart(2, '0')} (${targetTotalSeconds}ì´ˆ)`);
        
        let closestRow = null;
        let minDiff = Infinity;
        let rowIndex = -1;
        let matchedTime = '';
        let validTimeFoundCount = 0;
        
        // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ ì§€ì›ì„ ìœ„í•œ ì •ê·œì‹ë“¤
        const timePatterns = [
          { pattern: /(\d{1,2}):(\d{2}):(\d{2})/, name: 'HH:MM:SS' },
          { pattern: /(\d{1,2}):(\d{2})/, name: 'HH:MM' },
          { pattern: /(\d{1,2})ì‹œ\s*(\d{2})ë¶„\s*(\d{2})ì´ˆ/, name: 'í•œêµ­ì–´ ì‹œë¶„ì´ˆ' },
          { pattern: /(\d{1,2})ì‹œ\s*(\d{2})ë¶„/, name: 'í•œêµ­ì–´ ì‹œë¶„' }
        ];
        
        console.log(`ğŸ” === Bì—´ ì‹œê°„ ë°ì´í„° ë§¤ì¹­ ì‹œì‘ ===`);
        console.log(`ğŸ” ì´ ${rows.length}ê°œ í–‰ì—ì„œ ê²€ìƒ‰ ì¤‘...`);
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ - ì´ í–‰ ìˆ˜ ì„¤ì •
        updateProgress(0, rows.length, 0, 'ì‹œê°„ ë°ì´í„° ê²€ìƒ‰ ì¤‘...');
        const startTime = Date.now();
        
        // Bì—´(index 1)ë§Œ ê²€ìƒ‰
        for (let i = 0; i < rows.length; i++) {
          // ì¤‘ë‹¨ ì‹ í˜¸ í™•ì¸
          if (isAborted) {
            console.log('âŒ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
            break;
          }
          
          // ì£¼ê¸°ì ìœ¼ë¡œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ë§¤ 10í–‰ë§ˆë‹¤)
          if (i % 10 === 0) {
            const elapsed = Date.now() - startTime;
            const estimatedTotal = (elapsed / (i + 1)) * rows.length;
            const remaining = Math.max(0, estimatedTotal - elapsed);
            updateProgress(i, rows.length, remaining, `í–‰ ${i+1}/${rows.length} ê²€ì‚¬ ì¤‘...`);
          }
          
          const cellValue = rows[i][1]; // Bì—´ë§Œ í™•ì¸
          if (!cellValue || !cellValue.trim()) {
            // ë¹ˆ ì…€ì€ ë¡œê·¸ ìƒëµ
            continue;
          }
          
          console.log(`ğŸ” í–‰ ${i+1} Bì—´ ê²€ì‚¬: "${cellValue}"`);
          
          let hours, minutes, seconds = 0;
          let timeMatch = null;
          let matchedPatternName = '';
          
          // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ íŒŒì‹±
          for (const {pattern, name} of timePatterns) {
            timeMatch = cellValue.match(pattern);
            if (timeMatch) {
              hours = parseInt(timeMatch[1]);
              minutes = parseInt(timeMatch[2]);
              seconds = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
              matchedPatternName = name;
              console.log(`   âœ… íŒ¨í„´ ë§¤ì¹­: ${name} â†’ ${hours}:${minutes}:${seconds}`);
              break;
            }
          }
          
          if (!timeMatch) {
            console.log(`   âŒ ì‹œê°„ í˜•ì‹ ë§¤ì¹­ ì‹¤íŒ¨`);
            continue;
          }
          
          validTimeFoundCount++;
          
          // ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì •í™•í•œ ì‹œê°„ ê³„ì‚°
          const cellTotalSeconds = hours * 3600 + minutes * 60 + seconds;
          const diff = Math.abs(cellTotalSeconds - targetTotalSeconds);
          
          console.log(`   ğŸ“Š ì‹œê°„ ì°¨ì´: ${diff}ì´ˆ (í˜„ì¬ ìµœì†Œ: ${minDiff}ì´ˆ)`);
          
          // ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„ ì—…ë°ì´íŠ¸
          if (diff < minDiff) {
            minDiff = diff;
            closestRow = rows[i];
            rowIndex = i + 1;
            matchedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            console.log(`   ğŸ¯ ìƒˆë¡œìš´ ìµœì  ë§¤ì¹­: í–‰ ${rowIndex}, ì°¨ì´ ${diff}ì´ˆ`);
            
            // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ ë§¤ìš° ê°€ê¹Œìš´ ê²½ìš° (5ì´ˆ ì´ë‚´) ì¦‰ì‹œ ì¢…ë£Œ
            if (diff <= 5) {
              console.log(`âœ… === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì„±ê³µ! ===`);
              console.log(`   ğŸ“ ìœ„ì¹˜: í–‰ ${rowIndex}, Bì—´ (Cyprus ì‹œê°„)`);
              console.log(`   ğŸ• ì‹œê°„: ${matchedTime} (${diff}ì´ˆ ì°¨ì´)`);
              console.log(`   ğŸ“‹ ì „ì²´ í–‰ ë°ì´í„°:`);
              console.log(`      Aì—´(Blinds): "${rows[i][0] || ''}"`);
              console.log(`      Bì—´(Cyprus): "${rows[i][1] || ''}"`);
              console.log(`      Bì—´(Cyprus): "${rows[i][1]}"`);              console.log(`      Cì—´(Seoul): "${rows[i][2]}"`);
              console.log(`      Dì—´(#): "${rows[i][3] || ''}"`);
              break;
            }
          }
        }
        
        console.log(`ğŸ“Š === ë§¤ì¹­ ê²°ê³¼ ìš”ì•½ ===`);
        console.log(`ğŸ“Š ìœ íš¨í•œ ì‹œê°„ ë°ì´í„° ë°œê²¬: ${validTimeFoundCount}ê°œ`);
        console.log(`ğŸ“Š ìµœì†Œ ì‹œê°„ ì°¨ì´: ${minDiff === Infinity ? 'ë¬´í•œ' : minDiff + 'ì´ˆ'}`);
        console.log(`ğŸ“Š ìµœì  ë§¤ì¹­ í–‰: ${rowIndex > 0 ? rowIndex : 'ì—†ìŒ'}`)
        
        // ê²°ê³¼ ë¡œê¹…
        if (minDiff > 5) {
          const diffMinutes = Math.floor(minDiff / 60);
          const diffSeconds = minDiff % 60;
          let timeDiffStr = '';
          
          if (diffMinutes > 0) {
            timeDiffStr = `${diffMinutes}ë¶„ ${diffSeconds}ì´ˆ`;
          } else {
            timeDiffStr = `${diffSeconds}ì´ˆ`;
          }
          
          console.log(`âš ï¸ ì •í™•í•œ ë§¤ì¹˜ ì—†ìŒ. ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„:`);
          console.log(`   ğŸ“ í–‰ ${rowIndex}, Bì—´: ${matchedTime} (${timeDiffStr} ì°¨ì´)`);
        }
        
        // ìµœì¢… ê²°ê³¼ ì²˜ë¦¬ ë° ë°˜í™˜
        clearTimeout(timeoutId);
        hideProgressModal();
        
        if (isAborted) {
          console.error(`âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì·¨ì†Œ ===`);
          return null;
        }
        
        if (closestRow && minDiff !== Infinity) {
          console.log(`âœ… === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì™„ë£Œ ===`);
          console.log(`âœ… ë§¤ì¹­ ì„±ê³µ: í–‰ ${rowIndex}`);
          console.log(`âœ… ì‹œê°„ ì°¨ì´: ${minDiff}ì´ˆ`);
          console.log(`âœ… ì •í™•ë„: ${minDiff <= 5 ? 'ì •í™• (5ì´ˆ ì´ë‚´)' : minDiff <= 30 ? 'ê·¼ì‚¬ (30ì´ˆ ì´ë‚´)' : 'ëŒ€ëµì  (30ì´ˆ ì´ˆê³¼)'}`);
          
          return {
            row: closestRow,
            rowIndex: rowIndex,
            timeDiff: minDiff,
            targetTime: `${targetHours.toString().padStart(2, '0')}:${targetMinutes.toString().padStart(2, '0')}:${targetSeconds.toString().padStart(2, '0')}`,
            matchedTime: matchedTime,
            accuracy: minDiff <= 5 ? 'exact' : minDiff <= 30 ? 'close' : 'approximate'
          };
        } else {
          console.error(`âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹¤íŒ¨ ===`);
          console.error(`âŒ ë§¤ì¹­í•  ìˆ˜ ìˆëŠ” ì‹œê°„ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
          console.error(`âŒ ìœ íš¨í•œ ì‹œê°„ ë°ì´í„°: ${validTimeFoundCount}ê°œ`);
          console.error(`âŒ ê°€ëŠ¥í•œ ì›ì¸:`);
          console.error(`   - Bì—´ì— ì˜¬ë°”ë¥¸ ì‹œê°„ í˜•ì‹ì˜ ë°ì´í„°ê°€ ì—†ìŒ`);
          console.error(`   - ì§€ì›ë˜ëŠ” í˜•ì‹: HH:MM, HH:MM:SS, Nì‹œ Në¶„, Nì‹œ Në¶„ Nì´ˆ`);
          console.error(`   - ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ ì—´ì„ ì°¸ì¡°í•˜ê³  ìˆìŒ`);
          
          if (validTimeFoundCount === 0) {
            console.error(`ğŸ’¡ í•´ê²°ì±…: Bì—´ì— "14:35" ë˜ëŠ” "14ì‹œ 35ë¶„" í˜•ì‹ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
          } else {
            console.error(`ğŸ’¡ í•´ê²°ì±…: íƒ€ê²Ÿ ì‹œê°„ê³¼ ìœ ì‚¬í•œ ì‹œê°„ëŒ€ì˜ ë°ì´í„°ë¥¼ Bì—´ì— ì¶”ê°€í•˜ì„¸ìš”.`);
          }
          
          return null;
        }
      } catch (error) {
        clearTimeout(timeoutId);
        hideProgressModal();
        
        console.error('âŒ === Virtual ì‹œíŠ¸ ë§¤ì¹­ ì‹¤íŒ¨ ===');
        console.error('âŒ ì˜¤ë¥˜ íƒ€ì…:', error.name || 'Unknown');
        console.error('âŒ ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        console.error('âŒ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack || 'ìŠ¤íƒ ì •ë³´ ì—†ìŒ');
        console.error('âŒ ì…ë ¥ URL:', virtualSheetUrl);
        console.error('âŒ ì…ë ¥ íƒ€ì„ìŠ¤íƒ¬í”„:', targetTime);
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì›ì¸ ì•ˆë‚´
        if (error.message.includes('HTTP ì˜¤ë¥˜')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: Google Sheetsê°€ "ë§í¬ê°€ ìˆëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ê¸° ê¶Œí•œ"ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error.message.includes('ì˜¬ë°”ë¥¸ Google Sheets URLì´ ì•„ë‹™ë‹ˆë‹¤')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: URLì´ https://docs.google.com/spreadsheets/d/[ID]/... í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error.message.includes('CSVì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')) {
          console.error('ğŸ’¡ í•´ê²°ì±…: ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€, ì˜¬ë°”ë¥¸ gidë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error instanceof TypeError) {
          console.error('ğŸ’¡ í•´ê²°ì±…: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ CORS ì •ì±… ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
        
        return null;
      }
    }
    
    // ì§„í–‰ë¥  ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    function showProgressModal() {
      const modal = document.getElementById('progress-modal');
      modal.classList.remove('hidden');
      
      // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ì¶”ê°€)
      const cancelBtn = document.getElementById('cancel-progress');
      cancelBtn.onclick = function() {
        isAborted = true;
        hideProgressModal();
        console.log('ğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
      };
    }
    
    function hideProgressModal() {
      const modal = document.getElementById('progress-modal');
      modal.classList.add('hidden');
      
      // ì§„í–‰ë¥  ì´ˆê¸°í™”
      document.getElementById('progress-bar').style.width = '0%';
      document.getElementById('progress-percentage').textContent = '0%';
      document.getElementById('current-row').textContent = '-';
      document.getElementById('total-rows').textContent = '-';
      document.getElementById('remaining-time').textContent = 'ê³„ì‚° ì¤‘...';
      document.getElementById('current-status').textContent = 'ì‹œì‘ ì¤‘...';
    }
    
    function updateProgress(currentRow, totalRows, remainingMs, status) {
      const percentage = Math.min(100, Math.round((currentRow / totalRows) * 100));
      
      // Progress Bar ì—…ë°ì´íŠ¸
      document.getElementById('progress-bar').style.width = percentage + '%';
      document.getElementById('progress-percentage').textContent = percentage + '%';
      
      // ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('current-row').textContent = currentRow;
      document.getElementById('total-rows').textContent = totalRows;
      document.getElementById('current-status').textContent = status;
      
      // ë‚¨ì€ ì‹œê°„ ê³„ì‚° ë° í‘œì‹œ
      if (remainingMs > 0) {
        const remainingSeconds = Math.ceil(remainingMs / 1000);
        if (remainingSeconds > 60) {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          document.getElementById('remaining-time').textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
        } else {
          document.getElementById('remaining-time').textContent = `${remainingSeconds}ì´ˆ`;
        }
      } else {
        document.getElementById('remaining-time').textContent = 'ì™„ë£Œ ì¤‘...';
      }
    }
    
    // í•¸ë“œ ì„¸ë¶€ ì •ë³´ UI ì´ˆê¸°í™”
    function clearHandDetails() {
      console.log('ğŸ§¹ í•¸ë“œ ì„¸ë¶€ ì •ë³´ ì´ˆê¸°í™”...');
      
      // í—¤ë” ì •ë³´ ì´ˆê¸°í™”
      document.getElementById('hand-number').textContent = '-';
      document.getElementById('table-name').textContent = '-';
      document.getElementById('blinds').textContent = '-/-';
      document.getElementById('pot-amount').textContent = '-';
      
      // ì¹´ë©”ë¼ íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
      const cameraFilesEl = document.getElementById('camera-files');
      cameraFilesEl.textContent = 'ì„ íƒëœ í•¸ë“œ ì—†ìŒ';
      cameraFilesEl.title = '';
      
      // ë³´ë“œ ì¹´ë“œ ì´ˆê¸°í™”
      const boardEl = document.getElementById('community-cards');
      if (boardEl) {
        boardEl.innerHTML = '<div class="card-placeholder">ë³´ë“œ ì¹´ë“œ</div>';
      }
      
      // í”Œë ˆì´ì–´ ì„¹ì…˜ ì´ˆê¸°í™”
      const playersEl = document.getElementById('players-section');
      if (playersEl) {
        playersEl.innerHTML = '<div class="text-gray-500 text-center py-4">ì„ íƒëœ í•¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      // ì•¡ì…˜ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
      const historyEl = document.getElementById('action-history');
      if (historyEl) {
        historyEl.innerHTML = '<div class="text-gray-500 text-center py-4">ì•¡ì…˜ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      // í•¸ë“œ ê²°ê³¼ ì´ˆê¸°í™”
      const resultEl = document.getElementById('hand-result');
      if (resultEl) {
        resultEl.innerHTML = '<div class="text-gray-500 text-center py-4">í•¸ë“œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      console.log('âœ… í•¸ë“œ ì„¸ë¶€ ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ===== URL ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ë“¤ =====
    
    // CSV URL ìœ íš¨ì„± ê²€ì‚¬
    function validateCsvUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Google Sheets CSV ê²Œì‹œ URL í˜•ì‹
      if (url.includes('docs.google.com/spreadsheets/d/e/') && url.includes('/pub?') && url.includes('output=csv')) {
        return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ CSV ê²Œì‹œ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'csv' };
      }
      
      // ì¼ë°˜ Google Sheets í¸ì§‘ URL
      if (url.includes('docs.google.com/spreadsheets/d/') && url.includes('/edit')) {
        return { 
          valid: false, 
          message: 'âš ï¸ í¸ì§‘ URLì´ ì•„ë‹Œ CSV ê²Œì‹œ URLì´ í•„ìš”í•©ë‹ˆë‹¤', 
          type: 'edit',
          suggestion: 'ğŸ“ íŒŒì¼ â†’ ì›¹ì— ê²Œì‹œ â†’ CSV ì„ íƒ í›„ ê²Œì‹œí•˜ì„¸ìš”' 
        };
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Google Sheets CSV ê²Œì‹œ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // Google Sheets í¸ì§‘ URL ìœ íš¨ì„± ê²€ì‚¬
    function validateSheetUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Google Sheets í¸ì§‘ URL í˜•ì‹
      if (url.includes('docs.google.com/spreadsheets/d/') && url.includes('/edit')) {
        if (url.includes('gid=')) {
          return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Google Sheets URLì…ë‹ˆë‹¤ (íŠ¹ì • ì‹œíŠ¸ ì§€ì •)', type: 'sheet_gid' };
        } else {
          return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Google Sheets URLì…ë‹ˆë‹¤', type: 'sheet' };
        }
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Google Sheets í¸ì§‘ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // Apps Script URL ìœ íš¨ì„± ê²€ì‚¬
    function validateAppsScriptUrl(url) {
      if (!url || url.trim() === '') {
        return { valid: false, message: 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', type: 'empty' };
      }
      
      // Apps Script Web App URL í˜•ì‹
      if (url.includes('script.google.com/macros/s/') && url.endsWith('/exec')) {
        return { valid: true, message: 'âœ… ì˜¬ë°”ë¥¸ Apps Script Web App URLì…ë‹ˆë‹¤', type: 'apps_script' };
      }
      
      // Apps Script í¸ì§‘ URL
      if (url.includes('script.google.com/') && url.includes('/edit')) {
        return { 
          valid: false, 
          message: 'âš ï¸ í¸ì§‘ URLì´ ì•„ë‹Œ Web App ë°°í¬ URLì´ í•„ìš”í•©ë‹ˆë‹¤', 
          type: 'edit',
          suggestion: 'ğŸ“ ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ì›¹ ì•± ë°°í¬ URL ì‚¬ìš©í•˜ì„¸ìš”' 
        };
      }
      
      // ê¸°íƒ€ URL
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return { valid: false, message: 'âŒ Apps Script Web App URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', type: 'other' };
      }
      
      return { valid: false, message: 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤', type: 'invalid' };
    }
    
    // UI í”¼ë“œë°± ì—…ë°ì´íŠ¸
    function updateUrlFeedback(inputId, feedbackId, validation) {
      const input = document.getElementById(inputId);
      const feedback = document.getElementById(feedbackId);
      
      if (!input || !feedback) return;
      
      // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      input.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500', 'border-gray-600');
      
      if (validation.valid) {
        input.classList.add('border-green-500');
        feedback.className = 'text-xs mt-1 text-green-400';
        feedback.textContent = validation.message;
      } else {
        if (validation.type === 'empty') {
          input.classList.add('border-gray-600');
          feedback.className = 'text-xs mt-1 text-gray-400';
          feedback.textContent = validation.message;
        } else if (validation.type === 'edit' || validation.suggestion) {
          input.classList.add('border-yellow-500');
          feedback.className = 'text-xs mt-1 text-yellow-400';
          feedback.textContent = validation.message;
          if (validation.suggestion) {
            feedback.textContent += '\n' + validation.suggestion;
          }
        } else {
          input.classList.add('border-red-500');
          feedback.className = 'text-xs mt-1 text-red-400';
          feedback.textContent = validation.message;
        }
      }
    }
    
    // ===== Apps Script ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ =====
    
    // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testAppsScriptConnection() {
      const appsScriptUrl = CONFIG.SHEET_UPDATE_SCRIPT_URL;
      
      console.log('ğŸ” Apps Script URL ë””ë²„ê¹…:', appsScriptUrl);
      console.log('ğŸ” ì „ì²´ CONFIG:', CONFIG);
      
      if (!appsScriptUrl || appsScriptUrl.trim() === '') {
        alert('âš ï¸ Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nì„¤ì • ë‹¨ê³„:\n1. ì„¤ì • ë²„íŠ¼ í´ë¦­\n2. "Apps Script ì‹œíŠ¸ ì—°ë™" ì„¹ì…˜ ì°¾ê¸°\n3. "Apps Script Web App URL" í•„ë“œì— URL ì…ë ¥\n4. ì„¤ì • ì €ì¥ í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸');
        return false;
      }
      
      // URL í˜•ì‹ ê²€ì¦
      if (!appsScriptUrl.includes('script.google.com') || !appsScriptUrl.includes('/exec')) {
        alert('âš ï¸ Apps Script URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì˜¬ë°”ë¥¸ í˜•ì‹:\nhttps://script.google.com/macros/s/[SCRIPT_ID]/exec\n\ní˜„ì¬ URL:\n' + appsScriptUrl);
        return false;
      }
      
      console.log('ğŸ§ª Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      console.log('ğŸŒ ìš”ì²­ URL:', appsScriptUrl);
      
      // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      const testBtn = document.getElementById('test-apps-script');
      const originalText = testBtn.textContent;
      testBtn.disabled = true;
      testBtn.textContent = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
      
      try {
        // Apps ScriptëŠ” CORS ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ ë‹¨ìˆœ GET ìš”ì²­
        console.log('ğŸ“¡ GET ìš”ì²­ ì „ì†¡ ì¤‘...');
        
        const response = await fetch(appsScriptUrl, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          redirect: 'follow'
        });
        
        console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status);
        console.log('ğŸ“¡ ì‘ë‹µ í—¤ë”:', response.headers);
        
        if (response.ok) {
          const responseText = await response.text();
          console.log('ğŸ“¡ ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);
          
          try {
            const data = JSON.parse(responseText);
            console.log('âœ… Apps Script ì—°ê²° ì„±ê³µ:', data);
            
            alert(`âœ… Apps Script ì—°ê²° ì„±ê³µ!\n\nğŸ”— ì„œë¹„ìŠ¤: ${data.service || 'Virtual Table Sheet Updater'}\nğŸ“Š ìƒíƒœ: ${data.status}\nğŸ“ˆ ë²„ì „: ${data.version || 'v1.1'}\nâ° ì‹œê°„: ${new Date(data.time).toLocaleString()}\nğŸ› ï¸ ë©”ì†Œë“œ: ${data.method}`);
            return true;
            
          } catch (jsonError) {
            console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', jsonError);
            console.log('ğŸ“„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜. HTML ì‘ë‹µì¼ ìˆ˜ ìˆìŒ:', responseText.substring(0, 200));
            alert(`âš ï¸ Apps Script ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì‘ë‹µ ìƒíƒœ: ${response.status}\nì‘ë‹µ ë‚´ìš©: ${responseText.substring(0, 100)}...\n\ní•´ê²°ì±…:\nâ€¢ Apps Scriptê°€ ì˜¬ë°”ë¥´ê²Œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ doGet í•¨ìˆ˜ê°€ JSON ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸`);
            return false;
          }
          
        } else {
          console.error('âŒ Apps Script ì—°ê²° ì‹¤íŒ¨:', response.status, response.statusText);
          const responseText = await response.text();
          console.log('âŒ ì˜¤ë¥˜ ì‘ë‹µ:', responseText);
          
          alert(`âŒ Apps Script ì—°ê²° ì‹¤íŒ¨\n\nğŸ“Š ìƒíƒœ ì½”ë“œ: ${response.status}\nâŒ ì˜¤ë¥˜: ${response.statusText}\nğŸ“„ ìƒì„¸: ${responseText.substring(0, 200)}...\n\ní•´ê²°ì±…:\nâ€¢ Apps Script URLì´ ì •í™•í•œì§€ í™•ì¸\nâ€¢ ì›¹ì•±ì´ "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ Apps Script ì‹¤í–‰ ê¶Œí•œ í™•ì¸`);
          return false;
        }
        
      } catch (error) {
        console.error('âŒ Apps Script ì—°ê²° ì˜¤ë¥˜:', error);
        
        let errorMessage = `âŒ Apps Script ì—°ê²° ì˜¤ë¥˜\n\nğŸ” ì˜¤ë¥˜ ìœ í˜•: ${error.name}\nğŸ’¬ ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}\n\n`;
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += `ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í•´ê²°ì±…:\nâ€¢ ì¸í„°ë„· ì—°ê²° ìƒíƒœ í™•ì¸\nâ€¢ Apps Script URLì´ ì •í™•í•œì§€ í™•ì¸\nâ€¢ ì›¹ì•±ì´ ë°°í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸\nâ€¢ ë°©í™”ë²½/ë³´ì•ˆ í”„ë¡œê·¸ë¨ í™•ì¸`;
        } else if (error.name === 'TypeError' && error.message.includes('CORS')) {
          errorMessage += `ğŸ”’ CORS ì˜¤ë¥˜ í•´ê²°ì±…:\nâ€¢ Apps Script ì›¹ì•±ì„ "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ë¡œ ì¬ë°°í¬\nâ€¢ Apps Script URLì´ /execë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸`;
        } else {
          errorMessage += `ğŸ”§ ì¼ë°˜ì ì¸ í•´ê²°ì±…:\nâ€¢ Apps Script URL í˜•ì‹ í™•ì¸:\n  https://script.google.com/macros/s/[SCRIPT_ID]/exec\nâ€¢ ì›¹ì•± ë°°í¬ ìƒíƒœ í™•ì¸\nâ€¢ ì‹¤í–‰ ê¶Œí•œ ì„¤ì • í™•ì¸\nâ€¢ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ í›„ ì¬ì‹œë„`;
        }
        
        alert(errorMessage);
        return false;
        
      } finally {
        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë³µêµ¬
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      }
    }

    // Gemini API ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testGeminiAPIConnection() {
      console.log('ğŸ§ª Gemini API í…ŒìŠ¤íŠ¸ ì‹œì‘');
      
      // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      const testBtn = document.getElementById('test-gemini-api');
      const originalText = testBtn.textContent;
      testBtn.disabled = true;
      testBtn.textContent = 'ğŸ”„ API í…ŒìŠ¤íŠ¸ ì¤‘...';
      
      try {
        // ë¨¼ì € í˜„ì¬ ì…ë ¥ê°’ì„ CONFIGì— ì„ì‹œ ì €ì¥
        const apiKeyInput = document.getElementById('gemini-api-key').value.trim();
        if (apiKeyInput) {
          CONFIG.GEMINI_API_KEY = apiKeyInput;
          console.log('ğŸ’¾ ì…ë ¥ëœ API í‚¤ë¥¼ CONFIGì— ì„ì‹œ ì €ì¥:', apiKeyInput.length + 'ê¸€ì');
        }
        
        // CONFIGì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸° (ì €ì¥ëœ ê°’ ë˜ëŠ” ë°©ê¸ˆ ì…ë ¥í•œ ê°’)
        const apiKeyToTest = CONFIG.GEMINI_API_KEY;
        console.log('ğŸ”‘ í…ŒìŠ¤íŠ¸í•  API í‚¤:', apiKeyToTest ? `ì„¤ì •ë¨ (ê¸¸ì´: ${apiKeyToTest.length})` : 'ì—†ìŒ');
        
        // API í‚¤ ê¸°ë³¸ ê²€ì¦
        if (!apiKeyToTest || apiKeyToTest.trim() === '') {
          alert('âš ï¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\ní˜„ì¬ ìƒíƒœ:\nâ€¢ ì…ë ¥ í•„ë“œì— API í‚¤ë¥¼ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸\nâ€¢ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸');
          return false;
        }
        
        if (!apiKeyToTest.startsWith('AIza')) {
          alert('âš ï¸ Gemini API í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nAIzaë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.\n\ní˜„ì¬ í‚¤ ì‹œì‘: ' + apiKeyToTest.substring(0, 10) + '...');
          return false;
        }
        
        // í…ŒìŠ¤íŠ¸ìš© ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸
        const testPrompt = "ì•ˆë…•í•˜ì„¸ìš”. ì´ê²ƒì€ API ì—°ê²° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. 'í…ŒìŠ¤íŠ¸ ì„±ê³µ'ì´ë¼ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”.";
        
        console.log('ğŸŒ Gemini API í…ŒìŠ¤íŠ¸ í˜¸ì¶œ ì¤‘...');
        const result = await callGeminiAPI(testPrompt, apiKeyToTest);
        
        console.log('ğŸ“¦ í…ŒìŠ¤íŠ¸ ì‘ë‹µ:', result);
        
        if (result.includes('âŒ')) {
          alert(`âŒ Gemini API ì—°ê²° ì‹¤íŒ¨\n\n${result}\n\ní•´ê²°ì±…:\nâ€¢ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\nâ€¢ Gemini API ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸\nâ€¢ í• ë‹¹ëŸ‰ì´ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸`);
          return false;
        } else {
          alert(`âœ… Gemini API ì—°ê²° ì„±ê³µ!\n\nì‘ë‹µ ë‚´ìš©:\n${result.substring(0, 100)}${result.length > 100 ? '...' : ''}\n\nAPI í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.`);
          return true;
        }
        
      } catch (error) {
        console.error('âŒ API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
        alert(`âŒ API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n${error.message}`);
        return false;
        
      } finally {
        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë³µêµ¬
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      }
    }
    
    // ì‹œíŠ¸ì— ë°ì´í„° ì—…ë°ì´íŠ¸ (Fì—´: íŒŒì¼ëª…, Hì—´: AIë¶„ì„)
    async function updateSheetData(matchedRow, handNumber, filename, aiAnalysis) {
      const appsScriptUrl = CONFIG.SHEET_UPDATE_SCRIPT_URL;
      const writeSheetUrl = CONFIG.WRITE_SHEET_URL;
      
      if (!appsScriptUrl) {
        throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      
      if (!writeSheetUrl) {
        throw new Error('ì“°ê¸°ìš© ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      
      console.log('ğŸ“Š === ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
      console.log(`ğŸ“ ë§¤ì¹­ëœ í–‰: ${matchedRow}`);
      console.log(`ğŸ”¢ í•¸ë“œ ë²ˆí˜¸: ${handNumber}`);
      console.log(`ğŸ“ íŒŒì¼ëª…: ${filename}`);
      console.log(`ğŸ¤– AI ë¶„ì„: ${aiAnalysis}`);
      
      const updateData = {
        action: 'updateSheet',
        sheetUrl: writeSheetUrl,
        rowNumber: matchedRow,
        handNumber: handNumber,
        filename: filename,
        aiAnalysis: aiAnalysis,
        timestamp: new Date().toISOString()
      };
      
      try {
        console.log('ğŸ“¤ Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ ì¤‘...');
        
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            payload: JSON.stringify(updateData)
          })
        });
        
        console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('âœ… Apps Script ì‘ë‹µ:', result);
        
        if (result.status === 'success') {
          console.log('âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!');
          return {
            success: true,
            message: result.message || 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ',
            data: result
          };
        } else {
          console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', result.message);
          return {
            success: false,
            message: result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
            data: result
          };
        }
        
      } catch (error) {
        console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        return {
          success: false,
          message: error.message,
          error: error
        };
      }
    }
    
    
    // í•¸ë“œì—ì„œ í‚¤ í”Œë ˆì´ì–´ ì°¾ê¸°
    // AI í•¸ë“œ ë¶„ì„ í•¨ìˆ˜
    async function analyzeHandWithAI(handNumber) {
      try {
        debugLog('ğŸ” ì •í™•í•œ í•¸ë“œ ë¶„ì„ ì‹œì‘ - í•¸ë“œ #' + handNumber);
        
        // í•¸ë“œ ë°ì´í„° ë¡œë“œ
        const handData = await loadHandData(handNumber);
        if (!handData) {
          return 'âŒ í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        }
        
        // ì§ì ‘ ê³„ì‚°í•œ ì •í™•í•œ 3ì¤„ ìš”ì•½ ìƒì„±
        const preciseAnalysis = createPreciseThreeLineSummary(handData);
        debugLog('âœ… í•¸ë“œ ë¶„ì„ ì™„ë£Œ');
        
        return preciseAnalysis;
        
      } catch (error) {
        console.error('âŒ í•¸ë“œ ë¶„ì„ ì˜¤ë¥˜:', error);
        debugLog(`âŒ ë¶„ì„ ì‹¤íŒ¨: ${error.message}`);
        
        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì •ë³´ë¼ë„ ë°˜í™˜
        const fallbackSummary = createFallbackSummary(handData || { players: [], pot: 0, blinds: { bb: 0 } });
        return fallbackSummary;
      }
    }
    
    // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìš”ì•½ ìƒì„±
    function createFallbackSummary(handData) {
      const potInBB = handData.blinds.bb && handData.blinds.bb > 0 ? 
        Math.round((handData.pot / handData.blinds.bb) * 10) / 10 : 
        handData.pot;
      
      let line1 = 'í”Œë ˆì´ì–´ ì •ë³´ ë¶€ì¡±';
      if (handData.players && handData.players.length >= 1) {
        const player1 = handData.players[0];
        const player2 = handData.players[1] || { name: 'ìƒëŒ€ë°©', cards: ['?', '?'] };
        line1 = `${player1.name} (${player1.cards ? player1.cards.join('') : '??'}) vs ${player2.name} (${player2.cards ? player2.cards.join('') : '??'})`;
      }
      
      const board = handData.communityCards ? handData.communityCards.join(' ') : 'ë³´ë“œ ì—†ìŒ';
      const line2 = `ë³´ë“œ [${board}] ë¶„ì„ ë¶ˆê°€`;
      const line3 = `íŒŸ (${handData.pot || 0}) ${potInBB}BB - ê²°ê³¼ ì •ë³´ ì—†ìŒ`;
      
      return `${line1}\n${line2}\n${line3}`;
    }
    
    // ì •í™•í•œ 3ì¤„ ìš”ì•½ ìƒì„± (ê°„ëµí•˜ê³  ëª…í™•í•˜ê²Œ)
    function createPreciseThreeLineSummary(handData) {
      // BB ë‹¨ìœ„ë¡œ íŒŸ ê³„ì‚° (ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€)
      const potInBB = handData.blinds.bb && handData.blinds.bb > 0 ? 
        Math.round((handData.pot / handData.blinds.bb) * 10) / 10 : 
        handData.pot;
      
      // ë””ë²„ê¹…ì„ ìœ„í•´ ê³„ì‚° ê³¼ì • ì¶œë ¥
      console.log(`ğŸ² BB ê³„ì‚°: íŒŸ(${handData.pot}) / BB(${handData.blinds.bb}) = ${potInBB}BB`);
      
      // ì¹´ë“œ ë¬¸ì–‘ ë³€í™˜ í•¨ìˆ˜
      const convertCardSuits = (cards) => {
        if (!cards || cards.length === 0) return '??';
        return cards.map(card => {
          if (!card || card === '?') return '?';
          const rank = card.slice(0, -1);
          const suit = card.slice(-1);
          const suitSymbol = getSuitSymbol(suit);
          return rank + suitSymbol;
        }).join('');
      };
      
      const board = handData.communityCards ? handData.communityCards.map(card => {
        if (!card || card === '?') return '?';
        const rank = card.slice(0, -1);
        const suit = card.slice(-1);
        const suitSymbol = getSuitSymbol(suit);
        return rank + suitSymbol;
      }).join(' ') : 'ë³´ë“œ ì—†ìŒ';
      
      // 1ì¤„: í”Œë ˆì´ì–´ ëŒ€ê²° (ê°„ëµí•˜ê²Œ)
      let line1 = '';
      if (handData.players.length >= 2) {
        const player1 = handData.players[0];
        const player2 = handData.players[1];
        const p1Cards = convertCardSuits(player1.cards);
        const p2Cards = convertCardSuits(player2.cards);
        line1 = `${player1.name}(${p1Cards}) vs ${player2.name}(${p2Cards})`;
      } else {
        line1 = 'í”Œë ˆì´ì–´ ì •ë³´ ë¶€ì¡±';
      }
      
      // 2ì¤„: ë³´ë“œë§Œ ê°„ë‹¨íˆ
      let line2 = `ë³´ë“œ: ${board}`;
      
      // 3ì¤„: íŒŸ ì‚¬ì´ì¦ˆ (BB í™˜ì‚° ë° ì›ë³¸ ê¸ˆì•¡)
      let line3 = `íŒŸ: ${potInBB}BB (${handData.pot.toLocaleString()})`;
      
      return `${line1}\n${line2}\n${line3}`;
    }
    
    // ë³´ë“œ í…ìŠ¤ì²˜ ë¶„ì„
    function analyzeBoardTexture(board) {
      if (!board || board.length < 3) return 'ë³´ë“œ ë¶€ì¡±';
      
      // ìˆ˜íŠ¸ ë¶„ì„
      const suits = board.map(card => card.slice(-1));
      const suitCounts = {};
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      const maxSuitCount = Math.max(...Object.values(suitCounts));
      
      // ë­í¬ ë¶„ì„
      const ranks = board.map(card => {
        const rank = card.slice(0, -1);
        return rank === 'A' ? 14 : rank === 'K' ? 13 : rank === 'Q' ? 12 : rank === 'J' ? 11 : parseInt(rank);
      }).sort((a, b) => b - a);
      
      let texture = '';
      
      // í”ŒëŸ¬ì‹œ ë“œë¡œìš° ì²´í¬
      if (maxSuitCount >= 3) {
        texture += maxSuitCount >= 4 ? 'í”ŒëŸ¬ì‹œ ë³´ë“œ' : 'í”ŒëŸ¬ì‹œ ë“œë¡œìš° ë³´ë“œ';
      } else {
        texture += 'ë ˆì¸ë³´ìš° ë³´ë“œ';
      }
      
      // í˜ì–´ ì²´í¬
      const rankCounts = {};
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      const hasPair = Object.values(rankCounts).some(count => count >= 2);
      
      if (hasPair) {
        texture += ', í˜ì–´ ë³´ë“œ';
      }
      
      // ìŠ¤íŠ¸ë ˆì´íŠ¸ ê°€ëŠ¥ì„± ì²´í¬
      const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
      let hasConnectivity = false;
      
      for (let i = 0; i < uniqueRanks.length - 1; i++) {
        if (uniqueRanks[i] - uniqueRanks[i + 1] <= 2) {
          hasConnectivity = true;
          break;
        }
      }
      
      if (hasConnectivity) {
        texture += ', ì—°ê²°ì„± ë†’ìŒ';
      } else {
        texture += ', ë“œë¼ì´ ë³´ë“œ';
      }
      
      return texture;
    }
    
    // AI ë¶„ì„ìš© ê°„ì†Œí™”ëœ í”„ë¡¬í”„íŠ¸ (ë°±ì—…ìš©)
    function createAnalysisPrompt(handData) {
      // ì§ì ‘ ê³„ì‚°í•œ 3ì¤„ ìš”ì•½ì„ ë°˜í™˜
      return createPreciseThreeLineSummary(handData);
    }
    
    // Gemini API í˜¸ì¶œ (ì—¬ëŸ¬ ëª¨ë¸ fallback ì§€ì›)
    async function callGeminiAPI(prompt, apiKey) {
      // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœ)
      const models = [
        'gemini-1.5-flash',
        'gemini-1.5-pro', 
        'gemini-pro',
        'models/gemini-pro'
      ];

      debugLog('ğŸŒ Gemini API í˜¸ì¶œ ì‹œì‘');
      debugLog('ğŸ“ í”„ë¡¬í”„íŠ¸ ê¸¸ì´:', prompt.length);

      // ê° ëª¨ë¸ì„ ìˆœì„œëŒ€ë¡œ ì‹œë„
      for (let i = 0; i < models.length; i++) {
        const model = models[i];
        try {
          debugLog(`ğŸ” ëª¨ë¸ ì‹œë„ ${i + 1}/${models.length}:`, model);
          debugLog('ğŸ”— API URL:', `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey.substring(0, 10)}...`);
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }]
          })
        });
        
          debugLog('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
          
          if (response.ok) {
            const data = await response.json();
            debugLog('ğŸ“¦ API ì‘ë‹µ ë°ì´í„°:', data);
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
              const result = data.candidates[0].content.parts[0].text;
              debugLog(`âœ… ëª¨ë¸ '${model}' ì„±ê³µ! ê²°ê³¼ ê¸¸ì´:`, result.length);
              return result;
            } else {
              debugLog(`âš ï¸ ëª¨ë¸ '${model}' ì‘ë‹µ êµ¬ì¡° ì´ìƒ:`, data);
              if (i === models.length - 1) {
                return 'âŒ API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: ' + JSON.stringify(data);
              }
              continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            }
          } else {
            const errorText = await response.text();
            debugLog(`âŒ ëª¨ë¸ '${model}' ì‹¤íŒ¨ (${response.status}):`, errorText);
            
            if (response.status === 404 && i < models.length - 1) {
              debugLog('ğŸ”„ ë‹¤ìŒ ëª¨ë¸ë¡œ fallback...');
              continue; // 404ë©´ ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            } else if (i === models.length - 1) {
              return `âŒ ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜ (${response.status}): ${errorText}`;
            } else {
              continue;
            }
          }
          
        } catch (modelError) {
          debugLog(`âŒ ëª¨ë¸ '${model}' ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:`, modelError);
          if (i === models.length - 1) {
            return 'âŒ ëª¨ë“  ëª¨ë¸ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + modelError.message;
          }
          continue; // ë‹¤ìŒ ëª¨ë¸ ì‹œë„
        }
      }
      
      return 'âŒ ëª¨ë“  Gemini ëª¨ë¸ì„ ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    }
    
    async function getKeyPlayerFromHand(handData) {
      try {
        // Type ì‹œíŠ¸ì—ì„œ Notable í”Œë ˆì´ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const TYPE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1127201192&single=true&output=csv';
        
        const response = await fetch(TYPE_CSV_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        const notablePlayers = [];
        for (let i = 1; i < rows.length; i++) {
          const playerName = rows[i][1]; // Bì—´: Player
          const isNotable = rows[i][3];  // Dì—´: Notable
          
          if (isNotable === 'Y' || isNotable === 'y' || isNotable === 'âœ“') {
            notablePlayers.push(playerName);
          }
        }
        
        // í•¸ë“œì—ì„œ Notable í”Œë ˆì´ì–´ ì°¾ê¸°
        for (const player of handData.players) {
          if (notablePlayers.includes(player.name)) {
            return player;
          }
        }
        
        // Notable í”Œë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜í™˜
        return handData.players[0];
        
      } catch (error) {
        console.error('í‚¤ í”Œë ˆì´ì–´ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜í™˜
        return handData.players[0];
      }
    }
    
    // ì›í´ë¦­ í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ í†µí•© í•¨ìˆ˜
    async function processHandCompletion(handNumber, timestamp, virtualSheetUrl) {
      showNotification('ğŸ”„ í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
      
      try {
        // 1. í•¸ë“œ ë°ì´í„° ë¡œë“œ
        const handData = await loadHandData(handNumber);
        if (!handData) {
          throw new Error('í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 2. Virtual ì‹œíŠ¸ ë§¤ì¹­ ì§„í–‰
        showNotification('ğŸ” Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ ì¤‘...', 'info');
        const { matchedRow, isExactMatch } = await findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp);
        
        if (!matchedRow) {
          throw new Error('Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 3. í‚¤ í”Œë ˆì´ì–´ ì‹ë³„
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        // 4. íŒŒì¼ëª… ìë™ ìƒì„±
        let filename = `${handNumber}`;
        if (keyPlayer) {
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
        
        // 5. AI í•¸ë“œ ë¶„ì„ ì‹¤í–‰
        showNotification('ğŸ¤– AIë¡œ í•¸ë“œ ë¶„ì„ ì¤‘...', 'info');
        const aiSummary = await analyzeHandWithAI(handData);
        
        // 6. í•¸ë“œ ì¡°í•© ê²°ê³¼ ë¶„ì„ ì¶”ê°€
        const handAnalysis = analyzePlayerHands(handData);
        
        // 7. Apps Scriptë¥¼ í†µí•œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        showNotification('ğŸ“ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘...', 'info');
        await updateHandInSheet(handNumber, {
          filename: filename,
          aiSummary: aiSummary,
          handAnalysis: handAnalysis,
          virtualRow: matchedRow.row,
          isExactMatch: isExactMatch
        });
        
        // 8. ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        const handIndex = allHands.findIndex(h => h.handNumber === handNumber);
        if (handIndex !== -1) {
          allHands[handIndex].handEdit = true;
          allHands[handIndex].handEditTime = new Date().toISOString();
        }
        
        // 9. UI ì—…ë°ì´íŠ¸
        updateHandStatus(true);
        updateHandList();
        updateStats();
        
        showNotification('âœ… í•¸ë“œ ì™„ë£Œ ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('âœ… í•¸ë“œ ì™„ë£Œ:', { handNumber, filename, aiSummary, handAnalysis });
        
      } catch (error) {
        throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
      }
    }
    
    // í”Œë ˆì´ì–´ í•¸ë“œ ì¡°í•© ë¶„ì„ í•¨ìˆ˜
    function analyzePlayerHands(handData) {
      if (!handData.communityCards || handData.communityCards.length === 0) {
        return 'ë³´ë“œ ì¹´ë“œ ì—†ìŒ - í•¸ë“œ ì¡°í•© ë¶„ì„ ë¶ˆê°€';
      }
      
      const board = handData.communityCards;
      const analyses = [];
      
      handData.players.forEach(player => {
        if (player.cards && player.cards.length >= 2) {
          const combination = evaluateHandStrength(player.cards, board);
          analyses.push(`${player.name}: ${combination}`);
        }
      });
      
      return analyses.join(' | ');
    }
    
    // ìŠ¹ë¶€ ê²°ê³¼ íŒì • í•¨ìˆ˜
    function determineWinner(handData) {
      if (!handData.communityCards || handData.communityCards.length < 5 || handData.players.length < 2) {
        return { winner: null, reason: 'ë¶ˆì™„ì „í•œ ì •ë³´' };
      }
      
      const playerHandRankings = handData.players.map(player => {
        if (!player.cards || player.cards.length < 2) {
          return { player: player, rank: -1, description: 'ì¹´ë“œ ì—†ìŒ' };
        }
        
        const handRank = getHandRanking(player.cards, handData.communityCards);
        return {
          player: player,
          rank: handRank.rank,
          description: handRank.description,
          combination: evaluateHandStrength(player.cards, handData.communityCards)
        };
      }).filter(p => p.rank >= 0); // ìœ íš¨í•œ í•¸ë“œë§Œ
      
      // í•¸ë“œ ë­í‚¹ìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
      playerHandRankings.sort((a, b) => b.rank - a.rank);
      
      if (playerHandRankings.length < 2) {
        return { winner: null, reason: 'ë¹„êµ ë¶ˆê°€' };
      }
      
      const winner = playerHandRankings[0];
      const runnerUp = playerHandRankings[1];
      
      // ë™ì ì¸ ê²½ìš° ì²˜ë¦¬
      if (winner.rank === runnerUp.rank) {
        return { 
          winner: null, 
          reason: 'ë™ì  (í‚¤ì»¤ ê³„ì‚° ë³µì¡)',
          topHand: winner.combination
        };
      }
      
      return {
        winner: winner.player,
        reason: winner.combination,
        defeated: runnerUp.combination
      };
    }
    
    // í•¸ë“œ ë­í‚¹ ê³„ì‚° (ìˆ«ìë¡œ ë°˜í™˜)
    function getHandRanking(playerCards, board) {
      const allCards = [...playerCards, ...board];
      
      if (allCards.length < 5) return { rank: -1, description: 'ë¶ˆì™„ì „' };
      
      // ì¹´ë“œë¥¼ íŒŒì‹±
      const parsedCards = allCards.map(card => {
        const rank = card.slice(0, -1);
        const suit = card.slice(-1);
        let numRank = parseInt(rank);
        if (rank === 'J') numRank = 11;
        else if (rank === 'Q') numRank = 12;
        else if (rank === 'K') numRank = 13;
        else if (rank === 'A') numRank = 14;
        return { rank: numRank, suit: suit };
      }).sort((a, b) => b.rank - a.rank);
      
      const ranks = parsedCards.map(c => c.rank);
      const suits = parsedCards.map(c => c.suit);
      const rankCounts = {};
      const suitCounts = {};
      
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      
      const pairs = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 2);
      const threeOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 3);
      const fourOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 4);
      
      const isFlush = Object.values(suitCounts).some(count => count >= 5);
      const isStraight = checkStraight(ranks);
      
      // í•¸ë“œ ë­í‚¹ ë°˜í™˜ (ë†’ì„ìˆ˜ë¡ ê°•í•¨)
      if (isStraight && isFlush) {
        if (ranks[0] === 14 && ranks[1] === 13) return { rank: 9, description: 'ë¡œì–„ í”ŒëŸ¬ì‹œ' };
        return { rank: 8, description: 'ìŠ¤íŠ¸ë ˆì´íŠ¸ í”ŒëŸ¬ì‹œ' };
      }
      if (fourOfAKind.length > 0) return { rank: 7, description: 'í¬ì¹´ë“œ' };
      if (threeOfAKind.length > 0 && pairs.length >= 2) return { rank: 6, description: 'í’€í•˜ìš°ìŠ¤' };
      if (isFlush) return { rank: 5, description: 'í”ŒëŸ¬ì‹œ' };
      if (isStraight) return { rank: 4, description: 'ìŠ¤íŠ¸ë ˆì´íŠ¸' };
      if (threeOfAKind.length > 0) return { rank: 3, description: 'íŠ¸ë¦¬í”Œ' };
      if (pairs.length >= 2) return { rank: 2, description: 'íˆ¬í˜ì–´' };
      if (pairs.length === 1) return { rank: 1, description: 'ì›í˜ì–´' };
      return { rank: 0, description: 'í•˜ì´ì¹´ë“œ' };
    }
    
    // ì •í™•í•œ í¬ì»¤ í•¸ë“œ ê°•ë„ í‰ê°€ í•¨ìˆ˜
    function evaluateHandStrength(playerCards, board) {
      const allCards = [...playerCards, ...board];
      
      if (allCards.length < 5) return 'ë¶ˆì™„ì „í•œ í•¸ë“œ';
      
      // ì¹´ë“œë¥¼ ë­í¬ì™€ ìˆ˜íŠ¸ë¡œ íŒŒì‹±
      const parsedCards = allCards.map(card => {
        const rank = card.slice(0, -1);
        const suit = card.slice(-1);
        let numRank = parseInt(rank);
        if (rank === 'J') numRank = 11;
        else if (rank === 'Q') numRank = 12;
        else if (rank === 'K') numRank = 13;
        else if (rank === 'A') numRank = 14;
        return { rank: numRank, suit: suit, original: card };
      }).sort((a, b) => b.rank - a.rank); // ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
      
      // 5ì¥ ì¡°í•©ìœ¼ë¡œ ê°€ëŠ¥í•œ ëª¨ë“  í•¸ë“œ í‰ê°€
      const bestHand = getBestPokerHand(parsedCards);
      return bestHand;
    }
    
    // ìµœê³ ì˜ í¬ì»¤ í•¸ë“œ ì°¾ê¸° (7ì¥ ì¤‘ 5ì¥ ì¡°í•©)
    function getBestPokerHand(cards) {
      if (cards.length < 5) return 'ë¶ˆì™„ì „í•œ í•¸ë“œ';
      
      // 7ì¥ì´ ìˆë‹¤ë©´ 5ì¥ ì¡°í•©ì„ ëª¨ë‘ ê³„ì‚°í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ì†Œí™”
      const hand5 = cards.slice(0, 5);
      
      const ranks = hand5.map(c => c.rank).sort((a, b) => b - a);
      const suits = hand5.map(c => c.suit);
      const rankCounts = {};
      const suitCounts = {};
      
      ranks.forEach(rank => rankCounts[rank] = (rankCounts[rank] || 0) + 1);
      suits.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
      
      const pairs = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 2);
      const threeOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 3);
      const fourOfAKind = Object.keys(rankCounts).filter(rank => rankCounts[rank] >= 4);
      
      const isFlush = Object.values(suitCounts).some(count => count >= 5);
      const isStraight = checkStraight(ranks);
      
      // í•¸ë“œ ë­í‚¹ íŒì •
      if (isStraight && isFlush) {
        if (ranks[0] === 14 && ranks[1] === 13) return 'ë¡œì–„ í”ŒëŸ¬ì‹œ';
        return `ìŠ¤íŠ¸ë ˆì´íŠ¸ í”ŒëŸ¬ì‹œ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (fourOfAKind.length > 0) {
        return `í¬ì¹´ë“œ (${getRankName(parseInt(fourOfAKind[0]))})`;
      }
      
      if (threeOfAKind.length > 0 && pairs.length >= 2) {
        return `í’€í•˜ìš°ìŠ¤ (${getRankName(parseInt(threeOfAKind[0]))} over ${getRankName(parseInt(pairs.find(p => p !== threeOfAKind[0])))})`;
      }
      
      if (isFlush) {
        return `í”ŒëŸ¬ì‹œ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (isStraight) {
        return `ìŠ¤íŠ¸ë ˆì´íŠ¸ (${getRankName(ranks[0])} í•˜ì´)`;
      }
      
      if (threeOfAKind.length > 0) {
        return `íŠ¸ë¦¬í”Œ (${getRankName(parseInt(threeOfAKind[0]))})`;
      }
      
      if (pairs.length >= 2) {
        const sortedPairs = pairs.map(p => parseInt(p)).sort((a, b) => b - a);
        return `íˆ¬í˜ì–´ (${getRankName(sortedPairs[0])}, ${getRankName(sortedPairs[1])})`;
      }
      
      if (pairs.length === 1) {
        return `ì›í˜ì–´ (${getRankName(parseInt(pairs[0]))})`;
      }
      
      return `${getRankName(ranks[0])} í•˜ì´`;
    }
    
    // ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
    function checkStraight(ranks) {
      const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
      if (uniqueRanks.length < 5) return false;
      
      // ì¼ë°˜ ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
      for (let i = 0; i < uniqueRanks.length - 4; i++) {
        let consecutive = true;
        for (let j = 1; j < 5; j++) {
          if (uniqueRanks[i] - j !== uniqueRanks[i + j]) {
            consecutive = false;
            break;
          }
        }
        if (consecutive) return true;
      }
      
      // A-2-3-4-5 ìŠ¤íŠ¸ë ˆì´íŠ¸ ì²´í¬
      if (uniqueRanks.includes(14) && uniqueRanks.includes(5) && uniqueRanks.includes(4) && uniqueRanks.includes(3) && uniqueRanks.includes(2)) {
        return true;
      }
      
      return false;
    }
    
    // ë­í¬ë¥¼ ë¬¸ìë¡œ ë³€í™˜
    function getRankName(rank) {
      if (rank === 14) return 'A';
      if (rank === 13) return 'K';
      if (rank === 12) return 'Q';
      if (rank === 11) return 'J';
      return rank.toString();
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (Apps Script í˜¸ì¶œ)
    async function updateHandInSheet(handNumber, data) {
      // ì˜¬ë°”ë¥¸ Apps Script URL ì‚¬ìš©
      const scriptUrl = CONFIG.SHEET_UPDATE_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL;
      
      if (!scriptUrl) {
        throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      
      // Apps Script í˜¸í™˜ ë°ì´í„° êµ¬ì¡°ë¡œ ë³€í™˜
      const payload = {
        action: 'updateSheet',  // updateHand ëŒ€ì‹  updateSheet ì‚¬ìš©
        sheetUrl: CONFIG.WRITE_SHEET_URL,  // ì‹œíŠ¸ URL í¬í•¨
        rowNumber: data.virtualRow,  // virtualRowë¥¼ rowNumberë¡œ ë³€ê²½
        handNumber: handNumber,
        filename: data.filename,
        aiAnalysis: data.aiSummary,  // aiSummaryë¥¼ aiAnalysisë¡œ ë³€ê²½
        timestamp: new Date().toISOString()
      };
      
      console.log('ğŸ“¤ Apps Scriptë¡œ í•¸ë“œ ì—…ë°ì´íŠ¸ ì „ì†¡:', payload);
      console.log('ğŸ“¤ ì‚¬ìš© ì¤‘ì¸ Apps Script URL:', scriptUrl);
      
      try {
        const formData = new FormData();
        formData.append('payload', JSON.stringify(payload));
        
        const response = await fetch(scriptUrl + '?_t=' + Date.now(), {
          method: 'POST',
          body: formData,
          cache: 'no-cache'
        });
        
        console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`Apps Script ìš”ì²­ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“¦ Apps Script ì‘ë‹µ:', result);
        
        if (!result.success && result.status !== 'success') {
          throw new Error(result.error || result.message || 'Apps Script ì²˜ë¦¬ ì‹¤íŒ¨');
        }
        
        console.log('âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
        return result;
        
      } catch (error) {
        console.error('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        throw error;
      }
    }
    
    // Virtual ì‹œíŠ¸ ë§¤ì¹­ ë˜í¼ í•¨ìˆ˜ (ê¸°ì¡´ findClosestVirtualRowë¥¼ ì‚¬ìš©)
    async function findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp) {
      try {
        const result = await findClosestVirtualRow(timestamp, virtualSheetUrl);
        
        if (result && result.rowIndex) {
          return {
            matchedRow: {
              row: result.rowIndex,
              data: result.data || {},
              time: result.matchedTime
            },
            isExactMatch: result.accuracy === 'exact',
            accuracy: result.accuracy,
            timeDiff: result.timeDiff
          };
        } else {
          return {
            matchedRow: null,
            isExactMatch: false,
            accuracy: 'none',
            timeDiff: Infinity
          };
        }
      } catch (error) {
        console.error('âŒ Virtual ì‹œíŠ¸ ë§¤ì¹­ ë˜í¼ ì˜¤ë¥˜:', error);
        throw error;
      }
    }
    
    // ê°œì„ ëœ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ (ì²˜ë¦¬ ê³¼ì • ì‹¤ì‹œê°„ í™•ì¸)
    async function showImprovedCompletionModal(handNumber, timestamp, virtualSheetUrl) {
      const modal = document.getElementById('completion-modal');
      const timestampInput = document.getElementById('hand-timestamp');
      const filenameInput = document.getElementById('final-filename');
      const summaryTextarea = document.getElementById('ai-summary');
      const matchedRowInput = document.getElementById('matched-row');
      
      // ë§¤ì¹­ëœ í–‰ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
      window.currentMatchedRowData = null;
      
      // ì‹œê°„ í‘œì‹œ
      const handDate = new Date(timestamp * 1000);
      const hours = String(handDate.getHours()).padStart(2, '0');
      const minutes = String(handDate.getMinutes()).padStart(2, '0');
      const seconds = String(handDate.getSeconds()).padStart(2, '0');
      const timeString = `${hours}:${minutes}:${seconds}`;
      
      // ì´ˆê¸°ê°’ ì„¤ì •
      timestampInput.value = timestamp;
      filenameInput.value = `ì²˜ë¦¬ ì¤‘...`;
      summaryTextarea.value = `ğŸ”„ ì²˜ë¦¬ ì¤‘...\n\n1. í•¸ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...\n2. Virtual ì‹œíŠ¸ ë§¤ì¹­ ëŒ€ê¸°\n3. AI ë¶„ì„ ëŒ€ê¸°\n4. íŒŒì¼ëª… ìƒì„± ëŒ€ê¸°`;
      matchedRowInput.value = `í•¸ë“œ ì‹œê°„: ${timeString} - ë§¤ì¹­ ëŒ€ê¸° ì¤‘...`;
      
      modal.classList.remove('hidden');
      
      try {
        // 1ë‹¨ê³„: í•¸ë“œ ë°ì´í„° ë¡œë“œ
        summaryTextarea.value = `ğŸ”„ 1/4 í•¸ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...\n\ní•¸ë“œ #${handNumber} ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.`;
        const handData = await loadHandData(handNumber);
        if (!handData) {
          throw new Error('í•¸ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // 2ë‹¨ê³„: Virtual ì‹œíŠ¸ ë§¤ì¹­
        summaryTextarea.value = `ğŸ” 2/4 Virtual ì‹œíŠ¸ ë§¤ì¹­ ì¤‘...\n\nì‹œê°„: ${timeString}\nVirtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`;
        const { matchedRow, isExactMatch } = await findMatchingRowInVirtualSheet(virtualSheetUrl, timestamp);
        
        if (!matchedRow) {
          throw new Error('Virtual ì‹œíŠ¸ì—ì„œ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ë§¤ì¹­ëœ ì‹œê°„ í¬ë§·íŒ…
        let matchedTimeStr = matchedRow.time || '';
        if (matchedTimeStr && !matchedTimeStr.includes(':')) {
          // ìˆ«ìë§Œ ìˆìœ¼ë©´ timestampë¡œ ê°„ì£¼í•˜ê³  ë³€í™˜
          const matchedDate = new Date(parseInt(matchedTimeStr) * 1000);
          if (!isNaN(matchedDate.getTime())) {
            const h = String(matchedDate.getHours()).padStart(2, '0');
            const m = String(matchedDate.getMinutes()).padStart(2, '0');
            const s = String(matchedDate.getSeconds()).padStart(2, '0');
            matchedTimeStr = `${h}:${m}:${s}`;
          }
        }
        
        matchedRowInput.value = `ë§¤ì¹­: ${matchedRow.row}í–‰ [í•¸ë“œ ${timeString} â†” ì‹œíŠ¸ ${matchedTimeStr}] (${isExactMatch ? 'ì •í™•' : 'ê·¼ì‚¬'} ë§¤ì¹­)`;
        // ë§¤ì¹­ëœ í–‰ ì •ë³´ ì €ì¥
        window.currentMatchedRowData = {
          row: matchedRow.row,
          isExactMatch: isExactMatch,
          time: matchedRow.time,
          formattedTime: matchedTimeStr
        };
        
        // 3ë‹¨ê³„: AI ë¶„ì„ (ì •í™•í•œ ê³„ì‚°)
        summaryTextarea.value = `ğŸ¤– 3/4 í•¸ë“œ ë¶„ì„ ì¤‘...\n\ní”Œë ˆì´ì–´ ì¹´ë“œì™€ ë³´ë“œ ì¡°í•©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...\nìŠ¹ë¶€ ê²°ê³¼ë¥¼ ê³„ì‚° ì¤‘...`;
        const aiSummary = await analyzeHandWithAI(handNumber);
        
        // 4ë‹¨ê³„: íŒŒì¼ëª… ìƒì„±
        summaryTextarea.value = `ğŸ“ 4/4 íŒŒì¼ëª… ìƒì„± ì¤‘...\n\ní‚¤ í”Œë ˆì´ì–´ë¥¼ ì‹ë³„í•˜ê³  íŒŒì¼ëª…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        let filename = `${handNumber}`;
        if (keyPlayer) {
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
        
        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        filenameInput.value = filename;
        summaryTextarea.value = aiSummary;
        
        console.log('âœ… ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ:', {
          handNumber,
          filename,
          aiSummary,
          matchedRow: matchedRow.row,
          isExactMatch
        });
        
      } catch(error) {
        console.error('âŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        matchedRowInput.value = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
        summaryTextarea.value = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
        filenameInput.value = `ì˜¤ë¥˜_${handNumber}`;
      }
    }
    
    
    // ê¸°ì¡´ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ (ë°±ì—…ìš©)
    async function showCompletionModal(handNumber, timestamp, virtualSheetUrl) {
      const modal = document.getElementById('completion-modal');
      const timestampInput = document.getElementById('hand-timestamp');
      const filenameInput = document.getElementById('final-filename');
      const summaryTextarea = document.getElementById('ai-summary');
      const matchedRowInput = document.getElementById('matched-row');
      
      // ì‹œê°„ í‘œì‹œ (ë‚ ì§œ ì œì™¸, ì‹œê°„ë§Œ)
      const handDate = new Date(timestamp * 1000);
      const hours = String(handDate.getHours()).padStart(2, '0');
      const minutes = String(handDate.getMinutes()).padStart(2, '0');
      const seconds = String(handDate.getSeconds()).padStart(2, '0');
      const timeString = `${hours}:${minutes}:${seconds}`;
      
      // í•¸ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const handData = await loadHandData(handNumber);
      
      // íŒŒì¼ëª… ìƒì„± (í•¸ë“œë²ˆí˜¸_í‚¤í”Œë ˆì´ì–´_ì¹´ë“œ_ìƒëŒ€_ì¹´ë“œ)
      let filename = `${handNumber}`;
      
      if (handData && handData.players && handData.players.length > 0) {
        // Notable í”Œë ˆì´ì–´ ì°¾ê¸° (ë˜ëŠ” ì²« ë²ˆì§¸ í”Œë ˆì´ì–´)
        const keyPlayer = await getKeyPlayerFromHand(handData);
        
        if (keyPlayer) {
          // í‚¤ í”Œë ˆì´ì–´ ì´ë¦„ê³¼ ì¹´ë“œ
          filename += `_${keyPlayer.name}`;
          if (keyPlayer.cards && keyPlayer.cards.length > 0) {
            filename += `_${keyPlayer.cards.join('').replace(/[\s]/g, '')}`;
          }
          
          // ìƒëŒ€ í”Œë ˆì´ì–´ (ì²« ë²ˆì§¸ ìƒëŒ€)
          const opponent = handData.players.find(p => p.name !== keyPlayer.name);
          if (opponent) {
            filename += `_${opponent.name}`;
            if (opponent.cards && opponent.cards.length > 0) {
              filename += `_${opponent.cards.join('').replace(/[\s]/g, '')}`;
            }
          }
        }
      }
      
      filename += '.mp4';
      
      // ì´ˆê¸°í™”
      timestampInput.value = timeString; // ì‹œê°„ë§Œ í‘œì‹œ
      filenameInput.value = filename;
      summaryTextarea.value = 'ë¶„ì„ ì¤‘...';
      matchedRowInput.value = 'ê²€ìƒ‰ ì¤‘...';
      
      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.remove('hidden');
      
      // ë””ë²„ê¹…: ëª¨ë‹¬ê³¼ DOM ìš”ì†Œ ìƒíƒœ í™•ì¸
      console.log('ğŸ” === ëª¨ë‹¬ í‘œì‹œ ì§í›„ DOM ìƒíƒœ ===');
      console.log('  ëª¨ë‹¬ í‘œì‹œ ìƒíƒœ:', !modal.classList.contains('hidden'));
      console.log('  matched-row input ì¡´ì¬:', !!matchedRowInput);
      console.log('  matched-row í˜„ì¬ ê°’:', matchedRowInput.value);
      console.log('  ai-summary ì¡´ì¬:', !!summaryTextarea);
      console.log('  ai-summary í˜„ì¬ ê°’:', summaryTextarea.value);
      
      // Virtual ì‹œíŠ¸ ë§¤ì¹­ ë° AI ë¶„ì„ ë¹„ë™ê¸° ì‹¤í–‰ - async/await ì‚¬ìš©
      try {
        console.log('ğŸš€ Virtual ì‹œíŠ¸ ë§¤ì¹­ ë° AI ë¶„ì„ ì‹œì‘...');
        
        // ë³‘ë ¬ ì‹¤í–‰
        const [virtualMatch, aiSummary] = await Promise.all([
          findClosestVirtualRow(timestamp, virtualSheetUrl),
          analyzeHandWithAI(handNumber)
        ]);
        console.log('âœ… Promise.all ì™„ë£Œ - UI ì—…ë°ì´íŠ¸ ì‹œì‘');
        console.log('ğŸ“Š virtualMatch:', virtualMatch);
        console.log('ğŸ“ aiSummary:', aiSummary);
        
        // ë””ë²„ê¹…: DOM ìš”ì†Œ ìƒíƒœ ì¬í™•ì¸
        console.log('ğŸ” === Promise ì™„ë£Œ í›„ DOM ìƒíƒœ ===');
        console.log('  ëª¨ë‹¬ í‘œì‹œ ìƒíƒœ:', !modal.classList.contains('hidden'));
        console.log('  matched-row input ì¡´ì¬:', !!matchedRowInput);
        console.log('  matched-row í˜„ì¬ ê°’:', matchedRowInput.value);
        
        if (virtualMatch && virtualMatch.row) {
          const diffMinutes = Math.floor(virtualMatch.timeDiff / 60);
          const diffSeconds = virtualMatch.timeDiff % 60;
          
          let timeDiffStr = '';
          if (diffMinutes > 0) {
            timeDiffStr = `${diffMinutes}ë¶„ ${diffSeconds}ì´ˆ`;
          } else {
            timeDiffStr = `${diffSeconds}ì´ˆ`;
          }
          
          // ë§¤ì¹­ ì •í™•ë„ì— ë”°ë¥¸ ì•„ì´ì½˜ ë° ìƒíƒœ í‘œì‹œ
          let accuracyIcon = '';
          let accuracyText = '';
          
          switch(virtualMatch.accuracy) {
            case 'exact':
              accuracyIcon = 'ğŸ¯';
              accuracyText = 'ì •í™• ë§¤ì¹­';
              break;
            case 'close':
              accuracyIcon = 'âœ…';
              accuracyText = 'ê·¼ì‚¬ ë§¤ì¹­';
              break;
            case 'approximate':
              accuracyIcon = 'âš ï¸';
              accuracyText = 'ëŒ€ëµì  ë§¤ì¹­';
              break;
            default:
              accuracyIcon = 'â“';
              accuracyText = 'ë§¤ì¹­ ìƒíƒœ ë¶ˆëª…';
          }
          
          // ì‹œê°„ í¬ë§·íŒ…
          let targetTimeFormatted = virtualMatch.targetTime;
          let matchedTimeFormatted = virtualMatch.matchedTime;
          
          // íƒ€ê²Ÿ ì‹œê°„ í¬ë§·íŒ… (timestampì¸ ê²½ìš°)
          if (targetTimeFormatted && !targetTimeFormatted.includes(':')) {
            const targetDate = new Date(parseInt(targetTimeFormatted) * 1000);
            if (!isNaN(targetDate.getTime())) {
              const h = String(targetDate.getHours()).padStart(2, '0');
              const m = String(targetDate.getMinutes()).padStart(2, '0');
              const s = String(targetDate.getSeconds()).padStart(2, '0');
              targetTimeFormatted = `${h}:${m}:${s}`;
            }
          }
          
          // ë§¤ì¹­ ì‹œê°„ í¬ë§·íŒ… (ì´ë¯¸ HH:MM:SS í˜•ì‹ì¼ ìˆ˜ ìˆìŒ)
          if (matchedTimeFormatted && matchedTimeFormatted.match(/^\d+$/)) {
            const matchedDate = new Date(parseInt(matchedTimeFormatted) * 1000);
            if (!isNaN(matchedDate.getTime())) {
              const h = String(matchedDate.getHours()).padStart(2, '0');
              const m = String(matchedDate.getMinutes()).padStart(2, '0');
              const s = String(matchedDate.getSeconds()).padStart(2, '0');
              matchedTimeFormatted = `${h}:${m}:${s}`;
            }
          }
          
          const matchedRowText = `${accuracyIcon} Row ${virtualMatch.rowIndex} [í•¸ë“œ ${targetTimeFormatted} â†” ì‹œíŠ¸ ${matchedTimeFormatted}] (ì°¨ì´: ${timeDiffStr}) - ${accuracyText}`;
          
          // UI ì—…ë°ì´íŠ¸
          console.log('ğŸ“ matched-row ì—…ë°ì´íŠ¸ ì‹œë„...');
          matchedRowInput.value = matchedRowText;
          
          console.log('âœ… matched-row ì—…ë°ì´íŠ¸ ì™„ë£Œ:', matchedRowText);
          console.log('âœ… ì‹¤ì œ ê°’ í™•ì¸:', matchedRowInput.value);
          console.log('âœ… DOMì— ë°˜ì˜ í™•ì¸:', document.getElementById('matched-row').value);
        } else {
          matchedRowInput.value = 'âŒ ë§¤ì¹­ë˜ëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ';
          console.log('âŒ ë§¤ì¹­ ì‹¤íŒ¨ - UI ì—…ë°ì´íŠ¸');
        }
        
        // AI ìš”ì•½ ì—…ë°ì´íŠ¸
        console.log('ğŸ“ ai-summary ì—…ë°ì´íŠ¸ ì‹œë„...');
        summaryTextarea.value = aiSummary || 'ë¶„ì„ ì‹¤íŒ¨';
        console.log('âœ… ai-summary ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
      } catch(error) {
        console.error('âŒ ë¹„ë™ê¸° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        matchedRowInput.value = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
        summaryTextarea.value = 'ë¶„ì„ ì‹¤íŒ¨';
      }
    }
    
    // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('cancel-completion').addEventListener('click', () => {
      document.getElementById('completion-modal').classList.add('hidden');
    });
    
    // ì™„ë£Œ ì²˜ë¦¬ í™•ì¸ (ê°œì„ ëœ ë²„ì „)
    document.getElementById('confirm-completion').addEventListener('click', async () => {
      const handNumber = currentHand;
      const filename = document.getElementById('final-filename').value;
      const summary = document.getElementById('ai-summary').value;
      const matchedRowInfo = document.getElementById('matched-row').value;
      
      if (!filename || filename.includes('ì²˜ë¦¬ ì¤‘') || filename.includes('ì˜¤ë¥˜')) {
        alert('ì²˜ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì‹œê±°ë‚˜, ì²˜ë¦¬ì— ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!summary || summary.includes('ì²˜ë¦¬ ì¤‘') || summary.includes('ì²˜ë¦¬ ì‹¤íŒ¨')) {
        alert('í•¸ë“œ ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì‹œê±°ë‚˜, ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // í™•ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
      const confirmBtn = document.getElementById('confirm-completion');
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
      
      try {
        // Apps Scriptë¥¼ í†µí•œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        await updateHandInSheet(handNumber, {
          filename: filename,
          aiSummary: summary,
          handAnalysis: 'ì²˜ë¦¬ ì™„ë£Œ',
          virtualRow: matchedRowInfo,
          isExactMatch: true
        });
        
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        const handIndex = allHands.findIndex(h => h.handNumber === handNumber);
        if (handIndex !== -1) {
          allHands[handIndex].handEdit = true;
          allHands[handIndex].handEditTime = new Date().toISOString();
        }
        
        // UI ì—…ë°ì´íŠ¸
        updateHandStatus(true);
        updateHandList();
        updateStats();
        
        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('completion-modal').classList.add('hidden');
        
        // ì„±ê³µ ì•Œë¦¼
        showNotification(`âœ… í•¸ë“œ #${handNumber} í¸ì§‘ ì™„ë£Œ!`, 'success');
        alert(`âœ… í•¸ë“œ #${handNumber} í¸ì§‘ ì™„ë£Œ\n\níŒŒì¼ëª…: ${filename}\nìš”ì•½: ${summary.substring(0, 100)}...`);
        
      } catch (error) {
        console.error('âŒ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showNotification('âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
        alert(`âŒ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    });
    
    async function updateHandEditStatus(handNumber, checked) {
      const completeBtn = document.getElementById('complete-btn');
      const editBtn = document.getElementById('edit-btn');
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      completeBtn.disabled = true;
      editBtn.disabled = true;
      completeBtn.textContent = checked ? 'ì™„ë£Œ ì¤‘...' : 'ì·¨ì†Œ ì¤‘...';
      
      try {
        const payload = {
          action: 'updateHandEdit',
          handNumber: handNumber,
          checked: checked
        };
        
        console.log('ğŸ”§ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ - ì „ì†¡í•  ë°ì´í„°:', payload);
        console.log('ğŸ”§ í˜„ì¬ CONFIG.APPS_SCRIPT_URL:', CONFIG.APPS_SCRIPT_URL);
        
        const formData = new FormData();
        formData.append('payload', JSON.stringify(payload));
        
        console.log('ğŸ“¤ Google Apps Script ìš”ì²­ ì „ì†¡ ì¤‘...');
        console.log('ğŸ“¤ ì‚¬ìš© ì¤‘ì¸ URL:', CONFIG.APPS_SCRIPT_URL);
        const response = await fetch(CONFIG.APPS_SCRIPT_URL + '?_t=' + Date.now(), {
          method: 'POST',
          body: formData,
          cache: 'no-cache'
        });
        
        console.log('ğŸ“¨ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        console.log('ğŸ“¨ ì‘ë‹µ í—¤ë”:', Object.fromEntries(response.headers.entries()));
        
        const responseText = await response.text();
        console.log('ğŸ“¨ ì‘ë‹µ ì›ë³¸ í…ìŠ¤íŠ¸:', responseText);
        
        let result;
        try {
          result = JSON.parse(responseText);
          console.log('ğŸ“¨ íŒŒì‹±ëœ ê²°ê³¼:', result);
        } catch (parseError) {
          console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
          console.error('âŒ ì‘ë‹µì´ JSONì´ ì•„ë‹˜:', responseText);
          throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + responseText);
        }
        
        if (result.success === true || result.status === 'success') {
          console.log('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
          
          // ì„±ê³µ ì•Œë¦¼
          showNotification(
            checked ? 'âœ… í•¸ë“œ í¸ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ğŸ“ í•¸ë“œê°€ í¸ì§‘ ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!',
            'success'
          );
          
          // ì„±ê³µ ì†Œë¦¬ ì¬ìƒ
          playSound('success');
          
          // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ì•Œë¦¼ ì–µì œ)
          await loadIndexData(true);
          
          // í˜„ì¬ ì„ íƒëœ í•¸ë“œ ì—…ë°ì´íŠ¸
          if (currentHand === handNumber) {
            updateHandStatus(checked);
          }
        } else if (result.status === 'error') {
          console.error('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', result);
          showNotification('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
        } else {
          console.error('í•¸ë“œ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ:', result);
          showNotification('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜', 'error');
        }
      } catch (error) {
        console.error('API ì˜¤ë¥˜:', error);
        showNotification('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
        completeBtn.disabled = false;
        editBtn.disabled = false;
        completeBtn.textContent = 'ì™„ë£Œ';
      }
    }
    
    // í˜„ì¬ í•¸ë“œì˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateHandStatus(isCompleted) {
      const completeBtn = document.getElementById('complete-btn');
      const editBtn = document.getElementById('edit-btn');
      
      if (isCompleted) {
        completeBtn.classList.add('bg-gray-600');
        completeBtn.classList.remove('bg-green-600');
        completeBtn.textContent = 'ì™„ë£Œë¨';
        completeBtn.disabled = true;
        
        editBtn.classList.remove('bg-gray-600');
        editBtn.classList.add('bg-yellow-600');
        editBtn.disabled = false;
      } else {
        completeBtn.classList.remove('bg-gray-600');
        completeBtn.classList.add('bg-green-600');
        completeBtn.textContent = 'ì™„ë£Œ';
        completeBtn.disabled = false;
        
        editBtn.classList.add('bg-gray-600');
        editBtn.classList.remove('bg-yellow-600');
        editBtn.disabled = true;
      }
    }
    
    // ====================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    // ====================================
    


    document.getElementById('refresh-btn').addEventListener('click', () => {
      console.log('ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨');
      loadIndexData(false); // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì€ ì•Œë¦¼ í—ˆìš©
    });
    
    document.getElementById('settings-btn').addEventListener('click', () => {
      // Gemini API í‚¤ ë¡œë“œ
      document.getElementById('gemini-api-key').value = CONFIG.GEMINI_API_KEY;
      
      document.getElementById('settings-modal').classList.remove('hidden');
    });
    
    document.getElementById('cancel-settings').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.add('hidden');
    });
    
    document.getElementById('save-settings').addEventListener('click', () => {
      CONFIG.REFRESH_INTERVAL = parseInt(document.getElementById('refresh-interval').value);
      CONFIG.ENABLE_NOTIFICATIONS = document.getElementById('enable-notifications').checked;
      CONFIG.ENABLE_SOUND = document.getElementById('enable-sound').checked;
      
      // Apps Script ì„¤ì • ì €ì¥
      CONFIG.READ_SHEET_URL = document.getElementById('read-sheet-url').value;
      CONFIG.WRITE_SHEET_URL = document.getElementById('write-sheet-url').value;
      CONFIG.SHEET_UPDATE_SCRIPT_URL = document.getElementById('apps-script-url').value;
      
      // Gemini API í‚¤ ì €ì¥
      const apiKeyInput = document.getElementById('gemini-api-key').value.trim();
      CONFIG.GEMINI_API_KEY = apiKeyInput;
      console.log('ğŸ’¾ API í‚¤ ì €ì¥:', apiKeyInput ? `ì„¤ì •ë¨ (ê¸¸ì´: ${apiKeyInput.length})` : 'ë¹ˆ ê°’');
      
      // API í‚¤ ì €ì¥ ìƒíƒœ ì•Œë¦¼
      if (apiKeyInput) {
        showNotification('âœ… Gemini API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } else {
        showNotification('âš ï¸ API í‚¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', 'warning');
      }
      
      // Apps Script ì„¤ì • localStorage ì €ì¥
      localStorage.setItem('read_sheet_url', CONFIG.READ_SHEET_URL);
      localStorage.setItem('write_sheet_url', CONFIG.WRITE_SHEET_URL);
      localStorage.setItem('sheet_update_script_url', CONFIG.SHEET_UPDATE_SCRIPT_URL);
      
      // AI API í‚¤ localStorage ì €ì¥
      saveAPIKeys();
      
      // ëª¨ë“  íƒ€ì´ë¨¸ ì •ë¦¬
      if (refreshTimerInitial) {
        clearTimeout(refreshTimerInitial);
        refreshTimerInitial = null;
      }
      if (refreshTimerInterval) {
        clearInterval(refreshTimerInterval);
        refreshTimerInterval = null;
      }
      
      // ìƒˆë¡œìš´ íƒ€ì´ë¨¸ ì„¤ì •
      refreshTimerInterval = setInterval(() => loadIndexData(true), CONFIG.REFRESH_INTERVAL);
      
      document.getElementById('settings-modal').classList.add('hidden');
    });
    
    // ë²„í¼ ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById('clear-notification-history').addEventListener('click', () => {
      if (confirm('ì •ë§ë¡œ ìµœê·¼ í•¸ë“œ ë²„í¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜:\n- ìµœê·¼ í•¸ë“œ ë²„í¼ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤\n- ë‹¤ìŒ ë¡œë“œì‹œ ê¸°ì¡´ í•¸ë“œë„ ìƒˆ í•¸ë“œë¡œ ì¸ì‹ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤')) {
        // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        recentHandsBuffer.clear();
        masterHandList.clear();
        saveMasterHandList();
        
        // ê¸°ì¡´ ì•Œë¦¼ ê¸°ë¡ë„ ì´ˆê¸°í™”
        notifiedHands = {};
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(MASTER_LIST_KEY);
        
        showNotification('âœ… ìµœê·¼ í•¸ë“œ ë²„í¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        console.log('ğŸ”„ ë²„í¼ ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ì„¤ì • ì°½ ë‹«ê¸°
        document.getElementById('settings-modal').classList.add('hidden');
      }
    });
    
    // ===== ì„¤ì •ì°½ URL ìœ íš¨ì„± ê²€ì‚¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    
    // ì½ê¸°ìš© CSV ì‹œíŠ¸ URL ìœ íš¨ì„± ê²€ì‚¬
    document.getElementById('read-sheet-url').addEventListener('input', (e) => {
      const validation = validateCsvUrl(e.target.value);
      updateUrlFeedback('read-sheet-url', 'read-sheet-url-feedback', validation);
    });
    
    // ì“°ê¸°ìš© ì‹œíŠ¸ URL ìœ íš¨ì„± ê²€ì‚¬  
    document.getElementById('write-sheet-url').addEventListener('input', (e) => {
      const validation = validateSheetUrl(e.target.value);
      updateUrlFeedback('write-sheet-url', 'write-sheet-url-feedback', validation);
    });
    
    // Apps Script URL ìœ íš¨ì„± ê²€ì‚¬
    const appsScriptUrlElement = document.getElementById('apps-script-url');
    if (appsScriptUrlElement) {
      appsScriptUrlElement.addEventListener('input', (e) => {
        const validation = validateAppsScriptUrl(e.target.value);
        updateUrlFeedback('apps-script-url', 'apps-script-url-feedback', validation);
      });
    } else {
      console.error('âŒ apps-script-url ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ===== Apps Script ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    
    // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    const testAppsScriptElement = document.getElementById('test-apps-script');
    if (testAppsScriptElement) {
      testAppsScriptElement.addEventListener('click', async () => {
        await testAppsScriptConnection();
      });
    } else {
      console.error('âŒ test-apps-script ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // Gemini API í‚¤ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    const testGeminiApiElement = document.getElementById('test-gemini-api');
    if (testGeminiApiElement) {
      testGeminiApiElement.addEventListener('click', async () => {
        await testGeminiAPIConnection();
      });
    } else {
      console.error('âŒ test-gemini-api ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼
    const openSheetUpdateElement = document.getElementById('open-sheet-update');
    if (openSheetUpdateElement) {
      openSheetUpdateElement.addEventListener('click', () => {
        const filenameInput = document.getElementById('final-filename');
        const summaryTextarea = document.getElementById('ai-summary');
        const matchedRowInput = document.getElementById('matched-row');
        
        // ì™„ë£Œ ëª¨ë‹¬ì˜ ë°ì´í„°ë¥¼ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ë¡œ ë³µì‚¬
        document.getElementById('update-filename').value = filenameInput.value;
        document.getElementById('update-ai-analysis').value = summaryTextarea.value;
        document.getElementById('update-hand-number').textContent = currentHand || '-';
        
        // ë§¤ì¹­ëœ í–‰ ì •ë³´ í‘œì‹œ
        if (window.currentMatchedRowData) {
          const timeInfo = window.currentMatchedRowData.formattedTime ? 
            ` [ì‹œê°„: ${window.currentMatchedRowData.formattedTime}]` : '';
          document.getElementById('update-matched-row').textContent = 
            `Row ${window.currentMatchedRowData.row}${timeInfo} (${window.currentMatchedRowData.isExactMatch ? 'ì •í™•' : 'ê·¼ì‚¬'} ë§¤ì¹­)`;
        } else {
          document.getElementById('update-matched-row').textContent = matchedRowInput.value || '-';
        }
        const now = new Date();
        const nowTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        document.getElementById('update-matched-time').textContent = nowTimeStr;
        
        // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('sheet-update-modal').classList.remove('hidden');
    });
    } else {
      console.error('âŒ open-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ì·¨ì†Œ
    const cancelSheetUpdateElement = document.getElementById('cancel-sheet-update');
    if (cancelSheetUpdateElement) {
      cancelSheetUpdateElement.addEventListener('click', () => {
        document.getElementById('sheet-update-modal').classList.add('hidden');
      });
    } else {
      console.error('âŒ cancel-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    const confirmSheetUpdateElement = document.getElementById('confirm-sheet-update');
    if (confirmSheetUpdateElement) {
      confirmSheetUpdateElement.addEventListener('click', async () => {
      const filename = document.getElementById('update-filename').value.trim();
      const aiAnalysis = document.getElementById('update-ai-analysis').value.trim();
      const matchedRowText = document.getElementById('update-matched-row').textContent;
      
      if (!filename) {
        alert('âš ï¸ íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!currentHand) {
        alert('âš ï¸ í˜„ì¬ ì„ íƒëœ í•¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë§¤ì¹­ëœ í–‰ ë²ˆí˜¸ ì¶”ì¶œ
      let matchedRow = null;
      
      // ë¨¼ì € ì „ì—­ ë³€ìˆ˜ì—ì„œ í™•ì¸
      if (window.currentMatchedRowData && window.currentMatchedRowData.row) {
        matchedRow = window.currentMatchedRowData.row;
      } else {
        // í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œ ì‹œë„ (ì˜ˆ: "Row 5 ..." â†’ 5)
        const rowMatch = matchedRowText.match(/Row\s+(\d+)/);
        if (rowMatch) {
          matchedRow = parseInt(rowMatch[1]);
        }
      }
      
      if (!matchedRow) {
        alert('âš ï¸ ë§¤ì¹­ëœ í–‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € Virtual ì‹œíŠ¸ ë§¤ì¹­ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log('ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘...');
      console.log(`ğŸ“ í–‰: ${matchedRow}, í•¸ë“œ: ${currentHand}, íŒŒì¼ëª…: ${filename}`);
      
      try {
        // ì—…ë°ì´íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
        const updateBtn = document.getElementById('confirm-sheet-update');
        updateBtn.disabled = true;
        updateBtn.textContent = 'ğŸ“Š ì—…ë°ì´íŠ¸ ì¤‘...';
        
        const result = await updateSheetData(matchedRow, currentHand, filename, aiAnalysis);
        
        if (result.success) {
          alert(`âœ… ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nğŸ“ í–‰: ${matchedRow}\nğŸ“ íŒŒì¼ëª…: ${filename}\nğŸ¤– AI ë¶„ì„: ${aiAnalysis.substring(0, 30)}...`);
          document.getElementById('sheet-update-modal').classList.add('hidden');
          
          // ì™„ë£Œ ì²˜ë¦¬ë„ ê°™ì´ ì‹¤í–‰
          const handNumber = currentHand;
          masterHandList.get(handNumber).status = 'completed';
          saveMasterHandList();
          updateHandList();
          clearHandDetails();
          currentHand = null;
          
        } else {
          alert(`âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨\n\nì˜¤ë¥˜: ${result.message}`);
        }
        
      } catch (error) {
        console.error('ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert(`âŒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜\n\n${error.message}`);
        
      } finally {
        // ë²„íŠ¼ ë³µêµ¬
        const updateBtn = document.getElementById('confirm-sheet-update');
        updateBtn.disabled = false;
        updateBtn.textContent = 'ğŸ“Š ì‹œíŠ¸ ì—…ë°ì´íŠ¸';
      }
      });
    } else {
      console.error('âŒ confirm-sheet-update ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    document.getElementById('table-filter').addEventListener('change', updateHandList);
    document.getElementById('status-filter').addEventListener('change', updateHandList);
    
    document.getElementById('edit-btn').addEventListener('click', () => {
      if (currentHand) {
        const confirmed = confirm('ì´ í•¸ë“œë¥¼ í¸ì§‘ ëŒ€ê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (confirmed) {
          updateHandEditStatus(currentHand, false);
        }
      }
    });
    
    document.getElementById('complete-btn').addEventListener('click', async () => {
      if (currentHand) {
        // Virtual ì‹œíŠ¸ URL í™•ì¸ ë° ìœ íš¨ì„± ê²€ì¦
        const virtualSheetUrl = CONFIG.READ_SHEET_URL;
        if (!virtualSheetUrl) {
          alert('ë¨¼ì € ì„¤ì •ì—ì„œ Virtual ì‹œíŠ¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // URL ê¸°ë³¸ ê²€ì¦
        if (!virtualSheetUrl.includes('docs.google.com/spreadsheets')) {
          const confirmMessage = `âš ï¸ URL í˜•ì‹ í™•ì¸\n\nGoogle Sheets URLì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          if (!confirm(confirmMessage)) {
            return;
          }
          console.warn('âš ï¸ ë¹„í‘œì¤€ URLë¡œ ì§„í–‰:', virtualSheetUrl);
        } else {
          console.log('âœ… URL í˜•ì‹ í™•ì¸:', virtualSheetUrl.substring(0, 50) + '...');
        }
        
        // í•¸ë“œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        const handTime = await getHandTimestamp(currentHand);
        if (handTime) {
          // ê°œì„ ëœ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
          showImprovedCompletionModal(currentHand, handTime, virtualSheetUrl);
        } else {
          alert('í•¸ë“œ ì‹œê°„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      }
    });
    
    // ====================================
    // ì´ˆê¸°í™”
    // ====================================
    
    // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ
    function loadMasterHandList() {
      try {
        const stored = localStorage.getItem(MASTER_LIST_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          masterHandList.clear();
          for (const [handNumber, hand] of Object.entries(data)) {
            masterHandList.set(handNumber, hand);
          }
          console.log(`ğŸ“ ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ: ${masterHandList.size}ê°œ`);
        }
      } catch (e) {
        console.error('ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }
    
    // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥
    function saveMasterHandList() {
      try {
        const data = {};
        for (const [handNumber, hand] of masterHandList.entries()) {
          data[handNumber] = hand;
        }
        localStorage.setItem(MASTER_LIST_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }
    
    // Virtual ì‹œíŠ¸ URL ì €ì¥ ê¸°ëŠ¥ì€ ì„¤ì • ëª¨ë‹¬ì—ì„œ ì²˜ë¦¬ë¨
    
    // localStorageì—ì„œ Gemini API í‚¤ ë¡œë“œ
    function loadAPIKeys() {
      CONFIG.GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
      console.log('ğŸ”“ API í‚¤ ë¡œë“œ:', CONFIG.GEMINI_API_KEY ? `ì„¤ì •ë¨ (ê¸¸ì´: ${CONFIG.GEMINI_API_KEY.length})` : 'ì—†ìŒ');
    }
    
    // Gemini API í‚¤ ì €ì¥
    function saveAPIKeys() {
      localStorage.setItem('gemini_api_key', CONFIG.GEMINI_API_KEY);
    }

    // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
    function debugLog(...args) {
      if (CONFIG.DEBUG_MODE) {
        console.log(...args);
      }
    }

    async function init() {
      console.log('='.repeat(60));
      console.log('ğŸš€ í¬ì»¤ í•¸ë“œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ v9.2.0 - Gemini AI ë¶„ì„ ì‹œìŠ¤í…œ');
      
      // ì´ˆê¸°í™” ì‹œ AI í‚¤ ë¡œë“œ
      loadAPIKeys();
      console.log('='.repeat(60));
      
      // ë§ˆìŠ¤í„° í•¸ë“œ ëª©ë¡ ë¡œë“œ
      loadMasterHandList();
      console.log(`ğŸ“ ê¸°ì¡´ ë§ˆìŠ¤í„° í•¸ë“œ: ${masterHandList.size}ê°œ`);
      
      // Virtual ì‹œíŠ¸ URLì€ CONFIGì—ì„œ ê´€ë¦¬ë¨
      console.log(`ğŸ“Š Virtual ì‹œíŠ¸ ì„¤ì •: ${CONFIG.READ_SHEET_URL ? CONFIG.READ_SHEET_URL.substring(0, 50) + '...' : 'ë¯¸ì„¤ì •'}`);
      
      
      // Apps Script ì„¤ì • ë¡œë“œ
      const savedReadSheetUrl = localStorage.getItem('read_sheet_url');
      const savedWriteSheetUrl = localStorage.getItem('write_sheet_url');
      const savedScriptUrl = localStorage.getItem('sheet_update_script_url');
      
      if (savedReadSheetUrl) {
        CONFIG.READ_SHEET_URL = savedReadSheetUrl;
        document.getElementById('read-sheet-url').value = savedReadSheetUrl;
        console.log(`ğŸ“– ì½ê¸° ì‹œíŠ¸ URL ë¡œë“œë¨ (ì €ì¥ëœ ê°’)`);
      } else if (CONFIG.READ_SHEET_URL) {
        // localStorageì— ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ì„ UIì— í‘œì‹œ
        document.getElementById('read-sheet-url').value = CONFIG.READ_SHEET_URL;
        console.log(`ğŸ“– ì½ê¸° ì‹œíŠ¸ URL ê¸°ë³¸ê°’ ì‚¬ìš©`);
      }
      if (savedWriteSheetUrl) {
        CONFIG.WRITE_SHEET_URL = savedWriteSheetUrl;
        document.getElementById('write-sheet-url').value = savedWriteSheetUrl;
        console.log(`âœï¸ ì“°ê¸° ì‹œíŠ¸ URL ë¡œë“œë¨`);
      }
      if (savedScriptUrl) {
        CONFIG.SHEET_UPDATE_SCRIPT_URL = savedScriptUrl;
        document.getElementById('apps-script-url').value = savedScriptUrl;
        console.log(`ğŸ”— Apps Script URL ë¡œë“œë¨`);
      }
      
      // ìµœê·¼ í•¸ë“œ ë²„í¼ ìƒíƒœ í™•ì¸
      const bufferStatus = recentHandsBuffer.getStatus();
      console.log(`ğŸ’¾ ìµœê·¼ í•¸ë“œ ë²„í¼: ${bufferStatus.size}/${bufferStatus.maxSize}ê°œ (ìµœëŒ€ 100ê°œ ì €ì¥)`);
      if (bufferStatus.size > 0) {
        console.log(`ğŸ’¾ ë²„í¼ ë‚´ìš©:`, bufferStatus.buffer);
      }
      
      console.log('ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }
      
      console.log('ğŸ“„ ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹œì‘...');
      await loadIndexData();
      
      if (allHands.length > 0) {
        selectHand(allHands[0].handNumber);
      }
      
      // ìë™ ìƒˆë¡œê³ ì¹¨ - ì´ˆê¸° ë¡œë“œ ì§í›„ê°€ ì•„ë‹Œ REFRESH_INTERVAL í›„ì— ì‹œì‘
      // ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ ë¡œë“œ ì‹œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      refreshTimerInitial = setTimeout(() => {
        // ì²« ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰
        if (DEBUG_MODE) {
          console.log('â° ì²« ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ (ìƒˆ í•¸ë“œ ê°ì§€ í¬í•¨)');
        }
        loadIndexData(false);
        
        // ì´ˆê¸° íƒ€ì´ë¨¸ ì •ë¦¬
        refreshTimerInitial = null;
        
        // ì´í›„ ì •ê¸°ì ì¸ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
        refreshTimerInterval = setInterval(() => {
          if (DEBUG_MODE) {
            console.log('â° ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ (ìƒˆ í•¸ë“œ ê°ì§€ í¬í•¨)');
          }
          loadIndexData(false); // false = ìƒˆë¡œìš´ í•¸ë“œì— ëŒ€í•´ì„œëŠ” ì•Œë¦¼ í—ˆìš©
        }, CONFIG.REFRESH_INTERVAL);
      }, CONFIG.REFRESH_INTERVAL); // ì²« ì‹¤í–‰ë„ REFRESH_INTERVAL í›„ì—
      
      console.log('ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ì•± ì‹œì‘
    init();
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (refreshTimerInitial) {
        clearTimeout(refreshTimerInitial);
      }
      if (refreshTimerInterval) {
        clearInterval(refreshTimerInterval);
      }
    });
  </script>
</body>
</html>
