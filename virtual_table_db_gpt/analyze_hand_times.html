<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í¬ì»¤ í•¸ë“œ ì‹œê°„ ë¶„ì„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">ğŸ•’ í¬ì»¤ í•¸ë“œ ì‹œê°„ ë¶„ì„ ë„êµ¬</h1>
    
    <div class="bg-gray-800 rounded-lg p-6 mb-6">
      <button id="analyze-btn" class="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700">
        ğŸ“Š ì‹œê°„ ë°ì´í„° ë¶„ì„ ì‹œì‘
      </button>
      <span id="status" class="ml-4 text-gray-400"></span>
    </div>

    <div id="results" class="hidden">
      <!-- í†µê³„ ìš”ì•½ -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm">ì´ í•¸ë“œ ìˆ˜</div>
          <div class="text-2xl font-bold" id="total-hands">0</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm">ì²« í•¸ë“œ ì‹œê°„</div>
          <div class="text-xl font-bold" id="first-hand">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm">ë§ˆì§€ë§‰ í•¸ë“œ ì‹œê°„</div>
          <div class="text-xl font-bold" id="last-hand">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm">í‰ê·  í•¸ë“œ ê°„ê²©</div>
          <div class="text-xl font-bold" id="avg-interval">-</div>
        </div>
      </div>

      <!-- ì‹œê°„ëŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ -->
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">â° ì‹œê°„ëŒ€ë³„ í•¸ë“œ ë¶„í¬</h2>
        <canvas id="hourly-chart"></canvas>
      </div>

      <!-- ë‚ ì§œë³„ ë¶„í¬ ì°¨íŠ¸ -->
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">ğŸ“… ë‚ ì§œë³„ í•¸ë“œ ë¶„í¬</h2>
        <canvas id="daily-chart"></canvas>
      </div>

      <!-- ìƒì„¸ ì‹œê°„ ì •ë³´ í…Œì´ë¸” -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">ğŸ“‹ ìµœê·¼ í•¸ë“œ ì‹œê°„ ì •ë³´ (ìµœëŒ€ 20ê°œ)</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="text-left py-2">í•¸ë“œ #</th>
                <th class="text-left py-2">ì‹œê°„ (Epoch)</th>
                <th class="text-left py-2">ë³€í™˜ëœ ì‹œê°„</th>
                <th class="text-left py-2">ì´ì „ í•¸ë“œì™€ ê°„ê²©</th>
              </tr>
            </thead>
            <tbody id="time-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      CSV_HAND_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1906746276&single=true&output=csv',
      CSV_INDEX_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDY_i4330JANAjIz4sMncdJdRHsOkfUCjQusHTGQk2tykrhA4d09LeIp3XRbLd8hkN6SgSB47k_nux/pub?gid=1354012271&single=true&output=csv'
    };

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          const next = line[i + 1];
          
          if (char === '"' && inQuotes && next === '"') {
            current += '"';
            i++;
          } else if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      });
    }

    async function analyzeHandTimes() {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘...';
      
      try {
        // Hand ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
        const response = await fetch(CONFIG.CSV_HAND_URL + '&t=' + Date.now());
        const text = await response.text();
        const rows = parseCSV(text);
        
        // HAND í–‰ë§Œ í•„í„°ë§í•˜ê³  ì‹œê°„ ë°ì´í„° ì¶”ì¶œ
        const handData = [];
        for (const row of rows) {
          if (row[1] === 'HAND' && row[2] && row[3]) {
            const handNumber = row[2];
            const timestamp = row[3]; // Dì—´: ì‹œê°„ ì •ë³´ (epoch timestamp)
            
            // Epoch íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ìˆ«ìë¡œ ë³€í™˜
            const epochTime = parseInt(timestamp);
            if (!isNaN(epochTime) && epochTime > 0) {
              handData.push({
                handNumber: handNumber,
                epochTime: epochTime,
                date: new Date(epochTime * 1000) // JavaScriptëŠ” ë°€ë¦¬ì´ˆ ë‹¨ìœ„
              });
            }
          }
        }
        
        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        handData.sort((a, b) => a.epochTime - b.epochTime);
        
        console.log(`ì´ ${handData.length}ê°œ í•¸ë“œ ë¶„ì„ ì™„ë£Œ`);
        
        // í†µê³„ ê³„ì‚°
        if (handData.length > 0) {
          displayAnalysis(handData);
        } else {
          statusEl.textContent = 'ì‹œê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }
        
      } catch (error) {
        console.error('ë¶„ì„ ì‹¤íŒ¨:', error);
        statusEl.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
      }
    }

    function displayAnalysis(handData) {
      document.getElementById('results').classList.remove('hidden');
      document.getElementById('status').textContent = `${handData.length}ê°œ í•¸ë“œ ë¶„ì„ ì™„ë£Œ`;
      
      // ê¸°ë³¸ í†µê³„
      document.getElementById('total-hands').textContent = handData.length;
      document.getElementById('first-hand').textContent = 
        handData[0].date.toLocaleString('ko-KR');
      document.getElementById('last-hand').textContent = 
        handData[handData.length - 1].date.toLocaleString('ko-KR');
      
      // í‰ê·  ê°„ê²© ê³„ì‚°
      if (handData.length > 1) {
        const totalTime = handData[handData.length - 1].epochTime - handData[0].epochTime;
        const avgInterval = totalTime / (handData.length - 1);
        const minutes = Math.floor(avgInterval / 60);
        const seconds = Math.floor(avgInterval % 60);
        document.getElementById('avg-interval').textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
      }
      
      // ì‹œê°„ëŒ€ë³„ ë¶„í¬ ê³„ì‚°
      const hourlyDistribution = new Array(24).fill(0);
      const dailyDistribution = {};
      
      for (const hand of handData) {
        const hour = hand.date.getHours();
        hourlyDistribution[hour]++;
        
        const dateKey = hand.date.toLocaleDateString('ko-KR');
        dailyDistribution[dateKey] = (dailyDistribution[dateKey] || 0) + 1;
      }
      
      // ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸
      new Chart(document.getElementById('hourly-chart'), {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}ì‹œ`),
          datasets: [{
            label: 'í•¸ë“œ ìˆ˜',
            data: hourlyDistribution,
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af'
              }
            },
            x: {
              ticks: {
                color: '#9ca3af'
              }
            }
          }
        }
      });
      
      // ë‚ ì§œë³„ ì°¨íŠ¸
      const sortedDates = Object.keys(dailyDistribution).sort();
      new Chart(document.getElementById('daily-chart'), {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'í•¸ë“œ ìˆ˜',
            data: sortedDates.map(date => dailyDistribution[date]),
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            borderColor: 'rgba(34, 197, 94, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af'
              }
            },
            x: {
              ticks: {
                color: '#9ca3af',
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
      
      // ìƒì„¸ í…Œì´ë¸” (ìµœê·¼ 20ê°œ)
      const tableBody = document.getElementById('time-table');
      tableBody.innerHTML = '';
      
      const recentHands = handData.slice(-20).reverse(); // ìµœê·¼ 20ê°œ
      for (let i = 0; i < recentHands.length; i++) {
        const hand = recentHands[i];
        let interval = '';
        
        if (i < recentHands.length - 1) {
          const prevHand = recentHands[i + 1];
          const diff = hand.epochTime - prevHand.epochTime;
          const minutes = Math.floor(diff / 60);
          const seconds = diff % 60;
          interval = `${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
        
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700';
        row.innerHTML = `
          <td class="py-2">#${hand.handNumber}</td>
          <td class="py-2">${hand.epochTime}</td>
          <td class="py-2">${hand.date.toLocaleString('ko-KR')}</td>
          <td class="py-2">${interval}</td>
        `;
        tableBody.appendChild(row);
      }
    }

    // ë¶„ì„ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('analyze-btn').addEventListener('click', analyzeHandTimes);
    
    // í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ë¶„ì„
    window.addEventListener('load', analyzeHandTimes);
  </script>
</body>
</html>